<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PharmaSpace</title>
  <!-- Phase 1: Police Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Phase 1: Base & Typographie */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      /* Palette professionnelle avec meilleur contraste */
      --color-bg: #F1F5F9;           /* Fond g√©n√©ral l√©g√®rement gris-bleu */
      --color-surface: #FFFFFF;       /* Cartes et surfaces blanches */
      --color-border: #CBD5E1;        /* Bordures plus visibles */
      --color-border-hover: #94A3B8;  /* Hover plus marqu√© */
      
      --color-text-primary: #0F172A;
      --color-text-secondary: #475569;
      --color-text-muted: #64748B;
      
      /* Boutons principaux */
      --color-button-primary: #0F172A;
      --color-button-primary-text: #FFFFFF;
      
      --color-accent: #0284C7;
      --color-accent-hover: #0369A1;
      --color-warning: #3B82F6;
      --color-success: #059669;
      --color-error: #DC2626;
      
      /* Badges et pills */
      --color-badge-bg: #DBEAFE;
      --color-badge-text: #1e40af;
      
      /* Espacements */
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      
      /* Typographie */
      --font-body: 15px;
      --font-small: 13px;
      --font-tiny: 11px;
      
      /* Ombres pour profondeur */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    /* MODE SOMBRE */
    [data-theme="dark"] {
      /* Fonds */
      --color-bg: #0F172A;           /* Fond tr√®s sombre */
      --color-surface: #1E293B;      /* Cartes un peu plus claires */
      --color-border: #334155;       /* Bordures visibles */
      --color-border-hover: #475569; /* Hover bordures */
      
      /* Textes - TOUJOURS CLAIRS en mode sombre */
      --color-text-primary: #F1F5F9;   /* Texte principal tr√®s clair */
      --color-text-secondary: #CBD5E1; /* Texte secondaire clair */
      --color-text-muted: #94A3B8;     /* Texte discret mais visible */
      
      /* Boutons principaux - Visibles sur fond sombre */
      --color-button-primary: #334155;     /* Gris-bleu moyen */
      --color-button-primary-text: #F1F5F9; /* Texte clair */
      
      /* Couleurs d'accent */
      --color-accent: #38BDF8;
      --color-accent-hover: #0EA5E9;
      --color-warning: #FCD34D;
      --color-success: #34D399;
      --color-error: #F87171;
      
      /* Badges */
      --color-badge-bg: rgba(56, 189, 248, 0.15);
      --color-badge-text: #7DD3FC;
      
      /* Ombres plus prononc√©es */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }
    
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: var(--color-bg);
      color: var(--color-text-primary);
      line-height: 1.5;
      font-size: var(--font-body);
    }
    
    /* Style global pour inputs, selects et textareas - FORCE le background */
    input:not([type="color"]):not([type="range"]):not([type="checkbox"]):not([type="radio"]), 
    select, 
    textarea {
      color: var(--color-text-primary) !important;
      background: var(--color-surface) !important;
    }
    
    /* Style des options dans les selects */
    option {
      background: var(--color-surface);
      color: var(--color-text-primary);
    }
    
    input::placeholder, textarea::placeholder {
      color: var(--color-text-muted) !important;
      opacity: 0.7;
    }
    
    /* Labels et headings dans les modals */
    label {
      color: var(--color-text-primary);
    }
    
    h1, h2, h3, h4, h5, h6 {
      color: var(--color-text-primary);
    }
    
    /* Adapter le texte par d√©faut dans contenteditable selon le th√®me */
    [contenteditable="true"] {
      color: var(--color-text-primary);
    }
    
    /* Les spans et √©l√©ments avec des couleurs inline gardent leurs couleurs */
    [contenteditable="true"] *[style*="color"] {
      /* Garder la couleur inline */
    }

    </style>
</head>
<body>
  <!-- √âcran de login -->
  <div id="root"></div>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ========== FIREBASE CONFIGURATION ==========
    const firebaseConfig = {
      apiKey: "AIzaSyCIOU8mbcdOM8NaPfGqjv1PccCb63UlU6A",
      authDomain: "pharmaspace-a13af.firebaseapp.com",
      databaseURL: "https://pharmaspace-a13af-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "pharmaspace-a13af",
      storageBucket: "pharmaspace-a13af.firebasestorage.app",
      messagingSenderId: "596839487470",
      appId: "1:596839487470:web:d0948c48de44f7c7fb60ff"
    };

    // Initialize Firebase
    let firebaseApp;
    let db;
    let firebaseEnabled = false;

    try {
      firebaseApp = firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      firebaseEnabled = true;
      console.log('üî• Firebase initialis√© avec succ√®s !');
      
      // Authentification anonyme pour s√©curiser la base de donn√©es
      firebase.auth().signInAnonymously()
        .then(() => {
          console.log('üîê Authentification anonyme r√©ussie');
        })
        .catch((error) => {
          console.error('‚ùå Erreur authentification:', error);
        });
    } catch (error) {
      console.error('‚ùå Erreur Firebase:', error);
      firebaseEnabled = false;
    }

    // ========== FIREBASE SYNC FUNCTIONS ==========
    
    // Helper pour sauvegarder dans Firebase ET localStorage
    const saveToFirebase = async (path, data) => {
      if (firebaseEnabled) {
        try {
          await db.ref(path).set(data);
          console.log(`üî• Sauvegard√© sur Firebase: ${path}`);
        } catch (error) {
          console.error(`‚ùå Erreur sauvegarde Firebase ${path}:`, error);
        }
      }
      // Toujours sauvegarder en local comme backup
      localStorage.setItem(`pharmaspace_${path}`, JSON.stringify(data));
    };

    // Helper pour charger depuis Firebase avec fallback localStorage
    const loadFromFirebase = async (path, defaultValue) => {
      // D'abord essayer localStorage pour un chargement rapide
      const localData = localStorage.getItem(`pharmaspace_${path}`);
      let initialData = localData ? JSON.parse(localData) : defaultValue;

      // Puis √©couter Firebase pour les mises √† jour
      if (firebaseEnabled) {
        db.ref(path).on('value', (snapshot) => {
          const firebaseData = snapshot.val();
          if (firebaseData) {
            console.log(`üî• Donn√©es re√ßues de Firebase: ${path}`);
            // Mettre √† jour localStorage
            localStorage.setItem(`pharmaspace_${path}`, JSON.stringify(firebaseData));
          }
        });
      }

      return initialData;
    };

    // Fonction pour migrer les donn√©es existantes vers Firebase
    const migrateToFirebase = async () => {
      if (!firebaseEnabled) {
        alert('‚ùå Firebase n\'est pas activ√© !');
        return;
      }

      try {
        console.log('üîÑ Migration vers Firebase...');

        // R√©cup√©rer toutes les donn√©es du localStorage
        const medications = localStorage.getItem('pharmaspace_medications');
        const classes = localStorage.getItem('pharmaspace_classes');
        const forms = localStorage.getItem('pharmaspace_forms');
        const conseilsCategories = localStorage.getItem('conseilsCategories');
        const conseilsOfficine = localStorage.getItem('conseilsOfficine');

        // Envoyer sur Firebase
        const updates = {};
        if (medications) updates['medications'] = JSON.parse(medications);
        if (classes) updates['classes'] = JSON.parse(classes);
        if (forms) updates['forms'] = JSON.parse(forms);
        if (conseilsCategories) updates['conseilsCategories'] = JSON.parse(conseilsCategories);
        if (conseilsOfficine) updates['conseilsOfficine'] = JSON.parse(conseilsOfficine);

        // Migrer aussi les cat√©gories de documents
        const plaintes = conseilsOfficine ? JSON.parse(conseilsOfficine) : [];
        const docCategories = {};
        plaintes.forEach(plainte => {
          const savedCategories = localStorage.getItem('docCategories_' + plainte.id);
          if (savedCategories) {
            docCategories[plainte.id] = JSON.parse(savedCategories);
          }
        });
        if (Object.keys(docCategories).length > 0) {
          updates['docCategories'] = docCategories;
        }

        // Envoyer tout en une fois
        await db.ref().update(updates);

        console.log('‚úÖ Migration termin√©e !');
        alert('‚úÖ Migration vers Firebase r√©ussie !\n\nüî• Vos donn√©es sont maintenant synchronis√©es en temps r√©el sur tous vos appareils.');
      } catch (error) {
        console.error('‚ùå Erreur migration:', error);
        alert('‚ùå Erreur lors de la migration : ' + error.message);
      }
    };

    // ========== CODE CONSEILS OFFICINE ==========

    const INITIAL_CATEGORIES = [
      { nom: "Syst√®me respiratoire", couleur: "#3B82F6" },
      { nom: "Douleurs & Fi√®vre", couleur: "#EF4444" },
      { nom: "Syst√®me digestif", couleur: "#10B981" },
      { nom: "Bouche & Peau", couleur: "#3B82F6" }
    ];

    const INITIAL_PLAINTES = [
      { id: "rhume", nom: "Rhume", categorie: "Syst√®me respiratoire", emoji: "ü§ß", description: "√âcoulement nasal, congestion", specialites: [], informations: "", documents: [] },
      { id: "toux", nom: "Toux", categorie: "Syst√®me respiratoire", emoji: "üò∑", description: "Toux s√®che ou grasse", specialites: [], informations: "", documents: [] },
      { id: "gorge", nom: "Maux de gorge", categorie: "Syst√®me respiratoire", emoji: "ü§í", description: "Irritation, douleur", specialites: [], informations: "", documents: [] },
      { id: "tete", nom: "Maux de t√™te", categorie: "Douleurs & Fi√®vre", emoji: "ü§ï", description: "C√©phal√©es, migraines", specialites: [], informations: "", documents: [] },
      { id: "fievre", nom: "Fi√®vre", categorie: "Douleurs & Fi√®vre", emoji: "üå°Ô∏è", description: "Temp√©rature > 38¬∞C", specialites: [], informations: "", documents: [] },
      { id: "nausees", nom: "Naus√©es", categorie: "Syst√®me digestif", emoji: "ü§¢", description: "Envie de vomir", specialites: [], informations: "", documents: [] },
      { id: "estomac", nom: "Br√ªlures d'estomac", categorie: "Syst√®me digestif", emoji: "üî•", description: "Reflux gastrique", specialites: [], informations: "", documents: [] },
      { id: "constipation", nom: "Constipation", categorie: "Syst√®me digestif", emoji: "üí©", description: "Difficult√© √† aller √† la selle", specialites: [], informations: "", documents: [] },
      { id: "diarrhee", nom: "Diarrh√©e", categorie: "Syst√®me digestif", emoji: "üöΩ", description: "Selles liquides", specialites: [], informations: "", documents: [] },
      { id: "aphte", nom: "Aphte", categorie: "Bouche & Peau", emoji: "üò£", description: "Ulc√©ration buccale", specialites: [], informations: "", documents: [] },
      { id: "herpes", nom: "Boutons de fi√®vre", categorie: "Bouche & Peau", emoji: "üòñ", description: "Herp√®s labial", specialites: [], informations: "", documents: [] },
      { id: "ampoules", nom: "Cloche aux pieds", categorie: "Bouche & Peau", emoji: "ü¶∂", description: "Ampoules", specialites: [], informations: "", documents: [] },
      { id: "piercing", nom: "Piercing aux oreilles", categorie: "Bouche & Peau", emoji: "üëÇ", description: "Soins post-piercing", specialites: [], informations: "", documents: [] }
    ];

    const EditIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
    );

    const DeleteIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
      </svg>
    );

    const LinkIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/>
        <path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/>
      </svg>
    );

    function parseContent(content, couleur) {
      if (!content) return [];

      const lines = content.split('\n');
      const elements = [];
      let i = 0;

      while (i < lines.length) {
        const line = lines[i];
        
        // D√©tecter l'indentation (espaces en d√©but de ligne)
        const indentMatch = line.match(/^(\s+)/);
        const indentLevel = indentMatch ? indentMatch[1].length : 0;

        if (line.trim() === '[row]') {
          const rowContent = [];
          i++;
          while (i < lines.length && lines[i].trim() !== '[/row]') {
            rowContent.push(lines[i]);
            i++;
          }
          
          const rowElements = [];
          rowContent.forEach(rowLine => {
            const imgMatch = rowLine.match(/\[img-(small|medium|large)\](https?:\/\/[^\[]+)\[\/img-(small|medium|large)\]/) ||
                            rowLine.match(/\[img\](https?:\/\/[^\[]+)\[\/img\]/);
            
            if (imgMatch) {
              const size = imgMatch[1] || 'full';
              const url = imgMatch[2] || imgMatch[1];
              rowElements.push({ type: 'image', url, size });
            }
          });

          if (rowElements.length > 0) {
            elements.push({ type: 'row', items: rowElements });
          }
          i++;
          continue;
        }

        const imgCenterSmall = line.match(/\[img-center-small\](https?:\/\/[^\[]+)\[\/img-center-small\]/);
        const imgCenterMedium = line.match(/\[img-center-medium\](https?:\/\/[^\[]+)\[\/img-center-medium\]/);
        const imgCenterLarge = line.match(/\[img-center-large\](https?:\/\/[^\[]+)\[\/img-center-large\]/);
        const imgCenterFull = line.match(/\[img-center\](https?:\/\/[^\[]+)\[\/img-center\]/);

        const imgSmall = line.match(/\[img-small\](https?:\/\/[^\[]+)\[\/img-small\]/);
        const imgMedium = line.match(/\[img-medium\](https?:\/\/[^\[]+)\[\/img-medium\]/);
        const imgLarge = line.match(/\[img-large\](https?:\/\/[^\[]+)\[\/img-large\]/);
        const imgFull = line.match(/\[img\](https?:\/\/[^\[]+)\[\/img\]/);

        if (imgCenterSmall) {
          elements.push({ type: 'image', url: imgCenterSmall[1], size: 'small', centered: true });
        } else if (imgCenterMedium) {
          elements.push({ type: 'image', url: imgCenterMedium[1], size: 'medium', centered: true });
        } else if (imgCenterLarge) {
          elements.push({ type: 'image', url: imgCenterLarge[1], size: 'large', centered: true });
        } else if (imgCenterFull) {
          elements.push({ type: 'image', url: imgCenterFull[1], size: 'full', centered: true });
        } else if (imgSmall) {
          elements.push({ type: 'image', url: imgSmall[1], size: 'small' });
        } else if (imgMedium) {
          elements.push({ type: 'image', url: imgMedium[1], size: 'medium' });
        } else if (imgLarge) {
          elements.push({ type: 'image', url: imgLarge[1], size: 'large' });
        } else if (imgFull) {
          elements.push({ type: 'image', url: imgFull[1], size: 'full' });
        } else if (line.startsWith('http') && (line.match(/\.(jpg|jpeg|png|gif|webp)$/i) || line.includes('imgur') || line.includes('ibb.co'))) {
          elements.push({ type: 'image', url: line, size: 'full' });
        } else if (line.startsWith('http')) {
          elements.push({ type: 'link', url: line });
        } else {
          elements.push({ type: 'text', content: line.trimEnd(), indent: indentLevel });
        }

        i++;
      }

      return elements;
    }

    function renderParsedContent(elements, couleur) {
      return elements.map((el, idx) => {
        if (el.type === 'row') {
          return (
            <div key={idx} style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap', margin: '1rem 0' }}>
              {el.items.map((item, itemIdx) => {
                const width = item.size === 'small' ? '30%' : item.size === 'medium' ? '48%' : item.size === 'large' ? '70%' : '100%';
                return (
                  <img
                    key={itemIdx}
                    src={item.url}
                    alt="Image"
                    style={{
                      width: width,
                      minWidth: '150px',
                      borderRadius: '8px',
                      boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                      objectFit: 'cover'
                    }}
                  />
                );
              })}
            </div>
          );
        } else if (el.type === 'image') {
          const sizeMap = {
            'small': '30%',
            'medium': '50%',
            'large': '70%',
            'full': '100%'
          };
          const width = sizeMap[el.size] || '100%';
          const isInline = el.size === 'small' || el.size === 'medium';

          if (el.centered) {
            return (
              <div key={idx} style={{ textAlign: 'center', margin: '1rem 0' }}>
                <img
                  src={el.url}
                  alt="Image"
                  style={{
                    width: width,
                    maxWidth: '100%',
                    borderRadius: '8px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                    display: 'inline-block'
                  }}
                />
              </div>
            );
          }

          return (
            <img
              key={idx}
              src={el.url}
              alt="Image"
              style={{
                width: width,
                maxWidth: '100%',
                borderRadius: '8px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                margin: '0.5rem 0',
                display: isInline ? 'inline-block' : 'block',
                marginRight: isInline ? '1rem' : '0',
                verticalAlign: 'top'
              }}
            />
          );
        } else if (el.type === 'link') {
          return (
            <div key={idx}>
              <a href={el.url} target="_blank" style={{ color: couleur, textDecoration: 'underline' }}>
                {el.url}
              </a>
            </div>
          );
        } else {
          // Parser le formatage du texte avec indentation
          const marginLeft = (el.indent || 0) * 10; // 10px par espace
          return <div key={idx} style={{ marginLeft: `${marginLeft}px` }}>{parseFormattedText(el.content || '\u00A0')}</div>;
        }
      });
    }

    function parseFormattedText(text) {
      if (!text || text === '\u00A0') return text;
      
      // Titres
      if (text.startsWith('### ')) {
        return <h3 style={{ fontSize: '1.1rem', fontWeight: 'bold', marginTop: '1rem', marginBottom: '0.5rem', color: 'var(--color-text-primary)' }}>{text.substring(4)}</h3>;
      }
      if (text.startsWith('## ')) {
        return <h2 style={{ fontSize: '1.3rem', fontWeight: 'bold', marginTop: '1.2rem', marginBottom: '0.6rem', color: 'var(--color-text-primary)' }}>{text.substring(3)}</h2>;
      }
      if (text.startsWith('# ')) {
        return <h1 style={{ fontSize: '1.5rem', fontWeight: 'bold', marginTop: '1.5rem', marginBottom: '0.7rem', color: 'var(--color-text-primary)' }}>{text.substring(2)}</h1>;
      }
      
      // Listes
      if (text.startsWith('- ') || text.startsWith('‚Ä¢ ')) {
        return <li style={{ marginLeft: '1.5rem' }}>{parseInlineFormatting(text.substring(2))}</li>;
      }
      if (/^\d+\.\s/.test(text)) {
        const content = text.replace(/^\d+\.\s/, '');
        return <li style={{ marginLeft: '1.5rem', listStyleType: 'decimal' }}>{parseInlineFormatting(content)}</li>;
      }
      
      // Texte normal avec formatage inline
      return parseInlineFormatting(text);
    }

    function parseInlineFormatting(text) {
      const parts = [];
      let remaining = text;
      let key = 0;

      while (remaining.length > 0) {
        // Couleurs
        const colorRedMatch = remaining.match(/^\[color-red\](.*?)\[\/color-red\]/);
        const colorBlueMatch = remaining.match(/^\[color-blue\](.*?)\[\/color-blue\]/);
        const colorGreenMatch = remaining.match(/^\[color-green\](.*?)\[\/color-green\]/);
        const colorOrangeMatch = remaining.match(/^\[color-orange\](.*?)\[\/color-orange\]/);
        
        // Gras
        const boldMatch = remaining.match(/^\*\*(.*?)\*\*/);
        
        // Italique
        const italicMatch = remaining.match(/^\*(.*?)\*/);
        
        // Soulign√©
        const underlineMatch = remaining.match(/^__(.*?)__/);
        
        // Barr√©
        const strikeMatch = remaining.match(/^~~(.*?)~~/);
        
        if (colorRedMatch) {
          parts.push(<span key={key++} style={{ color: '#dc2626', fontWeight: 600 }}>{colorRedMatch[1]}</span>);
          remaining = remaining.substring(colorRedMatch[0].length);
        } else if (colorBlueMatch) {
          parts.push(<span key={key++} style={{ color: '#1d4ed8', fontWeight: 600 }}>{colorBlueMatch[1]}</span>);
          remaining = remaining.substring(colorBlueMatch[0].length);
        } else if (colorGreenMatch) {
          parts.push(<span key={key++} style={{ color: '#047857', fontWeight: 600 }}>{colorGreenMatch[1]}</span>);
          remaining = remaining.substring(colorGreenMatch[0].length);
        } else if (colorOrangeMatch) {
          parts.push(<span key={key++} style={{ color: '#c2410c', fontWeight: 600 }}>{colorOrangeMatch[1]}</span>);
          remaining = remaining.substring(colorOrangeMatch[0].length);
        } else if (boldMatch) {
          parts.push(<strong key={key++}>{boldMatch[1]}</strong>);
          remaining = remaining.substring(boldMatch[0].length);
        } else if (underlineMatch) {
          parts.push(<u key={key++}>{underlineMatch[1]}</u>);
          remaining = remaining.substring(underlineMatch[0].length);
        } else if (strikeMatch) {
          parts.push(<s key={key++}>{strikeMatch[1]}</s>);
          remaining = remaining.substring(strikeMatch[0].length);
        } else if (italicMatch && !remaining.startsWith('**')) {
          parts.push(<em key={key++}>{italicMatch[1]}</em>);
          remaining = remaining.substring(italicMatch[0].length);
        } else {
          parts.push(remaining[0]);
          remaining = remaining.substring(1);
        }
      }

      return parts.length > 0 ? <>{parts}</> : text;
    }

    function getPharmaQuizzMed(dci, nomCommercial) {
      if (!dci && !nomCommercial) return null;
      try {
        const flashcards = JSON.parse(localStorage.getItem('pharmaspace_medications') || '[]');
        
        // Essai 1: Correspondance exacte DCI
        if (dci) {
          let med = flashcards.find(f => f.dci.toLowerCase() === dci.toLowerCase());
          if (med) return med;
          
          // Essai 2: DCI contient (pour g√©rer les associations)
          med = flashcards.find(f => {
            const dciNorm = dci.toLowerCase().trim();
            const fDciNorm = f.dci.toLowerCase().trim();
            return dciNorm.includes(fDciNorm) || fDciNorm.includes(dciNorm);
          });
          if (med) return med;
        }
        
        // Essai 3: Correspondance nom commercial
        if (nomCommercial) {
          const nomNorm = nomCommercial.toLowerCase().trim();
          let med = flashcards.find(f => 
            f.commercial && f.commercial.some(c => c.toLowerCase() === nomNorm)
          );
          if (med) return med;
          
          // Essai 4: Nom commercial partiel
          med = flashcards.find(f => 
            f.commercial && f.commercial.some(c => {
              const cNorm = c.toLowerCase();
              return nomNorm.includes(cNorm) || cNorm.includes(nomNorm);
            })
          );
          if (med) return med;
        }
        
        return null;
      } catch (e) {
        console.error('Erreur getPharmaQuizzMed:', e);
        return null;
      }
    }

    function PlainteCard({ plainte, index, totalCount, categorie, categories, setSelectedPlainte, setEditingPlainte, setShowAddPlainte, deletePlainte, movePlainteUp, movePlainteDown, reorderPlaintes, changePlainteCategory, allPlaintesInCategory, isOnline = true }) {
      const [isHovered, setIsHovered] = React.useState(false);
      const [isDragging, setIsDragging] = React.useState(false);
      const [isDragOver, setIsDragOver] = React.useState(false);
      const nbSpecialites = plainte.specialites?.length || 0;
      const nbDocuments = plainte.documents?.length || 0;
      const nbFichesConseils = plainte.fichesConseils?.length || 0;
      const hasInfo = nbSpecialites > 0 || nbDocuments > 0 || nbFichesConseils > 0;
      
      // Couleur par cat√©gorie depuis le state
      const getCategoryColor = (categorieName) => {
        if (!categories || categories.length === 0) {
          const defaultColors = {
            "Syst√®me respiratoire": "#3B82F6",
            "Douleurs & Fi√®vre": "#EF4444",
            "Syst√®me digestif": "#10B981",
            "Bouche & Peau": "#3B82F6"
          };
          return defaultColors[categorieName] || "#64748B";
        }
        const cat = categories.find(c => (typeof c === 'string' ? c : c.nom) === categorieName);
        if (cat && typeof cat === 'object' && cat.couleur) {
          return cat.couleur;
        }
        const defaultColors = {
          "Syst√®me respiratoire": "#3B82F6",
          "Douleurs & Fi√®vre": "#EF4444",
          "Syst√®me digestif": "#10B981",
          "Bouche & Peau": "#3B82F6"
        };
        return defaultColors[categorieName] || "#64748B";
      };
      
      const handleDragStart = (e) => {
        e.stopPropagation();
        setIsDragging(true);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('plainteId', plainte.id);
        e.dataTransfer.setData('categorie', categorie);
      };
      
      const handleDragOver = (e) => {
        e.preventDefault();
        e.stopPropagation();
        const draggedId = e.dataTransfer.getData('plainteId');
        // Accepter le drop de n'importe quelle cat√©gorie
        if (draggedId && draggedId !== plainte.id) {
          setIsDragOver(true);
        }
      };
      
      const handleDragLeave = (e) => {
        e.stopPropagation();
        setIsDragOver(false);
      };
      
      const handleDrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        const draggedId = e.dataTransfer.getData('plainteId');
        const draggedCategorie = e.dataTransfer.getData('categorie');
        
        if (draggedId && draggedId !== plainte.id) {
          if (draggedCategorie === categorie) {
            // M√™me cat√©gorie : r√©organiser l'ordre
            reorderPlaintes(draggedId, plainte.id, categorie);
          } else {
            // Cat√©gorie diff√©rente : changer la cat√©gorie
            changePlainteCategory(draggedId, categorie);
          }
        }
        setIsDragOver(false);
      };
      
      const handleDragEnd = (e) => {
        e.stopPropagation();
        setIsDragging(false);
        setIsDragOver(false);
      };
      
      return (
        <div
          draggable
          onDragStart={handleDragStart}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
          onDrop={handleDrop}
          onDragEnd={handleDragEnd}
          style={{
            background: 'var(--color-surface)',
            border: isDragOver ? '2px dashed var(--color-text-primary)' : '1px solid var(--color-border)',
            borderLeft: `3px solid ${getCategoryColor(plainte.categorie)}`,
            borderRadius: '8px',
            padding: 'var(--spacing-lg)',
            transition: 'all 0.2s',
            cursor: isDragging ? 'grabbing' : 'grab',
            position: 'relative',
            minHeight: '80px',
            display: 'flex',
            flexDirection: 'column',
            justifyContent: 'center',
            opacity: isDragging ? 0.5 : 1,
            transform: isDragOver ? 'scale(1.02)' : 'scale(1)'
          }}
          onClick={() => !isDragging && setSelectedPlainte(plainte)}
        >
          {/* Image + Titre */}
          <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: hasInfo ? '0.5rem' : 0 }}>
            {plainte.imageUrl && (
              <img 
                src={plainte.imageUrl} 
                alt={plainte.nom}
                style={{
                  width: '60px',
                  height: '60px',
                  borderRadius: '8px',
                  objectFit: 'cover',
                  flexShrink: 0
                }}
                onError={(e) => e.target.style.display = 'none'}
              />
            )}
            <h3 style={{
              margin: 0,
              fontSize: '16px',
              fontWeight: 600,
              color: 'var(--color-text-primary)',
              paddingRight: '2.5rem',
              lineHeight: '1.4',
              flex: 1
            }}>
              {plainte.nom}
            </h3>
          </div>
          
          {/* Infos sp√©cialit√©s et documents */}
          {hasInfo && (
            <div style={{
              display: 'flex',
              gap: '0.5rem',
              fontSize: 'var(--font-tiny)',
              color: 'var(--color-text-muted)',
              fontWeight: 400,
              opacity: 0.85,
              alignItems: 'center'
            }}>
              {/* √âtoile jaune p√¢le discr√®te */}
              {plainte.starEnabled && (
                <span 
                  style={{ 
                    fontSize: '0.7rem',
                    opacity: 0.4
                  }}
                  title="Plainte marqu√©e"
                >
                  ‚≠ê
                </span>
              )}
              
              {nbSpecialites > 0 && (
                <span>{nbSpecialites} sp√©c{nbSpecialites > 1 ? 's' : ''}</span>
              )}
              {nbSpecialites > 0 && (nbDocuments > 0 || nbFichesConseils > 0) && (
                <span>‚Ä¢</span>
              )}
              {nbDocuments > 0 && (
                <span>{nbDocuments} doc{nbDocuments > 1 ? 's' : ''}</span>
              )}
              {nbDocuments > 0 && nbFichesConseils > 0 && (
                <span>‚Ä¢</span>
              )}
              {nbFichesConseils > 0 && (
                <span>{nbFichesConseils} fiche{nbFichesConseils > 1 ? 's' : ''}</span>
              )}
            </div>
          )}
          
          {/* Si seulement l'√©toile sans autre info */}
          {!hasInfo && plainte.starEnabled && (
            <div style={{
              display: 'flex',
              fontSize: '0.7rem',
              opacity: 0.85
            }}>
              <span 
                style={{ 
                  fontSize: '0.7rem',
                  opacity: 0.4
                }}
                title="Plainte marqu√©e"
              >
                ‚≠ê
              </span>
            </div>
          )}
          
          {/* Boutons modifier/supprimer - apparaissent au survol du coin (uniquement si en ligne) */}
          {isOnline && (
              <div 
                onMouseEnter={() => setIsHovered(true)}
                onMouseLeave={() => setIsHovered(false)}
                style={{
                  position: 'absolute',
                  top: '0.5rem',
                  right: '0.5rem',
                  display: 'flex',
                  gap: '0.4rem',
                  opacity: isHovered ? 1 : 0,
                  transition: 'opacity 0.2s',
                  zIndex: 10
                }}
              >
            {/* Bouton Modifier */}
            <button
              onClick={(e) => {
                e.stopPropagation();
                setEditingPlainte(plainte);
                setShowAddPlainte(true);
              }}
              style={{
                background: 'var(--color-badge-bg)',
                border: '1px solid #93C5FD',
                borderRadius: '4px',
                width: '24px',
                height: '24px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer',
                color: '#1E40AF',
                padding: 0,
                transition: 'all 0.2s'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.background = '#BFDBFE';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = '#DBEAFE';
              }}
              title="Modifier"
            >
              ‚úé
            </button>
            
            {/* Bouton Supprimer */}
            <button
              onClick={(e) => {
                e.stopPropagation();
                if (confirm(`Supprimer "${plainte.nom}" ?`)) {
                  deletePlainte(plainte.id);
                }
              }}
              style={{
                background: '#FEE2E2',
                border: '1px solid #FCA5A5',
                borderRadius: '4px',
                width: '24px',
                height: '24px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer',
                color: '#DC2626',
                padding: 0,
                transition: 'all 0.2s',
                fontSize: '16px',
                fontWeight: 'bold'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.background = '#FECACA';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = '#FEE2E2';
              }}
              title="Supprimer"
            >
              √ó
            </button>
          </div>
          )}
        </div>
      );
    }

    function ConseilsOfficine({ onReturnToMenu, medications, isOnline = true, handleOfflineAction = (action) => action(), onOpenDataManagement, onResetView }) {
      const [categories, setCategories] = useState([]);
      const [plaintes, setPlaintes] = useState([]);
      const [plaintesRenderKey, setPlaintesRenderKey] = useState(0);
      const [selectedPlainteRaw, setSelectedPlainteRaw] = useState(null);
      
      // Fonction pour obtenir la couleur selon la cat√©gorie
      const getCategoryColor = (categorieName) => {
        if (!categories || categories.length === 0) {
          // Couleurs par d√©faut si categories n'est pas charg√©
          const defaultColors = {
            "Syst√®me respiratoire": "#3B82F6",
            "Douleurs & Fi√®vre": "#EF4444",
            "Syst√®me digestif": "#10B981",
            "Bouche & Peau": "#3B82F6"
          };
          return defaultColors[categorieName] || "#64748B";
        }
        
        const cat = categories.find(c => (typeof c === 'string' ? c : c.nom) === categorieName);
        if (cat && typeof cat === 'object' && cat.couleur) {
          return cat.couleur;
        }
        // Couleurs par d√©faut pour compatibilit√©
        const defaultColors = {
          "Syst√®me respiratoire": "#3B82F6",
          "Douleurs & Fi√®vre": "#EF4444",
          "Syst√®me digestif": "#10B981",
          "Bouche & Peau": "#3B82F6"
        };
        return defaultColors[categorieName] || "#64748B";
      };
      
      // Wrapper pour normaliser automatiquement
      const setSelectedPlainte = (plainte) => {
        if (plainte === null) {
          setSelectedPlainteRaw(null);
        } else {
          setSelectedPlainteRaw({
            ...plainte,
            specialites: Array.isArray(plainte.specialites) ? plainte.specialites : []
          });
        }
      };
      
      const selectedPlainte = selectedPlainteRaw;
      const [searchTerm, setSearchTerm] = useState('');
      const [showCategoriesModal, setShowCategoriesModal] = useState(false);
      const [showAddPlainte, setShowAddPlainte] = useState(false);
      const [showImportMedModal, setShowImportMedModal] = useState(false);
      const [importSearchTerm, setImportSearchTerm] = useState('');
      const [importCategory, setImportCategory] = useState('G√©n√©ral');
      const [editingPlainte, setEditingPlainte] = useState(null);
      const [showAddSpecialite, setShowAddSpecialite] = useState(false);
      const [editingSpecialite, setEditingSpecialite] = useState(null);
      const [imageModalUrl, setImageModalUrl] = useState(null);

      // DEBUG: V√©rifier selectedPlainte pour fiches probl√©matiques
      useEffect(() => {
        if (selectedPlainte && (selectedPlainte.nom === 'Antipalud√©ens' || selectedPlainte.nom === 'Antiparasiaires')) {
          console.group('üîç DEBUG Fiche: ' + selectedPlainte.nom);
          console.log('selectedPlainte:', selectedPlainte);
          console.log('specialites:', selectedPlainte.specialites);
          console.log('specialites type:', typeof selectedPlainte.specialites);
          console.log('specialites isArray:', Array.isArray(selectedPlainte.specialites));
          if (selectedPlainte.specialites) {
            selectedPlainte.specialites.forEach((spec, i) => {
              console.log('  Sp√©cialit√© ' + i + ':', spec);
              console.log('    - imageUrls:', spec.imageUrls, 'type:', typeof spec.imageUrls, 'isArray:', Array.isArray(spec.imageUrls));
              console.log('    - allImageUrls:', spec.allImageUrls, 'type:', typeof spec.allImageUrls, 'isArray:', Array.isArray(spec.allImageUrls));
            });
          }
          console.groupEnd();
        }
      }, [selectedPlainte]);

      // Fermer la plainte ouverte quand on clique sur "Fiches" dans le header
      useEffect(() => {
        if (onResetView && selectedPlainte) {
          const handleReset = () => {
            setSelectedPlainte(null);
          };
          // Exposer la fonction pour que le parent puisse l'appeler
          if (typeof onResetView === 'function') {
            onResetView(handleReset);
          }
        }
      }, [onResetView, selectedPlainte]);

      useEffect(() => {
        // Listener pour r√©organiser les cat√©gories depuis le modal
        const handleReorder = (e) => {
          saveCategories(e.detail);
        };
        window.addEventListener('reorderCategories', handleReorder);
        return () => window.removeEventListener('reorderCategories', handleReorder);
      }, []);

      useEffect(() => {
        const savedCat = localStorage.getItem('conseilsCategories');
        const savedPlaintes = localStorage.getItem('conseilsOfficine');
        
        if (savedCat) {
          setCategories(JSON.parse(savedCat));
        } else {
          setCategories(INITIAL_CATEGORIES);
          localStorage.setItem('conseilsCategories', JSON.stringify(INITIAL_CATEGORIES));
        }
        
        if (savedPlaintes) {
          const loadedPlaintes = JSON.parse(savedPlaintes);
          // Normaliser : s'assurer que chaque plainte a specialites
          const normalizedPlaintes = loadedPlaintes.map(p => ({
            ...p,
            specialites: Array.isArray(p.specialites) ? p.specialites : []
          }));
          setPlaintes(normalizedPlaintes);
          
          // V√©rifier si on doit ouvrir une plainte sp√©cifique (depuis accueil)
          const openPlainteId = localStorage.getItem('openPlainteId');
          if (openPlainteId) {
            const plainteToOpen = normalizedPlaintes.find(p => p.id === openPlainteId);
            if (plainteToOpen) {
              setSelectedPlainte(plainteToOpen);
            }
            localStorage.removeItem('openPlainteId'); // Nettoyer
          }
        } else {
          setPlaintes(INITIAL_PLAINTES);
          localStorage.setItem('conseilsOfficine', JSON.stringify(INITIAL_PLAINTES));
        }
        
        // √âcouter Firebase pour les mises √† jour en temps r√©el
        if (firebaseEnabled) {
          const catRef = db.ref('conseilsCategories');
          catRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              console.log('üî• Cat√©gories conseils mis √† jour depuis Firebase');
              setCategories(data);
              localStorage.setItem('conseilsCategories', JSON.stringify(data));
            }
          });
          
          const plaintesRef = db.ref('conseilsOfficine');
          plaintesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              console.log('üî• Plaintes conseils mis √† jour depuis Firebase (listener local)');
              setPlaintes(data);
              localStorage.setItem('conseilsOfficine', JSON.stringify(data));
              setPlaintesRenderKey(prev => prev + 1); // Forcer le re-render
              
              // D√©clencher l'√©v√©nement pour mettre √† jour le cache des flashcards
              window.dispatchEvent(new CustomEvent('plaintesUpdated'));
              console.log('üîÑ √âv√©nement plaintesUpdated dispatch√© (listener local)');
            }
          });
          
          return () => {
            catRef.off();
            plaintesRef.off();
          };
        }
      }, []);

      const saveCategories = (newCat) => {
        setCategories(newCat);
        localStorage.setItem('conseilsCategories', JSON.stringify(newCat));
        if (firebaseEnabled) {
          db.ref('conseilsCategories').set(newCat).catch(err => {
            console.error('‚ùå Erreur sauvegarde cat√©gories:', err);
          });
        }
      };

      const savePlaintes = (newPlaintes) => {
        // Normaliser : s'assurer que chaque plainte a un tableau specialites ET nettoyer les documents
        const normalizedPlaintes = newPlaintes.map(p => {
          // Nettoyer les documents : retirer ceux avec data undefined
          const cleanDocuments = (p.documents || []).filter(doc => {
            if (!doc.data && !doc.url) {
              console.warn('‚ö†Ô∏è Document sans data/url retir√©:', doc);
              return false;
            }
            return true;
          }).map(doc => ({
            ...doc,
            data: doc.data || doc.url || '' // S'assurer que data existe
          }));
          
          return {
            ...p,
            specialites: Array.isArray(p.specialites) ? p.specialites : [],
            documents: cleanDocuments
          };
        });
        
        setPlaintes(normalizedPlaintes);
        localStorage.setItem('conseilsOfficine', JSON.stringify(normalizedPlaintes));
        if (firebaseEnabled) {
          db.ref('conseilsOfficine').set(normalizedPlaintes).catch(err => {
            console.error('‚ùå Erreur sauvegarde plaintes:', err);
          });
        }
        setPlaintesRenderKey(prev => prev + 1); // Forcer le re-render
        // Dispatcher un √©v√©nement pour notifier le composant flashcard
        window.dispatchEvent(new CustomEvent('plaintesUpdated'));
        console.log('üîÑ Plaintes sauvegard√©es, √©v√©nement dispatch√©');
      };

      const addCategory = (categoryData) => {
        const name = typeof categoryData === 'string' ? categoryData : categoryData.nom;
        const couleur = typeof categoryData === 'string' ? '#64748B' : categoryData.couleur;
        
        if (!name.trim()) return;
        
        const catExists = categories.some(c => {
          const catName = typeof c === 'string' ? c : c.nom;
          return catName === name.trim();
        });
        
        if (catExists) {
          alert('Cette cat√©gorie existe d√©j√† !');
          return;
        }
        
        saveCategories([...categories, { nom: name.trim(), couleur }]);
      };

      const editCategory = (oldName, newData) => {
        console.log('editCategory appel√©e:', { oldName, newData });
        const newName = typeof newData === 'string' ? newData : newData.nom;
        const newColor = typeof newData === 'string' ? null : newData.couleur;
        console.log('Valeurs extraites:', { newName, newColor });
        
        if (!newName.trim()) {
          alert('Le nom de la cat√©gorie ne peut pas √™tre vide');
          return;
        }
        
        const catExists = categories.some(c => {
          const catName = typeof c === 'string' ? c : c.nom;
          return catName !== oldName && catName === newName.trim();
        });
        
        if (catExists) {
          alert('Cette cat√©gorie existe d√©j√† !');
          return;
        }
        
        // Mettre √† jour le nom de la cat√©gorie dans toutes les plaintes
        const updatedPlaintes = plaintes.map(plainte => 
          plainte.categorie === oldName ? { ...plainte, categorie: newName.trim() } : plainte
        );
        savePlaintes(updatedPlaintes);
        
        // Mettre √† jour la liste des cat√©gories avec la nouvelle couleur
        const updatedCategories = (categories || []).map(cat => {
          const catName = typeof cat === 'string' ? cat : cat.nom;
          if (catName === oldName) {
            return { nom: newName.trim(), couleur: newColor || (typeof cat === 'object' ? cat.couleur : '#64748B') };
          }
          return cat;
        });
        console.log('Cat√©gories mises √† jour:', updatedCategories);
        saveCategories(updatedCategories);
        
        // Mettre √† jour selectedPlainte si n√©cessaire
        if (selectedPlainte && selectedPlainte.categorie === oldName) {
          setSelectedPlainte({ ...selectedPlainte, categorie: newName.trim() });
        }
      };

      const deleteCategory = (catName) => {
        const plaintesInCategory = (plaintes || []).filter(p => p.categorie === catName);
        if (plaintesInCategory.length > 0) {
          if (!window.confirm(`La cat√©gorie "${catName}" contient ${plaintesInCategory.length} fiche(s).\n\nSupprimer quand m√™me ? (Les fiches seront d√©plac√©es vers la premi√®re cat√©gorie disponible)`)) {
            return;
          }
          // D√©placer les plaintes vers la premi√®re cat√©gorie disponible
          const newCategories = categories.filter(c => {
            const name = typeof c === 'string' ? c : c.nom;
            return name !== catName;
          });
          const firstCat = newCategories[0];
          const firstCategory = firstCat ? (typeof firstCat === 'string' ? firstCat : firstCat.nom) : 'G√©n√©ral';
          const updatedPlaintes = plaintes.map(plainte => 
            plainte.categorie === catName ? { ...plainte, categorie: firstCategory } : plainte
          );
          savePlaintes(updatedPlaintes);
          saveCategories(newCategories);
        } else {
          if (!window.confirm(`Supprimer la cat√©gorie "${catName}" ?`)) return;
          saveCategories(categories.filter(c => {
            const name = typeof c === 'string' ? c : c.nom;
            return name !== catName;
          }));
        }
      };

      const moveCategoryUp = (index) => {
        if (index === 0) return;
        const newCategories = [...categories];
        [newCategories[index - 1], newCategories[index]] = [newCategories[index], newCategories[index - 1]];
        saveCategories(newCategories);
      };

      const moveCategoryDown = (index) => {
        if (index === categories.length - 1) return;
        const newCategories = [...categories];
        [newCategories[index], newCategories[index + 1]] = [newCategories[index + 1], newCategories[index]];
        saveCategories(newCategories);
      };

      const savePlainteData = (plainteData) => {
        if (editingPlainte) {
          const newPlaintes = plaintes.map(p => 
            p.id === editingPlainte.id ? { ...plainteData, id: p.id } : p
          );
          savePlaintes(newPlaintes);
          if (selectedPlainte?.id === editingPlainte.id) {
            setSelectedPlainte({ ...plainteData, id: editingPlainte.id });
          }
        } else {
          const newPlainte = { ...plainteData, id: Date.now().toString() };
          savePlaintes([...plaintes, newPlainte]);
        }
        setShowAddPlainte(false);
        setEditingPlainte(null);
      };

      const deletePlainte = (id) => {
        if (!window.confirm('Supprimer cette plainte ?')) return;
        savePlaintes((plaintes || []).filter(p => p.id !== id));
        if (selectedPlainte?.id === id) {
          setSelectedPlainte(null);
        }
      };

      const movePlainteUp = (plainteId, categorie) => {
        const plaintesInCategory = (plaintes || []).filter(p => p.categorie === categorie);
        const currentIndex = plaintesInCategory.findIndex(p => p.id === plainteId);
        if (currentIndex <= 0) return; // D√©j√† en haut
        
        // √âchanger avec la plainte pr√©c√©dente
        const prevPlainte = plaintesInCategory[currentIndex - 1];
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) return { ...prevPlainte, id: p.id, nom: p.nom, emoji: p.emoji, couleur: p.couleur, description: p.description, specialites: p.specialites, informations: p.informations, documents: p.documents };
          if (p.id === prevPlainte.id) return { ...p, id: prevPlainte.id };
          return p;
        });
        
        // Solution plus simple : r√©organiser par index
        const allPlaintes = [...plaintes];
        const indexInAll = allPlaintes.findIndex(p => p.id === plainteId);
        const prevIndexInAll = allPlaintes.findIndex(p => p.id === prevPlainte.id);
        [allPlaintes[indexInAll], allPlaintes[prevIndexInAll]] = [allPlaintes[prevIndexInAll], allPlaintes[indexInAll]];
        savePlaintes(allPlaintes);
      };

      const reorderPlaintes = (draggedId, targetId, categorie) => {
        // R√©organiser les plaintes par drag and drop dans une cat√©gorie
        const plaintesInCategory = (plaintes || []).filter(p => p.categorie === categorie);
        const draggedIndex = plaintesInCategory.findIndex(p => p.id === draggedId);
        const targetIndex = plaintesInCategory.findIndex(p => p.id === targetId);
        
        if (draggedIndex === -1 || targetIndex === -1) return;
        
        // R√©organiser dans la cat√©gorie
        const reordered = [...plaintesInCategory];
        const [removed] = reordered.splice(draggedIndex, 1);
        reordered.splice(targetIndex, 0, removed);
        
        // Reconstruire la liste compl√®te en pr√©servant les autres cat√©gories
        const otherPlaintes = plaintes.filter(p => p.categorie !== categorie);
        const finalPlaintes = [];
        
        plaintes.forEach(p => {
          if (p.categorie === categorie) {
            if (finalPlaintes.filter(fp => fp.categorie === categorie).length === 0) {
              // Premi√®re plainte de cette cat√©gorie, ins√©rer toutes les plaintes r√©organis√©es
              finalPlaintes.push(...reordered);
            }
          } else {
            finalPlaintes.push(p);
          }
        });
        
        savePlaintes(finalPlaintes);
      };

      const movePlainteDown = (plainteId, categorie) => {
        const plaintesInCategory = (plaintes || []).filter(p => p.categorie === categorie);
        const currentIndex = plaintesInCategory.findIndex(p => p.id === plainteId);
        if (currentIndex >= plaintesInCategory.length - 1) return; // D√©j√† en bas
        
        const nextPlainte = plaintesInCategory[currentIndex + 1];
        const allPlaintes = [...plaintes];
        const indexInAll = allPlaintes.findIndex(p => p.id === plainteId);
        const nextIndexInAll = allPlaintes.findIndex(p => p.id === nextPlainte.id);
        [allPlaintes[indexInAll], allPlaintes[nextIndexInAll]] = [allPlaintes[nextIndexInAll], allPlaintes[indexInAll]];
        savePlaintes(allPlaintes);
      };

      const changePlainteCategory = (plainteId, newCategorie) => {
        const newPlaintes = plaintes.map(p => 
          p.id === plainteId ? { ...p, categorie: newCategorie } : p
        );
        savePlaintes(newPlaintes);
        if (selectedPlainte?.id === plainteId) {
          setSelectedPlainte({ ...selectedPlainte, categorie: newCategorie });
        }
      };

      const saveSpecialite = (plainteId, specialite) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            if (editingSpecialite) {
              return {
                ...p,
                specialites: p.specialites.map(s => 
                  s.id === editingSpecialite.id ? { ...specialite, id: s.id } : s
                )
              };
            } else {
              return {
                ...p,
                specialites: [...p.specialites, { ...specialite, id: Date.now().toString() }]
              };
            }
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
        setShowAddSpecialite(false);
        setEditingSpecialite(null);
      };

      const deleteSpecialite = (plainteId, specialiteId) => {
        if (!window.confirm('Supprimer cette sp√©cialit√© ?')) return;
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return { ...p, specialites: p.specialites.filter(s => s.id !== specialiteId) };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const moveSpecialiteUp = (plainteId, specialiteId) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            const specs = [...p.specialites];
            const index = specs.findIndex(s => s.id === specialiteId);
            if (index > 0) {
              [specs[index - 1], specs[index]] = [specs[index], specs[index - 1]];
            }
            return { ...p, specialites: specs };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const moveSpecialiteDown = (plainteId, specialiteId) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            const specs = [...p.specialites];
            const index = specs.findIndex(s => s.id === specialiteId);
            if (index < specs.length - 1) {
              [specs[index], specs[index + 1]] = [specs[index + 1], specs[index]];
            }
            return { ...p, specialites: specs };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const updatePlainteInfo = (plainteId, field, value) => {
        const newPlaintes = plaintes.map(p => 
          p.id === plainteId ? { ...p, [field]: value } : p
        );
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const addDocument = (plainteId, document) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return { ...p, documents: [...(p.documents || []), { ...document, id: Date.now().toString() }] };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const deleteDocument = (plainteId, docId) => {
        if (!window.confirm('Supprimer ce lien ?')) return;
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return { ...p, documents: (p.documents || []).filter(d => d.id !== docId) };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const editDocument = (plainteId, docId, newName, newUrl, newCategory) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return {
              ...p,
              documents: (p.documents || []).map(d => 
                d.id === docId ? { ...d, nom: newName, data: newUrl, category: newCategory || 'Important' } : d
              )
            };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const renameCategoryInDocuments = (plainteId, oldCategoryName, newCategoryName) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return {
              ...p,
              documents: (p.documents || []).map(d => 
                (d.category || 'Important') === oldCategoryName ? { ...d, category: newCategoryName } : d
              )
            };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const moveDocumentInPlainte = (plainteId, docId, direction, category) => {
        const plainte = plaintes.find(p => p.id === plainteId);
        if (!plainte) return;
        
        const docsInCategory = (plainte.documents || []).filter(doc => (doc.category || 'Important') === category);
        const currentIndex = docsInCategory.findIndex(doc => doc.id === docId);
        
        if (direction === 'up' && currentIndex <= 0) return;
        if (direction === 'down' && currentIndex >= docsInCategory.length - 1) return;
        
        const targetDoc = direction === 'up' ? docsInCategory[currentIndex - 1] : docsInCategory[currentIndex + 1];
        const allDocs = [...(plainte.documents || [])];
        const indexInAll = allDocs.findIndex(doc => doc.id === docId);
        const targetIndexInAll = allDocs.findIndex(doc => doc.id === targetDoc.id);
        
        [allDocs[indexInAll], allDocs[targetIndexInAll]] = [allDocs[targetIndexInAll], allDocs[indexInAll]];
        
        const newPlaintes = plaintes.map(p => 
          p.id === plainteId ? { ...p, documents: allDocs } : p
        );
        savePlaintes(newPlaintes);
        setSelectedPlainte(newPlaintes.find(p => p.id === plainteId));
      };

      const reorderDocuments = (plainteId, draggedId, targetId) => {
        const plainte = plaintes.find(p => p.id === plainteId);
        if (!plainte || !plainte.documents) return;
        
        // Les IDs de documents sont des STRINGS, donc on convertit en string
        const draggedIdStr = String(draggedId);
        const targetIdStr = String(targetId);
        
        const allDocs = [...plainte.documents];
        
        console.log('üìã AVANT r√©organisation:', allDocs.map(d => d.nom));
        
        const draggedIndex = allDocs.findIndex(d => String(d.id) === draggedIdStr);
        const targetIndex = allDocs.findIndex(d => String(d.id) === targetIdStr);
        
        console.log('üîÑ reorderDocuments:', { draggedId, targetId, draggedIdStr, targetIdStr, draggedIndex, targetIndex });
        console.log(`   D√©placer "${allDocs[draggedIndex]?.nom}" (index ${draggedIndex}) vers position de "${allDocs[targetIndex]?.nom}" (index ${targetIndex})`);
        
        if (draggedIndex === -1 || targetIndex === -1) {
          console.log('‚ùå Document non trouv√©');
          return;
        }
        
        // R√©organiser
        const [removed] = allDocs.splice(draggedIndex, 1);
        allDocs.splice(targetIndex, 0, removed);
        
        console.log('‚úÖ APR√àS r√©organisation:', allDocs.map(d => d.nom));
        
        const newPlaintes = plaintes.map(p => 
          p.id === plainteId ? { ...p, documents: allDocs } : p
        );
        savePlaintes(newPlaintes);
        setSelectedPlainte(newPlaintes.find(p => p.id === plainteId));
      };

      // GESTION DES FICHES CONSEILS
      const addFicheConseil = (plainteId, fiche) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            const fiches = p.fichesConseils || [];
            return { ...p, fichesConseils: [...fiches, { ...fiche, id: Date.now() }] };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        setSelectedPlainte(newPlaintes.find(p => p.id === plainteId));
      };

      const updateFicheConseil = (plainteId, ficheId, updatedFiche) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            const fiches = (p.fichesConseils || []).map(f => 
              f.id === ficheId ? { ...f, ...updatedFiche } : f
            );
            return { ...p, fichesConseils: fiches };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        setSelectedPlainte(newPlaintes.find(p => p.id === plainteId));
      };

      const deleteFicheConseil = (plainteId, ficheId) => {
        if (!window.confirm('Supprimer cette fiche conseils ?')) return;
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            const fiches = (p.fichesConseils || []).filter(f => f.id !== ficheId);
            return { ...p, fichesConseils: fiches };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        setSelectedPlainte(newPlaintes.find(p => p.id === plainteId));
      };

      const togglePinFiche = (plainteId, ficheId) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            const fiches = (p.fichesConseils || []).map(f => ({
              ...f,
              isPinned: f.id === ficheId ? !f.isPinned : false // D√©s√©pingler les autres
            }));
            return { ...p, fichesConseils: fiches };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        setSelectedPlainte(newPlaintes.find(p => p.id === plainteId));
      };

      const handleImageUpload = (e, callback) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = () => callback(reader.result);
        reader.readAsDataURL(file);
      };

      const handleImageURL = (callback) => {
        let url = prompt("Collez l'URL de l'image :");
        if (!url) return;
        
        if (url.includes('imgur.com/a/')) {
          alert("‚ùå C'est une URL d'ALBUM !\n\nüìù Pour obtenir l'URL correcte :\n1. Ouvrez votre album\n2. Cliquez sur l'image\n3. Clic droit ‚Üí 'Copier l'adresse de l'image'\n4. Vous obtiendrez : https://i.imgur.com/abc123.jpg");
          return;
        }
        
        if (url.includes('imgur.com') && !url.includes('i.imgur.com')) {
          const match = url.match(/imgur\.com\/(?:gallery\/)?([a-zA-Z0-9]+)/);
          if (match && match[1]) {
            const imageId = match[1];
            const ext = prompt("Extension de l'image ?\n(jpg, png, gif, webp)", "jpg");
            if (ext) {
              url = `https://i.imgur.com/${imageId}.${ext}`;
              alert(`‚úÖ URL corrig√©e automatiquement :\n${url}`);
            } else {
              return;
            }
          }
        }
        
        if (!url.startsWith('http')) {
          alert("‚ùå L'URL doit commencer par http:// ou https://");
          return;
        }
        
        callback(url);
      };

      const filteredPlaintes = (plaintes || []).filter(p => 
        p.nom.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (p.description && p.description.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (p.specialites && Array.isArray(p.specialites) && p.specialites.some(s => s.nomCommercial?.toLowerCase().includes(searchTerm.toLowerCase()) || s.dci?.toLowerCase().includes(searchTerm.toLowerCase()))) ||
        p.categorie.toLowerCase().includes(searchTerm.toLowerCase()) // Recherche par cat√©gorie
      );

      return (
        <>
          {showCategoriesModal && (
            <CategoriesModal 
              categories={categories}
              onClose={() => setShowCategoriesModal(false)}
              onAdd={addCategory}
              onEdit={editCategory}
              onDelete={deleteCategory}
              onMoveUp={moveCategoryUp}
              onMoveDown={moveCategoryDown}
            />
          )}
          
          {showAddPlainte && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              backdropFilter: 'blur(4px)',
              zIndex: 1000,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '1rem'
            }} onClick={() => { setShowAddPlainte(false); setEditingPlainte(null); }}>
              <div onClick={(e) => e.stopPropagation()} style={{ width: '100%', maxWidth: '600px', maxHeight: '90vh', overflowY: 'auto' }}>
                <FormPlainte
                  plainte={editingPlainte}
                  categories={categories}
                  onSave={savePlainteData}
                  onCancel={() => { setShowAddPlainte(false); setEditingPlainte(null); }}
                />
              </div>
            </div>
          )}
          
          {selectedPlainte ? (
            <DetailPlainte 
              plainte={{
                ...selectedPlainte,
                specialites: Array.isArray(selectedPlainte.specialites) ? selectedPlainte.specialites : []
              }}
              categories={categories}
              onBack={() => { setSelectedPlainte(null); setShowAddSpecialite(false); setEditingSpecialite(null); }}
              onEdit={() => { setEditingPlainte(selectedPlainte); setShowAddPlainte(true); }}
              onDelete={() => deletePlainte(selectedPlainte.id)}
              onAddSpecialite={() => { setShowAddSpecialite(true); setEditingSpecialite(null); }}
              onEditSpecialite={(spec) => { setEditingSpecialite(spec); setShowAddSpecialite(true); }}
              onDeleteSpecialite={(specId) => deleteSpecialite(selectedPlainte.id, specId)}
              onMoveSpecialiteUp={(specId) => moveSpecialiteUp(selectedPlainte.id, specId)}
              onMoveSpecialiteDown={(specId) => moveSpecialiteDown(selectedPlainte.id, specId)}
              showAddSpecialite={showAddSpecialite}
              editingSpecialite={editingSpecialite}
              onSaveSpecialite={(spec) => saveSpecialite(selectedPlainte.id, spec)}
              onCancelSpecialite={() => { setShowAddSpecialite(false); setEditingSpecialite(null); }}
              handleImageUpload={handleImageUpload}
              handleImageURL={handleImageURL}
              onUpdatePlainteInfo={(field, value) => updatePlainteInfo(selectedPlainte.id, field, value)}
              onAddDocument={(doc) => addDocument(selectedPlainte.id, doc)}
              onDeleteDocument={(docId) => deleteDocument(selectedPlainte.id, docId)}
              onEditDocument={(docId, newName, newUrl, newCategory) => editDocument(selectedPlainte.id, docId, newName, newUrl, newCategory)}
              onRenameCategoryInDocuments={(oldName, newName) => renameCategoryInDocuments(selectedPlainte.id, oldName, newName)}
              onMoveDocument={(docId, direction, category) => moveDocumentInPlainte(selectedPlainte.id, docId, direction, category)}
              onReorderDocuments={(draggedId, targetId) => reorderDocuments(selectedPlainte.id, draggedId, targetId)}
              onAddFicheConseil={(fiche) => addFicheConseil(selectedPlainte.id, fiche)}
              onUpdateFicheConseil={(ficheId, fiche) => updateFicheConseil(selectedPlainte.id, ficheId, fiche)}
              onDeleteFicheConseil={(ficheId) => deleteFicheConseil(selectedPlainte.id, ficheId)}
              onTogglePinFiche={(ficheId) => togglePinFiche(selectedPlainte.id, ficheId)}
              onShowImportModal={() => setShowImportMedModal(true)}
              medications={medications}
              setImageModalUrl={setImageModalUrl}
            />
          ) : (
            <div>
          <div style={{
            maxWidth: '1400px',
            margin: '0 auto',
            padding: '2rem 2rem 0 2rem'
          }}>
            {/* Header section */}
            <div style={{ 
              marginBottom: '2rem'
            }}>
              <h1 style={{ 
                fontSize: '2rem', 
                fontWeight: 700, 
                color: 'var(--color-text-primary)', 
                marginBottom: '0.5rem' 
              }}>
                Fiches plaintes
              </h1>
              <p style={{ 
                fontSize: '1rem', 
                color: 'var(--color-text-muted)',
                marginBottom: '0'
              }}>
                Vos protocoles et fiches plaintes pour l'officine
              </p>
            </div>
            
            <div style={{
              display: 'flex',
              justifyContent: 'flex-end',
              gap: 'var(--spacing-md)',
              marginBottom: 'var(--spacing-xl)'
            }}>
              <button
                onClick={() => handleOfflineAction(() => setShowCategoriesModal(true))}
                disabled={!isOnline}
                  style={{
                    background: isOnline ? 'var(--color-surface)' : 'var(--color-bg)',
                    border: `1px solid ${isOnline ? 'var(--color-border)' : 'var(--color-border)'}`,
                    color: isOnline ? 'var(--color-text-secondary)' : 'var(--color-text-muted)',
                    padding: '0.5rem 1rem',
                    borderRadius: '6px',
                    cursor: isOnline ? 'pointer' : 'not-allowed',
                    fontSize: '14px',
                    fontWeight: 500,
                    whiteSpace: 'nowrap',
                    opacity: isOnline ? 1 : 0.5,
                    fontFamily: 'inherit'
                  }}
                >
                  G√©rer cat√©gories
                </button>
                <button
                  onClick={() => handleOfflineAction(() => setShowAddPlainte(true))}
                  disabled={!isOnline}
                  style={{
                    background: isOnline ? 'var(--color-button-primary)' : 'var(--color-bg)',
                    border: 'none',
                    color: isOnline ? 'white' : 'var(--color-text-muted)',
                    padding: '0.5rem 1rem',
                    borderRadius: '6px',
                    cursor: isOnline ? 'pointer' : 'not-allowed',
                    fontSize: '14px',
                    fontWeight: 500,
                    whiteSpace: 'nowrap',
                    opacity: isOnline ? 1 : 0.5,
                    fontFamily: 'inherit'
                  }}
                >
                  + Nouvelle plainte
                </button>
              </div>
            </div>

          <div style={{
            maxWidth: '1400px',
            margin: '0 auto',
            padding: '0 2rem 2rem 2rem',
            minHeight: '400px'
          }}>
            <div style={{ marginBottom: 'var(--spacing-xl)' }}>
              <input
                type="text"
                placeholder="Rechercher une plainte..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                style={{
                  width: '100%',
                  padding: '0.75rem 1rem',
                  border: '1px solid var(--color-border)',
                  borderRadius: '6px',
                  fontSize: 'var(--font-body)',
                  outline: 'none',
                  fontFamily: 'inherit',
                  background: 'var(--color-surface)'
                }}
              />
            </div>

            {(categories || []).map(categorieObj => {
            const categorie = typeof categorieObj === 'string' ? categorieObj : categorieObj.nom;
            const plaintesCategorie = filteredPlaintes.filter(p => p.categorie === categorie);
            
            // Ne pas afficher les cat√©gories vides lors d'une recherche
            if (searchTerm && plaintesCategorie.length === 0) {
              return null;
            }

            return (
              <div key={categorie} style={{ marginBottom: 'var(--spacing-2xl)' }}>
                <h2 style={{
                  color: 'var(--color-text-primary)',
                  fontSize: '22px',
                  marginBottom: 'var(--spacing-lg)',
                  fontWeight: 600,
                  letterSpacing: '-0.01em'
                }}>
                  {categorie}
                </h2>
                
                {plaintesCategorie.length === 0 ? (
                  <div style={{
                    background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                    padding: '2rem',
                    borderRadius: '8px',
                    textAlign: 'center',
                    color: 'var(--color-text-muted)',
                    fontStyle: 'italic',
                    border: '1px dashed var(--color-border)'
                  }}>
                    Aucune plainte dans cette cat√©gorie
                  </div>
                ) : (
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                    gap: 'var(--spacing-lg)'
                  }}>
                    {plaintesCategorie.map((plainte, index) => (
                      <PlainteCard
                        key={plainte.id}
                        plainte={plainte}
                        index={index}
                        totalCount={plaintesCategorie.length}
                        categorie={categorie}
                        categories={categories}
                        setSelectedPlainte={setSelectedPlainte}
                        setEditingPlainte={setEditingPlainte}
                        setShowAddPlainte={setShowAddPlainte}
                        deletePlainte={deletePlainte}
                        movePlainteUp={movePlainteUp}
                        movePlainteDown={movePlainteDown}
                        reorderPlaintes={reorderPlaintes}
                        changePlainteCategory={changePlainteCategory}
                        allPlaintesInCategory={plaintesCategorie}
                        isOnline={isOnline}
                      />
                    ))}
                  </div>
                )}
              </div>
            );
            })}
          </div>
          </div>
          )}

          {/* MODAL ZOOM IMAGE */}
          {imageModalUrl && (
            <div 
              onClick={() => setImageModalUrl(null)} 
              style={{ 
                position: 'fixed', 
                top: 0, 
                left: 0, 
                right: 0, 
                bottom: 0, 
                background: 'rgba(0, 0, 0, 0.7)', 
                backdropFilter: 'blur(8px)',
                zIndex: 9999, 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center', 
                padding: '2rem',
                cursor: 'pointer'
              }}
            >
              <div 
                style={{ 
                  background: 'var(--color-surface)', 
                  borderRadius: '16px', 
                  padding: '1.5rem',
                  boxShadow: '0 25px 80px rgba(0, 0, 0, 0.3)',
                  maxWidth: '90%',
                  maxHeight: '90%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
                onClick={(e) => e.stopPropagation()}
              >
                <img 
                  src={imageModalUrl} 
                  alt="Image agrandie" 
                  style={{ 
                    maxWidth: '100%', 
                    maxHeight: '80vh', 
                    objectFit: 'contain', 
                    borderRadius: '8px'
                  }} 
                />
              </div>
            </div>
          )}
          
          {/* Modal Import Flashcards */}
          {showImportMedModal && selectedPlainte && (
<div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.75)',
            backdropFilter: 'blur(8px)',
            zIndex: 2000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '1rem'
          }} onClick={() => { setShowImportMedModal(false); setImportSearchTerm(''); }}>
            <div onClick={(e) => e.stopPropagation()} style={{
              background: 'var(--color-surface)',
              borderRadius: '8px',
              padding: 'var(--spacing-xl)',
              maxWidth: '600px',
              width: '100%',
              maxHeight: '80vh',
              overflowY: 'auto',
              border: '1px solid var(--color-border)'
            }}>
              <h3 style={{ margin: '0 0 var(--spacing-lg) 0', fontSize: '18px', fontWeight: 600, color: 'var(--color-text-primary)' }}>
                Ajouter une sp√©cialit√©
              </h3>
              
              {/* S√©lecteur de cat√©gorie */}
              <div style={{ marginBottom: 'var(--spacing-md)' }}>
                <label style={{ display: 'block', marginBottom: 'var(--spacing-xs)', fontSize: '14px', fontWeight: 500, color: 'var(--color-text-primary)' }}>
                  Cat√©gorie
                </label>
                <select
                  value={importCategory}
                  onChange={(e) => setImportCategory(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.5rem 0.75rem',
                    border: '1px solid var(--color-border)',
                    borderRadius: '4px',
                    fontSize: '14px',
                    fontFamily: 'inherit',
                    background: 'var(--color-surface)',
                    color: 'var(--color-text-primary)',
                    cursor: 'pointer'
                  }}
                >
                  {(() => {
                    // R√©cup√©rer les cat√©gories depuis specCategories ou localStorage
                    let cats = selectedPlainte?.specCategories;
                    if (!cats || cats.length === 0) {
                      const saved = localStorage.getItem('specCategories_' + selectedPlainte?.id);
                      cats = saved ? JSON.parse(saved) : ['G√©n√©ral'];
                    }
                    return cats.map(cat => (
                      <option key={cat} value={cat}>{cat}</option>
                    ));
                  })()}
                </select>
              </div>
              
              <input
                type="text"
                placeholder="Rechercher par nom, DCI ou classe..."
                value={importSearchTerm}
                onChange={(e) => setImportSearchTerm(e.target.value)}
                style={{
                  width: '100%',
                  padding: '0.5rem 0.75rem',
                  border: '1px solid var(--color-border)',
                  borderRadius: '4px',
                  fontSize: '14px',
                  fontFamily: 'inherit',
                  marginBottom: 'var(--spacing-md)'
                }}
              />
              
              <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                {(medications || []).filter(med => 
                  !importSearchTerm || 
                  med.commercial.some(c => c.toLowerCase().includes(importSearchTerm.toLowerCase())) ||
                  med.dci.toLowerCase().includes(importSearchTerm.toLowerCase()) ||
                  (med.category && med.category.toLowerCase().includes(importSearchTerm.toLowerCase()))
                ).map((med, index) => (
                  <div
                    key={`${med.dci}-${med.commercial[0]}-${med.category}-${index}`}
                    onClick={() => {
                      const newSpec = {
                        id: Date.now(),
                        dci: med.dci,
                        nomCommercial: med.commercial.join(', '),
                        formePharma: med.pharmaceuticalForm || '',
                        dosage: '',
                        contreIndications: '',
                        prix: '',
                        remboursement: '',
                        imageUrls: med.imageUrls || (med.imageUrl ? [med.imageUrl] : []),
                        category: importCategory
                      };
                      
                      const updatedPlainte = {
                        ...selectedPlainte,
                        specialites: [...selectedPlainte.specialites, newSpec]
                      };
                      
                      const updatedPlaintes = plaintes.map(p =>
                        p.id === selectedPlainte.id ? updatedPlainte : p
                      );
                      
                      savePlaintes(updatedPlaintes);
                      setSelectedPlainte(updatedPlainte);
                      setShowImportMedModal(false);
                      setImportSearchTerm('');
                      setImportCategory('G√©n√©ral');
                    }}
                    style={{
                      padding: '1rem',
                      border: '2px solid var(--color-border)',
                      borderRadius: '12px',
                      marginBottom: '0.5rem',
                      cursor: 'pointer',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.borderColor = '#3B82F6';
                      e.currentTarget.style.background = 'var(--color-bg)';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.borderColor = 'var(--color-border)';
                      e.currentTarget.style.background = 'var(--color-surface)';
                    }}
                  >
                    <div style={{ fontWeight: 700, color: 'var(--color-text-primary)', marginBottom: '0.25rem' }}>
                      {med.commercial.join(' ‚Ä¢ ')}
                    </div>
                    <div style={{ fontSize: '0.85rem', color: 'var(--color-text-muted)' }}>
                      {med.dci}
                    </div>
                    {med.category && (
                      <div style={{ 
                        fontSize: '0.75rem', 
                        color: '#3B82F6',
                        marginTop: '0.25rem',
                        fontWeight: 600
                      }}>
                        üè∑Ô∏è {med.category}
                      </div>
                    )}
                    {(med.imageUrls || (med.imageUrl ? [med.imageUrl] : [])).length > 0 && (
                      <div style={{ marginTop: '0.5rem', fontSize: '0.75rem', color: '#3B82F6' }}>
                        üì∑ {(med.imageUrls || [med.imageUrl]).filter(Boolean).length} image(s)
                      </div>
                    )}
                  </div>
                ))}
              </div>
              
              <button
                onClick={() => { setShowImportMedModal(false); setImportSearchTerm(''); }}
                style={{
                  width: '100%',
                  marginTop: '1rem',
                  padding: '0.75rem',
                  background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 600,
                  color: 'var(--color-text-muted)'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
          )}
          
        </>
      );
    }

    function CategoriesModal({ categories, onClose, onAdd, onDelete, onEdit, onMoveUp, onMoveDown }) {
      const [newCat, setNewCat] = useState('');
      const [newCatColor, setNewCatColor] = useState('#3B82F6');
      const [editingCat, setEditingCat] = useState(null);
      const [editValue, setEditValue] = useState('');
      const [editColor, setEditColor] = useState('#3B82F6');
      const [draggedIndex, setDraggedIndex] = useState(null);
      const [dragOverIndex, setDragOverIndex] = useState(null);
      
      const handleDragStart = (index) => {
        setDraggedIndex(index);
      };
      
      const handleDragOver = (e, index) => {
        e.preventDefault();
        if (draggedIndex !== index) {
          setDragOverIndex(index);
        }
      };
      
      const handleDrop = (e, index) => {
        e.preventDefault();
        if (draggedIndex !== null && draggedIndex !== index) {
          const newCategories = [...categories];
          const draggedItem = newCategories[draggedIndex];
          newCategories.splice(draggedIndex, 1);
          newCategories.splice(index, 0, draggedItem);
          
          // Sauvegarder le nouvel ordre via la fonction externe
          if (onMoveUp || onMoveDown) {
            // Utiliser saveCategories directement
            const event = new CustomEvent('reorderCategories', { detail: newCategories });
            window.dispatchEvent(event);
          }
        }
        setDraggedIndex(null);
        setDragOverIndex(null);
      };
      
      const handleDragEnd = () => {
        setDraggedIndex(null);
        setDragOverIndex(null);
      };
      
      return (
        <div 
          onClick={onClose}
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            backdropFilter: 'blur(4px)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '1rem',
            zIndex: 1000
          }}
        >
          <div 
            onClick={(e) => e.stopPropagation()}
            style={{
              background: 'var(--color-surface)',
              borderRadius: '12px',
              padding: '0',
              maxWidth: '500px',
              width: '100%',
              maxHeight: '80vh',
              overflow: 'hidden',
              display: 'flex',
              flexDirection: 'column',
              border: '1px solid var(--color-border)'
            }}
          >
            {/* Header */}
            <div style={{ 
              padding: '1.5rem 2rem',
              borderBottom: '1px solid var(--color-border)',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <h2 style={{ 
                fontSize: '18px', 
                fontWeight: 600, 
                color: 'var(--color-text-primary)',
                margin: 0
              }}>
                G√©rer les cat√©gories
              </h2>
              <button
                onClick={onClose}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '24px',
                  color: 'var(--color-text-muted)',
                  cursor: 'pointer',
                  padding: 0,
                  lineHeight: 1,
                  width: '24px',
                  height: '24px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
              >
                √ó
              </button>
            </div>

            {/* Content */}
            <div style={{ 
              padding: '2rem',
              overflowY: 'auto',
              flex: 1
            }}>
              {/* Formulaire ajout */}
              <div style={{ marginBottom: 'var(--spacing-xl)' }}>
                <label style={{ 
                  display: 'block', 
                  marginBottom: 'var(--spacing-sm)', 
                  fontWeight: 500,
                  fontSize: '14px',
                  color: 'var(--color-text-secondary)'
                }}>
                  Ajouter une cat√©gorie
                </label>
                <div style={{ display: 'flex', gap: 'var(--spacing-sm)', marginBottom: 'var(--spacing-sm)' }}>
                  <input
                    type="text"
                    value={newCat}
                    onChange={(e) => setNewCat(e.target.value)}
                    onKeyPress={(e) => {
                      if (e.key === 'Enter' && newCat.trim()) {
                        onAdd({ nom: newCat.trim(), couleur: newCatColor });
                        setNewCat('');
                        setNewCatColor('#3B82F6');
                      }
                    }}
                    placeholder="Nom de la cat√©gorie"
                    style={{
                      flex: 1,
                      padding: '0.75rem 1rem',
                      border: '1px solid var(--color-border)',
                      borderRadius: '6px',
                      fontSize: 'var(--font-body)',
                      fontFamily: 'inherit',
                      background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)'
                    }}
                  />
                  <input
                    type="color"
                    value={newCatColor}
                    onChange={(e) => setNewCatColor(e.target.value)}
                    style={{
                      width: '50px',
                      height: '44px',
                      border: '1px solid var(--color-border)',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)'
                    }}
                  />
                </div>
                <button
                  onClick={() => {
                    if (newCat.trim()) {
                      onAdd({ nom: newCat.trim(), couleur: newCatColor });
                      setNewCat('');
                      setNewCatColor('#3B82F6');
                    }
                  }}
                  style={{
                    background: 'var(--color-button-primary)',
                    color: 'white',
                    border: 'none',
                    padding: '0.75rem 1.5rem',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    fontWeight: 500,
                    fontSize: '14px',
                    fontFamily: 'inherit'
                  }}
                >
                  + Ajouter
                </button>
              </div>

              {/* Liste des cat√©gories */}
              <div style={{ marginBottom: 'var(--spacing-lg)' }}>
                <label style={{ 
                  display: 'block', 
                  fontSize: '14px', 
                  fontWeight: 500, 
                  color: 'var(--color-text-secondary)',
                  marginBottom: 'var(--spacing-md)'
                }}>
                  Cat√©gories existantes
                </label>
                {(categories || []).map((catObj, index) => {
                  const catName = typeof catObj === 'string' ? catObj : catObj.nom;
                  const catColor = typeof catObj === 'string' ? '#64748B' : (catObj.couleur || '#64748B');
                  const isDragging = draggedIndex === index;
                  const isDragOver = dragOverIndex === index;
                  
                  return (
                    <div 
                      key={catName}
                      draggable
                      onDragStart={() => handleDragStart(index)}
                      onDragOver={(e) => handleDragOver(e, index)}
                      onDrop={(e) => handleDrop(e, index)}
                      onDragEnd={handleDragEnd}
                      style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: 'var(--spacing-md)',
                        background: isDragging ? 'var(--color-border)' : (isDragOver ? 'var(--color-surface)' : 'var(--color-bg)'),
                        borderRadius: '8px',
                        marginBottom: 'var(--spacing-sm)',
                        border: isDragOver ? '2px dashed var(--color-text-primary)' : '1px solid var(--color-border)',
                        position: 'relative',
                        cursor: 'grab',
                        transition: 'all 0.2s',
                        opacity: isDragging ? 0.5 : 1
                      }}
                      onMouseEnter={(e) => {
                        if (!isDragging) {
                          e.currentTarget.style.background = 'var(--color-surface)';
                          const buttons = e.currentTarget.querySelectorAll('.action-button');
                          buttons.forEach(btn => btn.style.opacity = '1');
                        }
                      }}
                      onMouseLeave={(e) => {
                        if (!isDragging) {
                          e.currentTarget.style.background = isDragOver ? 'var(--color-surface)' : 'var(--color-bg)';
                          const buttons = e.currentTarget.querySelectorAll('.action-button');
                          buttons.forEach(btn => btn.style.opacity = '0');
                        }
                      }}
                    >
                      <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-md)', flex: 1 }}>
                        {/* Poign√©e de drag */}
                        <div style={{ 
                          color: 'var(--color-text-muted)',
                          fontSize: '18px',
                          cursor: 'grab',
                          lineHeight: 1
                        }}>
                          ‚ãÆ‚ãÆ
                        </div>
                        <div 
                          style={{ 
                            width: '20px', 
                            height: '20px', 
                            borderRadius: '4px', 
                            background: catColor,
                            border: '1px solid var(--color-border)',
                            flexShrink: 0
                          }} 
                        />
                        <span style={{ color: 'var(--color-text-primary)', fontWeight: 500, fontSize: '15px' }}>
                          {catName}
                        </span>
                      </div>
                      
                      {/* Boutons d'action invisibles */}
                      <div style={{ display: 'flex', gap: 'var(--spacing-xs)' }}>
                        {/* Bouton √©dition */}
                        <button
                          className="action-button"
                          onClick={(e) => {
                            e.stopPropagation();
                            setEditingCat(catName);
                            setEditValue(catName);
                            setEditColor(catColor);
                          }}
                          style={{
                            background: 'var(--color-surface)',
                            color: 'var(--color-text-secondary)',
                            border: '1px solid var(--color-border)',
                            padding: '0.4rem 0.75rem',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontSize: '13px',
                            fontFamily: 'inherit',
                            opacity: 0,
                            transition: 'opacity 0.2s'
                          }}
                        >
                          Modifier
                        </button>
                        
                        {/* Bouton suppression */}
                        <button
                          className="action-button"
                          onClick={(e) => {
                            e.stopPropagation();
                            onDelete && onDelete(catName);
                          }}
                          style={{
                            background: '#FEE2E2',
                            color: '#DC2626',
                            border: '1px solid #FCA5A5',
                            padding: '0.4rem 0.75rem',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontSize: '13px',
                            fontFamily: 'inherit',
                            opacity: 0,
                            transition: 'opacity 0.2s'
                          }}
                        >
                          Supprimer
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Modal d'√©dition */}
            {editingCat && (
              <div
                onClick={() => {
                  setEditingCat(null);
                  setEditValue('');
                  setEditColor('#3B82F6');
                }}
                style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'rgba(0,0,0,0.7)',
                  backdropFilter: 'blur(4px)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '1rem',
                  zIndex: 1100
                }}
              >
                <div
                  onClick={(e) => e.stopPropagation()}
                  style={{
                    background: 'var(--color-surface)',
                    borderRadius: '12px',
                    padding: '2rem',
                    maxWidth: '400px',
                    width: '100%',
                    border: '1px solid var(--color-border)'
                  }}
                >
                  <h3 style={{
                    fontSize: '18px',
                    fontWeight: 600,
                    color: 'var(--color-text-primary)',
                    marginBottom: 'var(--spacing-lg)'
                  }}>
                    Modifier la cat√©gorie
                  </h3>

                  <div style={{ marginBottom: 'var(--spacing-lg)' }}>
                    <label style={{
                      display: 'block',
                      marginBottom: 'var(--spacing-xs)',
                      fontWeight: 500,
                      fontSize: '14px',
                      color: 'var(--color-text-secondary)'
                    }}>
                      Nom
                    </label>
                    <input
                      type="text"
                      value={editValue}
                      onChange={(e) => setEditValue(e.target.value)}
                      style={{
                        width: '100%',
                        padding: '0.75rem 1rem',
                        border: '1px solid var(--color-border)',
                        borderRadius: '6px',
                        fontSize: 'var(--font-body)',
                        fontFamily: 'inherit',
                        background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)'
                      }}
                    />
                  </div>

                  <div style={{ marginBottom: 'var(--spacing-xl)' }}>
                    <label style={{
                      display: 'block',
                      marginBottom: 'var(--spacing-xs)',
                      fontWeight: 500,
                      fontSize: '14px',
                      color: 'var(--color-text-secondary)'
                    }}>
                      Couleur
                    </label>
                    <input
                      type="color"
                      value={editColor}
                      onChange={(e) => setEditColor(e.target.value)}
                      style={{
                        width: '100%',
                        height: '50px',
                        border: '1px solid var(--color-border)',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)'
                      }}
                    />
                  </div>

                  <div style={{ display: 'flex', gap: 'var(--spacing-sm)' }}>
                    <button
                      onClick={() => {
                        setEditingCat(null);
                        setEditValue('');
                        setEditColor('#3B82F6');
                      }}
                      style={{
                        flex: 1,
                        padding: '0.75rem 1rem',
                        background: 'var(--color-surface)',
                        color: 'var(--color-text-secondary)',
                        border: '1px solid var(--color-border)',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontWeight: 500,
                        fontSize: '14px',
                        fontFamily: 'inherit'
                      }}
                    >
                      Annuler
                    </button>
                    <button
                      onClick={() => {
                        if (editValue.trim()) {
                          onEdit(editingCat, { nom: editValue.trim(), couleur: editColor });
                          setEditingCat(null);
                          setEditValue('');
                          setEditColor('#3B82F6');
                        }
                      }}
                      style={{
                        flex: 1,
                        padding: '0.75rem 1rem',
                        background: 'var(--color-button-primary)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontWeight: 500,
                        fontSize: '14px',
                        fontFamily: 'inherit'
                      }}
                    >
                      Enregistrer
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    function FormPlainte({ plainte, categories, onSave, onCancel }) {
      const [formData, setFormData] = useState({
        nom: plainte?.nom || '',
        categorie: plainte?.categorie || (categories[0] && (typeof categories[0] === 'string' ? categories[0] : categories[0].nom)) || '',
        imageUrl: plainte?.imageUrl || '',
        specialites: plainte?.specialites || [],
        informations: plainte?.informations || '',
        documents: plainte?.documents || [],
        starEnabled: plainte?.starEnabled || false
      });

      return (
        <div 
          onClick={onCancel}
          style={{ 
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            backdropFilter: 'blur(4px)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '1rem',
            zIndex: 1000
          }}
        >
          <div 
            onClick={(e) => e.stopPropagation()}
            style={{
            background: 'var(--color-surface)',
            borderRadius: '12px',
            padding: '0',
            maxWidth: '600px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'hidden',
            display: 'flex',
            flexDirection: 'column',
            border: '1px solid var(--color-border)'
          }}>
            {/* Header */}
            <div style={{ 
              padding: '1.5rem 2rem',
              borderBottom: '1px solid var(--color-border)',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <h2 style={{ 
                fontSize: '18px', 
                fontWeight: 600, 
                color: 'var(--color-text-primary)',
                margin: 0
              }}>
                {plainte ? 'Modifier la plainte' : 'Nouvelle plainte'}
              </h2>
              <button
                onClick={onCancel}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '24px',
                  color: 'var(--color-text-muted)',
                  cursor: 'pointer',
                  padding: 0,
                  lineHeight: 1
                }}
              >
                √ó
              </button>
            </div>

            {/* Content */}
            <div style={{ 
              padding: '2rem',
              overflowY: 'auto',
              flex: 1
            }}>
              {/* Nom */}
              <div style={{ marginBottom: 'var(--spacing-lg)' }}>
                <label style={{ 
                  display: 'block', 
                  marginBottom: 'var(--spacing-xs)', 
                  fontWeight: 500,
                  fontSize: '14px',
                  color: 'var(--color-text-secondary)'
                }}>
                  Nom *
                </label>
                <input
                  type="text"
                  value={formData.nom}
                  onChange={(e) => setFormData({ ...formData, nom: e.target.value })}
                  placeholder="Ex: Maux de t√™te"
                  style={{
                    width: '100%',
                    padding: '0.75rem 1rem',
                    border: '1px solid var(--color-border)',
                    borderRadius: '6px',
                    fontSize: 'var(--font-body)',
                    fontFamily: 'inherit',
                    background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)'
                  }}
                />
              </div>

              {/* Cat√©gorie */}
              <div style={{ marginBottom: 'var(--spacing-lg)' }}>
                <label style={{ 
                  display: 'block', 
                  marginBottom: 'var(--spacing-xs)', 
                  fontWeight: 500,
                  fontSize: '14px',
                  color: 'var(--color-text-secondary)'
                }}>
                  Cat√©gorie *
                </label>
                <select
                  value={formData.categorie}
                  onChange={(e) => setFormData({ ...formData, categorie: e.target.value })}
                  style={{
                    width: '100%',
                    padding: '0.75rem 1rem',
                    border: '1px solid var(--color-border)',
                    borderRadius: '6px',
                    fontSize: 'var(--font-body)',
                    fontFamily: 'inherit',
                    background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                    cursor: 'pointer'
                  }}
                >
                  {(categories || []).map(cat => {
                    const catName = typeof cat === 'string' ? cat : cat.nom;
                    return <option key={catName} value={catName}>{catName}</option>;
                  })}
                </select>
              </div>

              {/* Image URL */}
              <div style={{ marginBottom: 'var(--spacing-lg)' }}>
                <label style={{ 
                  display: 'block', 
                  marginBottom: 'var(--spacing-xs)', 
                  fontWeight: 500,
                  fontSize: '14px',
                  color: 'var(--color-text-secondary)'
                }}>
                  Image (URL)
                </label>
                <input
                  type="text"
                  value={formData.imageUrl || ''}
                  onChange={(e) => setFormData({ ...formData, imageUrl: e.target.value })}
                  placeholder="https://exemple.com/image.jpg"
                  style={{
                    width: '100%',
                    padding: '0.75rem 1rem',
                    border: '1px solid var(--color-border)',
                    borderRadius: '6px',
                    fontSize: 'var(--font-body)',
                    fontFamily: 'inherit',
                    background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)'
                  }}
                />
                {formData.imageUrl && (
                  <div style={{ marginTop: 'var(--spacing-sm)' }}>
                    <img 
                      src={formData.imageUrl} 
                      alt="Aper√ßu" 
                      style={{ 
                        maxWidth: '80px', 
                        maxHeight: '80px', 
                        borderRadius: '6px',
                        border: '1px solid var(--color-border)'
                      }}
                      onError={(e) => e.target.style.display = 'none'}
                    />
                  </div>
                )}
              </div>

              {/* √âtoile (Affichage prioritaire) */}
              <div style={{ marginBottom: 'var(--spacing-lg)' }}>
                <label style={{ 
                  display: 'flex',
                  alignItems: 'center',
                  gap: 'var(--spacing-sm)',
                  cursor: 'pointer',
                  userSelect: 'none'
                }}>
                  <input
                    type="checkbox"
                    checked={formData.starEnabled || false}
                    onChange={(e) => setFormData({ ...formData, starEnabled: e.target.checked })}
                    style={{
                      width: '18px',
                      height: '18px',
                      cursor: 'pointer'
                    }}
                  />
                  <span style={{
                    fontWeight: 500,
                    fontSize: '14px',
                    color: 'var(--color-text-secondary)'
                  }}>
                    ‚≠ê Afficher l'√©toile (fiche prioritaire)
                  </span>
                </label>
                <div style={{ 
                  fontSize: '13px', 
                  color: 'var(--color-text-muted)', 
                  marginTop: 'var(--spacing-xs)',
                  marginLeft: '26px'
                }}>
                  L'√©toile indique que cette fiche n√©cessite une attention particuli√®re
                </div>
              </div>
            </div>

            {/* Footer */}
            <div style={{ 
              padding: '1.5rem 2rem',
              borderTop: '1px solid var(--color-border)',
              display: 'flex',
              gap: 'var(--spacing-sm)'
            }}>
              <button
                onClick={onCancel}
                style={{
                  flex: 1,
                  padding: '0.75rem 1rem',
                  background: 'var(--color-surface)',
                  color: 'var(--color-text-secondary)',
                  border: '1px solid var(--color-border)',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontWeight: 500,
                  fontSize: '14px',
                  fontFamily: 'inherit'
                }}
              >
                Annuler
              </button>
              <button
                onClick={() => {
                  if (!formData.nom.trim() || !formData.categorie) {
                    alert('Le nom et la cat√©gorie sont obligatoires');
                    return;
                  }
                  onSave(formData);
                }}
                style={{
                  flex: 1,
                  padding: '0.75rem 1rem',
                  background: 'var(--color-button-primary)',
                  color: 'white',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontWeight: 500,
                  fontSize: '14px',
                  fontFamily: 'inherit'
                }}
              >
                {plainte ? 'Enregistrer' : 'Cr√©er'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    function DetailPlainte({ 
      plainte, categories, onBack, onEdit, onDelete, onAddSpecialite, onEditSpecialite, onDeleteSpecialite, onMoveSpecialiteUp, onMoveSpecialiteDown,
      showAddSpecialite, editingSpecialite, onSaveSpecialite, onCancelSpecialite,
      handleImageUpload, handleImageURL, onUpdatePlainteInfo, onAddDocument, onDeleteDocument, onEditDocument, onRenameCategoryInDocuments, onMoveDocument, onReorderDocuments,
      onAddFicheConseil, onUpdateFicheConseil, onDeleteFicheConseil, onTogglePinFiche,
      onShowImportModal, medications, setImageModalUrl}) {
      
      // Couleur par cat√©gorie depuis le state
      const getCategoryColor = (categorieName) => {
        if (!categories || categories.length === 0) {
          const defaultColors = {
            "Syst√®me respiratoire": "#3B82F6",
            "Douleurs & Fi√®vre": "#EF4444",
            "Syst√®me digestif": "#10B981",
            "Bouche & Peau": "#3B82F6"
          };
          return defaultColors[categorieName] || "#64748B";
        }
        const cat = categories.find(c => (typeof c === 'string' ? c : c.nom) === categorieName);
        if (cat && typeof cat === 'object' && cat.couleur) {
          return cat.couleur;
        }
        const defaultColors = {
          "Syst√®me respiratoire": "#3B82F6",
          "Douleurs & Fi√®vre": "#EF4444",
          "Syst√®me digestif": "#10B981",
          "Bouche & Peau": "#3B82F6"
        };
        return defaultColors[categorieName] || "#64748B";
      };
      
      const categoryColor = getCategoryColor(plainte.categorie);
      
      const [activeTab, setActiveTab] = useState('info');
      const [isHeaderHovered, setIsHeaderHovered] = useState(false);
      const [showFichesModal, setShowFichesModal] = useState(false);
      const [showAddFiche, setShowAddFiche] = useState(false);
      const [showViewFiche, setShowViewFiche] = useState(false);
      const [editingFiche, setEditingFiche] = useState(null);
      const [viewingFiche, setViewingFiche] = useState(null);
      const [ficheForm, setFicheForm] = useState({ nom: '', urls: '' });

      // Fonction pour r√©organiser les sp√©cialit√©s par drag and drop
      const reorderSpecialites = (draggedId, targetId) => {
        if (!plainte || !plainte.specialites) {
          console.log('‚ùå reorderSpecialites: plainte ou specialites manquant', plainte);
          return;
        }
        
        // Convertir les IDs en nombres pour la comparaison
        const draggedIdNum = typeof draggedId === 'string' ? parseInt(draggedId) : draggedId;
        const targetIdNum = typeof targetId === 'string' ? parseInt(targetId) : targetId;
        
        const draggedIndex = plainte.specialites.findIndex(s => s.id === draggedIdNum);
        const targetIndex = plainte.specialites.findIndex(s => s.id === targetIdNum);
        
        console.log('üîÑ reorderSpecialites:', { draggedId, targetId, draggedIdNum, targetIdNum, draggedIndex, targetIndex });
        
        if (draggedIndex === -1 || targetIndex === -1) {
          console.log('‚ùå Index non trouv√©');
          return;
        }
        
        const reordered = [...plainte.specialites];
        const [removed] = reordered.splice(draggedIndex, 1);
        reordered.splice(targetIndex, 0, removed);
        
        console.log('‚úÖ Nouvel ordre:', reordered.map(s => s.nomCommercial || s.dci));
        
        // Mettre √† jour via le callback parent
        onUpdatePlainteInfo('specialites', reordered);
      };

      return (
        <div style={{ position: 'static' }}>
          {showAddSpecialite && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              backdropFilter: 'blur(4px)',
              zIndex: 1000,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '1rem'
            }} onClick={onCancelSpecialite}>
              <div onClick={(e) => e.stopPropagation()} style={{ width: '100%', maxWidth: '900px', maxHeight: '90vh', overflowY: 'auto' }}>
                <FormSpecialite
                  specialite={editingSpecialite}
                  categoryColor={categoryColor}
                  onSave={onSaveSpecialite}
                  onCancel={onCancelSpecialite}
                  handleImageUpload={handleImageUpload}
                  handleImageURL={handleImageURL}
                  plainte={plainte}
                  medications={medications || []}
                />
              </div>
            </div>
          )}

          {/* Modal Liste des fiches conseils */}
          {showFichesModal && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              zIndex: 2000,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '1rem'
            }} onClick={() => setShowFichesModal(false)}>
              <div onClick={(e) => e.stopPropagation()} style={{
                background: 'var(--color-surface)',
                borderRadius: '8px',
                padding: 'var(--spacing-xl)',
                maxWidth: '800px',
                width: '100%',
                maxHeight: '80vh',
                overflowY: 'auto',
                border: '1px solid var(--color-border)'
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 'var(--spacing-lg)' }}>
                  <h2 style={{ margin: 0, color: 'var(--color-text-primary)', fontSize: '18px', fontWeight: 600 }}>Fiches plaintes</h2>
                  <button onClick={() => setShowFichesModal(false)} style={{
                    background: 'none',
                    border: 'none',
                    fontSize: '24px',
                    cursor: 'pointer',
                    color: 'var(--color-text-muted)',
                    padding: 0,
                    width: '24px',
                    height: '24px'
                  }}>√ó</button>
                </div>

                {(!plainte.fichesConseils || plainte.fichesConseils.length === 0) ? (
                  <div style={{
                    padding: 'var(--spacing-xl)',
                    textAlign: 'center',
                    color: 'var(--color-text-muted)',
                    background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                    borderRadius: '6px',
                    border: '1px solid var(--color-border)',
                    marginBottom: 'var(--spacing-md)'
                  }}>
                    <p style={{ margin: 0, fontSize: '14px' }}>Aucune fiche conseils</p>
                    <p style={{ margin: 'var(--spacing-xs) 0 0 0', fontSize: '13px' }}>Ajoutez des photos de vos fiches</p>
                  </div>
                ) : (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--spacing-xs)', marginBottom: 'var(--spacing-md)' }}>
                    {plainte.fichesConseils.map(fiche => (
                      <div key={fiche.id} style={{
                        padding: 'var(--spacing-sm) var(--spacing-md)',
                        background: fiche.isPinned ? `${categoryColor}10` : 'var(--color-bg)',
                        borderRadius: '4px',
                        border: fiche.isPinned ? `1px solid ${categoryColor}` : '1px solid var(--color-border)',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                      }}>
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <div style={{ 
                            fontWeight: 500, 
                            fontSize: '14px',
                            color: 'var(--color-text-primary)', 
                            marginBottom: 'var(--spacing-xs)', 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: 'var(--spacing-xs)',
                            whiteSpace: 'nowrap',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis'
                          }}>
                            <span style={{ overflow: 'hidden', textOverflow: 'ellipsis' }}>{fiche.nom}</span>
                            {fiche.isPinned && (
                              <span style={{
                                background: categoryColor,
                                color: 'white',
                                fontSize: '11px',
                                padding: '0.15rem 0.4rem',
                                borderRadius: '4px',
                                fontWeight: 500,
                                flexShrink: 0
                              }}>
                                √âPINGL√âE
                              </span>
                            )}
                          </div>
                          <div style={{ fontSize: '0.85rem', color: 'var(--color-text-muted)' }}>
                            {fiche.urls.length} page{fiche.urls.length > 1 ? 's' : ''}
                          </div>
                        </div>
                        <div style={{ display: 'flex', gap: '0.5rem', flexShrink: 0 }}>
                          <button
                            onClick={() => onTogglePinFiche(fiche.id)}
                            style={{
                              padding: '0.5rem 1rem',
                              background: fiche.isPinned ? '#f1f5f9' : '#3b82f6',
                              color: fiche.isPinned ? '#64748b' : 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontWeight: 600,
                              fontSize: '0.85rem'
                            }}
                            title={fiche.isPinned ? 'D√©s√©pingler' : '√âpingler comme fiche par d√©faut'}
                          >
                            {fiche.isPinned ? 'D√©s√©pingler' : '√âpingler'}
                          </button>
                          <button
                            onClick={() => {
                              setViewingFiche(fiche);
                              setShowViewFiche(true);
                              setShowFichesModal(false);
                            }}
                            style={{
                              padding: '0.5rem 1rem',
                              background: '#667eea',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontWeight: 600,
                              fontSize: '0.85rem'
                            }}
                          >
                            Voir
                          </button>
                          <button
                            onClick={() => {
                              setEditingFiche(fiche);
                              setFicheForm({ nom: fiche.nom, urls: fiche.urls.join('\n') });
                              setShowAddFiche(true);
                              setShowFichesModal(false);
                            }}
                            style={{
                              padding: '0.5rem 1rem',
                              background: '#10b981',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontWeight: 600,
                              fontSize: '0.85rem'
                            }}
                          >
                            Modifier
                          </button>
                          <button
                            onClick={() => {
                              onDeleteFicheConseil(fiche.id);
                            }}
                            style={{
                              padding: '0.5rem 1rem',
                              background: '#ef4444',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontWeight: 600,
                              fontSize: '0.85rem'
                            }}
                          >
                            Supprimer
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                <button
                  onClick={() => {
                    setEditingFiche(null);
                    setFicheForm({ nom: '', urls: '' });
                    setShowAddFiche(true);
                    setShowFichesModal(false);
                  }}
                  style={{
                    width: '100%',
                    padding: '1rem',
                    background: categoryColor,
                    color: 'white',
                    border: 'none',
                    borderRadius: '12px',
                    cursor: 'pointer',
                    fontWeight: 600,
                    fontSize: '1rem'
                  }}
                >
                  + Ajouter une fiche
                </button>
              </div>
            </div>
          )}

          {/* Modal Ajouter/Modifier fiche */}
          {showAddFiche && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              zIndex: 2000,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '1rem'
            }} onClick={() => { setShowAddFiche(false); setEditingFiche(null); }}>
              <div onClick={(e) => e.stopPropagation()} style={{
                background: 'var(--color-surface)',
                borderRadius: '8px',
                padding: 'var(--spacing-xl)',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '80vh',
                overflowY: 'auto',
                border: '1px solid var(--color-border)'
              }}>
                <h2 style={{ marginBottom: 'var(--spacing-lg)', color: 'var(--color-text-primary)', fontSize: '18px', fontWeight: 600 }}>
                  {editingFiche ? 'Modifier la fiche' : 'Nouvelle fiche'}
                </h2>

                <div style={{ marginBottom: 'var(--spacing-md)' }}>
                  <label style={{ display: 'block', marginBottom: 'var(--spacing-xs)', fontWeight: 500, color: 'var(--color-text-primary)', fontSize: '14px' }}>
                    Nom de la fiche *
                  </label>
                  <input
                    type="text"
                    value={ficheForm.nom}
                    onChange={(e) => setFicheForm({ ...ficheForm, nom: e.target.value })}
                    placeholder="Ex: Protocole diab√®te"
                    style={{
                      width: '100%',
                      padding: '0.5rem 0.75rem',
                      border: '1px solid var(--color-border)',
                      borderRadius: '4px',
                      fontSize: '14px',
                      fontFamily: 'inherit'
                    }}
                  />
                </div>

                <div style={{ marginBottom: 'var(--spacing-md)' }}>
                  <label style={{ display: 'block', marginBottom: 'var(--spacing-xs)', fontWeight: 500, color: 'var(--color-text-primary)', fontSize: '14px' }}>
                    URLs des pages (une par ligne) *
                  </label>
                  <textarea
                    value={ficheForm.urls}
                    onChange={(e) => setFicheForm({ ...ficheForm, urls: e.target.value })}
                    placeholder={'https://i.imgur.com/page1.jpg\nhttps://i.imgur.com/page2.jpg\nhttps://i.imgur.com/page3.jpg'}
                    rows={8}
                    style={{
                      width: '100%',
                      padding: '0.5rem 0.75rem',
                      border: '1px solid var(--color-border)',
                      borderRadius: '4px',
                      fontSize: '14px',
                      fontFamily: 'monospace',
                      resize: 'vertical'
                    }}
                  />
                  <div style={{ fontSize: '13px', color: 'var(--color-text-muted)', marginTop: 'var(--spacing-xs)' }}>
                    Chaque ligne = une page de la fiche
                  </div>
                </div>

                <div style={{ display: 'flex', gap: 'var(--spacing-xs)' }}>
                  <button
                    onClick={() => { setShowAddFiche(false); setEditingFiche(null); }}
                    style={{
                      flex: 1,
                      padding: '0.5rem',
                      background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                      color: 'var(--color-text-secondary)',
                      border: '1px solid var(--color-border)',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontWeight: 500,
                      fontSize: '14px',
                      fontFamily: 'inherit'
                    }}
                  >
                    Annuler
                  </button>
                  <button
                    onClick={() => {
                      if (!ficheForm.nom.trim() || !ficheForm.urls.trim()) {
                        alert('Veuillez remplir tous les champs');
                        return;
                      }
                      const urls = ficheForm.urls.split('\n').map(u => u.trim()).filter(u => u);
                      if (urls.length === 0) {
                        alert('Ajoutez au moins une URL');
                        return;
                      }
                      const ficheData = {
                        nom: ficheForm.nom.trim(),
                        urls: urls
                      };
                      if (editingFiche) {
                        onUpdateFicheConseil(editingFiche.id, ficheData);
                      } else {
                        onAddFicheConseil(ficheData);
                      }
                      setShowAddFiche(false);
                      setEditingFiche(null);
                      setFicheForm({ nom: '', urls: '' });
                      setShowFichesModal(true);
                    }}
                    style={{
                      flex: 1,
                      padding: '0.5rem',
                      background: 'var(--color-button-primary)',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontWeight: 500,
                      fontSize: '14px',
                      fontFamily: 'inherit'
                    }}
                  >
                    {editingFiche ? 'Enregistrer' : 'Ajouter'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Modal Visualisation fiche (scroll vertical) */}
          {showViewFiche && viewingFiche && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.9)',
              zIndex: 2000,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '1rem'
            }} onClick={() => { setShowViewFiche(false); setViewingFiche(null); }}>
              <div onClick={(e) => e.stopPropagation()} style={{
                background: 'var(--color-surface)',
                borderRadius: '16px',
                width: '100%',
                maxWidth: '900px',
                maxHeight: '90vh',
                display: 'flex',
                flexDirection: 'column'
              }}>
                <div style={{
                  padding: '1rem 1.5rem',
                  borderBottom: '2px solid #e2e8f0',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  gap: '1rem'
                }}>
                  
                  <h3 style={{ margin: 0, color: 'var(--color-text-primary)', textAlign: 'center', flex: '1', minWidth: 0, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                    {viewingFiche.nom}
                  </h3>
                  
                  <div style={{ display: 'flex', gap: '0.5rem', flexShrink: 0, flexWrap: 'wrap', justifyContent: 'flex-end' }}>
                    {/* Boutons pour chaque fiche */}
                    {(plainte.fichesConseils || []).map((fiche, idx) => (
                      <button
                        key={fiche.id}
                        onClick={() => {
                          setViewingFiche(fiche);
                        }}
                        style={{
                          padding: '0.5rem 0.75rem',
                          background: fiche.id === viewingFiche.id ? categoryColor : '#f1f5f9',
                          color: fiche.id === viewingFiche.id ? 'white' : '#475569',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontWeight: 600,
                          fontSize: '0.85rem',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                          if (fiche.id !== viewingFiche.id) {
                            e.currentTarget.style.background = '#e2e8f0';
                          }
                        }}
                        onMouseLeave={(e) => {
                          if (fiche.id !== viewingFiche.id) {
                            e.currentTarget.style.background = '#f1f5f9';
                          }
                        }}
                        title={fiche.nom}
                      >
                        {idx + 1}
                      </button>
                    ))}
                    
                    {/* Bouton G√©rer */}
                    <button
                      onClick={() => {
                        setShowViewFiche(false);
                        setShowFichesModal(true);
                      }}
                      style={{
                        padding: '0.5rem 1rem',
                        background: 'var(--color-button-primary)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '4px',
                        cursor: 'pointer',
                        fontWeight: 500,
                        fontSize: '14px',
                        fontFamily: 'inherit'
                      }}
                    >
                      G√©rer
                    </button>
                  </div>
                </div>

                <div style={{
                  flex: 1,
                  overflowY: 'auto',
                  padding: '1.5rem',
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '1rem',
                  background: 'var(--color-surface)'
                }}>
                  {viewingFiche.urls.map((url, index) => (
                    <div key={index} style={{
                      background: 'var(--color-surface)',
                      borderRadius: '8px',
                      padding: '0.5rem',
                      boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                    }}>
                      <div style={{
                        fontSize: '0.85rem',
                        color: 'var(--color-text-muted)',
                        marginBottom: '0.5rem',
                        fontWeight: 600
                      }}>
                        Page {index + 1} / {viewingFiche.urls.length}
                      </div>
                      <img
                        src={url}
                        alt={`Page ${index + 1}`}
                        style={{
                          width: '100%',
                          height: 'auto',
                          borderRadius: '4px',
                          cursor: 'pointer'
                        }}
                        onClick={() => setImageModalUrl(url)}
                        onError={(e) => {
                          e.target.style.display = 'none';
                          e.target.parentElement.innerHTML += '<div style="padding: 2rem; text-align: center; color: #ef4444;">Erreur de chargement</div>';
                        }}
                      />
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
          
          <div 
            style={{
              background: 'var(--color-surface)',
              borderRadius: '6px',
              padding: 'var(--spacing-md) var(--spacing-lg)',
              marginBottom: 'var(--spacing-lg)',
              border: '1px solid var(--color-border)',
              borderLeft: `3px solid ${categoryColor}`,
              position: 'relative'
            }}
            onMouseEnter={() => setIsHeaderHovered(true)}
            onMouseLeave={() => setIsHeaderHovered(false)}
          >
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div style={{ flex: 1, display: 'flex', alignItems: 'center' }}>
                <h1 style={{ 
                  fontSize: '18px', 
                  fontWeight: 600, 
                  color: 'var(--color-text-primary)', 
                  margin: 0 
                }}>{plainte.nom}</h1>
              </div>

              <div style={{ display: 'flex', gap: 'var(--spacing-xs)' }}>
                <button
                  onClick={onEdit}
                  style={{
                    background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                    color: 'var(--color-text-secondary)',
                    border: '1px solid var(--color-border)',
                    padding: '0.4rem 0.75rem',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontWeight: 500,
                    fontSize: '13px',
                    fontFamily: 'inherit',
                    transition: 'all 0.2s',
                    opacity: isHeaderHovered ? 1 : 0
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.background = 'var(--color-surface)';
                    e.currentTarget.style.borderColor = categoryColor;
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.background = 'var(--color-bg)';
                    e.currentTarget.style.borderColor = 'var(--color-border)';
                  }}
                >
                  Modifier
                </button>
                <button
                  onClick={onDelete}
                  style={{
                    background: '#FEE2E2',
                    color: '#DC2626',
                    border: '1px solid #FCA5A5',
                    padding: '0.4rem 0.75rem',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontWeight: 500,
                    fontSize: '13px',
                    fontFamily: 'inherit',
                    transition: 'all 0.2s',
                    opacity: isHeaderHovered ? 1 : 0
                  }}
                  onMouseEnter={(e) => e.currentTarget.style.background = '#FEE2E2'}
                  onMouseLeave={(e) => e.currentTarget.style.background = '#FEE2E2'}
                >
                  Supprimer
                </button>
              </div>
            </div>
          </div>

          <div style={{
            display: 'flex',
            gap: 'var(--spacing-xs)',
            marginBottom: 'var(--spacing-lg)',
            alignItems: 'center'
          }}>
            {/* Tabs principaux */}
            <div style={{ display: 'flex', gap: 'var(--spacing-xs)', background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)', padding: '0.25rem', borderRadius: '6px', border: '1px solid var(--color-border)' }}>
              {['info', 'specialites', 'documents'].map(tab => (
                <button
                  key={tab}
                  onClick={() => setActiveTab(tab)}
                  style={{
                    background: activeTab === tab ? 'var(--color-surface)' : 'transparent',
                    color: activeTab === tab ? 'var(--color-text-primary)' : 'var(--color-text-secondary)',
                    border: activeTab === tab ? '1px solid var(--color-border)' : 'none',
                    padding: '0.5rem 1rem',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontWeight: 500,
                    fontSize: '14px',
                    fontFamily: 'inherit',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    if (activeTab !== tab) {
                      e.currentTarget.style.background = 'var(--color-surface)';
                      e.currentTarget.style.opacity = '0.7';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (activeTab !== tab) {
                      e.currentTarget.style.background = 'transparent';
                      e.currentTarget.style.opacity = '1';
                    }
                  }}
                >
                  {tab === 'info' && 'Informations'}
                  {tab === 'specialites' && (
                    <>
                      Sp√©cialit√©s <strong>{plainte.specialites ? plainte.specialites.length : 0}</strong>
                    </>
                  )}
                  {tab === 'documents' && (
                    <>
                      Documents <strong>{(plainte.documents || []).length}</strong>
                    </>
                  )}
                </button>
              ))}
            </div>
            
            {/* Bouton Fiches plaintes dans son propre rectangle */}
            <div style={{ display: 'flex', background: `${categoryColor}15`, padding: '0.25rem', borderRadius: '6px', border: `1px solid ${categoryColor}40` }}>
              <button
                onClick={() => {
                  const fiches = plainte.fichesConseils || [];
                  if (fiches.length > 0) {
                    const pinnedFiche = fiches.find(f => f.isPinned);
                    const ficheToOpen = pinnedFiche || fiches[0];
                    setViewingFiche(ficheToOpen);
                    setShowViewFiche(true);
                  } else {
                    setEditingFiche(null);
                    setFicheForm({ nom: '', urls: '' });
                    setShowAddFiche(true);
                  }
                }}
                style={{
                  background: 'var(--color-surface)',
                  color: categoryColor,
                  border: 'none',
                  padding: '0.5rem 1rem',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontWeight: 500,
                  fontSize: '14px',
                  fontFamily: 'inherit',
                  transition: 'all 0.2s',
                  opacity: 0.9
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.opacity = '1';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.opacity = '0.9';
                }}
              >
                Fiches plaintes{(plainte.fichesConseils && plainte.fichesConseils.length > 0) ? <> <strong>{plainte.fichesConseils.length}</strong></> : ''}
              </button>
            </div>
          </div>

          {activeTab === 'info' && (
            <InformationsTab
              plainte={plainte}
              onUpdateInfo={(val) => onUpdatePlainteInfo('informations', val)}
              handleImageURL={handleImageURL}
              couleur={categoryColor}
            />
          )}

          {activeTab === 'specialites' && (
            <SpecialitesTab
              plainte={plainte}
              categoryColor={categoryColor}
              onAddSpecialite={onAddSpecialite}
              onEditSpecialite={onEditSpecialite}
              onDeleteSpecialite={onDeleteSpecialite}
              onMoveSpecialiteUp={onMoveSpecialiteUp}
              onMoveSpecialiteDown={onMoveSpecialiteDown}
              reorderSpecialites={reorderSpecialites}
              onShowImportModal={onShowImportModal}
              setImageModalUrl={setImageModalUrl}
              onUpdatePlainteInfo={onUpdatePlainteInfo}
            />
          )}

          {activeTab === 'documents' && (
            <DocumentsTab
              plainte={plainte}
              categoryColor={categoryColor}
              onAddDocument={onAddDocument}
              onDeleteDocument={onDeleteDocument}
              onEditDocument={onEditDocument}
              onRenameCategoryInDocuments={onRenameCategoryInDocuments}
              onMoveDocument={onMoveDocument}
              onReorderDocuments={onReorderDocuments}
            />
          )}
        </div>
      );
    }

    function InformationsTab({ plainte, onUpdateInfo, handleImageURL, couleur }) {
      const [editing, setEditing] = useState(false);
      const [tempValue, setTempValue] = useState(plainte.informations || '');
      const [showHelp, setShowHelp] = useState(false);
      const [helpPinned, setHelpPinned] = useState(false);
      const editorRef = React.useRef(null);
      const blockInputUpdate = React.useRef(false); // Bloquer temporairement onInput
      const savedSelection = React.useRef(null); // Sauvegarder la position du curseur
      const editingImageContainer = React.useRef(null); // Container de l'image en cours d'√©dition
      const [showImageModal, setShowImageModal] = useState(false);
      const [imageUrls, setImageUrls] = useState('');
      const [imageSize, setImageSize] = useState('50');
      const [imageAlign, setImageAlign] = useState('left');

      // Fonction pour nettoyer le HTML des boutons d'√©dition avant affichage
      const cleanHTMLForDisplay = (html) => {
        if (!html) return '';
        // Cr√©er un √©l√©ment temporaire pour parser le HTML
        const temp = document.createElement('div');
        temp.innerHTML = html;
        
        // Supprimer tous les boutons d'√©dition d'images
        const imageBtns = temp.querySelectorAll('.image-btns');
        imageBtns.forEach(btn => btn.remove());
        
        return temp.innerHTML;
      };

      const attachImageButtonListeners = () => {
        if (!editorRef.current) return;
        
        console.log('üîó Attachement des listeners aux boutons d\'images');
        
        // Boutons Modifier
        const editBtns = editorRef.current.querySelectorAll('.img-btn.edit');
        console.log('‚úé Boutons Modifier trouv√©s:', editBtns.length);
        
        editBtns.forEach((btn, index) => {
          btn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('‚úé Clic sur modifier');
            
            const wrapper = btn.closest('.image-wrapper');
            const img = wrapper?.querySelector('img');
            
            if (wrapper && img) {
              // Sauvegarder le wrapper pour le remplacer plus tard
              editingImageContainer.current = wrapper;
              
              // Pr√©remplir le modal avec l'URL actuelle
              setImageUrls(img.src);
              
              // D√©tecter la taille approximative
              const wrapperStyle = wrapper.style.maxWidth;
              if (wrapperStyle && wrapperStyle.includes('%')) {
                setImageSize(wrapperStyle.replace('%', ''));
              } else {
                setImageSize('50');
              }
              
              setShowImageModal(true);
              console.log('‚úÖ Modal ouvert pour modification');
            }
          };
        });
        
        // Boutons Supprimer
        const deleteBtns = editorRef.current.querySelectorAll('.img-btn.delete');
        console.log('‚úï Boutons Supprimer trouv√©s:', deleteBtns.length);
        
        deleteBtns.forEach((btn, index) => {
          btn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('üóëÔ∏è Clic sur supprimer');
            
            if (confirm('Supprimer cette image ?')) {
              const wrapper = btn.closest('.image-wrapper');
              
              if (wrapper) {
                // Cr√©er un √©l√©ment de remplacement √©ditable
                const placeholder = document.createElement('div');
                placeholder.innerHTML = '<br>';
                
                // Remplacer le wrapper par le placeholder
                wrapper.replaceWith(placeholder);
                
                // Mettre √† jour tempValue
                blockInputUpdate.current = true;
                setTempValue(editorRef.current.innerHTML);
                setTimeout(() => {
                  blockInputUpdate.current = false;
                }, 100);
                
                console.log('‚úÖ Image supprim√©e');
              }
            }
          };
        });
      };

      useEffect(() => {
        // Initialiser seulement au passage en mode √©dition, pas √† chaque changement
        if (editing && editorRef.current) {
          editorRef.current.innerHTML = tempValue || plainte.informations || '';
          // Attacher les listeners apr√®s l'initialisation
          setTimeout(() => attachImageButtonListeners(), 100);
        }
      }, [editing]); // Seulement quand editing change, pas plainte.informations

      useEffect(() => {
        // Attacher les listeners chaque fois que tempValue change (nouvelle image ajout√©e)
        if (editing && editorRef.current) {
          setTimeout(() => attachImageButtonListeners(), 100);
        }
      }, [tempValue, editing]);

      useEffect(() => {
        // Mettre √† jour tempValue quand plainte.informations change ET qu'on n'est PAS en √©dition
        if (!editing) {
          setTempValue(plainte.informations || '');
        }
      }, [plainte.informations, editing]);

      if (editing) {
        return (
          <>
            <style>{`
              [contenteditable="true"]:empty:before {
                content: attr(placeholder);
                color: #9ca3af;
                pointer-events: none;
              }
              [contenteditable="true"]:focus {
                outline: none;
              }
              
              /* Container pour les images */
              [contenteditable="true"] .image-wrapper {
                position: relative;
                display: inline-block;
                margin: 1rem 0;
                vertical-align: top;
              }
              
              /* Boutons cach√©s par d√©faut */
              [contenteditable="true"] .image-btns {
                position: absolute;
                top: 8px;
                right: 8px;
                display: none;
                gap: 4px;
                z-index: 10;
              }
              
              /* Afficher les boutons au survol */
              [contenteditable="true"] .image-wrapper:hover .image-btns {
                display: flex !important;
              }
              
              /* Style des boutons */
              [contenteditable="true"] .img-btn {
                color: white;
                border: none;
                width: 32px;
                height: 32px;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                font-weight: bold;
                transition: all 0.2s;
                line-height: 1;
              }
              
              [contenteditable="true"] .img-btn.edit {
                background: rgba(248, 250, 252, 0.95);
                color: #1E293B;
              }
              
              [contenteditable="true"] .img-btn.edit:hover {
                background: rgba(255, 255, 255, 1);
                transform: scale(1.1);
              }
              
              [contenteditable="true"] .img-btn.delete {
                background: rgba(239, 68, 68, 0.9);
              }
              
              [contenteditable="true"] .img-btn.delete:hover {
                background: rgba(220, 38, 38, 1);
                transform: scale(1.1);
              }
            `}</style>
            <div style={{ background: 'var(--color-surface)', borderRadius: '20px', padding: '2rem', paddingBottom: '4rem', boxShadow: '0 4px 20px rgba(0,0,0,0.1)' }}>
            {/* BARRE D'OUTILS DE FORMATAGE */}
            <div style={{
              display: 'flex',
              flexWrap: 'wrap',
              gap: '0.5rem',
              marginBottom: '1rem',
              padding: '1rem',
              background: 'var(--color-surface)',
              borderRadius: '12px',
              border: '2px solid var(--color-border)'
            }}>
              <button
                onClick={() => {
                  document.execCommand('bold', false, null);
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: 'var(--color-surface)',
                  border: '2px solid var(--color-border)',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 'bold',
                  fontSize: '0.9rem',
                  color: 'var(--color-text-primary)'
                }}
                title="Gras"
              >
                <strong>B</strong>
              </button>

              <button
                onClick={() => {
                  document.execCommand('italic', false, null);
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: 'var(--color-surface)',
                  border: '2px solid var(--color-border)',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontStyle: 'italic',
                  fontSize: '0.9rem',
                  color: 'var(--color-text-primary)'
                }}
                title="Italique"
              >
                <em>I</em>
              </button>

              <button
                onClick={() => {
                  document.execCommand('underline', false, null);
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: 'var(--color-surface)',
                  border: '2px solid var(--color-border)',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  textDecoration: 'underline',
                  fontSize: '0.9rem',
                  color: 'var(--color-text-primary)'
                }}
                title="Soulign√©"
              >
                <u>U</u>
              </button>

              <button
                onClick={() => {
                  document.execCommand('strikeThrough', false, null);
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: 'var(--color-surface)',
                  border: '2px solid var(--color-border)',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  textDecoration: 'line-through',
                  fontSize: '0.9rem',
                  color: 'var(--color-text-primary)'
                }}
                title="Barr√©"
              >
                <s>S</s>
              </button>

              <div style={{ width: '2px', background: '#cbd5e1' }}></div>

              <button
                onClick={() => {
                  document.execCommand('foreColor', false, '#dc2626');
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: '#fecaca',
                  border: '2px solid #ef4444',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#dc2626',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Rouge"
              >
                üî¥
              </button>

              <button
                onClick={() => {
                  document.execCommand('foreColor', false, '#1d4ed8');
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: '#bfdbfe',
                  border: '2px solid #3b82f6',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#1d4ed8',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Bleu"
              >
                üîµ
              </button>

              <button
                onClick={() => {
                  document.execCommand('foreColor', false, '#047857');
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: '#bbf7d0',
                  border: '2px solid #10b981',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#047857',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Vert"
              >
                üü¢
              </button>

              <button
                onClick={() => {
                  document.execCommand('foreColor', false, '#c2410c');
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: '#fed7aa',
                  border: '2px solid #f97316',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#c2410c',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Orange"
              >
                üü†
              </button>

              <button
                onClick={() => {
                  // D√©tecter le th√®me actuel et appliquer la couleur correspondante
                  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                  const defaultColor = isDark ? '#F1F5F9' : '#0F172A';
                  
                  // Appliquer la couleur par d√©faut du th√®me
                  document.execCommand('foreColor', false, defaultColor);
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: 'var(--color-surface)',
                  border: '2px solid var(--color-border)',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: 'var(--color-text-primary)',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Couleur par d√©faut (noir en clair, blanc en sombre)"
              >
                ‚ö´‚ö™
              </button>

              <div style={{ width: '2px', background: '#cbd5e1' }}></div>

              <button
                onClick={() => {
                  document.execCommand('hiliteColor', false, '#fef08a');
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: '#fef08a',
                  border: '2px solid #fbbf24',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#854d0e',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Surligner jaune"
              >
                üñçÔ∏è
              </button>
            </div>

            <div
              ref={editorRef}
              contentEditable="true"
              onInput={(e) => {
                if (!blockInputUpdate.current) {
                  setTempValue(e.currentTarget.innerHTML);
                }
              }}
              placeholder="D√©marche √† suivre, questions √† poser, sch√©ma, notes de cours..."
              style={{
                width: '100%',
                minHeight: '300px',
                padding: '1rem',
                border: `2px solid ${couleur}`,
                borderRadius: '12px',
                fontSize: '1rem',
                fontFamily: 'inherit',
                marginBottom: '1rem',
                overflowY: 'auto',
                background: 'var(--color-surface)',
                color: 'var(--color-text-primary)'
              }}
            />

            <div style={{ display: 'flex', gap: '0.75rem', marginBottom: '1rem' }}>
              <button
                onClick={() => {
                  // Sauvegarder la position du curseur AVANT d'ouvrir le modal
                  const selection = window.getSelection();
                  if (selection.rangeCount > 0) {
                    savedSelection.current = selection.getRangeAt(0).cloneRange();
                    console.log('üíæ Position du curseur sauvegard√©e');
                  }
                  setShowImageModal(true);
                }}
                style={{
                  background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                  border: '1px solid var(--color-border)',
                  padding: '0.5rem 1rem',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontWeight: 500,
                  fontSize: '14px',
                  fontFamily: 'inherit',
                  color: 'var(--color-text-secondary)',
                  transition: 'all 0.2s'
                }}
              >
                Ajouter image(s)
              </button>
            </div>

            {/* Modal d'ajout d'images */}
            {showImageModal && (
              <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.6)',
                backdropFilter: 'blur(8px)',
                zIndex: 3000,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                padding: '1rem'
              }} onClick={() => setShowImageModal(false)}>
                <div onClick={(e) => e.stopPropagation()} style={{
                  background: 'var(--color-surface)',
                  borderRadius: '16px',
                  padding: '2rem',
                  maxWidth: '600px',
                  width: '100%',
                  boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
                }}>
                  <h3 style={{ margin: '0 0 1.5rem 0', color: 'var(--color-text-primary)' }}>Ajouter des images</h3>

                  <div style={{ marginBottom: '1.5rem' }}>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>
                      URLs des images (une par ligne)
                    </label>
                    <textarea
                      value={imageUrls}
                      onChange={(e) => setImageUrls(e.target.value)}
                      placeholder={'https://i.imgur.com/image1.jpg\nhttps://i.imgur.com/image2.jpg'}
                      rows={4}
                      style={{
                        width: '100%',
                        padding: '0.75rem',
                        border: '2px solid var(--color-border)',
                        borderRadius: '8px',
                        fontSize: '0.9rem',
                        fontFamily: 'monospace',
                        resize: 'vertical'
                      }}
                    />
                  </div>

                  <div style={{ marginBottom: '1.5rem' }}>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>
                      Taille : {imageSize}%
                    </label>
                    <input
                      type="range"
                      min="20"
                      max="100"
                      step="10"
                      value={imageSize}
                      onChange={(e) => setImageSize(e.target.value)}
                      style={{ width: '100%' }}
                    />
                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.8rem', color: 'var(--color-text-muted)', marginTop: '0.25rem' }}>
                      <span>Petite (20%)</span>
                      <span>Moyenne (50%)</span>
                      <span>Grande (100%)</span>
                    </div>
                  </div>

                  <div style={{ marginBottom: '1.5rem' }}>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>
                      Alignement
                    </label>
                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                      <button
                        onClick={() => setImageAlign('left')}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: imageAlign === 'left' ? couleur : '#f1f5f9',
                          color: imageAlign === 'left' ? 'white' : '#475569',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                      >
                        ‚Üê Gauche
                      </button>
                      <button
                        onClick={() => setImageAlign('center')}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: imageAlign === 'center' ? couleur : '#f1f5f9',
                          color: imageAlign === 'center' ? 'white' : '#475569',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                      >
                        ‚Üî Centre
                      </button>
                      <button
                        onClick={() => setImageAlign('row')}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: imageAlign === 'row' ? couleur : '#f1f5f9',
                          color: imageAlign === 'row' ? 'white' : '#475569',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                      >
                        ‚áÑ C√¥te √† c√¥te
                      </button>
                    </div>
                  </div>

                  <div style={{ display: 'flex', gap: '1rem' }}>
                    <button
                      onClick={() => {
                        setShowImageModal(false);
                        setImageUrls('');
                      }}
                      style={{
                        flex: 1,
                        padding: '0.75rem',
                        background: '#f1f5f9',
                        color: '#475569',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: 600
                      }}
                    >
                      Annuler
                    </button>
                    <button
                      onClick={() => {
                        console.log('üîç Clic sur Ins√©rer');
                        const urls = imageUrls.split('\n').map(u => u.trim()).filter(u => u);
                        console.log('üìã URLs:', urls);
                        
                        if (urls.length === 0) {
                          alert('Ajoutez au moins une URL');
                          return;
                        }

                        let htmlToInsert = '';
                        
                        if (imageAlign === 'row') {
                          // Images c√¥te √† c√¥te
                          htmlToInsert = '<div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0;">';
                          urls.forEach(url => {
                            const width = Math.floor(100 / urls.length) - 2;
                            htmlToInsert += `
                              <span class="image-wrapper" contenteditable="false" style="position: relative; flex: 1; min-width: ${width}%;">
                                <img src="${url}" style="width: 100%; height: auto; border-radius: 8px; object-fit: contain; display: block;" />
                                <span class="image-btns">
                                  <button class="img-btn edit" contenteditable="false" title="Modifier">‚úé</button>
                                  <button class="img-btn delete" contenteditable="false" title="Supprimer">‚úï</button>
                                </span>
                              </span>
                            `;
                          });
                          htmlToInsert += '</div>';
                        } else {
                          // Images align√©es gauche ou centre
                          urls.forEach(url => {
                            if (imageAlign === 'center') {
                              // Centre : utiliser margin auto
                              htmlToInsert += `
                                <div style="margin: 1rem 0; text-align: center;">
                                  <span class="image-wrapper" contenteditable="false" style="position: relative; display: inline-block; max-width: ${imageSize}%;">
                                    <img src="${url}" style="width: 100%; height: auto; border-radius: 8px; display: block;" />
                                    <span class="image-btns">
                                      <button class="img-btn edit" contenteditable="false" title="Modifier">‚úé</button>
                                      <button class="img-btn delete" contenteditable="false" title="Supprimer">‚úï</button>
                                    </span>
                                  </span>
                                </div>
                              `;
                            } else {
                              // Gauche : alignement normal
                              htmlToInsert += `
                                <span class="image-wrapper" contenteditable="false" style="position: relative; display: inline-block; max-width: ${imageSize}%;">
                                  <img src="${url}" style="width: 100%; height: auto; border-radius: 8px; display: block;" />
                                  <span class="image-btns">
                                    <button class="img-btn edit" contenteditable="false" title="Modifier">‚úé</button>
                                    <button class="img-btn delete" contenteditable="false" title="Supprimer">‚úï</button>
                                  </span>
                                </span>
                              `;
                            }
                          });
                        }

                        console.log('üñºÔ∏è HTML √† ins√©rer:', htmlToInsert);
                        
                        const editor = document.querySelector('[contenteditable="true"]');
                        console.log('üìù √âditeur trouv√©:', editor);
                        
                        if (editor) {
                          blockInputUpdate.current = true;
                          
                          // Si on modifie une image existante
                          if (editingImageContainer.current) {
                            console.log('üîÑ Mode modification d\'image');
                            // Remplacer le container existant
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = htmlToInsert;
                            const newContainer = tempDiv.firstElementChild;
                            
                            editingImageContainer.current.replaceWith(newContainer);
                            editingImageContainer.current = null;
                            
                            console.log('‚úÖ Image modifi√©e');
                          } else {
                            // Mode ajout normal
                            console.log('‚ûï Mode ajout d\'image');
                            
                            // Restaurer la position du curseur sauvegard√©e
                            if (savedSelection.current) {
                              const selection = window.getSelection();
                              selection.removeAllRanges();
                              selection.addRange(savedSelection.current);
                              console.log('üîÑ Position du curseur restaur√©e');
                            }
                            
                            // S'assurer que l'√©diteur a le focus
                            editor.focus();
                            
                            // Utiliser execCommand qui respecte la position du curseur
                            document.execCommand('insertHTML', false, htmlToInsert);
                            
                            console.log('‚úÖ Image ins√©r√©e avec execCommand');
                          }
                          
                          // Attendre que le DOM soit mis √† jour
                          setTimeout(() => {
                            console.log('üìÑ Contenu apr√®s insertion:', editor.innerHTML);
                            
                            // Mettre √† jour tempValue avec le nouveau contenu
                            setTempValue(editor.innerHTML);
                            
                            // R√©activer les updates onInput
                            setTimeout(() => {
                              blockInputUpdate.current = false;
                              console.log('üîì Updates r√©activ√©s');
                              
                              // R√©attacher les listeners sur les nouveaux boutons
                              attachImageButtonListeners();
                            }, 100);
                          }, 50);
                        } else {
                          console.error('‚ùå √âditeur non trouv√© !');
                        }
                        
                        setShowImageModal(false);
                        setImageUrls('');
                        setImageSize('50');
                        setImageAlign('left');
                      }}
                      style={{
                        flex: 1,
                        padding: '0.75rem',
                        background: couleur,
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: 600
                      }}
                    >
                      Ins√©rer
                    </button>
                  </div>
                </div>
              </div>
            )}

            <div style={{ display: 'flex', gap: 'var(--spacing-xs)' }}>
              <button
                onClick={() => {
                  onUpdateInfo(tempValue);
                  setEditing(false);
                }}
                style={{
                  background: 'var(--color-button-primary)',
                  color: 'white',
                  border: 'none',
                  padding: '0.5rem 1rem',
                  borderRadius: '4px',
                  fontWeight: 500,
                  fontSize: '14px',
                  fontFamily: 'inherit',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
              >
                Enregistrer
              </button>
              <button
                onClick={() => {
                  setTempValue(plainte.informations || '');
                  setEditing(false);
                }}
                style={{
                  background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                  color: 'var(--color-text-secondary)',
                  border: '1px solid var(--color-border)',
                  padding: '0.5rem 1rem',
                  borderRadius: '4px',
                  fontWeight: 500,
                  fontSize: '14px',
                  fontFamily: 'inherit',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
          </>
        );
      }

      return (
        <div style={{ background: 'var(--color-surface)', borderRadius: '6px', padding: 'var(--spacing-lg)', border: '1px solid var(--color-border)', position: 'relative' }}>
          <button
            onClick={() => setEditing(true)}
            style={{
              position: 'absolute',
              top: '0.5rem',
              right: '0.5rem',
              background: 'var(--color-button-primary)',
              border: 'none',
              borderRadius: '4px',
              width: '28px',
              height: '28px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              cursor: 'pointer',
              color: 'white',
              fontSize: '14px',
              transition: 'all 0.2s'
            }}
            title="Modifier"
          >
            ‚úé
          </button>

          {plainte.informations ? (
            <div 
              style={{ color: 'var(--color-text-primary)', fontSize: '1rem', lineHeight: '1.8', paddingRight: '3rem' }}
              dangerouslySetInnerHTML={{ __html: cleanHTMLForDisplay(plainte.informations) }}
            />
          ) : (
            <p style={{ color: '#94a3b8', fontStyle: 'italic' }}>Cliquez sur l'ic√¥ne pour ajouter du contenu</p>
          )}
        </div>
      );
    }

    function SpecialitesTab({ plainte, categoryColor, onAddSpecialite, onEditSpecialite, onDeleteSpecialite, onMoveSpecialiteUp, onMoveSpecialiteDown, reorderSpecialites, onShowImportModal, setImageModalUrl, onUpdatePlainteInfo }) {
      // Composant pour afficher une cat√©gorie avec drag & drop
      const SpecCategoryItem = ({ cat, index, specsCount, isEditing, onEdit, onDelete, onDragStart, onDrop }) => {
        const [isHovered, setIsHovered] = React.useState(false);
        
        return (
          <div 
            draggable
            onDragStart={onDragStart}
            onDragEnd={(e) => {
              e.currentTarget.style.opacity = '1';
            }}
            onDragOver={(e) => {
              e.preventDefault();
              e.dataTransfer.dropEffect = 'move';
              e.currentTarget.style.borderStyle = 'dashed';
            }}
            onDragLeave={(e) => {
              e.currentTarget.style.borderStyle = 'solid';
            }}
            onDrop={onDrop}
            onMouseEnter={() => setIsHovered(true)}
            onMouseLeave={() => setIsHovered(false)}
            style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              padding: 'var(--spacing-sm) var(--spacing-md)',
              background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
              border: '1px solid var(--color-border)',
              borderRadius: '4px',
              marginBottom: 'var(--spacing-xs)',
              cursor: 'grab',
              transition: 'all 0.2s',
              position: 'relative'
            }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-sm)' }}>
              <span style={{ color: 'var(--color-text-muted)', fontSize: '16px' }}>‚ãÆ‚ãÆ</span>
              <span style={{ fontWeight: 500, fontSize: '14px', color: 'var(--color-text-primary)' }}>
                {cat} <strong style={{ color: 'var(--color-text-secondary)' }}>{specsCount}</strong>
              </span>
            </div>
            <div style={{ display: 'flex', gap: 'var(--spacing-xs)', opacity: isHovered ? 1 : 0, transition: 'opacity 0.2s' }}>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onEdit();
                }}
                style={{
                  background: 'var(--color-badge-bg)',
                  color: '#1E40AF',
                  border: '1px solid #93C5FD',
                  padding: '0.25rem 0.5rem',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontSize: '12px'
                }}
                title="Modifier"
              >
                ‚úé
              </button>
              {cat !== 'G√©n√©ral' && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    onDelete();
                  }}
                  style={{
                    background: '#FEE2E2',
                    color: '#DC2626',
                    border: '1px solid #FCA5A5',
                    padding: '0.25rem 0.5rem',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontSize: '12px'
                  }}
                  title="Supprimer"
                >
                  √ó
                </button>
              )}
            </div>
          </div>
        );
      };

      const [showCategoryManager, setShowCategoryManager] = useState(false);
      const [specCategories, setSpecCategories] = useState(() => {
        // D'abord essayer de charger depuis l'objet plainte
        if (plainte.specCategories && plainte.specCategories.length > 0) {
          // Migration : remplacer "Important" par "G√©n√©ral"
          const cats = plainte.specCategories.map(c => c === 'Important' ? 'G√©n√©ral' : c);
          return cats.includes('G√©n√©ral') ? cats : ['G√©n√©ral', ...cats];
        }
        // Sinon essayer localStorage
        const saved = localStorage.getItem('specCategories_' + plainte.id);
        if (saved) {
          try {
            const cats = JSON.parse(saved);
            // Migration : remplacer "Important" par "G√©n√©ral"
            const migratedCats = cats.map(c => c === 'Important' ? 'G√©n√©ral' : c);
            return migratedCats.includes('G√©n√©ral') ? migratedCats : ['G√©n√©ral', ...migratedCats];
          } catch (e) {
            return ['G√©n√©ral'];
          }
        }
        return ['G√©n√©ral'];
      });
      const [newCategory, setNewCategory] = useState('');
      const [editingCategory, setEditingCategory] = useState(null);
      const [editCategoryName, setEditCategoryName] = useState('');

      // Sauvegarder les cat√©gories dans localStorage et l'objet plainte
      React.useEffect(() => {
        localStorage.setItem('specCategories_' + plainte.id, JSON.stringify(specCategories));
        
        // Mettre √† jour l'objet plainte si onUpdatePlainteInfo existe
        if (onUpdatePlainteInfo) {
          onUpdatePlainteInfo('specCategories', specCategories);
        }
      }, [specCategories, plainte.id]);

      // Migration automatique : convertir les sp√©cialit√©s avec category "Important" vers "G√©n√©ral"
      React.useEffect(() => {
        if (plainte.specialites && plainte.specialites.length > 0) {
          const needsMigration = plainte.specialites.some(s => s.category === 'Important');
          if (needsMigration && onUpdatePlainteInfo) {
            const migratedSpecs = plainte.specialites.map(s => 
              s.category === 'Important' ? { ...s, category: 'G√©n√©ral' } : s
            );
            onUpdatePlainteInfo('specialites', migratedSpecs);
          }
        }
      }, [plainte.id]); // Ex√©cuter seulement au montage


      const handleAddCategory = () => {
        if (!newCategory.trim()) {
          alert('Le nom de la cat√©gorie ne peut pas √™tre vide');
          return;
        }
        if (specCategories.includes(newCategory.trim())) {
          alert('Cette cat√©gorie existe d√©j√†');
          return;
        }
        setSpecCategories([...specCategories, newCategory.trim()]);
        setNewCategory('');
      };

      const handleDeleteCategory = (categoryToDelete) => {
        if (categoryToDelete === 'G√©n√©ral') {
          alert('Impossible de supprimer la cat√©gorie "G√©n√©ral"');
          return;
        }
        
        const specsInCategory = (plainte.specialites || []).filter(s => s.category === categoryToDelete);
        if (specsInCategory.length > 0) {
          if (!confirm(`Cette cat√©gorie contient ${specsInCategory.length} sp√©cialit√©(s). Les d√©placer vers "G√©n√©ral" ?`)) {
            return;
          }
          // D√©placer toutes les sp√©cialit√©s vers G√©n√©ral
          const updatedSpecs = (plainte.specialites || []).map(s => 
            s.category === categoryToDelete ? { ...s, category: 'G√©n√©ral' } : s
          );
          if (onUpdatePlainteInfo) {
            onUpdatePlainteInfo('specialites', updatedSpecs);
          }
        }
        
        setSpecCategories(specCategories.filter(c => c !== categoryToDelete));
      };

      const handleEditCategory = (oldName, newName) => {
        if (!newName.trim()) {
          alert('Le nom ne peut pas √™tre vide');
          return;
        }
        if (specCategories.includes(newName.trim()) && newName.trim() !== oldName) {
          alert('Cette cat√©gorie existe d√©j√†');
          return;
        }
        
        // Renommer dans la liste des cat√©gories
        setSpecCategories(specCategories.map(c => c === oldName ? newName.trim() : c));
        
        // Renommer dans toutes les sp√©cialit√©s
        const updatedSpecs = (plainte.specialites || []).map(s => 
          s.category === oldName ? { ...s, category: newName.trim() } : s
        );
        if (onUpdatePlainteInfo) {
          onUpdatePlainteInfo('specialites', updatedSpecs);
        }
        
        setEditingCategory(null);
        setEditCategoryName('');
      };

      const moveCategoryUp = (category) => {
        const index = specCategories.indexOf(category);
        if (index > 0) {
          const newCategories = [...specCategories];
          [newCategories[index - 1], newCategories[index]] = [newCategories[index], newCategories[index - 1]];
          setSpecCategories(newCategories);
        }
      };

      const moveCategoryDown = (category) => {
        const index = specCategories.indexOf(category);
        if (index < specCategories.length - 1) {
          const newCategories = [...specCategories];
          [newCategories[index], newCategories[index + 1]] = [newCategories[index + 1], newCategories[index]];
          setSpecCategories(newCategories);
        }
      };

      // Grouper les sp√©cialit√©s par cat√©gorie
      const groupedSpecs = {};
      specCategories.forEach(cat => {
        groupedSpecs[cat] = (plainte.specialites || []).filter(s => (s.category || 'G√©n√©ral') === cat);
      });

      const categoriesToDisplay = specCategories.filter(cat => 
        groupedSpecs[cat] && groupedSpecs[cat].length > 0
      );

      return (
        <div style={{ paddingBottom: '2rem' }}>
          <div style={{ display: 'flex', gap: 'var(--spacing-xs)', marginBottom: 'var(--spacing-lg)', justifyContent: 'flex-end' }}>
            <button
              onClick={onShowImportModal}
              style={{
                background: 'var(--color-button-primary)',
                color: 'white',
                border: 'none',
                padding: '0.5rem 1rem',
                borderRadius: '4px',
                fontWeight: 500,
                fontSize: '14px',
                fontFamily: 'inherit',
                cursor: 'pointer',
                transition: 'all 0.2s'
              }}
              title="Importer depuis Flashcards"
            >
              Ajouter une sp√©cialit√©
            </button>
            <button
              onClick={() => setShowCategoryManager(true)}
              style={{
                background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                color: 'var(--color-text-secondary)',
                border: '1px solid var(--color-border)',
                padding: '0.5rem 1rem',
                borderRadius: '4px',
                fontWeight: 500,
                fontSize: '14px',
                fontFamily: 'inherit',
                cursor: 'pointer',
                transition: 'all 0.2s'
              }}
            >
              Cat√©gories
            </button>
          </div>

          {(!plainte.specialites || plainte.specialites.length === 0) ? (
            <div style={{
              background: 'var(--color-surface)',
              padding: '3rem',
              borderRadius: '16px',
              textAlign: 'center',
              color: 'var(--color-text-muted)'
            }}>
              <p>Aucune sp√©cialit√© ajout√©e</p>
            </div>
          ) : (
            <div>
              {categoriesToDisplay.map(category => {
                const specsInCategory = groupedSpecs[category] || [];
                if (specsInCategory.length === 0) return null;
                
                return (
                  <div key={category} style={{ marginBottom: '2rem' }}>
                    {/* Ne pas afficher le titre pour "G√©n√©ral" */}
                    {category !== 'G√©n√©ral' && (
                      <h3 style={{
                        color: 'var(--color-text-muted)',
                        fontSize: '1.05rem',
                        fontWeight: 600,
                        marginBottom: '1rem',
                        paddingBottom: '0.5rem',
                        borderBottom: '2px solid #e2e8f0'
                      }}>
                        {category} <span style={{ color: '#94a3b8', fontSize: '0.8rem', fontWeight: 400 }}>({specsInCategory.length})</span>
                      </h3>
                    )}
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
                      gap: '1.5rem'
                    }}>
                      {specsInCategory.map((spec, index) => (
                        <SpecialiteCard
                          key={spec.id}
                          specialite={spec}
                          category={category}
                          couleur={categoryColor}
                          plainte={plainte}
                          onEdit={() => onEditSpecialite(spec)}
                          onDelete={() => onDeleteSpecialite(spec.id)}
                          onMoveUp={() => onMoveSpecialiteUp(spec.id)}
                          onMoveDown={() => onMoveSpecialiteDown(spec.id)}
                          reorderSpecialites={reorderSpecialites}
                          onChangeCategory={(specId, newCategory) => {
                            const updatedSpecs = plainte.specialites.map(s =>
                              s.id === specId ? { ...s, category: newCategory } : s
                            );
                            if (onUpdatePlainteInfo) {
                              onUpdatePlainteInfo('specialites', updatedSpecs);
                            }
                          }}
                          allSpecialites={plainte.specialites}
                          canMoveUp={index > 0}
                          canMoveDown={index < plainte.specialites.length - 1}
                          setImageModalUrl={setImageModalUrl}
                        />
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* Modal G√©rer cat√©gories */}
          {showCategoryManager && (
            <div 
              onClick={() => setShowCategoryManager(false)}
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000
              }}>
              <div 
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'var(--color-surface)',
                  borderRadius: '8px',
                  padding: 'var(--spacing-xl)',
                  maxWidth: '500px',
                  width: '90%',
                  maxHeight: '80vh',
                  overflow: 'auto',
                  border: '1px solid var(--color-border)'
                }}>
                <h3 style={{ marginBottom: 'var(--spacing-lg)', color: 'var(--color-text-primary)', fontSize: '18px', fontWeight: 600 }}>G√©rer les cat√©gories</h3>

                {/* Ajouter nouvelle cat√©gorie */}
                <div style={{ marginBottom: 'var(--spacing-lg)', padding: 'var(--spacing-md)', background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)', borderRadius: '6px', border: '1px solid var(--color-border)' }}>
                  <h4 style={{ marginBottom: 'var(--spacing-sm)', color: 'var(--color-text-secondary)', fontSize: '14px', fontWeight: 500 }}>Ajouter une cat√©gorie</h4>
                  <div style={{ display: 'flex', gap: 'var(--spacing-xs)' }}>
                    <input
                      type="text"
                      placeholder="Nom de la cat√©gorie"
                      value={newCategory}
                      onChange={(e) => setNewCategory(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleAddCategory()}
                      style={{
                        flex: 1,
                        padding: '0.5rem 0.75rem',
                        border: '1px solid var(--color-border)',
                        borderRadius: '4px',
                        fontSize: '14px',
                        fontFamily: 'inherit'
                      }}
                    />
                    <button
                      onClick={handleAddCategory}
                      style={{
                        background: 'var(--color-button-primary)',
                        color: 'white',
                        border: 'none',
                        padding: '0.5rem 1rem',
                        borderRadius: '4px',
                        cursor: 'pointer',
                        fontWeight: 500,
                        fontSize: '14px',
                        fontFamily: 'inherit'
                      }}
                    >
                      Ajouter
                    </button>
                  </div>
                </div>

                {/* Liste des cat√©gories avec drag & drop */}
                <div style={{ marginBottom: 'var(--spacing-md)' }}>
                  <h4 style={{ marginBottom: 'var(--spacing-sm)', color: 'var(--color-text-secondary)', fontSize: '14px', fontWeight: 500 }}>Cat√©gories existantes</h4>
                  {(specCategories || []).map((cat, index) => {
                    const specsCount = (plainte.specialites || []).filter(s => (s.category || 'G√©n√©ral') === cat).length;
                    
                    return editingCategory === cat ? (
                      <div key={cat} style={{ display: 'flex', gap: 'var(--spacing-xs)', marginBottom: 'var(--spacing-xs)' }}>
                        <input
                          type="text"
                          value={editCategoryName}
                          onChange={(e) => setEditCategoryName(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && handleEditCategory(cat, editCategoryName)}
                          style={{
                            flex: 1,
                            padding: '0.5rem 0.75rem',
                            border: '1px solid var(--color-border)',
                            borderRadius: '4px',
                            fontSize: '14px',
                            fontFamily: 'inherit'
                          }}
                          autoFocus
                        />
                        <button
                          onClick={() => handleEditCategory(cat, editCategoryName)}
                          style={{
                            background: 'var(--color-button-primary)',
                            color: 'white',
                            border: 'none',
                            padding: '0.5rem 1rem',
                            borderRadius: '4px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontFamily: 'inherit'
                          }}
                        >
                          ‚úì
                        </button>
                        <button
                          onClick={() => {
                            setEditingCategory(null);
                            setEditCategoryName('');
                          }}
                          style={{
                            background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                            color: 'var(--color-text-secondary)',
                            border: '1px solid var(--color-border)',
                            padding: '0.5rem 1rem',
                            borderRadius: '4px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontFamily: 'inherit'
                          }}
                        >
                          ‚úï
                        </button>
                      </div>
                    ) : (
                      <SpecCategoryItem
                        key={cat}
                        cat={cat}
                        index={index}
                        specsCount={specsCount}
                        isEditing={editingCategory === cat}
                        onEdit={() => {
                          setEditingCategory(cat);
                          setEditCategoryName(cat);
                        }}
                        onDelete={() => handleDeleteCategory(cat)}
                        onDragStart={(e) => {
                          e.dataTransfer.effectAllowed = 'move';
                          e.dataTransfer.setData('text/plain', index.toString());
                          e.currentTarget.style.opacity = '0.5';
                        }}
                        onDrop={(e) => {
                          e.preventDefault();
                          e.currentTarget.style.borderStyle = 'solid';
                          const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                          if (draggedIndex !== index) {
                            const newCategories = [...specCategories];
                            const [removed] = newCategories.splice(draggedIndex, 1);
                            newCategories.splice(index, 0, removed);
                            setSpecCategories(newCategories);
                          }
                        }}
                      />
                    );
                  })}
                </div>

                <button
                  onClick={() => setShowCategoryManager(false)}
                  style={{
                    width: '100%',
                    background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                    color: 'var(--color-text-secondary)',
                    border: '1px solid var(--color-border)',
                    padding: '0.5rem',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontWeight: 500,
                    fontSize: '14px',
                    fontFamily: 'inherit'
                  }}
                >
                  Fermer
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Composant DocumentCard avec drag & drop
    function DocumentCard({ doc, category, categoryColor, onEdit, onDelete, onMove, openDocument }) {
      const [isDragging, setIsDragging] = React.useState(false);
      const [isDragOver, setIsDragOver] = React.useState(false);
      const [isHovered, setIsHovered] = React.useState(false);
      
      const handleDragStart = (e) => {
        e.stopPropagation();
        setIsDragging(true);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('documentId', String(doc.id));
        e.dataTransfer.setData('documentCategory', category);
        // Ajouter un effet visuel
        e.currentTarget.style.opacity = '0.5';
      };
      
      const handleDragOver = (e) => {
        e.preventDefault();
        e.stopPropagation();
        // Ne pas utiliser getData() ici car √ßa ne marche pas pendant le drag
        // On accepte juste tous les drags
        setIsDragOver(true);
        e.dataTransfer.dropEffect = 'move';
      };
      
      const handleDragLeave = (e) => {
        e.stopPropagation();
        // V√©rifier qu'on quitte vraiment l'√©l√©ment (pas un enfant)
        if (!e.currentTarget.contains(e.relatedTarget)) {
          setIsDragOver(false);
        }
      };
      
      const handleDrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        const draggedId = e.dataTransfer.getData('documentId');
        const draggedCategory = e.dataTransfer.getData('documentCategory');
        
        // Comparer en string pour √™tre s√ªr
        if (draggedId && String(draggedId) !== String(doc.id)) {
          // Appeler onMove avec les IDs et les cat√©gories
          onMove(draggedId, doc.id, draggedCategory, category);
          // Marquer l'√©v√©nement comme g√©r√©
          e.dataTransfer.setData('handled', 'true');
        }
        setIsDragOver(false);
      };
      
      const handleDragEnd = (e) => {
        e.stopPropagation();
        e.currentTarget.style.opacity = '1';
        setIsDragging(false);
        setIsDragOver(false);
      };
      
      return (
        <div
          draggable
          onDragStart={handleDragStart}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
          onDrop={handleDrop}
          onDragEnd={handleDragEnd}
          style={{
            background: 'var(--color-surface)',
            borderRadius: '8px',
            overflow: 'hidden',
            boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
            border: isDragOver ? `2px dashed ${categoryColor}` : (category === 'Important' ? `2px solid ${categoryColor}` : '1px solid #e2e8f0'),
            transition: 'all 0.2s',
            display: 'flex',
            flexDirection: 'column',
            cursor: isDragging ? 'grabbing' : 'grab',
            transform: isDragOver ? 'scale(1.02)' : 'scale(1)',
            pointerEvents: 'auto'
          }}
          onMouseEnter={(e) => {
            if (!isDragging) {
              e.currentTarget.style.transform = 'translateY(-2px)';
              e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)';
              setIsHovered(true);
            }
          }}
          onMouseLeave={(e) => {
            if (!isDragging) {
              e.currentTarget.style.transform = isDragOver ? 'scale(1.02)' : 'translateY(0)';
              e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
              setIsHovered(false);
            }
          }}
        >
          {/* CONTENU CLIQUABLE */}
          <div
            onClick={() => openDocument(doc)}
            style={{
              padding: '0.75rem',
              cursor: 'pointer',
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              gap: '0.5rem'
            }}
          >
            {/* Layout principal: ic√¥ne + titre √† gauche, boutons √† droite */}
            <div style={{ display: 'flex', alignItems: 'flex-start', gap: '0.5rem' }}>
              {/* Ic√¥ne circulaire */}
              <div style={{
                width: '32px',
                height: '32px',
                borderRadius: '50%',
                background: category === 'Important' ? `${categoryColor}15` : '#f1f5f9',
                border: `2px solid ${category === 'Important' ? categoryColor : '#cbd5e1'}`,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '0.9rem',
                flexShrink: 0
              }}>
                {doc.data && (doc.data.includes('youtube.com') || doc.data.includes('youtu.be') || doc.data.includes('vimeo.com')) ? 'üé•' : 'üìÑ'}
              </div>
              
              {/* Titre */}
              <div style={{ flex: 1, minWidth: 0 }}>
                <div style={{
                  fontSize: 'clamp(0.7rem, 0.85rem, 1rem)',
                  fontWeight: 600,
                  color: 'var(--color-text-primary)',
                  wordBreak: 'break-word',
                  lineHeight: '1.2',
                  display: '-webkit-box',
                  WebkitLineClamp: 3,
                  WebkitBoxOrient: 'vertical',
                  overflow: 'hidden'
                }}>
                  {doc.nom}
                </div>
              </div>
              
              {/* Boutons invisibles par d√©faut */}
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 18px)', gap: '0.2rem', opacity: isHovered ? 1 : 0, transition: 'opacity 0.2s' }}>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    onEdit(doc);
                  }}
                  style={{
                    background: 'var(--color-badge-bg)',
                    border: '1px solid #93C5FD',
                    borderRadius: '4px',
                    width: '18px',
                    height: '18px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: 'pointer',
                    fontSize: '10px',
                    padding: 0,
                    color: '#1E40AF'
                  }}
                  title="Modifier"
                >
                  ‚úé
                </button>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    onDelete(doc.id);
                  }}
                  style={{
                    background: '#FEE2E2',
                    border: '1px solid #FCA5A5',
                    borderRadius: '4px',
                    width: '18px',
                    height: '18px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: 'pointer',
                    fontSize: '12px',
                    fontWeight: 'bold',
                    padding: 0,
                    color: '#DC2626'
                  }}
                  title="Supprimer"
                >
                  √ó
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function DocumentsTab({ plainte, categoryColor, onAddDocument, onDeleteDocument, onEditDocument, onRenameCategoryInDocuments, onMoveDocument, onReorderDocuments }) {
      const [showAddModal, setShowAddModal] = useState(false);
      const [editingDoc, setEditingDoc] = useState(null);
      const [editName, setEditName] = useState('');
      const [editUrl, setEditUrl] = useState('');
      const [editCategory, setEditCategory] = useState('');
      const [linkName, setLinkName] = useState('');
      const [linkUrl, setLinkUrl] = useState('');
      const [linkCategory, setLinkCategory] = useState('');
      const [showCategoryManager, setShowCategoryManager] = useState(false);
      const [docCategories, setDocCategories] = useState(() => {
        // D'abord essayer de charger depuis l'objet plainte
        if (plainte.docCategories && plainte.docCategories.length > 0) {
          return plainte.docCategories;
        }
        // Sinon essayer localStorage
        const saved = localStorage.getItem('docCategories_' + plainte.id);
        return saved ? JSON.parse(saved) : ['Important'];
      });
      const [newCategory, setNewCategory] = useState('');
      const [editingCategory, setEditingCategory] = useState(null);
      const [editCategoryName, setEditCategoryName] = useState('');

      // Initialiser linkCategory avec la premi√®re cat√©gorie quand le modal s'ouvre
      React.useEffect(() => {
        if (showAddModal && docCategories.length > 0) {
          setLinkCategory(docCategories[0]);
        }
      }, [showAddModal, docCategories]);

      // Sauvegarder les cat√©gories dans localStorage, Firebase ET dans l'objet plainte
      React.useEffect(() => {
        // Sauvegarder les cat√©gories sp√©cifiques √† cette plainte
        localStorage.setItem('docCategories_' + plainte.id, JSON.stringify(docCategories));
        
        // Sauvegarder aussi sur Firebase
        if (firebaseEnabled) {
          db.ref('docCategories/' + plainte.id).set(docCategories).catch(err => {
            console.error('‚ùå Erreur sauvegarde docCategories:', err);
          });
        }
      }, [docCategories, plainte.id]);

      const handleAddLink = () => {
        if (!linkName.trim() || !linkUrl.trim()) {
          alert('Nom et URL sont obligatoires');
          return;
        }
        if (!linkUrl.startsWith('http')) {
          alert("L'URL doit commencer par http:// ou https://");
          return;
        }

        onAddDocument({
          type: 'link',
          nom: linkName,
          data: linkUrl,
          category: linkCategory || docCategories[0] || 'Important'
        });

        setLinkName('');
        setLinkUrl('');
        setLinkCategory('');
        setShowAddModal(false);
      };

      const handleDocumentMove = (draggedId, targetId, draggedCategory, targetCategory) => {
        // Seulement si m√™me cat√©gorie : r√©organiser l'ordre
        if (draggedCategory === targetCategory && onReorderDocuments) {
          onReorderDocuments(draggedId, targetId);
        }
        // Si cat√©gories diff√©rentes : ne rien faire (on utilise le menu modifier √† la place)
      };

      const handleAddCategory = () => {
        if (!newCategory.trim()) {
          alert('Le nom de la cat√©gorie ne peut pas √™tre vide');
          return;
        }
        if (docCategories.includes(newCategory.trim())) {
          alert('Cette cat√©gorie existe d√©j√†');
          return;
        }
        setDocCategories([...docCategories, newCategory.trim()]);
        setNewCategory('');
      };

      const handleEditCategory = (oldName, newName) => {
        if (!newName.trim()) {
          alert('Le nom de la cat√©gorie ne peut pas √™tre vide');
          return;
        }
        if (oldName !== newName && docCategories.includes(newName)) {
          alert('Cette cat√©gorie existe d√©j√†');
          return;
        }
        // Mettre √† jour la liste des cat√©gories
        setDocCategories(docCategories.map(cat => cat === oldName ? newName : cat));
        // Mettre √† jour tous les documents qui ont cette cat√©gorie
        if (onRenameCategoryInDocuments) {
          onRenameCategoryInDocuments(oldName, newName);
        }
        setEditingCategory(null);
        setEditCategoryName('');
      };

      const handleDeleteCategory = (categoryName) => {
        // Emp√™cher la suppression de "Important"
        if (categoryName === 'Important') {
          alert('La cat√©gorie "Important" ne peut pas √™tre supprim√©e car elle est obligatoire.');
          return;
        }
        
        const docsInCategory = (plainte.documents || []).filter(doc => (doc.category || 'Important') === categoryName).length;
        if (docsInCategory > 0) {
          if (!confirm(`‚ö†Ô∏è ${docsInCategory} document(s) sont dans cette cat√©gorie.\n\nSupprimer quand m√™me ?\n(Les documents seront d√©plac√©s vers "Important")`)) {
            return;
          }
        } else {
          if (!confirm(`Supprimer la cat√©gorie "${categoryName}" ?`)) {
            return;
          }
        }
        setDocCategories(docCategories.filter(cat => cat !== categoryName));
      };

      const handleMoveCategoryUp = (index) => {
        if (index === 0) return;
        const newCategories = [...docCategories];
        [newCategories[index - 1], newCategories[index]] = [newCategories[index], newCategories[index - 1]];
        setDocCategories(newCategories);
      };

      const handleMoveCategoryDown = (index) => {
        if (index === docCategories.length - 1) return;
        const newCategories = [...docCategories];
        [newCategories[index], newCategories[index + 1]] = [newCategories[index + 1], newCategories[index]];
        setDocCategories(newCategories);
      };

      const openDocument = (doc) => {
        if (doc.data) {
          window.open(doc.data, '_blank');
        } else {
          console.error('‚ùå Document sans URL:', doc);
          alert('Ce document n\'a pas d\'URL valide.');
        }
      };

      // Grouper les documents par cat√©gorie (recalcul√© quand plainte.documents ou docCategories changent)
      const groupedDocs = React.useMemo(() => {
        const grouped = {};
        docCategories.forEach(cat => {
          grouped[cat] = (plainte.documents || []).filter(doc => (doc.category || 'Important') === cat);
        });
        // Ajouter les documents sans cat√©gorie ou avec cat√©gorie supprim√©e
        const uncategorized = (plainte.documents || []).filter(doc => !docCategories.includes(doc.category || 'Important'));
        if (uncategorized.length > 0) {
          grouped['Important'] = [...(grouped['Important'] || []), ...uncategorized];
        }
        return grouped;
      }, [plainte.documents, docCategories]);

      // Cr√©er une liste de cat√©gories √† afficher (inclut "Important" si des documents y sont)
      const categoriesToDisplay = React.useMemo(() => {
        const cats = [...docCategories];
        // Si des documents sont dans "Important" et que "Important" n'est pas dans la liste, l'ajouter
        if (groupedDocs['Important'] && groupedDocs['Important'].length > 0 && !cats.includes('Important')) {
          cats.unshift('Important'); // Ajouter en premier
        }
        return cats;
      }, [docCategories, groupedDocs]);

      // Composant pour chaque item de cat√©gorie (pour pouvoir utiliser useState)
      const CategoryItem = ({ cat, index, docsCount, isEditing, onEdit, onDelete, onDragStart, onDrop }) => {
        const [isHovered, setIsHovered] = React.useState(false);
        
        return (
          <div 
            draggable
            onDragStart={onDragStart}
            onDragEnd={(e) => {
              e.currentTarget.style.opacity = '1';
            }}
            onDragOver={(e) => {
              e.preventDefault();
              e.dataTransfer.dropEffect = 'move';
              e.currentTarget.style.borderStyle = 'dashed';
            }}
            onDragLeave={(e) => {
              e.currentTarget.style.borderStyle = 'solid';
            }}
            onDrop={onDrop}
            onMouseEnter={() => setIsHovered(true)}
            onMouseLeave={() => setIsHovered(false)}
            style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              padding: 'var(--spacing-sm) var(--spacing-md)',
              background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
              border: '1px solid var(--color-border)',
              borderRadius: '4px',
              marginBottom: 'var(--spacing-xs)',
              cursor: 'grab',
              transition: 'all 0.2s',
              position: 'relative'
            }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-sm)' }}>
              <span style={{ color: 'var(--color-text-muted)', fontSize: '16px' }}>‚ãÆ‚ãÆ</span>
              <span style={{ fontWeight: 500, fontSize: '14px', color: 'var(--color-text-primary)' }}>
                {cat} <strong style={{ color: 'var(--color-text-secondary)' }}>{docsCount}</strong>
              </span>
            </div>
            <div style={{ display: 'flex', gap: 'var(--spacing-xs)', opacity: isHovered ? 1 : 0, transition: 'opacity 0.2s' }}>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onEdit();
                }}
                style={{
                  background: 'var(--color-badge-bg)',
                  color: '#1E40AF',
                  border: '1px solid #93C5FD',
                  padding: '0.25rem 0.5rem',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontSize: '12px'
                }}
                title="Modifier"
              >
                ‚úé
              </button>
              {cat !== 'Important' && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    onDelete();
                  }}
                  style={{
                    background: '#FEE2E2',
                    color: '#DC2626',
                    border: '1px solid #FCA5A5',
                    padding: '0.25rem 0.5rem',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontSize: '12px'
                  }}
                  title="Supprimer"
                >
                  √ó
                </button>
              )}
            </div>
          </div>
        );
      };

      return (
        <div style={{ paddingBottom: '2rem' }}>
          <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.5rem', justifyContent: 'flex-end' }}>
            <button
              onClick={() => setShowAddModal(true)}
              style={{
                background: 'var(--color-button-primary)',
                color: 'white',
                border: 'none',
                padding: '0.5rem 1rem',
                borderRadius: '4px',
                fontWeight: 500,
                cursor: 'pointer',
                fontSize: '14px',
                fontFamily: 'inherit',
                transition: 'all 0.2s'
              }}
            >
              Ajouter un lien
            </button>
            <button
              onClick={() => setShowCategoryManager(true)}
              style={{
                background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                color: 'var(--color-text-secondary)',
                border: '1px solid var(--color-border)',
                padding: '0.5rem 1rem',
                borderRadius: '4px',
                fontWeight: 500,
                cursor: 'pointer',
                fontSize: '14px',
                fontFamily: 'inherit',
                transition: 'all 0.2s'
              }}
            >
              Cat√©gories
            </button>
          </div>

          {/* MODAL GESTIONNAIRE DE CAT√âGORIES */}
          {showCategoryManager && (
            <div 
              onClick={() => setShowCategoryManager(false)}
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000
              }}>
              <div 
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'var(--color-surface)',
                  borderRadius: '8px',
                  padding: 'var(--spacing-xl)',
                  maxWidth: '500px',
                  width: '90%',
                  maxHeight: '80vh',
                  overflow: 'auto',
                  border: '1px solid var(--color-border)'
                }}>
                <h3 style={{ marginBottom: 'var(--spacing-lg)', color: 'var(--color-text-primary)', fontSize: '18px', fontWeight: 600 }}>G√©rer les cat√©gories</h3>

                {/* Ajouter nouvelle cat√©gorie */}
                <div style={{ marginBottom: 'var(--spacing-lg)', padding: 'var(--spacing-md)', background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)', borderRadius: '6px', border: '1px solid var(--color-border)' }}>
                  <h4 style={{ marginBottom: 'var(--spacing-sm)', color: 'var(--color-text-secondary)', fontSize: '14px', fontWeight: 500 }}>Ajouter une cat√©gorie</h4>
                  <div style={{ display: 'flex', gap: 'var(--spacing-xs)' }}>
                    <input
                      type="text"
                      placeholder="Nom de la cat√©gorie"
                      value={newCategory}
                      onChange={(e) => setNewCategory(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleAddCategory()}
                      style={{
                        flex: 1,
                        padding: '0.5rem 0.75rem',
                        border: '1px solid var(--color-border)',
                        borderRadius: '4px',
                        fontSize: '14px',
                        fontFamily: 'inherit'
                      }}
                    />
                    <button
                      onClick={handleAddCategory}
                      style={{
                        background: 'var(--color-button-primary)',
                        color: 'white',
                        border: 'none',
                        padding: '0.5rem 1rem',
                        borderRadius: '4px',
                        cursor: 'pointer',
                        fontWeight: 500,
                        fontSize: '14px',
                        fontFamily: 'inherit'
                      }}
                    >
                      Ajouter
                    </button>
                  </div>
                </div>

                {/* Liste des cat√©gories */}
                <div style={{ marginBottom: 'var(--spacing-md)' }}>
                  <h4 style={{ marginBottom: 'var(--spacing-sm)', color: 'var(--color-text-secondary)', fontSize: '14px', fontWeight: 500 }}>Cat√©gories existantes</h4>
                  {(docCategories || []).map((cat, index) => {
                    const docsCount = (plainte.documents || []).filter(doc => (doc.category || 'Important') === cat).length;
                    
                    return editingCategory === cat ? (
                      <div key={cat} style={{ display: 'flex', gap: 'var(--spacing-xs)', marginBottom: 'var(--spacing-xs)' }}>
                        <input
                          type="text"
                          value={editCategoryName}
                          onChange={(e) => setEditCategoryName(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && handleEditCategory(cat, editCategoryName)}
                          style={{
                            flex: 1,
                            padding: '0.5rem 0.75rem',
                            border: '1px solid var(--color-border)',
                            borderRadius: '4px',
                            fontSize: '14px',
                            fontFamily: 'inherit'
                          }}
                          autoFocus
                        />
                        <button
                          onClick={() => handleEditCategory(cat, editCategoryName)}
                          style={{
                            background: 'var(--color-button-primary)',
                            color: 'white',
                            border: 'none',
                            padding: '0.5rem 1rem',
                            borderRadius: '4px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontFamily: 'inherit'
                          }}
                        >
                          ‚úì
                        </button>
                        <button
                          onClick={() => {
                            setEditingCategory(null);
                            setEditCategoryName('');
                          }}
                          style={{
                            background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                            color: 'var(--color-text-secondary)',
                            border: '1px solid var(--color-border)',
                            padding: '0.5rem 1rem',
                            borderRadius: '4px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontFamily: 'inherit'
                          }}
                        >
                          ‚úï
                        </button>
                      </div>
                    ) : (
                      <CategoryItem
                        key={cat}
                        cat={cat}
                        index={index}
                        docsCount={docsCount}
                        isEditing={editingCategory === cat}
                        onEdit={() => {
                          setEditingCategory(cat);
                          setEditCategoryName(cat);
                        }}
                        onDelete={() => handleDeleteCategory(cat)}
                        onDragStart={(e) => {
                          e.dataTransfer.effectAllowed = 'move';
                          e.dataTransfer.setData('text/plain', index.toString());
                          e.currentTarget.style.opacity = '0.5';
                        }}
                        onDrop={(e) => {
                          e.preventDefault();
                          e.currentTarget.style.borderStyle = 'solid';
                          const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                          if (draggedIndex !== index) {
                            const newCategories = [...docCategories];
                            const [removed] = newCategories.splice(draggedIndex, 1);
                            newCategories.splice(index, 0, removed);
                            setDocCategories(newCategories);
                          }
                        }}
                      />
                    );
                  })}
                </div>

                <button
                  onClick={() => setShowCategoryManager(false)}
                  style={{
                    width: '100%',
                    background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                    color: 'var(--color-text-secondary)',
                    border: '1px solid var(--color-border)',
                    padding: '0.5rem',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontWeight: 500,
                    fontSize: '14px',
                    fontFamily: 'inherit'
                  }}
                >
                  Fermer
                </button>
              </div>
            </div>
          )}

          {showAddModal && (
            <div 
              onClick={() => setShowAddModal(false)}
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000
              }}>
              <div 
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'var(--color-surface)',
                  borderRadius: '8px',
                  padding: 'var(--spacing-xl)',
                  maxWidth: '500px',
                  width: '90%',
                  border: '1px solid var(--color-border)'
                }}>
                <h3 style={{ marginBottom: 'var(--spacing-lg)', color: 'var(--color-text-primary)', fontSize: '18px', fontWeight: 600 }}>Ajouter un lien</h3>

                <input
                  type="text"
                  placeholder="Nom du lien"
                  value={linkName}
                  onChange={(e) => setLinkName(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.5rem 0.75rem',
                    border: '1px solid var(--color-border)',
                    borderRadius: '4px',
                    fontSize: '14px',
                    fontFamily: 'inherit',
                    marginBottom: 'var(--spacing-sm)'
                  }}
                />
                <input
                  type="text"
                  placeholder="https://drive.google.com/..."
                  value={linkUrl}
                  onChange={(e) => setLinkUrl(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.5rem 0.75rem',
                    border: '1px solid var(--color-border)',
                    borderRadius: '4px',
                    fontSize: '14px',
                    fontFamily: 'inherit',
                    marginBottom: 'var(--spacing-sm)'
                  }}
                />
                <select
                  value={linkCategory}
                  onChange={(e) => setLinkCategory(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.5rem 0.75rem',
                    border: '1px solid var(--color-border)',
                    borderRadius: '4px',
                    fontSize: '14px',
                    fontFamily: 'inherit',
                    marginBottom: 'var(--spacing-md)',
                    cursor: 'pointer'
                  }}
                >
                  {(docCategories || []).map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>
                <button
                  onClick={handleAddLink}
                  style={{
                    width: '100%',
                    background: 'var(--color-button-primary)',
                    color: 'white',
                    border: 'none',
                    padding: '0.5rem',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontWeight: 500,
                    fontSize: '14px',
                    fontFamily: 'inherit',
                    marginBottom: 'var(--spacing-sm)'
                  }}
                >
                  Ajouter le lien
                </button>

                <button
                  onClick={() => setShowAddModal(false)}
                  style={{
                    width: '100%',
                    background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                    color: 'var(--color-text-secondary)',
                    border: '1px solid var(--color-border)',
                    padding: '0.5rem',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontWeight: 500,
                    fontSize: '14px',
                    fontFamily: 'inherit'
                  }}
                >
                  Annuler
                </button>
              </div>
            </div>
          )}

          {/* MODAL √âDITION */}
          {editingDoc && (
            <div 
              onClick={() => {
                console.log('üñ±Ô∏è Clic sur overlay - fermeture modal');
                setEditingDoc(null);
              }}
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000,
                cursor: 'pointer'
              }}>
              <div 
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'var(--color-surface)',
                  borderRadius: '20px',
                  padding: '2rem',
                  maxWidth: '500px',
                  width: '90%'
                }}>
                <h3 style={{ marginBottom: '1.5rem', color: 'var(--color-text-primary)' }}>Modifier le lien</h3>

                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, fontSize: '0.9rem', color: 'var(--color-text-muted)' }}>
                  Nom du lien
                </label>
                <input
                  type="text"
                  placeholder="Nom du lien"
                  value={editName}
                  onChange={(e) => setEditName(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid var(--color-border)',
                    borderRadius: '8px',
                    marginBottom: '1rem'
                  }}
                />

                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, fontSize: '0.9rem', color: 'var(--color-text-muted)' }}>
                  URL du lien
                </label>
                <input
                  type="text"
                  placeholder="https://..."
                  value={editUrl}
                  onChange={(e) => setEditUrl(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid var(--color-border)',
                    borderRadius: '8px',
                    marginBottom: '1rem'
                  }}
                />

                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, fontSize: '0.9rem', color: 'var(--color-text-muted)' }}>
                  Cat√©gorie
                </label>
                <select
                  value={editCategory}
                  onChange={(e) => setEditCategory(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid var(--color-border)',
                    borderRadius: '8px',
                    marginBottom: '1rem',
                    cursor: 'pointer'
                  }}
                >
                  {(docCategories || []).map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>

                <button
                  onClick={() => {
                    if (!editName.trim()) {
                      alert('Le nom ne peut pas √™tre vide');
                      return;
                    }
                    if (!editUrl.trim() || !editUrl.startsWith('http')) {
                      alert('L\'URL doit commencer par http:// ou https://');
                      return;
                    }
                    onEditDocument(editingDoc.id, editName, editUrl, editCategory);
                    setEditingDoc(null);
                    setEditName('');
                    setEditUrl('');
                    setEditCategory('');
                  }}
                  style={{
                    width: '100%',
                    background: categoryColor,
                    color: 'white',
                    border: 'none',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600,
                    marginBottom: '0.75rem'
                  }}
                >
                  Enregistrer
                </button>

                <button
                  onClick={() => {
                    setEditingDoc(null);
                    setEditName('');
                    setEditUrl('');
                    setEditCategory('');
                  }}
                  style={{
                    width: '100%',
                    background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                    color: '#475569',
                    border: 'none',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600
                  }}
                >
                  Annuler
                </button>
              </div>
            </div>
          )}

          {(plainte.documents || []).length === 0 ? (
            <div style={{
              background: 'var(--color-surface)',
              padding: '3rem',
              borderRadius: '16px',
              textAlign: 'center',
              color: 'var(--color-text-muted)'
            }}>
              <p>Aucun lien ajout√©</p>
            </div>
          ) : (
            <div>
              {categoriesToDisplay.map(category => {
                const docsInCategory = groupedDocs[category] || [];
                if (docsInCategory.length === 0) return null;
                
                return (
                  <div key={category} style={{ marginBottom: '2rem' }}>
                    <h3 style={{
                      color: category === 'Important' ? categoryColor : '#64748b',
                      fontSize: category === 'Important' ? '1.2rem' : '1.05rem',
                      fontWeight: category === 'Important' ? 700 : 600,
                      marginBottom: '1rem',
                      paddingBottom: '0.5rem',
                      paddingLeft: category === 'Important' ? '0.75rem' : '0',
                      borderLeft: category === 'Important' ? `4px solid ${categoryColor}` : 'none',
                      borderBottom: `2px solid ${category === 'Important' ? categoryColor : '#e2e8f0'}`,
                      background: category === 'Important' ? `${categoryColor}08` : 'transparent',
                      padding: category === 'Important' ? '0.75rem' : '0 0 0.5rem 0',
                      borderRadius: category === 'Important' ? '8px' : '0'
                    }}>
                      {category} <span style={{ color: '#94a3b8', fontSize: '0.8rem', fontWeight: 400 }}>({docsInCategory.length})</span>
                    </h3>
                    <div 
                      style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                        gap: '0.75rem'
                      }}
                    >
                      {docsInCategory.map((doc, index) => (
                        <DocumentCard
                          key={doc.id}
                          doc={doc}
                          category={category}
                          categoryColor={categoryColor}
                          onEdit={(doc) => {
                            setEditingDoc(doc);
                            setEditName(doc.nom);
                            setEditUrl(doc.data);
                            setEditCategory(doc.category || 'Important');
                          }}
                          onDelete={(docId) => onDeleteDocument(docId)}
                          onMove={handleDocumentMove}
                          openDocument={openDocument}
                        />
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    function SpecialiteCard({ specialite, category, couleur, plainte, onEdit, onDelete, onMoveUp, onMoveDown, reorderSpecialites, onChangeCategory, allSpecialites, canMoveUp, canMoveDown, setImageModalUrl }) {
      const [isHovered, setIsHovered] = React.useState(false);
      const [isDragging, setIsDragging] = React.useState(false);
      const [isDragOver, setIsDragOver] = React.useState(false);
      
      const handleDragStart = (e) => {
        e.stopPropagation();
        setIsDragging(true);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('specialiteId', specialite.id);
        e.dataTransfer.setData('specialiteCategory', category || 'G√©n√©ral');
      };
      
      const handleDragOver = (e) => {
        e.preventDefault();
        e.stopPropagation();
        const draggedIdStr = e.dataTransfer.getData('specialiteId');
        const draggedId = typeof draggedIdStr === 'string' ? parseInt(draggedIdStr) : draggedIdStr;
        if (draggedId && draggedId !== specialite.id) {
          setIsDragOver(true);
        }
      };
      
      const handleDragLeave = (e) => {
        e.stopPropagation();
        setIsDragOver(false);
      };
      
      const handleDrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        const draggedIdStr = e.dataTransfer.getData('specialiteId');
        const draggedId = typeof draggedIdStr === 'string' ? parseInt(draggedIdStr) : draggedIdStr;
        const draggedCategory = e.dataTransfer.getData('specialiteCategory');
        const targetCategory = category || 'G√©n√©ral';
        
        if (draggedId && draggedId !== specialite.id) {
          if (draggedCategory === targetCategory) {
            // M√™me cat√©gorie : r√©organiser
            if (reorderSpecialites) {
              reorderSpecialites(draggedId, specialite.id);
            }
          } else {
            // Cat√©gorie diff√©rente : changer la cat√©gorie
            if (onChangeCategory) {
              onChangeCategory(draggedId, targetCategory);
            }
          }
        }
        setIsDragOver(false);
      };
      
      const handleDragEnd = (e) => {
        e.stopPropagation();
        setIsDragging(false);
        setIsDragOver(false);
      };
      
      const pharmaData = getPharmaQuizzMed(specialite.dci, specialite.nomCommercial);
      
      // DEBUG COMPLET
      console.group('üîç SpecialiteCard: ' + (specialite.nomCommercial || specialite.dci));
      console.log('üìã Nom commercial:', specialite.nomCommercial);
      console.log('üíä DCI:', specialite.dci);
      console.log('üéØ pharmaData:', pharmaData);
      if (pharmaData) {
        console.log('   ‚úÖ Classe:', pharmaData.classe);
        console.log('   ‚úÖ Cat√©gorie:', pharmaData.category);
        console.log('   ‚úÖ Couleur:', pharmaData.couleur);
      } else {
        console.log('   ‚ùå AUCUNE correspondance trouv√©e');
        // Chercher manuellement dans les flashcards
        try {
          const flashcards = JSON.parse(localStorage.getItem('pharmaspace_medications') || '[]');
          console.log('   üìä Nombre de flashcards:', flashcards.length);
          if (flashcards.length > 0) {
            console.log('   üîé Recherche manuelle...');
            const byDCI = flashcards.filter(f => 
              f.dci && specialite.dci && f.dci.toLowerCase().includes(specialite.dci.toLowerCase().split(/[+,]/)[0].trim())
            );
            console.log('   - Par DCI:', byDCI.length > 0 ? byDCI[0] : 'aucun');
            const byName = flashcards.filter(f => 
              f.commercial && specialite.nomCommercial && 
              f.commercial.some(c => c.toLowerCase().includes(specialite.nomCommercial.toLowerCase()))
            );
            console.log('   - Par nom:', byName.length > 0 ? byName[0] : 'aucun');
          }
        } catch(e) {
          console.error('   ‚ö†Ô∏è Erreur recherche:', e);
        }
      }
      console.groupEnd();
      

      return (
        <div 
          draggable
          onDragStart={handleDragStart}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
          onDrop={handleDrop}
          onDragEnd={handleDragEnd}
          style={{
            background: 'var(--color-surface)',
            borderRadius: '12px',
            padding: '1.25rem',
            boxShadow: '0 4px 20px rgba(0,0,0,0.1)',
            border: isDragOver ? `2px dashed ${couleur}` : `2px solid ${couleur}40`,
            position: 'relative',
            opacity: isDragging ? 0.5 : 1,
            cursor: isDragging ? 'grabbing' : 'grab',
            transform: isDragOver ? 'scale(1.02)' : 'scale(1)',
            transition: 'all 0.2s'
          }}
        >
          {/* Boutons modifier et supprimer en haut √† droite */}
          <div 
            className="specialite-card-buttons"
            style={{
            position: 'absolute',
            top: '0.5rem',
            right: '0.5rem',
            display: 'flex',
            gap: '0.4rem',
            opacity: 0,
            transition: 'opacity 0.2s',
            zIndex: 10
          }}
          onMouseEnter={(e) => {
            e.currentTarget.style.opacity = '1';
          }}
          onMouseLeave={(e) => {
            e.currentTarget.style.opacity = '0';
          }}
          >
            {/* Bouton Modifier */}
            <button
              onClick={(e) => {
                e.stopPropagation();
                onEdit();
              }}
              style={{
                background: 'var(--color-button-primary)',
                border: 'none',
                borderRadius: '4px',
                width: '28px',
                height: '28px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer',
                color: 'white',
                fontSize: '14px',
                padding: 0
              }}
              title="Modifier"
            >
              ‚úé
            </button>
            
            {/* Bouton Supprimer */}
            <button
              onClick={(e) => {
                e.stopPropagation();
                if (window.confirm(`Supprimer ${specialite.nomCommercial || specialite.dci} ?`)) {
                  onDelete();
                }
              }}
              style={{
                background: '#FEE2E2',
                border: '1px solid #FCA5A5',
                borderRadius: '4px',
                width: '28px',
                height: '28px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer',
                color: '#DC2626',
                fontSize: '16px',
                padding: 0
              }}
              title="Supprimer"
            >
              √ó
            </button>
          </div>

          {(() => {
            const images = specialite.imageUrls && specialite.imageUrls.length > 0 
              ? specialite.imageUrls.filter(img => img && img.trim() !== '')
              : (specialite.image ? [specialite.image] : []);
            
            return images.length > 0 ? (
              <div style={{
                display: 'flex',
                gap: '0.5rem',
                marginBottom: '1rem',
                flexWrap: 'wrap'
              }}>
                {images.map((img, idx) => (
                  <div key={idx} style={{
                    width: images.length === 1 ? '100%' : 'calc(50% - 0.25rem)',
                    height: '140px',
                    borderRadius: '8px',
                    overflow: 'hidden',
                    border: `2px solid ${couleur}`,
                    background: 'white'
                  }}>
                    <img 
                      src={img} 
                      alt={`${specialite.nomCommercial} ${idx + 1}`} 
                      style={{
                        width: '100%',
                        height: '100%',
                        objectFit: 'contain',
                        cursor: 'pointer'
                      }} 
                      onClick={() => setImageModalUrl(img)}
                      onError={(e) => e.target.style.display = 'none'} 
                    />
                  </div>
                ))}
              </div>
            ) : null;
          })()}

          <h4 style={{
            color: 'var(--color-text-primary)',
            fontSize: '1.2rem',
            marginBottom: '0.5rem',
            fontWeight: 600,
            paddingRight: '4rem',
            display: 'flex',
            alignItems: 'center',
            gap: '0.5rem',
            flexWrap: 'wrap'
          }}>
            <span style={{ fontSize: '1.2rem', fontWeight: 600 }}>{specialite.nomCommercial || specialite.dci}</span>
          </h4>

          {specialite.dci && specialite.nomCommercial && (
            <div style={{ 
              marginBottom: '0.5rem', 
              fontSize: '0.95rem', 
              color: 'var(--color-text-muted)',
              fontWeight: 500
            }}>
              {specialite.dci}
            </div>
          )}

          {/* M√©tadonn√©es discr√®tes : classe et forme */}
          <div style={{
            display: 'flex',
            gap: '0.4rem',
            marginBottom: '0.75rem',
            flexWrap: 'wrap'
          }}>
            {pharmaData && (pharmaData.classe || pharmaData.category) && (
              <span style={{
                padding: '0.2rem 0.5rem',
                background: 'var(--color-surface)',
                border: '1px solid var(--color-border)',
                borderRadius: '8px',
                fontSize: '0.7rem',
                color: '#94a3b8',
                fontWeight: 500
              }}>
                {pharmaData.classe || pharmaData.category}
              </span>
            )}
            {specialite.formePharma && (
              <span style={{
                padding: '0.2rem 0.5rem',
                background: 'var(--color-surface)',
                border: '1px solid var(--color-border)',
                borderRadius: '8px',
                fontSize: '0.7rem',
                color: '#94a3b8',
                fontWeight: 500
              }}>
                {[...new Set(specialite.formePharma.split(',').map(f => f.trim()))].join(', ')}
              </span>
            )}
          </div>



          {specialite.posologie && (
            <div style={{
              padding: '0.75rem',
              background: '#f0fdf4',
              borderRadius: '6px',
              marginBottom: '0.5rem',
              fontSize: '0.85rem',
              color: '#065f46',
              whiteSpace: 'pre-wrap'
            }}>
              <strong>Posologie</strong> {specialite.posologie}
            </div>
          )}

          {specialite.conseils && (
            <div style={{
              padding: '0.75rem',
              background: '#eff6ff',
              borderRadius: '6px',
              marginBottom: '0.5rem',
              fontSize: '0.85rem',
              color: 'var(--color-badge-text)',
              whiteSpace: 'pre-wrap'
            }}>
              <strong>Conseils</strong> {specialite.conseils}
            </div>
          )}

          {specialite.contreIndications && (
            <div style={{
              padding: '0.75rem',
              background: '#fef2f2',
              borderRadius: '6px',
              marginBottom: '0.5rem',
              fontSize: '0.85rem',
              color: '#991b1b',
              whiteSpace: 'pre-wrap'
            }}>
              <strong>CI</strong> {specialite.contreIndications}
            </div>
          )}

          {specialite.notes && (
            <div style={{
              padding: '0.75rem',
              background: '#fefce8',
              borderRadius: '6px',
              fontSize: '0.85rem',
              color: '#854d0e',
              whiteSpace: 'pre-wrap'
            }}>
              <strong>Notes</strong> {specialite.notes}
            </div>
          )}
        </div>
      );
    }

    function FormSpecialite({ specialite, categoryColor, onSave, onCancel, handleImageUpload, handleImageURL, plainte, medications }) {
      // DEBUG
      console.group('üîç FormSpecialite - Initialisation');
      console.log('medications:', medications);
      console.log('medications est un tableau?', Array.isArray(medications));
      console.log('specialite:', specialite);
      console.groupEnd();
      
      // Initialisation des images pour le mode √©dition
      // Utiliser allImageUrls (toutes les images) plut√¥t que imageUrls (seulement les s√©lectionn√©es)
      const initImages = specialite && specialite.allImageUrls && specialite.allImageUrls.length > 0
        ? specialite.allImageUrls.filter(img => img && img.trim() !== '')
        : (specialite && specialite.imageUrls ? specialite.imageUrls.filter(img => img && img.trim() !== '') : []);
      const initForms = specialite && specialite.formePharma ? specialite.formePharma.split(',').map(f => f.trim()) : [];
      
      // Calculer les index des images actuellement s√©lectionn√©es
      const initSelectedIndexes = specialite && specialite.imageUrls && initImages.length > 0
        ? specialite.imageUrls
            .filter(img => img && img.trim() !== '')
            .map(selectedImg => initImages.findIndex(img => img === selectedImg))
            .filter(idx => idx !== -1)
        : initImages.map((_, i) => i);
      
      const [formData, setFormData] = useState(specialite ? {
        nomCommercial: specialite.nomCommercial || '',
        dci: specialite.dci || '',
        category: specialite.category || 'G√©n√©ral',
        image: specialite.image || null,
        imageUrls: Array.isArray(specialite.imageUrls) ? specialite.imageUrls : [],
        allImageUrls: Array.isArray(specialite.allImageUrls) ? specialite.allImageUrls : (Array.isArray(specialite.imageUrls) ? specialite.imageUrls : []),
        selectedImages: initSelectedIndexes,
        posologie: specialite.posologie || '',
        conseils: specialite.conseils || '',
        contreIndications: specialite.contreIndications || '',
        notes: specialite.notes || '',
        formePharma: specialite.formePharma || ''
      } : {
        nomCommercial: '',
        dci: '',
        category: 'G√©n√©ral',
        image: null,
        imageUrls: [],
        allImageUrls: [],
        selectedImages: [],
        posologie: '',
        conseils: '',
        contreIndications: '',
        notes: '',
        formePharma: ''
      });

      const [originalImages, setOriginalImages] = useState(initImages);
      const [originalForms, setOriginalForms] = useState(initForms);

      return (
        <div style={{ maxWidth: 'none', margin: '0', padding: '0 2rem' }}>
          <div style={{
            background: 'var(--color-surface)',
            borderRadius: '20px',
            padding: '2rem',
            boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
            maxWidth: '800px',
            margin: '0 auto'
          }}>
            <h2 style={{ marginBottom: '1rem', color: 'var(--color-text-primary)' }}>
              {specialite ? 'Modifier' : 'Ajouter une sp√©cialit√©'}
            </h2>

            {/* IMPORT DEPUIS FLASHCARD */}
            <div style={{ marginBottom: '1.5rem', padding: '1rem', background: 'var(--color-bg)', borderRadius: '12px', border: '2px solid #3B82F6' }}>
              <label style={{ display: 'block', marginBottom: '0.75rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>
                Importer depuis mes flashcards
              </label>
              <select
                value=""
                onChange={(e) => {
                  console.group('üîç Import depuis flashcard');
                  console.log('e.target.value:', e.target.value);
                  if (e.target.value !== '') {
                    const selectedIndex = parseInt(e.target.value);
                    console.log('selectedIndex:', selectedIndex);
                    console.log('medications:', medications);
                    console.log('medications type:', typeof medications);
                    console.log('medications est array?', Array.isArray(medications));
                    const sortedMeds = (medications || []).sort((a, b) => a.dci.localeCompare(b.dci));
                    console.log('sortedMeds:', sortedMeds);
                    console.log('sortedMeds length:', sortedMeds.length);
                    const med = sortedMeds[selectedIndex];
                    console.log('med s√©lectionn√©:', med);
                    
                    if (med) {
                      console.log('‚úÖ M√©dicament trouv√©, import en cours...');
                      // R√©cup√©rer TOUTES les images et formes (avec v√©rifications)
                      const allImages = (med.imageUrls && Array.isArray(med.imageUrls)) 
                        ? med.imageUrls 
                        : (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []));
                      
                      const allForms = med.pharmaceuticalForm 
                        ? (typeof med.pharmaceuticalForm === 'string' 
                            ? med.pharmaceuticalForm.split(',').map(f => f.trim()) 
                            : (Array.isArray(med.pharmaceuticalForm) ? med.pharmaceuticalForm : []))
                        : [];
                      
                      setOriginalImages(allImages);
                      setOriginalForms(allForms);
                      setFormData({
                        nomCommercial: (med.commercial && Array.isArray(med.commercial) && med.commercial.length > 0) 
                          ? med.commercial[0] 
                          : (typeof med.commercial === 'string' ? med.commercial : ''),
                        dci: med.dci || '',
                        category: formData.category || 'G√©n√©ral',
                        image: allImages.length > 0 ? allImages[0] : null,
                        imageUrls: allImages,
                        allImageUrls: allImages, // Sauvegarder TOUTES les images
                        selectedImages: allImages.map((_, i) => i),
                        formePharma: allForms.join(', '),
                        posologie: '',
                        conseils: '',
                        contreIndications: '',
                        notes: ''
                      });
                      console.log('‚úÖ FormData mis √† jour:', formData);
                    } else {
                      console.error('‚ùå M√©dicament non trouv√© √† l\'index', selectedIndex);
                    }
                  }
                  console.groupEnd();
                }}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #3B82F6',
                  borderRadius: '8px',
                  fontSize: '0.9rem',
                  cursor: 'pointer',
                  background: 'var(--color-surface)'
                }}
              >
                <option value="">-- S√©lectionner un m√©dicament --</option>
                {(medications || []).sort((a, b) => a.dci.localeCompare(b.dci)).map((med, idx) => (
                  <option key={idx} value={idx}>
                    {med.dci} ({med.commercial && Array.isArray(med.commercial) ? med.commercial.join(', ') : (med.commercial || 'Sans nom')})
                  </option>
                ))}
              </select>
              <div style={{ fontSize: '0.75rem', color: 'var(--color-text-muted)', marginTop: '0.5rem', fontStyle: 'italic' }}>
                üí° Cliquer ici pour importer les infos d'un m√©dicament de vos flashcards
              </div>

              {/* S√âLECTION DES IMAGES */}
              {originalImages && originalImages.length > 0 && (
                <div style={{ marginTop: '1rem', padding: '1rem', background: 'var(--color-surface)', borderRadius: '8px', border: '2px solid var(--color-border)' }}>
                  <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.75rem', color: 'var(--color-text-primary)' }}>
                    ‚úì S√©lectionnez les images √† afficher ({formData.selectedImages?.length || 0}/{originalImages.length})
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '0.75rem' }}>
                    {originalImages.map((url, idx) => {
                      const isSelected = formData.selectedImages?.includes(idx);
                      return (
                        <div
                          key={idx}
                          onClick={(e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            const selected = formData.selectedImages || [];
                            const newSelected = isSelected
                              ? selected.filter(i => i !== idx)
                              : [...selected, idx];
                            
                            // R√©cup√©rer les images et formes correspondantes
                            const selectedImages = newSelected.map(i => originalImages[i]);
                            const selectedForms = newSelected
                              .map(i => originalForms[i])
                              .filter(f => f)
                              .join(', ');
                            
                            setFormData({
                              ...formData,
                              selectedImages: newSelected,
                              imageUrls: selectedImages,
                              image: selectedImages.length > 0 ? selectedImages[0] : null,
                              formePharma: selectedForms
                            });
                          }}
                          style={{
                            position: 'relative',
                            cursor: 'pointer',
                            border: `3px solid ${isSelected ? '#10B981' : '#e2e8f0'}`,
                            borderRadius: '8px',
                            overflow: 'hidden',
                            background: isSelected ? '#D1FAE5' : '#f8fafc',
                            transition: 'all 0.2s'
                          }}
                        >
                          <img
                            src={url}
                            alt={`Image ${idx + 1}`}
                            style={{
                              width: '100%',
                              height: '120px',
                              objectFit: 'cover',
                              opacity: isSelected ? 1 : 0.5
                            }}
                          />
                          <div style={{
                            position: 'absolute',
                            top: '0.5rem',
                            right: '0.5rem',
                            width: '24px',
                            height: '24px',
                            borderRadius: '50%',
                            background: isSelected ? '#10B981' : 'white',
                            border: `2px solid ${isSelected ? '#10B981' : '#cbd5e1'}`,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '0.75rem',
                            fontWeight: 700
                          }}>
                            {isSelected ? '‚úì' : ''}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Nom commercial</label>
                <input
                  type="text"
                  value={formData.nomCommercial}
                  onChange={(e) => setFormData({ ...formData, nomCommercial: e.target.value })}
                  placeholder="Ex: Dafalgan"
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid var(--color-border)',
                    borderRadius: '8px'
                  }}
                />
              </div>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>DCI *</label>
                <input
                  type="text"
                  value={formData.dci}
                  onChange={(e) => setFormData({ ...formData, dci: e.target.value })}
                  placeholder="Ex: Parac√©tamol"
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid var(--color-border)',
                    borderRadius: '8px'
                  }}
                />
              </div>
            </div>

            {/* Forme pharmaceutique */}
            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Forme pharmaceutique</label>
              <input
                type="text"
                value={formData.formePharma}
                onChange={(e) => setFormData({ ...formData, formePharma: e.target.value })}
                placeholder="Ex: Comprim√©, Sirop, Spray..."
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid var(--color-border)',
                  borderRadius: '8px'
                }}
              />
            </div>

            {/* Cat√©gorie */}
            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Cat√©gorie</label>
              <select
                value={formData.category || 'G√©n√©ral'}
                onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid var(--color-border)',
                  borderRadius: '8px',
                  background: 'var(--color-surface)',
                  cursor: 'pointer',
                  fontSize: '1rem'
                }}
              >
                {(() => {
                  // Charger les cat√©gories depuis plainte
                  let cats = plainte?.specCategories;
                  if (!cats || cats.length === 0) {
                    const saved = localStorage.getItem('specCategories_' + plainte?.id);
                    cats = saved ? JSON.parse(saved) : ['G√©n√©ral'];
                  }
                  return cats.map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ));
                })()}
              </select>
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Images de la bo√Æte</label>
              
              <button
                type="button"
                onClick={() => {
                  handleImageURL((url) => {
                    const currentImages = formData.imageUrls || [];
                    setFormData({ 
                      ...formData, 
                      imageUrls: [...currentImages, url],
                      image: currentImages.length === 0 ? url : formData.image
                    });
                  });
                }}
                style={{
                  width: '100%',
                  padding: '1rem',
                  border: '2px dashed #3B82F6',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  background: '#EFF6FF',
                  color: '#3B82F6',
                  fontWeight: 600,
                  marginBottom: '1rem'
                }}
              >
                + Ajouter une image par URL
              </button>

              {formData.imageUrls && formData.imageUrls.length > 0 && (
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(120px, 1fr))', gap: '0.75rem' }}>
                  {formData.imageUrls.filter(img => img && img.trim() !== '').map((img, idx) => (
                    <div key={idx} style={{ position: 'relative' }}>
                      <img
                        src={img}
                        alt={`Image ${idx + 1}`}
                        style={{
                          width: '100%',
                          height: '120px',
                          objectFit: 'cover',
                          borderRadius: '8px',
                          border: '2px solid var(--color-border)',
                          cursor: 'pointer'
                        }}
                        onClick={() => setFormData({ ...formData, zoomedImage: img })}
                      />
                      <button
                        type="button"
                        onClick={() => {
                          const newImages = formData.imageUrls.filter((_, i) => i !== idx);
                          setFormData({ 
                            ...formData, 
                            imageUrls: newImages,
                            image: newImages.length > 0 ? newImages[0] : null
                          });
                        }}
                        style={{
                          position: 'absolute',
                          top: '-8px',
                          right: '-8px',
                          background: '#ef4444',
                          color: 'white',
                          border: 'none',
                          width: '24px',
                          height: '24px',
                          borderRadius: '50%',
                          cursor: 'pointer',
                          fontSize: '0.7rem'
                        }}
                      >
                        ‚úï
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Posologie</label>
              <textarea
                value={formData.posologie}
                onChange={(e) => setFormData({ ...formData, posologie: e.target.value })}
                placeholder="Ex: Adultes: 1 cp toutes les 6h&#10;Enfants: 15mg/kg/6h"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid var(--color-border)',
                  borderRadius: '8px',
                  minHeight: '100px',
                  fontFamily: 'inherit'
                }}
              />
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Conseils</label>
              <textarea
                value={formData.conseils}
                onChange={(e) => setFormData({ ...formData, conseils: e.target.value })}
                placeholder="Ex: Avec de l'eau, pendant les repas"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid var(--color-border)',
                  borderRadius: '8px',
                  minHeight: '60px',
                  fontFamily: 'inherit'
                }}
              />
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Contre-indications</label>
              <textarea
                value={formData.contreIndications}
                onChange={(e) => setFormData({ ...formData, contreIndications: e.target.value })}
                placeholder="Ex: Insuffisance h√©patique"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid var(--color-border)',
                  borderRadius: '8px',
                  minHeight: '60px',
                  fontFamily: 'inherit'
                }}
              />
            </div>

            <div style={{ marginBottom: '2rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Notes</label>
              <textarea
                value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                placeholder="Ex: Rayon 3, tr√®s demand√©"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid var(--color-border)',
                  borderRadius: '8px',
                  minHeight: '60px',
                  fontFamily: 'inherit'
                }}
              />
            </div>

            <div style={{ display: 'flex', gap: '1rem' }}>
              <button
                onClick={() => {
                  if (!formData.dci?.trim()) {
                    alert('La DCI est obligatoire');
                    return;
                  }
                  // Filtrer les images selon la s√©lection
                  // formData.imageUrls contient d√©j√† les images s√©lectionn√©es (mises √† jour dans le onChange)
                  const filteredData = {
                    ...formData,
                    imageUrls: (formData.imageUrls || []).filter(img => img && img.trim() !== ''),
                    allImageUrls: originalImages.length > 0 ? originalImages : (formData.allImageUrls || []), // Garder TOUTES les images
                    image: formData.imageUrls && formData.imageUrls.length > 0
                      ? formData.imageUrls[0]
                      : formData.image
                  };
                  onSave(filteredData);
                }}
                style={{
                  flex: 1,
                  background: categoryColor,
                  color: 'white',
                  border: 'none',
                  padding: '1rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                {specialite ? 'Enregistrer' : 'Ajouter'}
              </button>
              <button
                onClick={onCancel}
                style={{
                  flex: 1,
                  background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                  color: '#475569',
                  border: 'none',
                  padding: '1rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
        </div>
      );
    }
    // ========== FIN CODE CONSEILS OFFICINE ==========



    // IC√îNES SVG
    const BookOpen = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
      </svg>
    );
    const Brain = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/>
        <path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/>
      </svg>
    );
    const ChevronLeft = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    );
    const ChevronRight = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    );
    const Settings = ({ size = 24, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6"/>
      </svg>
    );
    const Plus = ({ size = 24, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
    );
    const Trash2 = ({ size = 24, color }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
      </svg>
    );
    const Edit = ({ size = 24, color }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
    );
    const Edit2 = ({ size = 24, color }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
      </svg>
    );
    const Camera = ({ size = 24, color }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>
      </svg>
    );
    const Database = ({ size = 24, color }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
      </svg>
    );
    const Check = ({ size = 24, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    );
    const X = ({ size = 24, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    );

    
// ========================================
    // LISTE DES M√âDICAMENTS DE D√âPART
    // ========================================
    // Cette liste sera charg√©e automatiquement pour tous les utilisateurs
    // Pour ajouter vos 272 m√©dicaments, remplacez simplement ce tableau
    // Format : { dci: "...", commercial: ["..."], category: "...", image: null }
    
    const INITIAL_MEDS = [];

const INITIAL_CLASSES = {};

function PharmaSpace() {
  
  const [mode, setMode] = useState('accueil'); // D√©marrer sur accueil
  const resetConseilsViewRef = React.useRef(null);
  const [plaintes, setPlaintes] = useState(() => {
    const saved = localStorage.getItem('conseilsOfficine');
    return saved ? JSON.parse(saved) : [];
  });
  
  // States pour Ressources
  const INITIAL_RESSOURCES = [
    {
      id: 'cat_1',
      nom: 'Bases de donn√©es',
      liens: [
        { id: 'link_1', nom: 'Th√©riaque', url: 'https://www.theriaque.org/apps/contenu/accueil.php', description: 'Base fran√ßaise des m√©dicaments' },
        { id: 'link_2', nom: 'CBIP', url: 'https://www.cbip.be/fr/', description: 'Centre Belge d\'Information Pharmacoth√©rapeutique' },
        { id: 'link_3', nom: 'AFMPS', url: 'https://www.afmps.be/fr', description: 'Agence F√©d√©rale des M√©dicaments' }
      ]
    },
    {
      id: 'cat_2',
      nom: 'Tabac',
      liens: [
        { id: 'link_4', nom: 'Info TABACSTOP', url: 'https://cancer.be/prevention/ne-pas-fumer/', description: 'Service d\'aide au sevrage tabagique' },
        { id: 'link_5', nom: 'R√©pertoire tabacologues', url: 'https://repertoire.fares.be/', description: 'Trouver un tabacologue en Belgique' }
      ]
    },
    {
      id: 'cat_3',
      nom: 'Apprentissage',
      liens: [
        { id: 'link_6', nom: 'CBIP - Auditorium', url: 'https://www.cbip.be/fr/formations/auditorium-elearnings/', description: 'E-learnings et formations' },
        { id: 'link_7', nom: 'APB (+Phil)', url: 'https://www.apb.be/fr-BE', description: 'Association Pharmaceutique Belge' },
        { id: 'link_8', nom: 'SSPF', url: 'https://www.sspf.be/', description: 'Soci√©t√© Scientifique des Pharmaciens Francophones' }
      ]
    },
    {
      id: 'cat_4',
      nom: 'Grossesse - Contraception - Allaitement',
      liens: [
        { id: 'link_9', nom: 'Ma contraception d\'urgence', url: 'https://www.macontraceptiondurgence.be/', description: 'Infos patient contraception d\'urgence' },
        { id: 'link_10', nom: 'Cybele', url: 'https://www.cybele.be/indexlist.php', description: 'M√©dicaments et grossesse' },
        { id: 'link_11', nom: 'Le CRAT', url: 'https://www.lecrat.fr/', description: 'Centre de R√©f√©rence Agents T√©ratog√®nes' },
        { id: 'link_12', nom: 'Lareb', url: 'https://www.lareb.nl/', description: 'M√©dicaments et grossesse (NL)' },
        { id: 'link_13', nom: 'La leche league', url: 'https://lllbelgique.org/', description: 'Support allaitement maternel' },
        { id: 'link_14', nom: 'Infor allaitement', url: 'https://www.infor-allaitement.be/', description: 'Information et soutien allaitement' },
        { id: 'link_15', nom: 'Lactancia', url: 'https://e-lactancia.org/', description: 'Compatibilit√© m√©dicaments et allaitement' },
        { id: 'link_16', nom: 'LactMed', url: 'https://www.ncbi.nlm.nih.gov/books/NBK501922/', description: 'Base de donn√©es m√©dicaments et allaitement' }
      ]
    },
    {
      id: 'cat_5',
      nom: 'Pr√©parations magistrales',
      liens: [
        { id: 'link_17', nom: 'Qualit√© m√©dico-pharmaceutique', url: 'https://www.mfk-qmp.be/fr', description: 'Standards de qualit√© pr√©parations' },
        { id: 'link_18', nom: 'FTM', url: 'https://www.tmf-ftm.be/fr_FR/web/pharmacist/welcome', description: 'Formulaire Th√©rapeutique Magistral' }
      ]
    },
    {
      id: 'cat_6',
      nom: 'Interactions m√©dicamenteuses',
      liens: [
        { id: 'link_19', nom: 'Medscape', url: 'https://reference.medscape.com/drug-interactionchecker', description: 'V√©rificateur d\'interactions complet' },
        { id: 'link_20', nom: 'Drugs.com', url: 'https://www.drugs.com/drug_interactions.html', description: 'Base de donn√©es interactions' }
      ]
    }
  ];
  
  const [ressources, setRessources] = useState(() => {
    const saved = localStorage.getItem('ressources');
    const data = saved ? JSON.parse(saved) : INITIAL_RESSOURCES;
    // S'assurer que chaque cat√©gorie a un tableau liens
    return (data || []).map(cat => ({
      ...cat,
      liens: cat.liens || []
    }));
  });
  
  const [hoveredCategory, setHoveredCategory] = useState(null);
  const [hoveredLink, setHoveredLink] = useState(null);
  const [showAddCategory, setShowAddCategory] = useState(false);
  const [showManageCategories, setShowManageCategories] = useState(false);
  const [showAddLink, setShowAddLink] = useState(null);
  const [showAddLinkGlobal, setShowAddLinkGlobal] = useState(false);
  const [editingCategory, setEditingCategory] = useState(null);
  const [editingLink, setEditingLink] = useState(null);
  const [categoryForm, setCategoryForm] = useState({ nom: '' });
  const [linkForm, setLinkForm] = useState({ nom: '', url: '', description: '', categoryId: '' });
  const [draggedLink, setDraggedLink] = useState(null);
  const [draggedCategory, setDraggedCategory] = useState(null);
  
  // Sauvegarder ressources
  const saveRessources = (newRessources) => {
    setRessources(newRessources);
    localStorage.setItem('ressources', JSON.stringify(newRessources));
    if (firebaseEnabled) {
      db.ref('ressources').set(newRessources).catch(err => {
        console.error('‚ùå Erreur sauvegarde ressources:', err);
      });
    }
  };
  
  // Listener Firebase pour ressources
  useEffect(() => {
    if (firebaseEnabled) {
      const ressourcesRef = db.ref('ressources');
      ressourcesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• Ressources mis √† jour depuis Firebase');
          // S'assurer que chaque cat√©gorie a un tableau liens
          const cleanedData = (data || []).map(cat => ({
            ...cat,
            liens: cat.liens || []
          }));
          setRessources(cleanedData);
          localStorage.setItem('ressources', JSON.stringify(cleanedData));
        }
      });
      return () => ressourcesRef.off();
    }
  }, []);
  
  // √âcouter les changements de plaintes
  
  // ========== S√âMINAIRES ==========
  const [seminaires, setSeminaires] = useState(() => {
    const saved = localStorage.getItem('seminaires');
    const data = saved ? JSON.parse(saved) : [];
    return (data || []).map(cat => ({
      ...cat,
      liens: cat.liens || []
    }));
  });
  
  const [activeCategorySeminaire, setActiveCategorySeminaire] = useState(0);
  const [showAddSeminaireLink, setShowAddSeminaireLink] = useState(false);
  const [showManageCategoriesSeminaires, setShowManageCategoriesSeminaires] = useState(false);
  const [editingCategorySeminaire, setEditingCategorySeminaire] = useState(null);
  const [editingLinkSeminaire, setEditingLinkSeminaire] = useState(null);
  const [categoryFormSeminaire, setCategoryFormSeminaire] = useState({ nom: '' });
  const [linkFormSeminaire, setLinkFormSeminaire] = useState({ nom: '', url: '', description: '', categoryId: '' });
  const [draggedLinkSeminaire, setDraggedLinkSeminaire] = useState(null);
  const [draggedCategorySeminaire, setDraggedCategorySeminaire] = useState(null);
  const [hoveredLinkSeminaire, setHoveredLinkSeminaire] = useState(null);
  
  // Sauvegarder s√©minaires
  const saveSeminaires = (newSeminaires) => {
    setSeminaires(newSeminaires);
    localStorage.setItem('seminaires', JSON.stringify(newSeminaires));
    if (firebaseEnabled) {
      db.ref('seminaires').set(newSeminaires).catch(err => {
        console.error('‚ùå Erreur sauvegarde s√©minaires:', err);
      });
    }
  };
  
  // Listener Firebase pour s√©minaires
  useEffect(() => {
    if (firebaseEnabled) {
      const seminairesRef = db.ref('seminaires');
      seminairesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• S√©minaires mis √† jour depuis Firebase');
          const cleanedData = (data || []).map(cat => ({
            ...cat,
            liens: cat.liens || []
          }));
          setSeminaires(cleanedData);
          localStorage.setItem('seminaires', JSON.stringify(cleanedData));
        }
      });
      return () => seminairesRef.off();
    }
  }, []);
  
  // √âcouter les changements de plaintes
  useEffect(() => {
    const handlePlaintesUpdate = () => {
      const saved = localStorage.getItem('conseilsOfficine');
      if (saved) {
        setPlaintes(JSON.parse(saved));
      }
    };
    
    window.addEventListener('plaintesUpdated', handlePlaintesUpdate);
    
    return () => {
      window.removeEventListener('plaintesUpdated', handlePlaintesUpdate);
    };
  }, []);
    
    // DEBUG: V√©rifier les flashcards au chargement
    React.useEffect(() => {
      console.group('üöÄ PharmaSpace - Diagnostic au chargement');
      try {
        // V√©rifier TOUTES les cl√©s localStorage
        console.log('üîë Cl√©s localStorage disponibles:');
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.includes('flash') || key.includes('card') || key.includes('med') || key.includes('pharma')) {
            try {
              const value = localStorage.getItem(key);
              const parsed = JSON.parse(value || '[]');
              const count = Array.isArray(parsed) ? parsed.length : (parsed ? 'objet' : 'vide');
              console.log(`  - ${key}: ${count} √©l√©ments`);
              if (Array.isArray(parsed) && parsed.length > 0) {
                console.log('    Exemple:', parsed[0].dci || parsed[0].commercial || parsed[0].nom || Object.keys(parsed[0]).slice(0, 3));
              }
            } catch(e) {
              console.log(`  - ${key}: non-JSON`);
            }
          }
        }
        
        // Sp√©cifiquement flashcards
        const flashcards = JSON.parse(localStorage.getItem('pharmaspace_medications') || '[]');
        console.log('\nüìä localStorage["pharmaspace_medications"]:', flashcards.length, '√©l√©ments');
        
        // Essayer pharmaspace_medications
        const meds = localStorage.getItem('pharmaspace_medications');
        if (meds) {
          try {
            const parsed = JSON.parse(meds);
            console.log('üìä localStorage["pharmaspace_medications"]:', Array.isArray(parsed) ? parsed.length : 'objet', '√©l√©ments');
            if (Array.isArray(parsed) && parsed.length > 0) {
              console.log('  Exemple:', parsed[0]);
            }
          } catch(e) {
            console.log('üìä localStorage["pharmaspace_medications"]: erreur parsing');
          }
        }
        
        if (flashcards.length > 0) {
          console.log('\n‚úÖ Exemples de flashcards:');
          flashcards.slice(0, 5).forEach(f => {
            console.log('  -', f.dci, '(', f.commercial?.join(', ') || 'sans nom', ')', '‚Üí', f.classe || f.category);
          });
        } else {
          console.warn('\n‚ö†Ô∏è AUCUNE flashcard dans localStorage["flashcards"] !');
        }
        
        const conseils = JSON.parse(localStorage.getItem('conseilsOfficine') || '[]');
        console.log('\nüìã Nombre de fiches conseils:', conseils.length);
        if (conseils.length > 0) {
          const firstPlainte = conseils[0];
          console.log('‚úÖ Exemple de fiche:', firstPlainte.nom);
          if (firstPlainte.specialites && firstPlainte.specialites.length > 0) {
            console.log('  Sp√©cialit√©s:', firstPlainte.specialites.length);
            console.log('  Exemple:', firstPlainte.specialites[0].nomCommercial || firstPlainte.specialites[0].dci);
          }
        }
      } catch(e) {
        console.error('‚ùå Erreur diagnostic:', e);
      }
      console.groupEnd();
    }, []);
  const [imageModalUrl, setImageModalUrl] = useState(null);
  const [firebaseStatus, setFirebaseStatus] = useState(firebaseEnabled ? 'üü¢ Connect√©' : 'üü° Local');
  const [isOnline, setIsOnline] = useState(navigator.onLine && firebaseEnabled);
  const [showOfflineWarning, setShowOfflineWarning] = useState(false);
  
  // D√©tecter les changements de connexion
  useEffect(() => {
    const updateOnlineStatus = () => {
      const online = navigator.onLine && firebaseEnabled;
      setIsOnline(online);
      setFirebaseStatus(online ? 'üü¢ Connect√©' : 'üî¥ Hors ligne');
    };

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    return () => {
      window.removeEventListener('online', updateOnlineStatus);
      window.removeEventListener('offline', updateOnlineStatus);
    };
  }, []);
  
  // Handler pour les actions n√©cessitant une connexion
  const handleOfflineAction = (action) => {
    if (!isOnline) {
      alert('‚ö†Ô∏è Connexion Internet requise\n\nVous devez √™tre connect√© √† Internet pour modifier les donn√©es.\n\nVos donn√©es sont consultables hors ligne, mais toute modification n√©cessite une synchronisation avec Firebase.');
      return false;
    }
    action();
    return true;
  };
  
  const [medications, setMedications] = useState(() => {
    // Fonction pour ajouter des IDs si manquants
    const ensureIds = (meds) => {
      return meds.map(med => {
        if (!med.id) {
          return {
            ...med,
            id: `med_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
          };
        }
        return med;
      });
    };
    
    // Si Firebase est activ√©, on attend Firebase (pas de localStorage)
    if (firebaseEnabled) {
      return ensureIds(INITIAL_MEDS); // Temporaire, sera remplac√© par Firebase
    }
    // Si Firebase d√©sactiv√©, charger depuis localStorage
    const saved = localStorage.getItem('pharmaspace_medications');
    return saved ? ensureIds(JSON.parse(saved)) : ensureIds(INITIAL_MEDS);
  });
  
  // √âcouter les changements Firebase pour medications
  useEffect(() => {
    if (firebaseEnabled) {
      const medsRef = db.ref('medications');
      medsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• Medications mis √† jour depuis Firebase');
          // Ajouter des IDs si manquants
          const dataWithIds = data.map(med => {
            if (!med.id) {
              return {
                ...med,
                id: `med_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
              };
            }
            return med;
          });
          setMedications(dataWithIds);
          localStorage.setItem('pharmaspace_medications', JSON.stringify(dataWithIds));
        }
      });
      
      // Listener global pour conseilsOfficine (pour notifier les flashcards)
      const plaintesRefGlobal = db.ref('conseilsOfficine');
      plaintesRefGlobal.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• conseilsOfficine chang√© (listener global pour flashcards)');
          // NE PAS toucher au state, juste mettre √† jour localStorage
          localStorage.setItem('conseilsOfficine', JSON.stringify(data));
          // Notifier les flashcards
          window.dispatchEvent(new CustomEvent('plaintesUpdated'));
        }
      });
      
      return () => {
        medsRef.off();
        plaintesRefGlobal.off();
      };
    }
  }, []);
  
  const [therapeuticClasses, setTherapeuticClasses] = useState(() => {
    if (firebaseEnabled) {
      return INITIAL_CLASSES; // Temporaire, sera remplac√© par Firebase
    }
    const saved = localStorage.getItem('pharmaspace_classes');
    return saved ? JSON.parse(saved) : INITIAL_CLASSES;
  });
  
  // √âcouter les changements Firebase pour classes
  useEffect(() => {
    if (firebaseEnabled) {
      const classesRef = db.ref('classes');
      classesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• Classes mis √† jour depuis Firebase');
          setTherapeuticClasses(data);
          localStorage.setItem('pharmaspace_classes', JSON.stringify(data));
        }
      });
      
      return () => classesRef.off();
    }
  }, []);
  
  // √âcouter les changements Firebase pour forms
  useEffect(() => {
    if (firebaseEnabled) {
      const formsRef = db.ref('forms');
      formsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• Forms mis √† jour depuis Firebase');
          setPharmaceuticalForms(data);
          localStorage.setItem('pharmaspace_forms', JSON.stringify(data));
        }
      });
      
      return () => formsRef.off();
    }
  }, []);
  
  // Wrapper pour sauvegarder medications sur Firebase
  const saveMedications = (newMedications) => {
    setMedications(newMedications);
    localStorage.setItem('pharmaspace_medications', JSON.stringify(newMedications));
    if (firebaseEnabled) {
      // Nettoyer les propri√©t√©s undefined avant d'envoyer √† Firebase
      const cleanedMedications = newMedications.map(med => {
        const cleaned = { ...med };
        // Supprimer les propri√©t√©s undefined
        Object.keys(cleaned).forEach(key => {
          if (cleaned[key] === undefined) {
            delete cleaned[key];
          }
        });
        // S'assurer que nextReview et interval existent (null si pas d√©fini)
        if (!('nextReview' in cleaned)) cleaned.nextReview = null;
        if (!('interval' in cleaned)) cleaned.interval = null;
        return cleaned;
      });
      
      db.ref('medications').set(cleanedMedications).catch(err => {
        console.error('‚ùå Erreur sauvegarde medications:', err);
      });
    }
  };
  
  // Wrapper pour sauvegarder classes sur Firebase
  const saveClasses = (newClasses) => {
    setTherapeuticClasses(newClasses);
    localStorage.setItem('pharmaspace_classes', JSON.stringify(newClasses));
    if (firebaseEnabled) {
      db.ref('classes').set(newClasses).catch(err => {
        console.error('‚ùå Erreur sauvegarde classes:', err);
      });
    }
  };
  
  // Wrapper pour sauvegarder forms sur Firebase  
  const saveForms = (newForms) => {
    setPharmaceuticalForms(newForms);
    localStorage.setItem('pharmaspace_forms', JSON.stringify(newForms));
    if (firebaseEnabled) {
      db.ref('forms').set(newForms).catch(err => {
        console.error('‚ùå Erreur sauvegarde forms:', err);
      });
    }
  };
  
  const [pharmaceuticalForms, setPharmaceuticalForms] = useState(() => {
    if (firebaseEnabled) {
      // Si Firebase activ√©, liste par d√©faut (sera remplac√© par Firebase)
      return [
        'A√©rosol-doseur',
        'Autre',
        'Bain de bouche',
        'Capsule',
        'Capsule P√©dia.',
        'Capsules molles',
        'Collyre',
        'Comprim√©',
      'Comprim√© effervescent',
      'Comprim√© orodispersible',
      'Comprim√© sublingual',
      'Comprim√©s √† croquer',
      'Cr√®me',
      'Gel',
      'Globules',
      'Gouttes',
      'Gouttes auriculaires',
      'Gouttes auriculaires et collyre',
      'Gouttes nasal',
      'Granule effervescent',
      'Granul√©s',
      'G√©lule',
      'Lotion',
      'Lyophilisat',
      'Ovule',
      'Pastille',
      'Patch',
      'Pommade',
      'Pommade nasal',
      'Pommade ophtalmique',
      'Poudre pour inhalation',
      'Poudre pour sirop',
      'Poudre pour solution',
      'Poudre pour solution injectable',
      'Poudre pour suspension',
      'Poudre pour suspension buvable',
      'Poudre pour suspension injectable',
      'Sachet',
      'Sachet P√©dia.',
      'Sachet pour sirop',
      'Shampoing',
      'Sirop',
      'Sirop P√©dia.',
      'Solution',
      'Solution buvable',
      'Solution buvable en gouttes',
      'Solution cutan√©e',
      'Solution injectable',
      'Solution nasal',
      'Solution pour inhalation',
      'Solution pour inhalation/n√©bulisation',
      'Solution pour n√©bulisation',
      'Solution pour n√©bulisation/inhalation',
      'Solution rectale',
      'Spray',
      'Spray buccal',
      'Spray nasal',
      'Spray nasal Baby',
      'Spray nasal P√©dia.',
      'Suppo P√©dia',
      'Suppositoire',
      'Suppositoire P√©dia.',
      'Suspension',
      'Suspension buvable',
      'Suspension injectable',
      'Suspension pour inhalation'
    ];
    }
    // Si Firebase d√©sactiv√©, charger depuis localStorage
    const saved = localStorage.getItem('pharmaspace_forms');
    return saved ? JSON.parse(saved) : [
      'A√©rosol-doseur',
      'Autre',
      'Bain de bouche',
      'Capsule',
      'Capsule P√©dia.',
      'Capsules molles',
      'Collyre',
      'Comprim√©',
      'Comprim√© effervescent',
      'Comprim√© orodispersible',
      'Comprim√© sublingual',
      'Comprim√©s √† croquer',
      'Cr√®me',
      'Gel',
      'Globules',
      'Gouttes',
      'Gouttes auriculaires',
      'Gouttes auriculaires et collyre',
      'Gouttes nasal',
      'Granule effervescent',
      'Granul√©s',
      'G√©lule',
      'Lotion',
      'Lyophilisat',
      'Ovule',
      'Pastille',
      'Patch',
      'Pommade',
      'Pommade nasal',
      'Pommade ophtalmique',
      'Poudre pour inhalation',
      'Poudre pour sirop',
      'Poudre pour solution',
      'Poudre pour solution injectable',
      'Poudre pour suspension',
      'Poudre pour suspension buvable',
      'Poudre pour suspension injectable',
      'Sachet',
      'Sachet P√©dia.',
      'Sachet pour sirop',
      'Shampoing',
      'Sirop',
      'Sirop P√©dia.',
      'Solution',
      'Solution buvable',
      'Solution buvable en gouttes',
      'Solution cutan√©e',
      'Solution injectable',
      'Solution nasal',
      'Solution pour inhalation',
      'Solution pour inhalation/n√©bulisation',
      'Solution pour n√©bulisation',
      'Solution pour n√©bulisation/inhalation',
      'Solution rectale',
      'Spray',
      'Spray buccal',
      'Spray nasal',
      'Spray nasal Baby',
      'Spray nasal P√©dia.',
      'Suppo P√©dia',
      'Suppositoire',
      'Suppositoire P√©dia.',
      'Suspension',
      'Suspension buvable',
      'Suspension injectable',
      'Suspension pour inhalation'
    ];
  });
    const [currentIndex, setCurrentIndex] = useState(0);
  const [currentMedDCI, setCurrentMedDCI] = useState(null);
  const [showAnswer, setShowAnswer] = useState(false);
  const [hoveredCardIndex, setHoveredCardIndex] = useState(null);
  
  // M√©moriser le DCI du m√©dicament actuel
  useEffect(() => {
    const currentMed = getFlashcardListMedications[currentIndex];
    if (currentMed) {
      setCurrentMedDCI(currentMed.dci);
    }
  }, [currentIndex, getFlashcardListMedications]);
  
  // Restaurer la position quand la liste change (apr√®s ajout de note)
  // IMPORTANT: Ne pas restaurer lors de la navigation normale (handleNext/handlePrev)
  const [lastRefreshKey, setLastRefreshKey] = useState(refreshKey);
  
  useEffect(() => {
    console.log('üîç useEffect restauration - refreshKey:', refreshKey, 'lastRefreshKey:', lastRefreshKey);
    
    // Si refreshKey n'a pas chang√©, c'est juste une navigation normale ‚Üí skip
    if (refreshKey === lastRefreshKey) {
      console.log('‚è≠Ô∏è  Skip restauration - navigation normale');
      return;
    }
    
    // Mettre √† jour le lastRefreshKey
    setLastRefreshKey(refreshKey);
    
    if (isForceRepositioning) {
      console.log('‚è∏Ô∏è  Restauration d√©sactiv√©e (repositionnement forc√© en cours)');
      return;
    }
    
    if (currentMedDCI && getFlashcardListMedications) {
      console.log('üîç Recherche de', currentMedDCI, 'dans la liste de', getFlashcardListMedications.length, 'm√©dicaments');
      const newIndex = getFlashcardListMedications.findIndex(med => med.dci === currentMedDCI);
      console.log('üîç Trouv√© √† l\'index:', newIndex, 'vs currentIndex:', currentIndex);
      if (newIndex !== -1 && newIndex !== currentIndex) {
        console.log('üìç REPOSITIONNEMENT apr√®s refreshKey change:', currentMedDCI, 'de l\'index', currentIndex, '‚Üí', newIndex);
        setCurrentIndex(newIndex);
      } else if (newIndex === -1) {
        console.error('‚ùå M√©dicament', currentMedDCI, 'non trouv√© dans la liste!');
      } else {
        console.log('‚úÖ D√©j√† au bon index');
      }
    } else {
      console.log('‚è≠Ô∏è  Skip restauration - currentMedDCI:', currentMedDCI, 'liste:', !!getFlashcardListMedications);
    }
  }, [refreshKey, currentMedDCI]);
  const [flashcardView, setFlashcardView] = useState('list');
  const [showSettings, setShowSettings] = useState(false);
  const [showManagement, setShowManagement] = useState(false);
  
  const [selectionMode, setSelectionMode] = useState('all');
  const [selectedClasses, setSelectedClasses] = useState([]);
  const [selectedMeds, setSelectedMeds] = useState([]);
    const [stats, setStats] = useState({ correct: 0, total: 0 });
  const [userAnswer, setUserAnswer] = useState('');
          const [sortBy, setSortBy] = useState('commercial');
  const [filterCategory, setFilterCategory] = useState('all');
  const [editingIndex, setEditingIndex] = useState(null);
  const [customMed, setCustomMed] = useState({ dci: '', commercial: '', category: '', imageUrls: '', pharmaceuticalForm: '' });
  const [imageUpdated, setImageUpdated] = useState(false);
  const [listUpdateKey, setListUpdateKey] = useState(0);
  const [searchQuery, setSearchQuery] = useState('');
  const [debouncedSearchQuery, setDebouncedSearchQuery] = useState('');
  const [showSearchDropdown, setShowSearchDropdown] = useState(false);
  const [searchResults, setSearchResults] = useState({ flashcards: [], fiches: [] });
  
  // Debounce pour la recherche (300ms)
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedSearchQuery(searchQuery);
    }, 300);
    return () => clearTimeout(timer);
  }, [searchQuery]);
  
  const [errorMessage, setErrorMessage] = useState('');
  const [showClassManager, setShowClassManager] = useState(false);
  const [newClassName, setNewClassName] = useState('');
  const [newClassColor, setNewClassColor] = useState('#64748b');
  const [editingClass, setEditingClass] = useState(null);
  const [showFormManager, setShowFormManager] = useState(false);
  const [newFormName, setNewFormName] = useState('');
  const [editingForm, setEditingForm] = useState(null);
  const [flashcardListSort, setFlashcardListSort] = useState('commercial');
  const [notesCountCache, setNotesCountCache] = useState({});
  const [expandedCard, setExpandedCard] = useState(null);
  const [editingItemId, setEditingItemId] = useState(null);
  const [editingText, setEditingText] = useState('');
  const [refreshKey, setRefreshKey] = useState(0);
  const [showNotesModal, setShowNotesModal] = useState(false);
      const [modalMedication, setModalMedication] = useState(null);
      const [pendingCacheUpdate, setPendingCacheUpdate] = useState(false);
      const [isForceRepositioning, setIsForceRepositioning] = useState(false);
      const [medicationToReposition, setMedicationToReposition] = useState(null);
      
  // Recalculer le cache quand la modale se ferme
  useEffect(() => {
    console.log('üîç useEffect fermeture - showNotesModal:', showNotesModal, 'pendingCacheUpdate:', pendingCacheUpdate, 'modalMedication:', modalMedication?.dci);
    if (!showNotesModal && pendingCacheUpdate && modalMedication) {
      console.log('üîÑ Recalcul du cache apr√®s fermeture modale');
      const medName = modalMedication.commercial?.[0] || modalMedication.dci;
      console.log('üìù M√©dicament √† repositionner:', medName);
      
      // Sauvegarder le m√©dicament √† repositionner (utiliser le NOM pas le DCI)
      setMedicationToReposition(medName);
      
      // Bloquer le useEffect de restauration
      setIsForceRepositioning(true);
      
      // Recalculer le cache
      setRefreshKey(prev => prev + 1);
      setPendingCacheUpdate(false);
    }
  }, [showNotesModal, pendingCacheUpdate, modalMedication]);
  
  // useEffect s√©par√© pour le repositionnement apr√®s recalcul du cache
  useEffect(() => {
    if (medicationToReposition && !pendingCacheUpdate && !showNotesModal) {
      console.log('üéØ D√©but repositionnement sur:', medicationToReposition);
      
      setTimeout(() => {
        // Chercher avec le NOM (pas le DCI) car le cache utilise maintenant le nom
        const newIndex = getFlashcardListMedications.findIndex(med => {
          const medName = med.commercial[0] || med.dci;
          return medName === medicationToReposition;
        });
        console.log('üîç Index trouv√©:', newIndex, 'pour', medicationToReposition);
        
        if (newIndex !== -1 && newIndex !== currentIndex) {
          console.log('%cüìç CHANGEMENT D\'INDEX: ' + currentIndex + ' ‚Üí ' + newIndex, 'background: #00ff00; color: #000; font-size: 20px; font-weight: bold; padding: 10px;');
          console.log('%cM√©dicament: ' + medicationToReposition, 'background: #00ff00; color: #000; font-size: 16px; padding: 5px;');
          console.log('AVANT setCurrentIndex - currentIndex:', currentIndex);
          setCurrentIndex(newIndex);
          console.log('APR√àS setCurrentIndex - devrait √™tre:', newIndex);
          setCurrentMedDCI(medicationToReposition);
        } else if (newIndex === currentIndex) {
          console.log('%c‚úÖ D√©j√† au bon index: ' + currentIndex, 'background: #ffff00; color: #000; font-size: 16px; padding: 5px;');
        } else {
          console.error('%c‚ùå M√©dicament non trouv√©!', 'background: #ff0000; color: #fff; font-size: 20px; font-weight: bold; padding: 10px;');
        }
        
        // Nettoyer
        setMedicationToReposition(null);
        setIsForceRepositioning(false);
        console.log('‚úÖ Repositionnement termin√©');
      }, 300);
    }
  }, [medicationToReposition, pendingCacheUpdate, showNotesModal, getFlashcardListMedications]);
  const [addingNoteType, setAddingNoteType] = useState(null);
  const [newNoteText, setNewNoteText] = useState('');
  const [showDataManagement, setShowDataManagement] = useState(false);
  
  // Mode sombre
  const [darkMode, setDarkMode] = useState(() => {
    const saved = localStorage.getItem('darkMode');
    return saved === 'true';
  });
  
  // Appliquer le th√®me
  useEffect(() => {
    document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
    localStorage.setItem('darkMode', darkMode);
  }, [darkMode]);
  
  // Calculer le cache des notes/conseils UNE SEULE FOIS
  useEffect(() => {
    // Ne pas recalculer si la modale de notes est ouverte (pour √©viter de changer de m√©dicament)
    if (showNotesModal) {
      console.log('‚è∏Ô∏è  Cache en attente (modale ouverte)');
      return;
    }
    
    if (medications && medications.length > 0) {
      console.log('üîÑ Calcul du cache notes/conseils...');
      const cache = {};
      medications.forEach(med => {
        const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
        const name = (med.commercial && Array.isArray(med.commercial) && med.commercial.length > 0) ? med.commercial[0] : med.dci;
        
        // CORRECTION: Utiliser le nom commercial comme cl√© (plus unique que le DCI)
        const key = name; // Utiliser le nom pour identifier de fa√ßon unique
        const count = getConsolidatedNotesConseils(name, images).length;
        cache[key] = count;
        
        // Log pour Plantspray ou autres avec "plant" dans le nom
        if (name.toLowerCase().includes('plant') || med.dci.toLowerCase().includes('plant')) {
          console.log('üìä Cache: nom="' + name + '", dci="' + med.dci + '", cl√©="' + key + '" ‚Üí ' + count + ' notes/conseils');
          console.log('   getConsolidatedNotesConseils("' + name + '") retourne:', getConsolidatedNotesConseils(name, images));
        }
      });
      setNotesCountCache(cache);
      console.log('‚úÖ Cache calcul√©:', Object.keys(cache).length, 'm√©dicaments');
    }
  }, [medications, notesParSpecialite, refreshKey, showNotesModal]);
  
  // Force update quand on ajoute/supprime des notes standalone
  useEffect(() => {
    const standaloneKey = 'notesConseils_standalone';
    const handleStorageChange = () => {
      if (!showNotesModal) {
        console.log('üîÑ Mise √† jour d√©tect√©e dans notes standalone');
        setRefreshKey(prev => prev + 1);
      }
    };
    
    const handlePlaintesUpdate = () => {
      console.log('üîÑ Mise √† jour d√©tect√©e dans les plaintes');
      console.log('   ‚Üí refreshKey va √™tre incr√©ment√©');
      console.log('   ‚Üí Cache va √™tre recalcul√©');
      setRefreshKey(prev => {
        console.log('   ‚Üí refreshKey:', prev, '‚Üí', prev + 1);
        return prev + 1;
      });
    };
    
    window.addEventListener('storage', handleStorageChange);
    window.addEventListener('plaintesUpdated', handlePlaintesUpdate);
    
    return () => {
      window.removeEventListener('storage', handleStorageChange);
      window.removeEventListener('plaintesUpdated', handlePlaintesUpdate);
    };
  }, [showNotesModal]);

  // Notes et Conseils par sp√©cialit√© (nom commercial)
  const [notesParSpecialite, setNotesParSpecialite] = useState(() => {
    if (firebaseEnabled) {
      return {}; // Temporaire, sera remplac√© par Firebase
    }
    const saved = localStorage.getItem('pharmaspace_notes');
    return saved ? JSON.parse(saved) : {};
  });
  
  // √âcouter les changements Firebase pour notes
  useEffect(() => {
    if (firebaseEnabled) {
      const notesRef = db.ref('notesParSpecialite');
      notesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• Notes mis √† jour depuis Firebase');
          setNotesParSpecialite(data);
          localStorage.setItem('pharmaspace_notes', JSON.stringify(data));
        }
      });
      
      // √âcouter aussi les notes standalone
      const standaloneRef = db.ref('notesConseils_standalone');
      standaloneRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• Notes standalone mises √† jour depuis Firebase');
          
          // Nettoyer les donn√©es corrompues
          const cleanedData = {};
          Object.keys(data).forEach(key => {
            if (data[key] && typeof data[key] === 'object') {
              cleanedData[key] = {
                notes: Array.isArray(data[key].notes) ? data[key].notes : [],
                conseils: Array.isArray(data[key].conseils) ? data[key].conseils : [],
                images: data[key].images || [],
                dci: data[key].dci || '',
                nomCommercial: data[key].nomCommercial || ''
              };
            }
          });
          
          localStorage.setItem('notesConseils_standalone', JSON.stringify(cleanedData));
          setRefreshKey(prev => prev + 1); // Forcer le recalcul du cache
        }
      });
      
      return () => {
        notesRef.off();
        standaloneRef.off();
      };
    }
  }, []);
  
  // Wrapper pour sauvegarder notes sur Firebase
  const saveNotesParSpecialite = (newNotes) => {
    setNotesParSpecialite(newNotes);
    localStorage.setItem('pharmaspace_notes', JSON.stringify(newNotes));
    if (firebaseEnabled) {
      db.ref('notesParSpecialite').set(newNotes).catch(err => {
        console.error('‚ùå Erreur sauvegarde notes:', err);
      });
    }
  };
  
  // Fonctions pour g√©rer les notes et conseils
  const normalizeSpecialiteName = (name) => {
    return name.toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Enlever accents
      .replace(/[^a-z0-9]/g, ''); // Garder seulement lettres et chiffres
  };
  
  const ajouterNote = (nomCommercial, texte) => {
    const key = normalizeSpecialiteName(nomCommercial);
    const newNotes = { ...notesParSpecialite };
    if (!newNotes[key]) {
      newNotes[key] = { notes: [], conseils: [] };
    }
    const newNote = {
      id: Date.now().toString(),
      texte: texte.trim(),
      date: new Date().toISOString()
    };
    newNotes[key].notes = [...(newNotes[key].notes || []), newNote];
    saveNotesParSpecialite(newNotes);
  };
  
  const modifierNote = (nomCommercial, noteId, nouveauTexte) => {
    const key = normalizeSpecialiteName(nomCommercial);
    const newNotes = { ...notesParSpecialite };
    if (newNotes[key] && newNotes[key].notes) {
      newNotes[key].notes = newNotes[key].notes.map(note =>
        note.id === noteId ? { ...note, texte: nouveauTexte.trim() } : note
      );
      saveNotesParSpecialite(newNotes);
    }
  };
  
  const supprimerNote = (nomCommercial, noteId) => {
    const key = normalizeSpecialiteName(nomCommercial);
    const newNotes = { ...notesParSpecialite };
    if (newNotes[key] && newNotes[key].notes) {
      newNotes[key].notes = newNotes[key].notes.filter(note => note.id !== noteId);
      saveNotesParSpecialite(newNotes);
    }
  };
  
  const ajouterConseil = (nomCommercial, texte) => {
    const key = normalizeSpecialiteName(nomCommercial);
    const newNotes = { ...notesParSpecialite };
    if (!newNotes[key]) {
      newNotes[key] = { notes: [], conseils: [] };
    }
    const newConseil = {
      id: Date.now().toString(),
      texte: texte.trim(),
      date: new Date().toISOString()
    };
    newNotes[key].conseils = [...(newNotes[key].conseils || []), newConseil];
    saveNotesParSpecialite(newNotes);
  };
  
  const modifierConseil = (nomCommercial, conseilId, nouveauTexte) => {
    const key = normalizeSpecialiteName(nomCommercial);
    const newNotes = { ...notesParSpecialite };
    if (newNotes[key] && newNotes[key].conseils) {
      newNotes[key].conseils = newNotes[key].conseils.map(conseil =>
        conseil.id === conseilId ? { ...conseil, texte: nouveauTexte.trim() } : conseil
      );
      saveNotesParSpecialite(newNotes);
    }
  };
  
  const supprimerConseil = (nomCommercial, conseilId) => {
    const key = normalizeSpecialiteName(nomCommercial);
    const newNotes = { ...notesParSpecialite };
    if (newNotes[key] && newNotes[key].conseils) {
      newNotes[key].conseils = newNotes[key].conseils.filter(conseil => conseil.id !== conseilId);
      saveNotesParSpecialite(newNotes);
    }
  };
  
  const getNotesConseils = (nomCommercial) => {
    const key = normalizeSpecialiteName(nomCommercial);
    return notesParSpecialite[key] || { notes: [], conseils: [] };
  };
  
  // Collecter notes/conseils avec association aux images + formes + standalone
  const getConsolidatedNotesConseils = (nomCommercialOuDCI, imageUrls = []) => {
    const searchTerm = nomCommercialOuDCI.toLowerCase();
    const allItems = [];
    
    // 1. Notes/conseils depuis les plaintes
    const conseilsData = localStorage.getItem('conseilsOfficine');
    if (conseilsData) {
      try {
        const plaintes = JSON.parse(conseilsData);
        if (!Array.isArray(plaintes)) {
          console.warn('‚ö†Ô∏è  conseilsOfficine n\'est pas un tableau:', plaintes);
          return [];
        }
        plaintes.forEach(plainte => {
          if (plainte.specialites && Array.isArray(plainte.specialites)) {
            plainte.specialites.forEach(spec => {
              const specNom = (spec.nomCommercial || '').toLowerCase();
              const specDCI = (spec.dci || '').toLowerCase();
              
              if (specNom.includes(searchTerm) || searchTerm.includes(specNom) ||
                  specDCI.includes(searchTerm) || searchTerm.includes(specDCI)) {
                
                const specImages = spec.imageUrls || (spec.imageUrl ? [spec.imageUrl] : []);
                let matchesImages = imageUrls.length === 0 || specImages.length === 0;
                if (!matchesImages && imageUrls.length > 0 && specImages.length > 0) {
                  matchesImages = imageUrls.some(url => specImages.includes(url));
                }
                
                if (matchesImages) {
                  const formes = spec.formePharma ? spec.formePharma.split(',').map(f => f.trim()).filter(Boolean) : [];
                  
                  if (spec.notes && spec.notes.trim()) {
                    allItems.push({
                      type: 'note',
                      texte: spec.notes,
                      plainteId: plainte.id,
                      plainteName: plainte.nom,
                      specId: spec.id,
                      formes: formes,
                      isStandalone: false,
                      id: `${plainte.id}_${spec.id || Date.now()}_note`
                    });
                  }
                  
                  if (spec.conseils && spec.conseils.trim()) {
                    allItems.push({
                      type: 'conseil',
                      texte: spec.conseils,
                      plainteId: plainte.id,
                      plainteName: plainte.nom,
                      specId: spec.id,
                      formes: formes,
                      isStandalone: false,
                      id: `${plainte.id}_${spec.id || Date.now()}_conseil`
                    });
                  }
                }
              }
            });
          }
        });
      } catch (e) {
        console.error('Erreur consolidation:', e);
      }
    }
    
    // 2. Notes/conseils standalone (non li√©es √† une plainte)
    try {
      const standaloneKey = 'notesConseils_standalone';
      const stored = localStorage.getItem(standaloneKey);
      if (stored) {
        const standalone = JSON.parse(stored);
        const key = normalizeSpecialiteName(nomCommercialOuDCI);
        
        if (standalone[key]) {
          // V√©rifier que notes et conseils sont des tableaux
          const notes = Array.isArray(standalone[key].notes) ? standalone[key].notes : [];
          const conseils = Array.isArray(standalone[key].conseils) ? standalone[key].conseils : [];
          
          notes.forEach(note => {
            allItems.push({
              type: 'note',
              texte: note.texte,
              isStandalone: true,
              formes: [],
              id: note.id
            });
          });
          
          conseils.forEach(conseil => {
            allItems.push({
              type: 'conseil',
              texte: conseil.texte,
              isStandalone: true,
              formes: [],
              id: conseil.id
            });
          });
        }
      }
    } catch (e) {
      console.error('Erreur standalone:', e);
    }
    
    return allItems;
  };
  
  // Mettre √† jour une note/conseil
  const updateNoteConseilInPlainte = (item, newText) => {
    const conseilsData = localStorage.getItem('conseilsOfficine');
    if (conseilsData) {
      try {
        const plaintes = JSON.parse(conseilsData);
        const newPlaintes = plaintes.map(plainte => {
          if (plainte.id === item.plainteId) {
            const newSpecs = plainte.specialites.map(spec => {
              if (spec.id === item.specId) {
                if (item.type === 'note') {
                  return { ...spec, notes: newText };
                } else {
                  return { ...spec, conseils: newText };
                }
              }
              return spec;
            });
            return { ...plainte, specialites: newSpecs };
          }
          return plainte;
        });
        
        localStorage.setItem('conseilsOfficine', JSON.stringify(newPlaintes));
        if (firebaseEnabled) {
          saveToFirebase('conseilsOfficine', newPlaintes);
        }
        setRefreshKey(prev => prev + 1); // Forcer la mise √† jour du cache
        return true;
      } catch (e) {
        console.error('Erreur update:', e);
      }
    }
    return false;
  };
  
  // Supprimer une note/conseil
  const deleteNoteConseilInPlainte = (item) => {
    const conseilsData = localStorage.getItem('conseilsOfficine');
    if (conseilsData) {
      try {
        const plaintes = JSON.parse(conseilsData);
        const newPlaintes = plaintes.map(plainte => {
          if (plainte.id === item.plainteId) {
            const newSpecs = plainte.specialites.map(spec => {
              if (spec.id === item.specId) {
                if (item.type === 'note') {
                  return { ...spec, notes: '' };
                } else {
                  return { ...spec, conseils: '' };
                }
              }
              return spec;
            });
            return { ...plainte, specialites: newSpecs };
          }
          return plainte;
        });
        
        localStorage.setItem('conseilsOfficine', JSON.stringify(newPlaintes));
        if (firebaseEnabled) {
          saveToFirebase('conseilsOfficine', newPlaintes);
        }
        setRefreshKey(prev => prev + 1); // Forcer la mise √† jour du cache
        return true;
      } catch (e) {
        console.error('Erreur delete:', e);
      }
    }
    return false;
  };
  
  // Cr√©er une note/conseil pour une sp√©cialit√© non li√©e √† une plainte
  const createStandaloneNoteConseil = (nomCommercial, dci, type, texte, imageUrls = []) => {
    // Stocker dans un objet s√©par√© pour les notes "standalone"
    const standaloneKey = 'notesConseils_standalone';
    let standalone = {};
    try {
      const stored = localStorage.getItem(standaloneKey);
      if (stored) standalone = JSON.parse(stored);
    } catch (e) {}
    
    const key = normalizeSpecialiteName(nomCommercial || dci);
    if (!standalone[key]) {
      standalone[key] = { notes: [], conseils: [], images: imageUrls, dci: dci, nomCommercial: nomCommercial };
    }
    
    const newItem = {
      id: Date.now() + '_' + Math.random(),
      texte: texte,
      type: type,
      images: imageUrls
    };
    
    if (type === 'note') {
      standalone[key].notes.push(newItem);
    } else {
      standalone[key].conseils.push(newItem);
    }
    
    localStorage.setItem(standaloneKey, JSON.stringify(standalone));
    
    // Synchroniser avec Firebase
    if (firebaseEnabled) {
      db.ref('notesConseils_standalone').set(standalone).catch(err => {
        console.error('‚ùå Erreur sauvegarde Firebase standalone:', err);
      });
    }
    
    console.log('üíæ Note ajout√©e');
    if (showNotesModal) {
      console.log('‚è∏Ô∏è  Mise √† jour du cache diff√©r√©e (modale ouverte)');
      setPendingCacheUpdate(true);
    } else {
      console.log('üîÑ Mise √† jour du cache imm√©diate');
      setRefreshKey(prev => prev + 1);
    }
    return true;
  };
  
  // Mettre √† jour une note standalone
  const updateStandaloneNoteConseil = (itemId, newText) => {
    const standaloneKey = 'notesConseils_standalone';
    try {
      const stored = localStorage.getItem(standaloneKey);
      if (stored) {
        const standalone = JSON.parse(stored);
        let updated = false;
        
        Object.keys(standalone).forEach(key => {
          ['notes', 'conseils'].forEach(type => {
            // V√©rifier que c'est un tableau avant de findIndex
            if (Array.isArray(standalone[key][type])) {
              const idx = standalone[key][type].findIndex(item => item.id === itemId);
              if (idx !== -1) {
                standalone[key][type][idx].texte = newText;
                updated = true;
              }
            }
          });
        });
        
        if (updated) {
          localStorage.setItem(standaloneKey, JSON.stringify(standalone));
          
          // Synchroniser avec Firebase
          if (firebaseEnabled) {
            db.ref('notesConseils_standalone').set(standalone).catch(err => {
              console.error('‚ùå Erreur mise √† jour Firebase standalone:', err);
            });
          }
          
          setRefreshKey(prev => prev + 1); // Forcer la mise √† jour du cache
          return true;
        }
      }
    } catch (e) {
      console.error('Erreur update standalone:', e);
    }
    return false;
  };
  
  // Supprimer une note standalone
  const deleteStandaloneNoteConseil = (itemId) => {
    const standaloneKey = 'notesConseils_standalone';
    try {
      const stored = localStorage.getItem(standaloneKey);
      if (stored) {
        const standalone = JSON.parse(stored);
        
        Object.keys(standalone).forEach(key => {
          ['notes', 'conseils'].forEach(type => {
            // V√©rifier que c'est un tableau avant de filter
            if (Array.isArray(standalone[key][type])) {
              standalone[key][type] = standalone[key][type].filter(item => item.id !== itemId);
            }
          });
        });
        
        localStorage.setItem(standaloneKey, JSON.stringify(standalone));
        
        // Synchroniser avec Firebase
        if (firebaseEnabled) {
          db.ref('notesConseils_standalone').set(standalone).catch(err => {
            console.error('‚ùå Erreur suppression Firebase standalone:', err);
          });
        }
        
        console.log('üóëÔ∏è  Note supprim√©e');
        if (showNotesModal) {
          console.log('‚è∏Ô∏è  Mise √† jour du cache diff√©r√©e (modale ouverte)');
          setPendingCacheUpdate(true);
        } else {
          console.log('üîÑ Mise √† jour du cache imm√©diate');
          setRefreshKey(prev => prev + 1);
        }
        return true;
      }
    } catch (e) {
      console.error('Erreur delete standalone:', e);
    }
    return false;
  };
  const [showImgurGuide, setShowImgurGuide] = useState(false);



  // Chargement des donn√©es depuis data.json au d√©marrage
  React.useEffect(() => {
    // V√©rifier si les donn√©es sont d√©j√† dans localStorage
    const hasMeds = localStorage.getItem('pharmaspace_medications');
    const hasClasses = localStorage.getItem('pharmaspace_classes');
    const hasForms = localStorage.getItem('pharmaspace_forms');
    
    // Si aucune donn√©e dans localStorage, charger depuis data.json
    if (!hasMeds || !hasClasses) {
      fetch('./data.json')
        .then(response => {
          if (!response.ok) {
            console.warn('‚ö†Ô∏è data.json non trouv√©, utilisation des donn√©es par d√©faut');
            return null;
          }
          return response.json();
        })
        .then(data => {
          if (data) {
            console.log('‚úÖ Donn√©es charg√©es depuis data.json');
            // Charger medications si absent de localStorage
            if (!hasMeds && data.medications) {
              setMedications(data.medications);
              localStorage.setItem('pharmaspace_medications', JSON.stringify(data.medications));
            }
            // Charger classes si absent de localStorage
            if (!hasClasses && data.therapeuticClasses) {
              setTherapeuticClasses(data.therapeuticClasses);
              localStorage.setItem('pharmaspace_classes', JSON.stringify(data.therapeuticClasses));
            }
            // Charger formes si absent de localStorage
            if (!hasForms && data.pharmaceuticalForms) {
              setPharmaceuticalForms(data.pharmaceuticalForms);
              localStorage.setItem('pharmaspace_forms', JSON.stringify(data.pharmaceuticalForms));
            }
            // Charger conseils si pr√©sents et absents de localStorage
            if (data.conseilsCategories && !localStorage.getItem('conseilsCategories')) {
              localStorage.setItem('conseilsCategories', JSON.stringify(data.conseilsCategories));
            }
            if (data.conseilsOfficine && !localStorage.getItem('conseilsOfficine')) {
              localStorage.setItem('conseilsOfficine', JSON.stringify(data.conseilsOfficine));
            }
          }
        })
        .catch(error => {
          console.error('‚ùå Erreur chargement data.json:', error);
        });
    } else {
      console.log('‚úÖ Donn√©es charg√©es depuis localStorage');
    }
  }, []); // Ex√©cut√© une seule fois au d√©marrage

  // Sauvegarde automatique
  React.useEffect(() => {
    localStorage.setItem('pharmaspace_medications', JSON.stringify(medications));
  }, [medications]);

  React.useEffect(() => {
    localStorage.setItem('pharmaspace_classes', JSON.stringify(therapeuticClasses));
  }, [therapeuticClasses]);

  React.useEffect(() => {
    localStorage.setItem('pharmaspace_forms', JSON.stringify(pharmaceuticalForms));
  }, [pharmaceuticalForms]);

  // R√©initialiser l'index quand la recherche change
  React.useEffect(() => {
    if (mode === 'flashcard') {
      setCurrentIndex(0);
    }
  }, [debouncedSearchQuery]);

  // ========== ALGORITHME SRS ==========
  

  

  

  // ========== STATISTIQUES ==========
  

  // ========== FONCTIONS UTILITAIRES ==========
  const normalizeString = (str) => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");

  const levenshteinDistance = (str1, str2) => {
    const matrix = [];
    for (let i = 0; i <= str2.length; i++) matrix[i] = [i];
    for (let j = 0; j <= str1.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= str2.length; i++) {
      for (let j = 1; j <= str1.length; j++) {
        matrix[i][j] = str2.charAt(i - 1) === str1.charAt(j - 1) ? matrix[i - 1][j - 1] : Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
      }
    }
    return matrix[str2.length][str1.length];
  };

  const checkAnswer = (userAns, correctAns) => {
    const normalized1 = normalizeString(userAns);
    const normalized2 = normalizeString(correctAns);
    return levenshteinDistance(normalized1, normalized2) <= Math.floor(normalized2.length * 0.2);
  };

  const getCategories = () => {
    // R√©cup√©rer les classes des m√©dicaments
    const medsCategories = medications.map(med => med.category);
    // R√©cup√©rer toutes les classes de therapeuticClasses
    const allClasses = Object.keys(therapeuticClasses);
    // Combiner et d√©dupliquer
    return [...new Set([...medsCategories, ...allClasses])].sort();
  };
  const getClassColor = (className) => therapeuticClasses[className] || '#64748b';

  const getSortedMedications = () => {
    let sorted = [...medications];
    if (debouncedSearchQuery.trim()) {
      const query = debouncedSearchQuery.toLowerCase();
      sorted = sorted.filter(med => 
        med.dci.toLowerCase().includes(query) ||
        med.commercial.some(name => name.toLowerCase().includes(query)) ||
        med.category.toLowerCase().includes(query) ||
        (med.pharmaceuticalForm && med.pharmaceuticalForm.toLowerCase().includes(query))
      );
    }
    if (filterCategory !== 'all') sorted = sorted.filter(med => med.category === filterCategory);
    switch(sortBy) {
      case 'dci': sorted.sort((a, b) => a.dci.localeCompare(b.dci)); break;
      case 'commercial': sorted.sort((a, b) => a.commercial[0].localeCompare(b.commercial[0])); break;
      case 'category': sorted.sort((a, b) => a.category.localeCompare(b.category)); break;
      case 'form': sorted.sort((a, b) => (a.pharmaceuticalForm || '').localeCompare(b.pharmaceuticalForm || '')); break;
    }
    return sorted;
  };

  const getFlashcardListMedications = useMemo(() => {
    let sorted = [...medications];
    if (debouncedSearchQuery.trim()) {
      const query = debouncedSearchQuery.toLowerCase();
      sorted = sorted.filter(med => 
        med.dci.toLowerCase().includes(query) ||
        med.commercial.some(name => name.toLowerCase().includes(query)) ||
        med.category.toLowerCase().includes(query) ||
        (med.pharmaceuticalForm && med.pharmaceuticalForm.toLowerCase().includes(query))
      );
    }
    switch(flashcardListSort) {
      case 'dci': sorted.sort((a, b) => a.dci.localeCompare(b.dci)); break;
      case 'commercial': sorted.sort((a, b) => a.commercial[0].localeCompare(b.commercial[0])); break;
      case 'category': sorted.sort((a, b) => a.category.localeCompare(b.category)); break;
      case 'form': sorted.sort((a, b) => (a.pharmaceuticalForm || '').localeCompare(b.pharmaceuticalForm || '')); break;
      case 'notes': 
        // ULTRA OPTIMISATION: Utiliser le cache pr√©-calcul√©
        const medsWithCount = sorted.map(med => {
          const name = med.commercial[0] || med.dci;
          // CORRECTION: Chercher dans le cache avec le nom, pas le DCI
          const count = notesCountCache[name] || 0;
          
          // Log pour Plantspray
          if (name.toLowerCase().includes('plant') || med.dci.toLowerCase().includes('plant')) {
            console.log('üîç Tri: nom="' + name + '", dci="' + med.dci + '", cl√©="' + name + '" ‚Üí cache[nom]=' + count);
          }
          
          return {
            med: med,
            notesCount: count
          };
        });
        
        // Maintenant trier par le nombre pr√©-calcul√© (ultra rapide)
        medsWithCount.sort((a, b) => {
          // Ceux avec notes en premier
          if (a.notesCount > 0 && b.notesCount === 0) return -1;
          if (a.notesCount === 0 && b.notesCount > 0) return 1;
          
          // Si les deux ont des notes, trier par nombre
          if (a.notesCount > 0 && b.notesCount > 0) {
            if (a.notesCount !== b.notesCount) {
              return b.notesCount - a.notesCount; // Plus de notes en premier
            }
          }
          
          // Si √©gaux, trier par DCI
          return a.med.dci.localeCompare(b.med.dci);
        });
        
        // Log des premiers pour v√©rifier le tri
        console.log('üìã Top 10 apr√®s tri par notes:');
        medsWithCount.slice(0, 10).forEach((item, i) => {
          const name = item.med.commercial[0] || item.med.dci;
          console.log(`  ${i+1}. ${name} (${item.notesCount} notes)`);
        });
        
        // Extraire juste les m√©dicaments tri√©s
        sorted = medsWithCount.map(item => item.med);
        break;
    }
    return sorted;
  }, [medications, debouncedSearchQuery, flashcardListSort, notesCountCache]);

  const handleQuizSubmit = (e) => {
    e.preventDefault();
    if (!userAnswer.trim()) return;
    const isCorrect = checkAnswer(userAnswer, getFlashcardListMedications[currentIndex].dci);
    setShowQuizFeedback(true);
    setStats({ correct: stats.correct + (isCorrect ? 1 : 0), total: stats.total + 1 });
  };

  const handleNext = () => {
    if (currentIndex < getFlashcardListMedications.length - 1) {
      setCurrentIndex(currentIndex + 1);
      setShowAnswer(false);
    } else {
      // Quiz supprim√©
      setMode('menu');
      // setShuffledMeds([]);
    }
  };

  const applySelection = () => {
    let medsToUse = [];
    
    if (selectionMode === 'all') {
      medsToUse = [...medications];
    } else if (selectionMode === 'class') {
      medsToUse = medications.filter(med => selectedClasses.includes(med.category));
    } else if (selectionMode === 'custom') {
      medsToUse = selectedMeds.map(i => medications[i]);
    }
    
    if (medsToUse.length === 0) {
      alert('Aucun m√©dicament s√©lectionn√©');
      return;
    }
    
    // M√©langer les m√©dicaments
    
    // shuffledMeds non utilis√©
    setCurrentIndex(0);
    setShowAnswer(false);
    setStats({ correct: 0, total: 0 });
    setShowSettings(false);
  };

  const startMode = (newMode) => {
    setMode(newMode);
    setSelectionMode('all');
    setSelectedClasses([]);
    setSelectedMeds([]);
    
    // Initialiser le mode
    const medsToUse = [...medications];
    setCurrentIndex(0);
    setShowAnswer(false);
    setStats({ correct: 0, total: 0 });
    setSearchQuery('');
    
    if (newMode === 'flashcard') {
      setFlashcardView('card');
    }
  };

  

  const startEditMedication = (index) => {
    const med = medications[index];
    const imageText = med.imageUrls ? med.imageUrls.join('\n') : (med.imageUrl ? med.imageUrl : (med.image || ''));
    setCustomMed({ 
      dci: med.dci, 
      commercial: med.commercial.join(', '), 
      category: med.category, 
      imageUrls: imageText,
      pharmaceuticalForm: med.pharmaceuticalForm || ''
    });
    setEditingIndex(index);
  };

  const cancelEdit = () => {
    setEditingIndex(null);
    setCustomMed({ dci: '', commercial: '', category: '', imageUrls: '', pharmaceuticalForm: '' });
    setErrorMessage('');
    setShowClassManager(false);
    setEditingClass(null);
  };

  const saveMedication = () => {
    if (!customMed.dci || !customMed.commercial || !customMed.category) {
      setErrorMessage('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires (DCI, Nom commercial, Classe)');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    
    const newMed = {
      id: editingIndex !== null ? medications[editingIndex].id : `med_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      dci: customMed.dci,
      commercial: customMed.commercial.split(',').map(s => s.trim()).filter(s => s),
      category: customMed.category,
      imageUrls: customMed.imageUrls.split('\n').map(s => s.trim()).filter(s => s),
      pharmaceuticalForm: customMed.pharmaceuticalForm.trim(),
      nextReview: null,  // Valeur par d√©faut pour Firebase
      interval: null     // Valeur par d√©faut pour Firebase
    };
    
    if (editingIndex !== null) {
      const updated = [...medications];
      newMed.nextReview = medications[editingIndex].nextReview;
      newMed.interval = medications[editingIndex].interval;
      updated[editingIndex] = newMed;
      saveMedications(updated);
      setEditingIndex(null);
      
      // SYNCHRONISATION: Mettre √† jour les sp√©cialit√©s dans Conseils qui ont le m√™me DCI
      const conseilsData = JSON.parse(localStorage.getItem('conseilsOfficine') || '[]');
      let hasChanges = false;
      const updatedConseils = conseilsData.map(plainte => {
        // V√©rifier que specialites existe
        if (!plainte.specialites || !Array.isArray(plainte.specialites)) {
          return plainte;
        }
        
        const updatedSpecs = plainte.specialites.map(spec => {
          if (spec.dci && spec.dci.toLowerCase() === newMed.dci.toLowerCase()) {
            hasChanges = true;
            return {
              ...spec,
              nomCommercial: newMed.commercial.join(', '),
              imageUrls: newMed.imageUrls,
              formePharma: newMed.pharmaceuticalForm
            };
          }
          return spec;
        });
        return { ...plainte, specialites: updatedSpecs };
      });
      
      if (hasChanges) {
        // Sauvegarder sur Firebase aussi
        if (firebaseEnabled) {
          db.ref('conseilsOfficine').set(updatedConseils).catch(err => {
            console.error('‚ùå Erreur sync conseils:', err);
          });
        }
        localStorage.setItem('conseilsOfficine', JSON.stringify(updatedConseils));
        console.log(`‚úÖ Synchronisation: ${newMed.dci} mis √† jour dans Conseils`);
      }
      
      // Fermer le modal apr√®s modification
      setShowManagement(false);
    } else {
      saveMedications([...medications, newMed]);
    }
    setCustomMed({ dci: '', commercial: '', category: '', imageUrls: '', pharmaceuticalForm: '' });
    setErrorMessage('');
    // Forcer le re-render de la liste
    setListUpdateKey(prev => prev + 1);
  };

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onloadend = () => {
      // Ancien code d'upload supprim√©
    };
    reader.readAsDataURL(file);
  };
  
  // NOUVELLE : Fonction pour ajouter une image par URL
  const handleImageURL = () => {
    let url = prompt("üåê Collez l'URL de votre image\n\nüìç Services recommand√©s :\n‚Ä¢ Imgur.com (gratuit, rapide)\n‚Ä¢ imgbb.com\n‚Ä¢ Google Photos\n\nüí° L'URL doit finir par .jpg, .png, .gif ou .webp\n\nExemple :\nhttps://i.imgur.com/abc123.jpg");
    if (!url) return;
    
    // Valider que c'est une URL
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      alert("‚ùå L'URL doit commencer par http:// ou https://");
      return;
    }
    
    // D√âTECTION D'ALBUM IMGUR
    if (url.includes('imgur.com/a/')) {
      alert("‚ùå C'est une URL d'ALBUM !\n\n" +
            "Vous avez coll√© : " + url + "\n\n" +
            "üìç Comment obtenir la bonne URL :\n\n" +
            "1. Ouvrez votre album\n" +
            "2. Cliquez sur l'image que vous voulez\n" +
            "3. Faites clic droit sur l'image\n" +
            "4. 'Copier l'adresse de l'image'\n\n" +
            "‚úÖ Vous obtiendrez une URL comme :\n" +
            "https://i.imgur.com/abc123.jpg");
      return;
    }
    
    // AUTO-CORRECTION DES URLs IMGUR
    // Si c'est une URL Imgur sans "i." au d√©but, la corriger
    if (url.includes('imgur.com') && !url.includes('i.imgur.com')) {
      // Extraire l'ID de l'image
      const match = url.match(/imgur\.com\/(?:gallery\/)?([a-zA-Z0-9]+)/);
      if (match && match[1]) {
        const imageId = match[1];
        // Demander l'extension
        const ext = prompt("üîß Auto-correction Imgur\n\nQuelle est l'extension de votre image ?\n\nTapez : jpg, png, gif ou webp", "jpg");
        if (ext) {
          url = `https://i.imgur.com/${imageId}.${ext}`;
          alert(`‚úÖ URL corrig√©e automatiquement :\n${url}`);
        }
      }
    }
    
    // V√©rifier que c'est une image
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
    const hasImageExtension = imageExtensions.some(ext => url.toLowerCase().includes(ext));
    
    if (!hasImageExtension && !url.includes('imgur.com') && !url.includes('googleusercontent.com') && !url.includes('ibb.co')) {
      const confirm = window.confirm("‚ö†Ô∏è Cette URL ne semble pas √™tre une image.\nVoulez-vous quand m√™me l'utiliser ?");
      if (!confirm) return;
    }
    
    // Mettre √† jour l'image directement
    // Ancien code URL supprim√©
  }
  
  // Nouvelle fonction pour valider l'image
  const validateImage = () => {
    if (!tempImageUrl) return;
    // Ancien code temp image supprim√©
    setImageUpdated(true);
    setTimeout(() => setImageUpdated(false), 100);
    alert('‚úÖ Image ajout√©e avec succ√®s !\n\nVous pouvez maintenant modifier le m√©dicament.');
  }

  const addNewClass = () => {
    if (!newClassName.trim()) {
      setErrorMessage('‚ö†Ô∏è Veuillez entrer un nom de classe');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    if (getCategories().includes(newClassName.trim())) {
      setErrorMessage('‚ö†Ô∏è Cette classe existe d√©j√†');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    saveClasses({...therapeuticClasses, [newClassName.trim()]: newClassColor});
    setCustomMed({...customMed, category: newClassName.trim()});
    setNewClassName('');
    setNewClassColor('#64748b');
    setShowClassManager(false);
    setErrorMessage('');
  };

  const updateClass = (oldName, newName, newColor) => {
    if (!newName.trim()) {
      setErrorMessage('‚ö†Ô∏è Veuillez entrer un nom de classe');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    if (newName !== oldName && getCategories().includes(newName.trim())) {
      setErrorMessage('‚ö†Ô∏è Cette classe existe d√©j√†');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    const updatedClasses = {...therapeuticClasses};
    delete updatedClasses[oldName];
    updatedClasses[newName.trim()] = newColor;
    saveClasses(updatedClasses);
    const updatedMeds = medications.map(med => 
      med.category === oldName ? {...med, category: newName.trim()} : med
    );
    saveMedications(updatedMeds);
    setEditingClass(null);
    setErrorMessage('');
  };

  
  const resetToDefault = () => {
    if (window.confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir r√©initialiser TOUTES vos donn√©es ? Cette action est irr√©versible.')) {
      localStorage.removeItem('pharmaspace_medications');
      localStorage.removeItem('pharmaspace_classes');
      saveMedications(INITIAL_MEDS);
      saveClasses(INITIAL_CLASSES);
      alert('‚úÖ R√©initialisation termin√©e !\n\nüîÑ Retour aux 7 m√©dicaments par d√©faut\nüí° Pensez √† exporter avant de r√©initialiser la prochaine fois !');
    }
  };

  // Fonction pour recharger intelligemment sans perdre les personnalisations
  const smartReload = () => {
    if (confirm('üîÑ Recharger les donn√©es depuis data.json ?\n\n‚úÖ TOUT sera recharg√© depuis data.json (cache vid√©)\n‚ö†Ô∏è Vos modifications locales seront perdues\n\nContinuer ?')) {
      // Vider compl√®tement le localStorage
      localStorage.clear();
      
      // Recharger la page
      alert('‚úÖ Cache vid√© et rechargement en cours...\n\nüíä Toutes les donn√©es seront recharg√©es depuis data.json');
      location.reload(true);
    }
  };

  const exportData = () => {
    // R√©cup√©rer les donn√©es conseils depuis localStorage
    const conseilsCategories = localStorage.getItem('conseilsCategories');
    const conseilsOfficine = localStorage.getItem('conseilsOfficine');
    
    // R√©cup√©rer toutes les cat√©gories de documents pour chaque fiche
    const docCategories = {};
    const plaintes = conseilsOfficine ? JSON.parse(conseilsOfficine) : [];
    plaintes.forEach(plainte => {
      const savedCategories = localStorage.getItem('docCategories_' + plainte.id);
      if (savedCategories) {
        docCategories[plainte.id] = JSON.parse(savedCategories);
      }
    });
    
    const data = { 
      medications, 
      therapeuticClasses,
      pharmaceuticalForms,
      ressources,
      seminaires,
      conseilsCategories: conseilsCategories ? JSON.parse(conseilsCategories) : null,
      conseilsOfficine: conseilsOfficine ? JSON.parse(conseilsOfficine) : null,
      docCategories: Object.keys(docCategories).length > 0 ? docCategories : null,
      exportDate: new Date().toISOString() 
    };
    
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pharmaspace_backup_${new Date().toISOString().split('T')[0]}.json`;
    const categoriesCount = Object.keys(docCategories).length;
    alert('‚úÖ Sauvegarde compl√®te t√©l√©charg√©e !\n\nüìÅ Fichier : pharmaspace_backup_' + new Date().toISOString().split('T')[0] + '.json\nüíä Flashcards: ' + medications.length + ' m√©dicaments\nüé® Classes th√©rapeutiques: ' + Object.keys(therapeuticClasses).length + '\nüíä Formes pharmaceutiques: ' + pharmaceuticalForms.length + '\nüìã Conseils: ' + (conseilsOfficine ? JSON.parse(conseilsOfficine).length : 0) + ' fiches' + (categoriesCount > 0 ? '\nüìÅ Cat√©gories documents: ' + categoriesCount + ' fiches avec cat√©gories' : '') + '\nüíæ Gardez ce fichier pr√©cieusement !\nüì§ Vous pouvez le partager avec vos coll√®gues.');
    a.click();
    URL.revokeObjectURL(url);
  };

  const importData = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          // D√âTECTION D'IMPORT AUTOMATIQUE D'IMAGES
          if (data.urlsMap && data.metadata) {
            const urlsMap = data.urlsMap;
            const count = Object.keys(urlsMap).length;
            
            if (!window.confirm('üéâ Import automatique d\'images d√©tect√© !\n\n' + count + ' images √† importer.\n\nVoulez-vous appliquer ces images aux m√©dicaments correspondants ?')) {
              return;
            }
            
            // Appliquer les URLs aux m√©dicaments existants
            let applied = 0;
            let notFound = [];
            
            const updatedMeds = medications.map(med => {
              // Chercher par nom commercial (premier de la liste)
              const medName = med.commercial[0];
              
              if (urlsMap[medName]) {
                applied++;
                return { ...med, image: urlsMap[medName] };
              }
              
              notFound.push(medName);
              return med;
            });
            
            saveMedications(updatedMeds);
            
            alert('‚úÖ Import r√©ussi !\n\n' + applied + ' images appliqu√©es\n' + notFound.length + ' m√©dicaments sans correspondance\n\n' + (notFound.length > 0 ? 'M√©dicaments non trouv√©s : ' + notFound.slice(0, 5).join(', ') + (notFound.length > 5 ? '...' : '') : ''));
            return;
          }
          
          // IMPORT NORMAL (donn√©es compl√®tes)
          if (data.medications && data.therapeuticClasses) {
            saveMedications(data.medications);
            saveClasses(data.therapeuticClasses);
            
            // Importer les formes pharmaceutiques intelligemment
            if (data.pharmaceuticalForms) {
              // R√©cup√©rer les formes actuelles (avec suppressions)
              const currentForms = pharmaceuticalForms;
              // Trouver les nouvelles formes du fichier (pas dans les formes actuelles)
              const newForms = data.pharmaceuticalForms.filter(form => !currentForms.includes(form));
              // Ajouter seulement les nouvelles formes (garder les suppressions)
              if (newForms.length > 0) {
                saveForms([...currentForms, ...newForms].sort());
              }
              // Si pas de nouvelles formes, garder les formes actuelles (avec suppressions)
            }
            
            // Restaurer les conseils si pr√©sents
            if (data.conseilsCategories) {
              localStorage.setItem('conseilsCategories', JSON.stringify(data.conseilsCategories));
            }
            if (data.conseilsOfficine) {
              localStorage.setItem('conseilsOfficine', JSON.stringify(data.conseilsOfficine));
            }
            
            // Restaurer les cat√©gories de documents si pr√©sentes
            if (data.docCategories) {
              Object.keys(data.docCategories).forEach(plainteId => {
                localStorage.setItem('docCategories_' + plainteId, JSON.stringify(data.docCategories[plainteId]));
              });
            }
            
            // Restaurer les ressources si pr√©sentes
            if (data.ressources) {
              saveRessources(data.ressources);
            }
            
            // Restaurer les s√©minaires si pr√©sents
            if (data.seminaires) {
              saveSeminaires(data.seminaires);
            }
            
            const conseilsCount = data.conseilsOfficine ? data.conseilsOfficine.length : 0;
            const formsCount = data.pharmaceuticalForms ? data.pharmaceuticalForms.length : 0;
            const categoriesCount = data.docCategories ? Object.keys(data.docCategories).length : 0;
            const ressourcesCount = data.ressources ? data.ressources.length : 0;
            const seminairesCount = data.seminaires ? data.seminaires.length : 0;
            
            let message = '‚úÖ Donn√©es import√©es avec succ√®s !\n\nüíä ' + data.medications.length + ' m√©dicaments charg√©s\nüé® ' + Object.keys(data.therapeuticClasses).length + ' classes th√©rapeutiques';
            if (formsCount > 0) message += '\nüíä ' + formsCount + ' formes pharmaceutiques';
            message += '\nüìã ' + conseilsCount + ' fiches conseils';
            if (categoriesCount > 0) message += '\nüìÅ ' + categoriesCount + ' fiches avec cat√©gories documents';
            if (ressourcesCount > 0) message += '\nüîó ' + ressourcesCount + ' cat√©gories de ressources';
            if (seminairesCount > 0) message += '\nüìö ' + seminairesCount + ' cat√©gories de s√©minaires';
            if (conseilsCount > 0) message += '\n\n‚ö†Ô∏è Rechargez la page pour voir les conseils';
            
            alert(message);
          } else {
            alert('‚ùå Fichier invalide');
          }
        } catch (err) {
          alert('‚ùå Erreur lors de l\'import : ' + err.message);
        }
      };
      reader.readAsText(file);
    }
  };

  const ImagePlaceholder = () => (
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
      <circle cx="8.5" cy="8.5" r="1.5"/>
      <polyline points="21 15 16 10 5 21"/>
    </svg>
  );

  

  return (
    <div style={{ minHeight: '100vh', background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)' }}>
      <style>{`
        .button-hover { transition: all 0.2s; } 
        .button-hover:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
      `}</style>

      {/* HEADER FIXE */}
      <div style={{
        position: 'sticky',
        top: 0,
        zIndex: 1000,
        background: 'var(--color-surface)',
        borderBottom: '1px solid var(--color-border)',
        padding: '1rem 2rem'
      }}>
        <div style={{
          maxWidth: '1400px',
          margin: '0 auto',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center'
        }}>
          <div style={{
            fontSize: '20px',
            fontWeight: 700,
            letterSpacing: '-0.02em',
            color: 'var(--color-text-primary)',
            display: 'flex',
            alignItems: 'center',
            gap: '0.5rem'
          }}
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M4 19h16M4 15l4-6 4 2 4-8 4 4M4 11h16"/>
            </svg>
            PharmaSpace
          </div>
          <nav style={{ display: 'flex', gap: '2rem', alignItems: 'center' }}>
            <a 
              onClick={() => setMode('accueil')}
              style={{
                color: mode === 'accueil' ? 'var(--color-text-primary)' : 'var(--color-text-secondary)',
                textDecoration: 'none',
                fontSize: '15px',
                fontWeight: mode === 'accueil' ? 600 : 500,
                cursor: 'pointer',
                transition: 'color 0.2s'
              }}
            >
              Accueil
            </a>
            <a 
              onClick={() => setMode('flashcard')}
              style={{
                color: mode === 'flashcard' ? 'var(--color-text-primary)' : 'var(--color-text-secondary)',
                textDecoration: 'none',
                fontSize: '15px',
                fontWeight: mode === 'flashcard' ? 600 : 500,
                cursor: 'pointer',
                transition: 'color 0.2s'
              }}
            >
              Sp√©cialit√©s
            </a>
            <a 
              onClick={() => {
                if (mode === 'conseils' && resetConseilsViewRef.current) {
                  // Si d√©j√† en mode conseils, fermer la plainte ouverte
                  resetConseilsViewRef.current();
                } else {
                  // Sinon, basculer en mode conseils
                  setMode('conseils');
                }
              }}
              style={{
                color: mode === 'conseils' ? 'var(--color-text-primary)' : 'var(--color-text-secondary)',
                textDecoration: 'none',
                fontSize: '15px',
                fontWeight: mode === 'conseils' ? 600 : 500,
                cursor: 'pointer',
                transition: 'color 0.2s'
              }}
            >
              Fiches
            </a>
            <a 
              onClick={() => setMode('ressources')}
              style={{
                color: mode === 'ressources' ? 'var(--color-text-primary)' : 'var(--color-text-secondary)',
                textDecoration: 'none',
                fontSize: '15px',
                fontWeight: mode === 'ressources' ? 600 : 500,
                cursor: 'pointer',
                transition: 'color 0.2s'
              }}
            >
              Ressources
            </a>
            <a 
              onClick={() => setMode('seminaires')}
              style={{
                color: mode === 'seminaires' ? 'var(--color-text-primary)' : 'var(--color-text-secondary)',
                textDecoration: 'none',
                fontSize: '15px',
                fontWeight: mode === 'seminaires' ? 600 : 500,
                cursor: 'pointer',
                transition: 'color 0.2s'
              }}
            >
              Cours & S√©minaires
            </a>
            <button
              onClick={() => setShowDataManagement(true)}
              style={{
                background: 'var(--color-surface)',
                border: `2px solid ${isOnline ? '#059669' : '#DC2626'}`,
                borderRadius: '6px',
                padding: '0.5rem',
                fontSize: '14px',
                fontWeight: 500,
                color: isOnline ? '#059669' : '#DC2626',
                cursor: 'pointer',
                transition: 'all 0.2s',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}
              onMouseEnter={(e) => {
                e.target.style.background = 'var(--color-bg)';
              }}
              onMouseLeave={(e) => {
                e.target.style.background = 'var(--color-surface)';
              }}
            >
              <Database size={18} color={isOnline ? '#059669' : '#DC2626'} />
            </button>
          </nav>
        </div>
      </div>

      {/* CONTAINER PRINCIPAL */}
      <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '3rem 2rem' }}>
        {mode !== 'conseils' ? (
          <div>
          
          {/* MODE ACCUEIL */}
          {mode === 'accueil' && (
            <div>
              {/* Widgets statistiques - version discr√®te */}
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
                gap: '1rem',
                marginBottom: '2rem'
              }}>
                {/* Flashcards */}
                <div style={{
                  background: 'var(--color-surface)',
                  borderRadius: '12px',
                  padding: '1.25rem',
                  border: '1px solid var(--color-border)',
                  transition: 'all 0.2s',
                  cursor: 'pointer'
                }}
                onClick={() => setMode('flashcard')}
                onMouseEnter={(e) => {
                  e.currentTarget.style.borderColor = 'var(--color-accent)';
                  e.currentTarget.style.transform = 'translateY(-1px)';
                  e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.borderColor = 'var(--color-border)';
                  e.currentTarget.style.transform = 'translateY(0)';
                  e.currentTarget.style.boxShadow = 'none';
                }}
                >
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'space-between',
                    marginBottom: '0.5rem'
                  }}>
                    <div style={{ fontSize: '0.85rem', color: 'var(--color-text-secondary)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                      Flashcards
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" strokeWidth="2">
                      <rect x="2" y="6" width="20" height="12" rx="2"/>
                      <path d="M2 10h20"/>
                    </svg>
                  </div>
                  <div style={{ fontSize: '1.75rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>
                    {medications.length}
                  </div>
                </div>

                {/* Fiches plaintes */}
                <div style={{
                  background: 'var(--color-surface)',
                  borderRadius: '12px',
                  padding: '1.25rem',
                  border: '1px solid var(--color-border)',
                  transition: 'all 0.2s',
                  cursor: 'pointer'
                }}
                onClick={() => setMode('conseils')}
                onMouseEnter={(e) => {
                  e.currentTarget.style.borderColor = 'var(--color-accent)';
                  e.currentTarget.style.transform = 'translateY(-1px)';
                  e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.borderColor = 'var(--color-border)';
                  e.currentTarget.style.transform = 'translateY(0)';
                  e.currentTarget.style.boxShadow = 'none';
                }}
                >
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'space-between',
                    marginBottom: '0.5rem'
                  }}>
                    <div style={{ fontSize: '0.85rem', color: 'var(--color-text-secondary)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                      Fiches plaintes
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" strokeWidth="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                      <line x1="12" y1="18" x2="12" y2="12"/>
                      <line x1="9" y1="15" x2="15" y2="15"/>
                    </svg>
                  </div>
                  <div style={{ fontSize: '1.75rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>
                    {plaintes.length}
                  </div>
                </div>
              </div>

              {/* Barre de recherche unifi√©e */}
              <div style={{
                background: 'var(--color-surface)',
                borderRadius: '16px',
                padding: '1.5rem',
                border: '2px solid var(--color-border)',
                marginBottom: '2rem'
              }}>
                <h3 style={{ margin: '0 0 1rem 0', fontSize: '1.1rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>
                  Recherche rapide
                </h3>
                <div style={{ position: 'relative' }}>
                  <input
                    type="text"
                    placeholder="Rechercher une sp√©cialit√©, une fiche conseil..."
                    value={searchQuery}
                    onChange={(e) => {
                      const query = e.target.value;
                      setSearchQuery(query);
                      
                      if (query.trim().length > 1) {
                        // Rechercher dans flashcards
                        const flashcardResults = medications
                          .filter(med => 
                            (med.dci && med.dci.toLowerCase().includes(query.toLowerCase())) ||
                            (med.commercial && med.commercial.some && med.commercial.some(c => c.toLowerCase().includes(query.toLowerCase())))
                          )
                          .slice(0, 5);
                        
                        // Rechercher dans fiches plaintes
                        const ficheResults = plaintes
                          .filter(p => p.nom.toLowerCase().includes(query.toLowerCase()))
                          .slice(0, 5);
                        
                        setSearchResults({ flashcards: flashcardResults, fiches: ficheResults });
                        setShowSearchDropdown(true);
                      } else {
                        setShowSearchDropdown(false);
                      }
                    }}
                    onFocus={() => {
                      if (searchQuery.trim().length > 1) {
                        setShowSearchDropdown(true);
                      }
                    }}
                    onBlur={() => {
                      // D√©lai pour permettre le clic sur les r√©sultats
                      setTimeout(() => setShowSearchDropdown(false), 200);
                    }}
                    style={{
                      width: '100%',
                      padding: '0.75rem 1rem 0.75rem 3rem',
                      border: '2px solid var(--color-border)',
                      borderRadius: '8px',
                      fontSize: '15px',
                      outline: 'none',
                      transition: 'border-color 0.2s',
                      background: 'var(--color-surface)',
                      color: 'var(--color-text-primary)'
                    }}
                    onFocusCapture={(e) => e.target.style.borderColor = 'var(--color-accent)'}
                    onBlurCapture={(e) => e.target.style.borderColor = 'var(--color-border)'}
                  />
                  <svg 
                    style={{ 
                      position: 'absolute', 
                      left: '1rem', 
                      top: '50%', 
                      transform: 'translateY(-50%)',
                      pointerEvents: 'none'
                    }} 
                    width="20" 
                    height="20" 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="var(--color-text-muted)" 
                    strokeWidth="2"
                  >
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                  </svg>
                  
                  {/* Dropdown de r√©sultats */}
                  {showSearchDropdown && (searchResults.flashcards.length > 0 || searchResults.fiches.length > 0) && (
                    <div style={{
                      position: 'absolute',
                      top: 'calc(100% + 0.5rem)',
                      left: 0,
                      right: 0,
                      background: 'var(--color-surface)',
                      border: '2px solid var(--color-border)',
                      borderRadius: '8px',
                      boxShadow: '0 10px 25px rgba(0,0,0,0.1)',
                      maxHeight: '400px',
                      overflowY: 'auto',
                      zIndex: 1000
                    }}>
                      {searchResults.flashcards.length > 0 && (
                        <div>
                          <div style={{ padding: '0.75rem 1rem', borderBottom: '1px solid var(--color-border)', fontSize: '0.75rem', fontWeight: 600, color: 'var(--color-text-muted)', textTransform: 'uppercase' }}>
                            Sp√©cialit√©s ({searchResults.flashcards.length})
                          </div>
                          {searchResults.flashcards.map((med, idx) => (
                            <div
                              key={idx}
                              onClick={() => {
                                setSearchQuery(med.commercial[0] || med.dci);
                                setMode('flashcard');
                                setShowSearchDropdown(false);
                              }}
                              style={{
                                padding: '0.75rem 1rem',
                                cursor: 'pointer',
                                borderBottom: '1px solid var(--color-border)',
                                transition: 'background 0.2s'
                              }}
                              onMouseEnter={(e) => e.currentTarget.style.background = 'var(--color-bg)'}
                              onMouseLeave={(e) => e.currentTarget.style.background = 'var(--color-surface)'}
                            >
                              <div style={{ fontWeight: 600, fontSize: '0.9rem', color: 'var(--color-text-primary)' }}>
                                {med.commercial?.[0] || med.dci}
                              </div>
                              <div style={{ fontSize: '0.75rem', color: 'var(--color-text-muted)' }}>
                                {med.dci} {med.classe && `‚Ä¢ ${med.classe}`}
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                      
                      {searchResults.fiches.length > 0 && (
                        <div>
                          <div style={{ padding: '0.75rem 1rem', borderBottom: '1px solid var(--color-border)', fontSize: '0.75rem', fontWeight: 600, color: 'var(--color-text-muted)', textTransform: 'uppercase' }}>
                            Fiches Conseils ({searchResults.fiches.length})
                          </div>
                          {searchResults.fiches.map((fiche, idx) => (
                            <div
                              key={idx}
                              onClick={() => {
                                localStorage.setItem('openPlainteId', fiche.id);
                                setMode('conseils');
                                setShowSearchDropdown(false);
                                setSearchQuery('');
                              }}
                              style={{
                                padding: '0.75rem 1rem',
                                cursor: 'pointer',
                                borderBottom: idx < searchResults.fiches.length - 1 ? '1px solid #f1f5f9' : 'none',
                                transition: 'background 0.2s'
                              }}
                              onMouseEnter={(e) => e.currentTarget.style.background = 'var(--color-bg)'}
                              onMouseLeave={(e) => e.currentTarget.style.background = 'var(--color-surface)'}
                            >
                              <div style={{ fontWeight: 600, fontSize: '0.9rem', color: 'var(--color-text-primary)' }}>
                                {fiche.nom}
                              </div>
                              {fiche.categorie && (
                                <div style={{ fontSize: '0.75rem', color: 'var(--color-text-muted)' }}>
                                  {fiche.categorie}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* Nouvelles additions */}
              <div style={{
                background: 'var(--color-surface)',
                borderRadius: '16px',
                padding: '1.5rem',
                border: '2px solid var(--color-border)'
              }}>
                <h3 style={{ margin: '0 0 1rem 0', fontSize: '1.1rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>
                  Derniers ajouts
                </h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                  {(() => {
                    // Combiner flashcards et fiches avec timestamps
                    const recentItems = [];
                    
                    // Ajouter les derni√®res flashcards (5 plus r√©centes)
                    medications.slice(-5).reverse().forEach(med => {
                      recentItems.push({
                        type: 'flashcard',
                        nom: med.commercial?.[0] || med.dci,
                        dci: med.dci,
                        classe: med.classe || med.category,
                        onClick: () => {
                          setSearchQuery(med.commercial?.[0] || med.dci);
                          setMode('flashcard');
                        }
                      });
                    });
                    
                    // Ajouter les derni√®res fiches (5 plus r√©centes)
                    plaintes.slice(-5).reverse().forEach(plainte => {
                      // Charger categories depuis localStorage
                      const savedCategories = localStorage.getItem('conseilsCategories');
                      const categories = savedCategories ? JSON.parse(savedCategories) : [];
                      const couleur = categories.find(c => c.nom === plainte.categorie)?.couleur || '#64748b';
                      
                      recentItems.push({
                        type: 'fiche',
                        nom: plainte.nom,
                        couleur: couleur,
                        plainteId: plainte.id,
                        onClick: () => {
                          // Stocker l'ID de la plainte √† ouvrir
                          localStorage.setItem('openPlainteId', plainte.id);
                          setMode('conseils');
                        }
                      });
                    });
                    
                    // Afficher les 8 derniers
                    return recentItems.slice(0, 8).map((item, idx) => (
                      <div
                        key={idx}
                        onClick={item.onClick}
                        style={{
                          padding: '0.75rem',
                          background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          transition: 'all 0.2s',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.75rem'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = '#E0F2FE';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = 'var(--color-bg)';
                        }}
                      >
                        <div style={{
                          width: '32px',
                          height: '32px',
                          borderRadius: '6px',
                          background: '#F1F5F9',
                          border: '1px solid #CBD5E1',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          flexShrink: 0
                        }}>
                          {item.type === 'flashcard' ? (
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748B" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                              <rect x="2" y="7" width="20" height="14" rx="2"/>
                              <path d="M16 3h2a2 2 0 0 1 2 2v2M8 3H6a2 2 0 0 0-2 2v2"/>
                            </svg>
                          ) : (
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748B" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                              <polyline points="14 2 14 8 20 8"/>
                              <line x1="9" y1="15" x2="15" y2="15"/>
                            </svg>
                          )}
                        </div>
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <div style={{ fontWeight: 600, fontSize: '0.9rem', color: 'var(--color-text-primary)', marginBottom: '0.1rem' }}>
                            {item.nom}
                          </div>
                          {item.dci && (
                            <div style={{ fontSize: '0.75rem', color: 'var(--color-text-muted)' }}>
                              {item.dci} {item.classe && `‚Ä¢ ${item.classe}`}
                            </div>
                          )}
                        </div>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" strokeWidth="2">
                          <polyline points="9 18 15 12 9 6"/>
                        </svg>
                      </div>
                    ));
                  })()}
                </div>
              </div>
            </div>
          )}
          
          {/* MODE RESSOURCES */}
          {mode === 'ressources' && (
            <div>
              {/* Header section */}
              <div style={{ 
                marginBottom: '2rem'
              }}>
                <div>
                  <h1 style={{ 
                    fontSize: '2rem', 
                    fontWeight: 700, 
                    color: 'var(--color-text-primary)', 
                    marginBottom: '0.5rem' 
                  }}>
                    Ressources
                  </h1>
                  <p style={{ 
                    fontSize: '1rem', 
                    color: 'var(--color-text-muted)',
                    marginBottom: '0'
                  }}>
                    Liens utiles et bases de donn√©es essentielles
                  </p>
                </div>
              </div>
              
              <div style={{
                display: 'flex',
                justifyContent: 'flex-end',
                gap: '0.5rem',
                marginBottom: '3.5rem'
              }}>
                <button
                  onClick={() => {
                    setShowAddLinkGlobal(true);
                    setLinkForm({ nom: '', url: '', description: '', categoryId: ressources[0]?.id || '' });
                  }}
                  style={{
                    padding: '0.5rem 1rem',
                    background: 'var(--color-surface)',
                    border: '1px solid var(--color-border)',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    fontWeight: 500,
                    fontSize: '14px',
                    color: 'var(--color-text-secondary)',
                    transition: 'all 0.2s'
                  }}
                  className="button-hover"
                >
                  + Nouveau lien
                </button>
                <button
                  onClick={() => setShowManageCategories(true)}
                  style={{
                    padding: '0.5rem 1rem',
                    background: 'var(--color-button-primary)',
                    color: 'white',
                      border: 'none',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontWeight: 500,
                      fontSize: '14px',
                      transition: 'all 0.2s'
                    }}
                    className="button-hover"
                  >
                    G√©rer les cat√©gories
                  </button>
              </div>

              {/* Liste des cat√©gories */}
              {(ressources || []).map((categorie, catIndex) => (
                <div 
                  key={categorie.id} 
                  style={{ marginBottom: '2.5rem' }}
                >
                  {/* Header cat√©gorie */}
                  <h2 style={{ 
                    fontSize: '1.3rem', 
                    fontWeight: 600, 
                    color: 'var(--color-text-primary)',
                    marginBottom: '1rem'
                  }}>
                    {categorie.nom}
                  </h2>

                  {/* Grid des liens */}
                  <div style={{ 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', 
                    gap: '1rem' 
                  }}>
                    {(categorie.liens || []).map((link, linkIndex) => (
                      <div
                        key={link.id}
                        draggable
                        onDragStart={(e) => {
                          setDraggedLink({ categoryId: categorie.id, link, linkIndex });
                          e.dataTransfer.effectAllowed = 'move';
                        }}
                        onDragOver={(e) => {
                          e.preventDefault();
                          e.dataTransfer.dropEffect = 'move';
                        }}
                        onDrop={(e) => {
                          e.preventDefault();
                          if (draggedLink && draggedLink.link.id !== link.id) {
                            const newRessources = [...(ressources || [])];
                            const sourceCat = newRessources.find(c => c.id === draggedLink.categoryId);
                            const targetCat = newRessources.find(c => c.id === categorie.id);
                            
                            if (sourceCat && targetCat && sourceCat.liens && targetCat.liens) {
                              // Retirer de l'ancienne position
                              sourceCat.liens = sourceCat.liens.filter(l => l.id !== draggedLink.link.id);
                              
                              // Ins√©rer √† la nouvelle position
                              const targetIndex = targetCat.liens.findIndex(l => l.id === link.id);
                              targetCat.liens.splice(targetIndex, 0, draggedLink.link);
                              
                              saveRessources(newRessources);
                            }
                            setDraggedLink(null);
                          }
                        }}
                        onDragEnd={() => setDraggedLink(null)}
                        style={{
                          position: 'relative',
                          background: 'var(--color-surface)',
                          border: '1px solid var(--color-border)',
                          borderRadius: '6px',
                          padding: '1rem',
                          transition: 'all 0.2s',
                          cursor: 'move',
                          display: 'flex',
                          flexDirection: 'column',
                          minHeight: '80px'
                        }}
                      >
                        {/* Boutons de modification (hover en haut √† droite) */}
                        <div 
                          className="resource-card-buttons"
                          style={{
                            position: 'absolute',
                            top: '0.5rem',
                            right: '0.5rem',
                            display: 'flex',
                            gap: '0.25rem',
                            opacity: 0,
                            transition: 'opacity 0.2s',
                            zIndex: 10
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.opacity = '1';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.opacity = '0';
                          }}
                        >
                            <button
                              onClick={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                setEditingLink({ categoryId: categorie.id, link });
                                setLinkForm({ nom: link.nom, url: link.url, description: link.description, categoryId: categorie.id });
                              }}
                              style={{
                                padding: '0.25rem 0.4rem',
                                background: 'var(--color-surface)',
                                border: '1px solid var(--color-border)',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '0.75rem',
                                color: 'var(--color-text-secondary)'
                              }}
                            >
                              ‚úé
                            </button>
                            <button
                              onClick={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                if (window.confirm(`Supprimer "${link.nom}" ?`)) {
                                  const newRessources = (ressources || []).map(c => 
                                    c.id === categorie.id 
                                      ? { ...c, liens: (c.liens || []).filter(l => l.id !== link.id) }
                                      : c
                                  );
                                  saveRessources(newRessources);
                                }
                              }}
                              style={{
                                padding: '0.25rem 0.4rem',
                                background: 'var(--color-surface)',
                                border: '1px solid var(--color-border)',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '0.75rem',
                                color: '#EF4444'
                              }}
                            >
                              √ó
                            </button>
                          </div>

                        {/* Contenu du lien */}
                        <a
                          href={link.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          onClick={(e) => {
                            if (draggedLink) {
                              e.preventDefault();
                            }
                          }}
                          style={{
                            textDecoration: 'none',
                            display: 'flex',
                            flexDirection: 'column',
                            flex: 1
                          }}
                        >
                          <div style={{ 
                            fontWeight: 600, 
                            fontSize: '1rem', 
                            color: 'var(--color-text-primary)', 
                            marginBottom: '0.5rem',
                            paddingRight: hoveredLink === link.id ? '3rem' : '0'
                          }}>
                            {link.nom}
                          </div>
                          <div style={{ 
                            fontSize: '0.75rem', 
                            color: 'var(--color-text-muted)',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap'
                          }}>
                            {link.description}
                          </div>
                        </a>
                      </div>
                    ))}
                  </div>
                </div>
              ))}

              {/* Modal g√©rer cat√©gories */}
              {showManageCategories && (
                <div
                  style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    backdropFilter: 'blur(4px)',
                    zIndex: 1000,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '1rem'
                  }}
                  onClick={() => setShowManageCategories(false)}
                >
                  <div
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: 'var(--color-surface)',
                      borderRadius: '16px',
                      padding: '2rem',
                      maxWidth: '600px',
                      width: '100%',
                      maxHeight: '80vh',
                      overflowY: 'auto'
                    }}
                  >
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                      <h3 style={{ margin: 0, fontSize: '1.3rem', fontWeight: 600 }}>
                        G√©rer les cat√©gories
                      </h3>
                      <button
                        onClick={() => {
                          setShowAddCategory(true);
                          setCategoryForm({ nom: '' });
                        }}
                        style={{
                          padding: '0.5rem 1rem',
                          background: 'var(--color-button-primary)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '0.85rem',
                          fontWeight: 600
                        }}
                      >
                        + Nouvelle
                      </button>
                    </div>

                    {/* Liste drag and drop */}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                      {(ressources || []).map((cat, index) => (
                        <div
                          key={cat.id}
                          draggable
                          onDragStart={() => setDraggedCategory(index)}
                          onDragOver={(e) => e.preventDefault()}
                          onDrop={(e) => {
                            e.preventDefault();
                            if (draggedCategory !== null && draggedCategory !== index) {
                              const newRessources = [...(ressources || [])];
                              const [removed] = newRessources.splice(draggedCategory, 1);
                              newRessources.splice(index, 0, removed);
                              saveRessources(newRessources);
                              setDraggedCategory(null);
                            }
                          }}
                          onDragEnd={() => setDraggedCategory(null)}
                          style={{
                            padding: '1rem',
                            background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                            border: '2px solid var(--color-border)',
                            borderRadius: '8px',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            cursor: 'move',
                            transition: 'all 0.2s'
                          }}
                        >
                          <div style={{ fontWeight: 600, color: 'var(--color-text-primary)' }}>
                            {cat.nom}
                          </div>
                          <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <button
                              onClick={() => {
                                setEditingCategory(cat.id);
                                setCategoryForm({ nom: cat.nom });
                              }}
                              style={{
                                padding: '0.25rem 0.5rem',
                                background: 'var(--color-surface)',
                                border: '1px solid var(--color-border)',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '0.8rem',
                                color: 'var(--color-text-primary)'
                              }}
                            >
                              ‚úé
                            </button>
                            <button
                              onClick={() => {
                                if (window.confirm(`Supprimer la cat√©gorie "${cat.nom}" et tous ses liens ?`)) {
                                  saveRessources((ressources || []).filter(c => c.id !== cat.id));
                                }
                              }}
                              style={{
                                padding: '0.25rem 0.5rem',
                                background: 'var(--color-surface)',
                                border: '1px solid var(--color-border)',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '0.8rem',
                                color: '#EF4444'
                              }}
                            >
                              √ó
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>

                    <button
                      onClick={() => setShowManageCategories(false)}
                      style={{
                        width: '100%',
                        marginTop: '1.5rem',
                        padding: '0.75rem',
                        background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                        border: '1px solid var(--color-border)',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: 600
                      }}
                    >
                      Fermer
                    </button>
                  </div>
                </div>
              )}

              {/* Modal ajout cat√©gorie */}
              {showAddCategory && (
                <div
                  style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    backdropFilter: 'blur(4px)',
                    zIndex: 1001,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '1rem'
                  }}
                  onClick={() => setShowAddCategory(false)}
                >
                  <div
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: 'var(--color-surface)',
                      borderRadius: '16px',
                      padding: '2rem',
                      maxWidth: '500px',
                      width: '100%'
                    }}
                  >
                    <h3 style={{ margin: '0 0 1.5rem 0', fontSize: '1.3rem', fontWeight: 600 }}>
                      Nouvelle cat√©gorie
                    </h3>
                    <div style={{ marginBottom: '1.5rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem' }}>
                        Nom de la cat√©gorie
                      </label>
                      <input
                        type="text"
                        value={categoryForm.nom}
                        onChange={(e) => setCategoryForm({ ...categoryForm, nom: e.target.value })}
                        placeholder="Ex: Bases de donn√©es"
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      />
                    </div>
                    <div style={{ display: 'flex', gap: '1rem' }}>
                      <button
                        onClick={() => setShowAddCategory(false)}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                          border: '1px solid var(--color-border)',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                      >
                        Annuler
                      </button>
                      <button
                        onClick={() => {
                          if (categoryForm.nom.trim()) {
                            const newCategory = {
                              id: `cat_${Date.now()}`,
                              nom: categoryForm.nom.trim(),
                              liens: []
                            };
                            saveRessources([...(ressources || []), newCategory]);
                            setShowAddCategory(false);
                            setCategoryForm({ nom: '' });
                          }
                        }}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: 'var(--color-button-primary)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                        className="button-hover"
                      >
                        Cr√©er
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Modal modifier cat√©gorie */}
              {editingCategory && (
                <div
                  style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    backdropFilter: 'blur(4px)',
                    zIndex: 1001,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '1rem'
                  }}
                  onClick={() => setEditingCategory(null)}
                >
                  <div
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: 'var(--color-surface)',
                      borderRadius: '16px',
                      padding: '2rem',
                      maxWidth: '500px',
                      width: '100%'
                    }}
                  >
                    <h3 style={{ margin: '0 0 1.5rem 0', fontSize: '1.3rem', fontWeight: 600 }}>
                      Modifier la cat√©gorie
                    </h3>
                    <div style={{ marginBottom: '1.5rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem' }}>
                        Nom de la cat√©gorie
                      </label>
                      <input
                        type="text"
                        value={categoryForm.nom}
                        onChange={(e) => setCategoryForm({ ...categoryForm, nom: e.target.value })}
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      />
                    </div>
                    <div style={{ display: 'flex', gap: '1rem' }}>
                      <button
                        onClick={() => setEditingCategory(null)}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                          border: '1px solid var(--color-border)',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                      >
                        Annuler
                      </button>
                      <button
                        onClick={() => {
                          if (categoryForm.nom.trim()) {
                            const newRessources = (ressources || []).map(c =>
                              c.id === editingCategory
                                ? { ...c, nom: categoryForm.nom.trim() }
                                : c
                            );
                            saveRessources(newRessources);
                            setEditingCategory(null);
                          }
                        }}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: 'var(--color-button-primary)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                        className="button-hover"
                      >
                        Enregistrer
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Modal ajout lien global */}
              {showAddLinkGlobal && (
                <div
                  style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    backdropFilter: 'blur(4px)',
                    zIndex: 1000,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '1rem'
                  }}
                  onClick={() => setShowAddLinkGlobal(false)}
                >
                  <div
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: 'var(--color-surface)',
                      borderRadius: '16px',
                      padding: '2rem',
                      maxWidth: '500px',
                      width: '100%'
                    }}
                  >
                    <h3 style={{ margin: '0 0 1.5rem 0', fontSize: '1.3rem', fontWeight: 600 }}>
                      Nouveau lien
                    </h3>
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem' }}>
                        Cat√©gorie
                      </label>
                      <select
                        value={linkForm.categoryId}
                        onChange={(e) => setLinkForm({ ...linkForm, categoryId: e.target.value })}
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      >
                        {(ressources || []).map(cat => (
                          <option key={cat.id} value={cat.id}>{cat.nom}</option>
                        ))}
                      </select>
                    </div>
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem' }}>
                        Nom
                      </label>
                      <input
                        type="text"
                        value={linkForm.nom}
                        onChange={(e) => setLinkForm({ ...linkForm, nom: e.target.value })}
                        placeholder="Ex: Th√©riaque"
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      />
                    </div>
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem' }}>
                        URL
                      </label>
                      <input
                        type="url"
                        value={linkForm.url}
                        onChange={(e) => setLinkForm({ ...linkForm, url: e.target.value })}
                        placeholder="https://..."
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      />
                    </div>
                    <div style={{ marginBottom: '1.5rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem' }}>
                        Description
                      </label>
                      <textarea
                        value={linkForm.description}
                        onChange={(e) => setLinkForm({ ...linkForm, description: e.target.value })}
                        placeholder="Courte description..."
                        rows="3"
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem',
                          resize: 'vertical',
                          fontFamily: 'inherit'
                        }}
                      />
                    </div>
                    <div style={{ display: 'flex', gap: '1rem' }}>
                      <button
                        onClick={() => setShowAddLinkGlobal(false)}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                          border: '1px solid var(--color-border)',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                      >
                        Annuler
                      </button>
                      <button
                        onClick={() => {
                          if (linkForm.nom.trim() && linkForm.url.trim() && linkForm.categoryId) {
                            const newLink = {
                              id: `link_${Date.now()}`,
                              nom: linkForm.nom.trim(),
                              url: linkForm.url.trim(),
                              description: linkForm.description.trim()
                            };
                            const newRessources = (ressources || []).map(c =>
                              c.id === linkForm.categoryId
                                ? { ...c, liens: [...(c.liens || []), newLink] }
                                : c
                            );
                            saveRessources(newRessources);
                            setShowAddLinkGlobal(false);
                            setLinkForm({ nom: '', url: '', description: '', categoryId: ressources[0]?.id || '' });
                          }
                        }}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: 'var(--color-button-primary)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                        className="button-hover"
                      >
                        Ajouter
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Modal modifier lien */}
              {editingLink && (
                <div
                  style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    backdropFilter: 'blur(4px)',
                    zIndex: 1000,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '1rem'
                  }}
                  onClick={() => setEditingLink(null)}
                >
                  <div
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: 'var(--color-surface)',
                      borderRadius: '16px',
                      padding: '2rem',
                      maxWidth: '500px',
                      width: '100%'
                    }}
                  >
                    <h3 style={{ margin: '0 0 1.5rem 0', fontSize: '1.3rem', fontWeight: 600 }}>
                      Modifier le lien
                    </h3>
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem' }}>
                        Cat√©gorie
                      </label>
                      <select
                        value={linkForm.categoryId}
                        onChange={(e) => setLinkForm({ ...linkForm, categoryId: e.target.value })}
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      >
                        {(ressources || []).map(cat => (
                          <option key={cat.id} value={cat.id}>{cat.nom}</option>
                        ))}
                      </select>
                    </div>
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem' }}>
                        Nom
                      </label>
                      <input
                        type="text"
                        value={linkForm.nom}
                        onChange={(e) => setLinkForm({ ...linkForm, nom: e.target.value })}
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      />
                    </div>
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem' }}>
                        URL
                      </label>
                      <input
                        type="url"
                        value={linkForm.url}
                        onChange={(e) => setLinkForm({ ...linkForm, url: e.target.value })}
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      />
                    </div>
                    <div style={{ marginBottom: '1.5rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem' }}>
                        Description
                      </label>
                      <textarea
                        value={linkForm.description}
                        onChange={(e) => setLinkForm({ ...linkForm, description: e.target.value })}
                        rows="3"
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem',
                          resize: 'vertical',
                          fontFamily: 'inherit'
                        }}
                      />
                    </div>
                    <div style={{ display: 'flex', gap: '1rem' }}>
                      <button
                        onClick={() => setEditingLink(null)}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                          border: '1px solid var(--color-border)',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                      >
                        Annuler
                      </button>
                      <button
                        onClick={() => {
                          if (linkForm.nom.trim() && linkForm.url.trim()) {
                            const newRessources = (ressources || []).map(c => {
                              // Retirer le lien de son ancienne cat√©gorie
                              const filteredLinks = (c.liens || []).filter(l => l.id !== editingLink.link.id);
                              
                              // Ajouter √† la nouvelle cat√©gorie
                              if (c.id === linkForm.categoryId) {
                                return {
                                  ...c,
                                  liens: [...filteredLinks, {
                                    ...editingLink.link,
                                    nom: linkForm.nom.trim(),
                                    url: linkForm.url.trim(),
                                    description: linkForm.description.trim()
                                  }]
                                };
                              }
                              
                              return { ...c, liens: filteredLinks };
                            });
                            saveRessources(newRessources);
                            setEditingLink(null);
                          }
                        }}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: 'var(--color-button-primary)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                        className="button-hover"
                      >
                        Enregistrer
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* MODE S√âMINAIRES */}
          {mode === 'seminaires' && (
            <div>
              {/* Header section */}
              <div style={{ 
                marginBottom: '2rem'
              }}>
                <div>
                  <h1 style={{ 
                    fontSize: '2rem', 
                    fontWeight: 700, 
                    color: 'var(--color-text-primary)', 
                    marginBottom: '0.5rem' 
                  }}>
                    Cours & S√©minaires
                  </h1>
                  <p style={{ 
                    fontSize: '1rem', 
                    color: 'var(--color-text-muted)',
                    marginBottom: '0'
                  }}>
                    Formations et √©v√©nements professionnels
                  </p>
                </div>
              </div>
              
              <div style={{
                display: 'flex',
                justifyContent: 'flex-end',
                gap: '0.5rem',
                marginBottom: '2rem'
              }}>
                <button
                  onClick={() => {
                    setShowAddSeminaireLink(true);
                    setLinkFormSeminaire({ nom: '', url: '', description: '', categoryId: seminaires[activeCategorySeminaire]?.id || '' });
                  }}
                  style={{
                    padding: '0.5rem 1rem',
                    background: 'var(--color-surface)',
                    border: '1px solid var(--color-border)',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    fontWeight: 500,
                    fontSize: '14px',
                    color: 'var(--color-text-secondary)',
                    transition: 'all 0.2s'
                  }}
                  className="button-hover"
                >
                  + Nouveau lien
                </button>
                <button
                  onClick={() => setShowManageCategoriesSeminaires(true)}
                  style={{
                    padding: '0.5rem 1rem',
                    background: 'var(--color-button-primary)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    fontWeight: 500,
                    fontSize: '14px',
                    transition: 'all 0.2s'
                  }}
                  className="button-hover"
                >
                  G√©rer les cat√©gories
                </button>
              </div>

              {/* Onglets */}
              {seminaires.length > 0 ? (
                <>
                  <div style={{ 
                    display: 'flex', 
                    gap: '0.5rem', 
                    borderBottom: '2px solid var(--color-border)',
                    marginBottom: '2rem',
                    overflowX: 'auto',
                    paddingBottom: '0.5rem'
                  }}>
                    {seminaires.map((cat, index) => (
                      <button
                        key={cat.id}
                        onClick={() => setActiveCategorySeminaire(index)}
                        style={{
                          padding: '0.75rem 1.5rem',
                          background: activeCategorySeminaire === index ? 'var(--color-button-primary)' : 'var(--color-bg)',
                          color: activeCategorySeminaire === index ? 'white' : 'var(--color-text-secondary)',
                          border: 'none',
                          borderRadius: '6px 6px 0 0',
                          cursor: 'pointer',
                          fontSize: '14px',
                          fontWeight: activeCategorySeminaire === index ? 600 : 500,
                          transition: 'all 0.2s',
                          whiteSpace: 'nowrap',
                          borderBottom: activeCategorySeminaire === index ? '3px solid var(--color-accent)' : 'none'
                        }}
                        className="button-hover"
                      >
                        {cat.nom}
                      </button>
                    ))}
                    <button
                      onClick={() => setShowManageCategoriesSeminaires(true)}
                      style={{
                        padding: '0.75rem 1rem',
                        background: 'var(--color-surface)',
                        color: 'var(--color-text-secondary)',
                        border: '1px solid var(--color-border)',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: 500,
                        transition: 'all 0.2s'
                      }}
                      className="button-hover"
                      title="Ajouter une cat√©gorie"
                    >
                      +
                    </button>
                  </div>

                  {/* Contenu de l'onglet actif */}
                  {seminaires[activeCategorySeminaire] && (
                    <div>
                      {seminaires[activeCategorySeminaire].liens.length > 0 ? (
                        <div style={{ 
                          display: 'grid', 
                          gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', 
                          gap: '1rem' 
                        }}>
                          {seminaires[activeCategorySeminaire].liens.map((link, linkIndex) => (
                            <div
                              key={link.id}
                              draggable
                              onDragStart={(e) => {
                                setDraggedLinkSeminaire({ categoryId: seminaires[activeCategorySeminaire].id, link, linkIndex });
                                e.dataTransfer.effectAllowed = 'move';
                              }}
                              onDragOver={(e) => {
                                e.preventDefault();
                                e.dataTransfer.dropEffect = 'move';
                              }}
                              onDrop={(e) => {
                                e.preventDefault();
                                if (draggedLinkSeminaire && draggedLinkSeminaire.link.id !== link.id) {
                                  const newSeminaires = [...seminaires];
                                  const sourceCat = newSeminaires.find(c => c.id === draggedLinkSeminaire.categoryId);
                                  const targetCat = newSeminaires.find(c => c.id === seminaires[activeCategorySeminaire].id);
                                  
                                  if (sourceCat && targetCat && sourceCat.liens && targetCat.liens) {
                                    sourceCat.liens = sourceCat.liens.filter(l => l.id !== draggedLinkSeminaire.link.id);
                                    const targetIndex = targetCat.liens.findIndex(l => l.id === link.id);
                                    targetCat.liens.splice(targetIndex, 0, draggedLinkSeminaire.link);
                                    saveSeminaires(newSeminaires);
                                  }
                                  setDraggedLinkSeminaire(null);
                                }
                              }}
                              onDragEnd={() => setDraggedLinkSeminaire(null)}
                              style={{
                                position: 'relative',
                                background: 'var(--color-surface)',
                                border: '1px solid var(--color-border)',
                                borderRadius: '6px',
                                padding: '1rem',
                                transition: 'all 0.2s',
                                cursor: 'move',
                                display: 'flex',
                                flexDirection: 'column',
                                minHeight: '80px'
                              }}
                            >
                              {/* Boutons de modification (hover en haut √† droite) */}
                              <div 
                                className="seminaire-card-buttons"
                                style={{
                                  position: 'absolute',
                                  top: '0.5rem',
                                  right: '0.5rem',
                                  display: 'flex',
                                  gap: '0.25rem',
                                  opacity: 0,
                                  transition: 'opacity 0.2s',
                                  zIndex: 10
                                }}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.opacity = '1';
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.opacity = '0';
                                }}
                              >
                                <button
                                  onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    setEditingLinkSeminaire({ categoryId: seminaires[activeCategorySeminaire].id, link });
                                    setLinkFormSeminaire({ nom: link.nom, url: link.url, description: link.description, categoryId: seminaires[activeCategorySeminaire].id });
                                  }}
                                  style={{
                                    padding: '0.25rem 0.4rem',
                                    background: 'var(--color-surface)',
                                    border: '1px solid var(--color-border)',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    fontSize: '0.75rem',
                                    color: 'var(--color-text-secondary)'
                                  }}
                                >
                                  ‚úé
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    if (window.confirm(`Supprimer "${link.nom}" ?`)) {
                                      const newSeminaires = seminaires.map(c => 
                                        c.id === seminaires[activeCategorySeminaire].id 
                                          ? { ...c, liens: c.liens.filter(l => l.id !== link.id) }
                                          : c
                                      );
                                      saveSeminaires(newSeminaires);
                                    }
                                  }}
                                  style={{
                                    padding: '0.25rem 0.4rem',
                                    background: 'var(--color-surface)',
                                    border: '1px solid var(--color-border)',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    fontSize: '0.75rem',
                                    color: '#EF4444'
                                  }}
                                >
                                  √ó
                                </button>
                              </div>

                              {/* Contenu du lien */}
                              <a
                                href={link.url}
                                target="_blank"
                                rel="noopener noreferrer"
                                onClick={(e) => {
                                  e.stopPropagation();
                                }}
                                style={{
                                  textDecoration: 'none',
                                  color: 'inherit',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  gap: '0.5rem',
                                  flex: 1
                                }}
                              >
                                <h3 style={{
                                  margin: 0,
                                  fontSize: '1rem',
                                  fontWeight: 600,
                                  color: 'var(--color-text-primary)',
                                  lineHeight: '1.4'
                                }}>
                                  {link.nom}
                                </h3>
                                {link.description && (
                                  <p style={{
                                    margin: 0,
                                    fontSize: '0.85rem',
                                    color: 'var(--color-text-secondary)',
                                    lineHeight: '1.5',
                                    flex: 1
                                  }}>
                                    {link.description}
                                  </p>
                                )}
                              </a>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div style={{
                          padding: '3rem',
                          textAlign: 'center',
                          color: 'var(--color-text-muted)',
                          background: 'var(--color-bg)',
                          borderRadius: '12px',
                          border: '2px dashed var(--color-border)'
                        }}>
                          <p style={{ margin: '0 0 1rem 0', fontSize: '1.1rem' }}>üì≠ Aucun lien dans cette cat√©gorie</p>
                          <button
                            onClick={() => {
                              setShowAddSeminaireLink(true);
                              setLinkFormSeminaire({ nom: '', url: '', description: '', categoryId: seminaires[activeCategorySeminaire].id });
                            }}
                            style={{
                              padding: '0.75rem 1.5rem',
                              background: 'var(--color-button-primary)',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontSize: '0.9rem',
                              fontWeight: 500
                            }}
                          >
                            + Ajouter le premier lien
                          </button>
                        </div>
                      )}
                    </div>
                  )}
                </>
              ) : (
                <div style={{
                  padding: '4rem 2rem',
                  textAlign: 'center',
                  color: 'var(--color-text-muted)',
                  background: 'var(--color-bg)',
                  borderRadius: '12px',
                  border: '2px dashed var(--color-border)'
                }}>
                  <h2 style={{ margin: '0 0 1rem 0', color: 'var(--color-text-primary)' }}>üìö Commencez par cr√©er une cat√©gorie</h2>
                  <p style={{ margin: '0 0 2rem 0', fontSize: '1rem' }}>
                    Organisez vos s√©minaires par th√®me (Cardiologie, Diab√©tologie, etc.)
                  </p>
                  <button
                    onClick={() => setShowManageCategoriesSeminaires(true)}
                    style={{
                      padding: '0.75rem 1.5rem',
                      background: 'var(--color-button-primary)',
                      color: 'white',
                      border: 'none',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontSize: '1rem',
                      fontWeight: 600
                    }}
                  >
                    + Cr√©er ma premi√®re cat√©gorie
                  </button>
                </div>
              )}

              {/* Modal Ajouter un lien */}
              {showAddSeminaireLink && (
                <div
                  style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    backdropFilter: 'blur(4px)',
                    zIndex: 1000,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '1rem'
                  }}
                  onClick={() => setShowAddSeminaireLink(false)}
                >
                  <div
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: 'var(--color-surface)',
                      borderRadius: '16px',
                      padding: '2rem',
                      maxWidth: '500px',
                      width: '100%'
                    }}
                  >
                    <h3 style={{ margin: '0 0 1.5rem 0', fontSize: '1.3rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>
                      Nouveau lien
                    </h3>
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem', color: 'var(--color-text-primary)' }}>
                        Cat√©gorie
                      </label>
                      <select
                        value={linkFormSeminaire.categoryId}
                        onChange={(e) => setLinkFormSeminaire({ ...linkFormSeminaire, categoryId: e.target.value })}
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      >
                        {seminaires.map(cat => (
                          <option key={cat.id} value={cat.id}>{cat.nom}</option>
                        ))}
                      </select>
                    </div>
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem', color: 'var(--color-text-primary)' }}>
                        Nom du s√©minaire
                      </label>
                      <input
                        type="text"
                        value={linkFormSeminaire.nom}
                        onChange={(e) => setLinkFormSeminaire({ ...linkFormSeminaire, nom: e.target.value })}
                        placeholder="Ex: Formation Continue en Cardiologie"
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      />
                    </div>
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem', color: 'var(--color-text-primary)' }}>
                        URL
                      </label>
                      <input
                        type="url"
                        value={linkFormSeminaire.url}
                        onChange={(e) => setLinkFormSeminaire({ ...linkFormSeminaire, url: e.target.value })}
                        placeholder="https://..."
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      />
                    </div>
                    <div style={{ marginBottom: '1.5rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem', color: 'var(--color-text-primary)' }}>
                        Description (optionnel)
                      </label>
                      <textarea
                        value={linkFormSeminaire.description}
                        onChange={(e) => setLinkFormSeminaire({ ...linkFormSeminaire, description: e.target.value })}
                        placeholder="Courte description du s√©minaire..."
                        rows="3"
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem',
                          fontFamily: 'inherit',
                          resize: 'vertical'
                        }}
                      />
                    </div>
                    <div style={{ display: 'flex', gap: '1rem' }}>
                      <button
                        onClick={() => setShowAddSeminaireLink(false)}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: 'var(--color-bg)',
                          color: 'var(--color-text-primary)',
                          border: '1px solid var(--color-border)',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontSize: '1rem',
                          fontWeight: 500
                        }}
                      >
                        Annuler
                      </button>
                      <button
                        onClick={() => {
                          if (linkFormSeminaire.nom && linkFormSeminaire.url && linkFormSeminaire.categoryId) {
                            const newLink = {
                              id: Date.now().toString(),
                              nom: linkFormSeminaire.nom,
                              url: linkFormSeminaire.url,
                              description: linkFormSeminaire.description
                            };
                            const newSeminaires = seminaires.map(cat =>
                              cat.id === linkFormSeminaire.categoryId
                                ? { ...cat, liens: [...cat.liens, newLink] }
                                : cat
                            );
                            saveSeminaires(newSeminaires);
                            setShowAddSeminaireLink(false);
                            setLinkFormSeminaire({ nom: '', url: '', description: '', categoryId: '' });
                          }
                        }}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: 'var(--color-button-primary)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontSize: '1rem',
                          fontWeight: 600
                        }}
                      >
                        Ajouter
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Modal Modifier un lien */}
              {editingLinkSeminaire && (
                <div
                  style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    backdropFilter: 'blur(4px)',
                    zIndex: 1000,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '1rem'
                  }}
                  onClick={() => setEditingLinkSeminaire(null)}
                >
                  <div
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: 'var(--color-surface)',
                      borderRadius: '16px',
                      padding: '2rem',
                      maxWidth: '500px',
                      width: '100%'
                    }}
                  >
                    <h3 style={{ margin: '0 0 1.5rem 0', fontSize: '1.3rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>
                      Modifier le lien
                    </h3>
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem', color: 'var(--color-text-primary)' }}>
                        Cat√©gorie
                      </label>
                      <select
                        value={linkFormSeminaire.categoryId}
                        onChange={(e) => setLinkFormSeminaire({ ...linkFormSeminaire, categoryId: e.target.value })}
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      >
                        {seminaires.map(cat => (
                          <option key={cat.id} value={cat.id}>{cat.nom}</option>
                        ))}
                      </select>
                    </div>
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem', color: 'var(--color-text-primary)' }}>
                        Nom du s√©minaire
                      </label>
                      <input
                        type="text"
                        value={linkFormSeminaire.nom}
                        onChange={(e) => setLinkFormSeminaire({ ...linkFormSeminaire, nom: e.target.value })}
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      />
                    </div>
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem', color: 'var(--color-text-primary)' }}>
                        URL
                      </label>
                      <input
                        type="url"
                        value={linkFormSeminaire.url}
                        onChange={(e) => setLinkFormSeminaire({ ...linkFormSeminaire, url: e.target.value })}
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem'
                        }}
                      />
                    </div>
                    <div style={{ marginBottom: '1.5rem' }}>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.9rem', color: 'var(--color-text-primary)' }}>
                        Description
                      </label>
                      <textarea
                        value={linkFormSeminaire.description}
                        onChange={(e) => setLinkFormSeminaire({ ...linkFormSeminaire, description: e.target.value })}
                        rows="3"
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          border: '2px solid var(--color-border)',
                          borderRadius: '8px',
                          fontSize: '1rem',
                          fontFamily: 'inherit',
                          resize: 'vertical'
                        }}
                      />
                    </div>
                    <div style={{ display: 'flex', gap: '1rem' }}>
                      <button
                        onClick={() => setEditingLinkSeminaire(null)}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: 'var(--color-bg)',
                          color: 'var(--color-text-primary)',
                          border: '1px solid var(--color-border)',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontSize: '1rem',
                          fontWeight: 500
                        }}
                      >
                        Annuler
                      </button>
                      <button
                        onClick={() => {
                          if (linkFormSeminaire.nom && linkFormSeminaire.url) {
                            const newSeminaires = seminaires.map(cat => {
                              // Retirer le lien de l'ancienne cat√©gorie
                              const filteredLinks = cat.liens.filter(l => l.id !== editingLinkSeminaire.link.id);
                              
                              // Ajouter le lien √† la nouvelle cat√©gorie
                              if (cat.id === linkFormSeminaire.categoryId) {
                                return {
                                  ...cat,
                                  liens: [...filteredLinks, {
                                    ...editingLinkSeminaire.link,
                                    nom: linkFormSeminaire.nom,
                                    url: linkFormSeminaire.url,
                                    description: linkFormSeminaire.description
                                  }]
                                };
                              }
                              return { ...cat, liens: filteredLinks };
                            });
                            saveSeminaires(newSeminaires);
                            setEditingLinkSeminaire(null);
                            setLinkFormSeminaire({ nom: '', url: '', description: '', categoryId: '' });
                          }
                        }}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: 'var(--color-button-primary)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontSize: '1rem',
                          fontWeight: 600
                        }}
                      >
                        Enregistrer
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Modal G√©rer les cat√©gories */}
              {showManageCategoriesSeminaires && (
                <div
                  style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    backdropFilter: 'blur(4px)',
                    zIndex: 1001,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '1rem'
                  }}
                  onClick={() => setShowManageCategoriesSeminaires(false)}
                >
                  <div
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: 'var(--color-surface)',
                      borderRadius: '16px',
                      padding: '2rem',
                      maxWidth: '600px',
                      width: '100%',
                      maxHeight: '80vh',
                      overflowY: 'auto'
                    }}
                  >
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                      <h3 style={{ margin: 0, fontSize: '1.3rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>
                        G√©rer les cat√©gories
                      </h3>
                      <button
                        onClick={() => {
                          const nom = prompt('Nom de la nouvelle cat√©gorie :');
                          if (nom && nom.trim()) {
                            const newCategory = {
                              id: Date.now().toString(),
                              nom: nom.trim(),
                              liens: []
                            };
                            saveSeminaires([...seminaires, newCategory]);
                          }
                        }}
                        style={{
                          padding: '0.5rem 1rem',
                          background: 'var(--color-button-primary)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '0.85rem',
                          fontWeight: 600
                        }}
                      >
                        + Nouvelle
                      </button>
                    </div>

                    {/* Liste drag and drop */}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                      {seminaires.map((cat, index) => (
                        <div
                          key={cat.id}
                          draggable
                          onDragStart={() => setDraggedCategorySeminaire(index)}
                          onDragOver={(e) => e.preventDefault()}
                          onDrop={(e) => {
                            e.preventDefault();
                            if (draggedCategorySeminaire !== null && draggedCategorySeminaire !== index) {
                              const newSeminaires = [...seminaires];
                              const [removed] = newSeminaires.splice(draggedCategorySeminaire, 1);
                              newSeminaires.splice(index, 0, removed);
                              saveSeminaires(newSeminaires);
                              setDraggedCategorySeminaire(null);
                              // Ajuster l'onglet actif
                              if (activeCategorySeminaire === draggedCategorySeminaire) {
                                setActiveCategorySeminaire(index);
                              } else if (activeCategorySeminaire === index) {
                                setActiveCategorySeminaire(draggedCategorySeminaire);
                              }
                            }
                          }}
                          onDragEnd={() => setDraggedCategorySeminaire(null)}
                          style={{
                            padding: '1rem',
                            background: 'var(--color-bg)',
                            color: 'var(--color-text-primary)',
                            border: '2px solid var(--color-border)',
                            borderRadius: '8px',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            cursor: 'move',
                            transition: 'all 0.2s'
                          }}
                        >
                          <div style={{ fontWeight: 600, color: 'var(--color-text-primary)' }}>
                            {cat.nom} <span style={{ color: 'var(--color-text-muted)', fontWeight: 400 }}>({cat.liens.length} lien{cat.liens.length !== 1 ? 's' : ''})</span>
                          </div>
                          <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <button
                              onClick={() => {
                                const newNom = prompt('Nouveau nom :', cat.nom);
                                if (newNom && newNom.trim()) {
                                  const newSeminaires = seminaires.map(c =>
                                    c.id === cat.id ? { ...c, nom: newNom.trim() } : c
                                  );
                                  saveSeminaires(newSeminaires);
                                }
                              }}
                              style={{
                                padding: '0.25rem 0.5rem',
                                background: 'var(--color-surface)',
                                border: '1px solid var(--color-border)',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '0.8rem',
                                color: 'var(--color-text-primary)'
                              }}
                            >
                              ‚úé
                            </button>
                            <button
                              onClick={() => {
                                if (window.confirm(`Supprimer la cat√©gorie "${cat.nom}" et tous ses liens (${cat.liens.length}) ?`)) {
                                  const newSeminaires = seminaires.filter(c => c.id !== cat.id);
                                  saveSeminaires(newSeminaires);
                                  // Ajuster l'onglet actif si n√©cessaire
                                  if (activeCategorySeminaire >= newSeminaires.length) {
                                    setActiveCategorySeminaire(Math.max(0, newSeminaires.length - 1));
                                  }
                                }
                              }}
                              style={{
                                padding: '0.25rem 0.5rem',
                                background: 'var(--color-surface)',
                                border: '1px solid var(--color-border)',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '0.8rem',
                                color: '#EF4444'
                              }}
                            >
                              √ó
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>

                    <button
                      onClick={() => setShowManageCategoriesSeminaires(false)}
                      style={{
                        marginTop: '1.5rem',
                        width: '100%',
                        padding: '0.75rem',
                        background: 'var(--color-button-primary)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontSize: '1rem',
                        fontWeight: 600
                      }}
                    >
                      Fermer
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* MODE FLASHCARD */}
          {mode === 'flashcard' && (
            <div>
              {/* Header section */}
              <div style={{ marginBottom: '2rem' }}>
                <h1 style={{ 
                  fontSize: '2rem', 
                  fontWeight: 700, 
                  color: 'var(--color-text-primary)', 
                  marginBottom: '0.5rem' 
                }}>
                  Sp√©cialit√©s
                </h1>
                <p style={{ 
                  fontSize: '1rem', 
                  color: 'var(--color-text-muted)',
                  marginBottom: '0'
                }}>
                  M√©morisez les DCI et noms commerciaux de vos m√©dicaments
                </p>
              </div>
              
              {/* Barre de contr√¥les */}
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 'var(--spacing-xl)', flexWrap: 'wrap', gap: 'var(--spacing-md)' }}>
                <div style={{ fontSize: 'var(--font-small)', color: 'var(--color-text-muted)', fontWeight: 600 }}>
                  {currentIndex + 1} / {getFlashcardListMedications.length}
                </div>
                <div style={{ display: 'flex', gap: 'var(--spacing-sm)' }}>
                  <button 
                    onClick={() => setShowManagement(true)} 
                    className="button-hover" 
                    style={{ 
                      padding: '0.5rem 1rem', 
                      background: 'var(--color-surface)', 
                      border: '1px solid var(--color-border)', 
                      borderRadius: '6px', 
                      cursor: 'pointer',
                      transition: 'all 0.2s',
                      fontSize: '14px',
                      fontWeight: 500,
                      color: 'var(--color-text-secondary)',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem'
                    }}
                  >
                    <Plus size={16} style={{ color: 'var(--color-text-secondary)' }} />
                    Ajouter
                  </button>
                  <button 
                    onClick={() => setFlashcardView('card')} 
                    className="button-hover" 
                    style={{ 
                      padding: '0.5rem 1rem', 
                      background: flashcardView === 'card' ? 'var(--color-button-primary)' : 'var(--color-bg)', 
                      border: '1px solid var(--color-border)', 
                      borderRadius: '6px', 
                      color: flashcardView === 'card' ? 'white' : 'var(--color-text-secondary)', 
                      cursor: 'pointer', 
                      fontSize: '14px', 
                      fontWeight: 500,
                      transition: 'all 0.2s'
                    }}
                  >
                    Carte
                  </button>
                  <button 
                    onClick={() => setFlashcardView('list')} 
                    className="button-hover" 
                    style={{ 
                      padding: '0.5rem 1rem', 
                      background: flashcardView === 'list' ? 'var(--color-button-primary)' : 'var(--color-bg)', 
                      border: '1px solid var(--color-border)', 
                      borderRadius: '6px', 
                      color: flashcardView === 'list' ? 'white' : 'var(--color-text-secondary)', 
                      cursor: 'pointer', 
                      fontSize: '14px', 
                      fontWeight: 500,
                      transition: 'all 0.2s'
                    }}
                  >
                    Liste
                  </button>
                </div>
              </div>

              {/* BARRE DE RECHERCHE ET TRI MODE CARTE */}
              {flashcardView === 'card' && (
                <div style={{ display: 'flex', gap: 'var(--spacing-md)', marginBottom: 'var(--spacing-xl)' }}>
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder="Rechercher par DCI, nom commercial..."
                    style={{
                      flex: 1,
                      padding: '0.75rem 1rem',
                      border: '1px solid var(--color-border)',
                      borderRadius: '6px',
                      fontSize: 'var(--font-body)',
                      fontFamily: 'inherit',
                      background: 'var(--color-surface)',
                      transition: 'all 0.2s'
                    }}
                    onFocus={(e) => {
                      e.target.style.borderColor = 'var(--color-border-hover)';
                    }}
                    onBlur={(e) => {
                      e.target.style.borderColor = 'var(--color-border)';
                    }}
                  />
                  <select 
                    value={flashcardListSort} 
                    onChange={(e) => setFlashcardListSort(e.target.value)} 
                    style={{ 
                      padding: '0.75rem 1rem', 
                      border: '1px solid var(--color-border)', 
                      borderRadius: '6px', 
                      fontSize: '14px', 
                      cursor: 'pointer', 
                      background: 'var(--color-surface)',
                      fontFamily: 'inherit',
                      color: 'var(--color-text-primary)'
                    }}
                  >
                    <option value="dci">DCI (A-Z)</option>
                    <option value="commercial">Commercial (A-Z)</option>
                    <option value="category">Par classe</option>
                    <option value="form">Par forme</option>
                    <option value="notes">Par notes/conseils</option>
                  </select>
                </div>
              )}

              {flashcardView === 'card' ? (
                <>
                  {getFlashcardListMedications[currentIndex] ? (
                  <div 
                    onClick={() => setShowAnswer(!showAnswer)} 
                    style={{ 
                      background: 'var(--color-surface)', 
                      borderRadius: '12px', 
                      padding: '3rem', 
                      cursor: 'pointer', 
                      minHeight: '400px', 
                      display: 'flex', 
                      flexDirection: 'column', 
                      alignItems: 'center', 
                      justifyContent: 'center', 
                      transition: 'all 0.3s', 
                      boxShadow: '0 4px 12px rgba(0, 0, 0, 0.05)', 
                      border: '1px solid var(--color-border)',
                      position: 'relative'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.borderColor = 'var(--color-border-hover)';
                      setHoveredCardIndex(currentIndex);
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.borderColor = 'var(--color-border)';
                      setHoveredCardIndex(null);
                    }}
                  >
                    <div style={{ 
                      fontSize: 'var(--font-tiny)', 
                      color: 'var(--color-text-muted)', 
                      marginBottom: 'var(--spacing-lg)', 
                      textTransform: 'uppercase', 
                      letterSpacing: '0.05em', 
                      fontWeight: 600 
                    }}>
                      {showAnswer ? 'DCI' : 'Nom Commercial'}
                    </div>
                    <div style={{ 
                      fontSize: showAnswer ? '32px' : '28px', 
                      fontWeight: 600, 
                      color: 'var(--color-text-primary)', 
                      marginBottom: 'var(--spacing-md)', 
                      textAlign: 'center',
                      letterSpacing: '-0.01em'
                    }}>
                      {showAnswer ? getFlashcardListMedications[currentIndex].dci : getFlashcardListMedications[currentIndex].commercial.join(' ‚Ä¢ ')}
                    </div>
                    {showAnswer && (
                      <div style={{ 
                        padding: '0.5rem 1rem', 
                        background: `${getClassColor(getFlashcardListMedications[currentIndex].category)}15`, 
                        borderRadius: '6px', 
                        color: getClassColor(getFlashcardListMedications[currentIndex].category), 
                        fontSize: '14px', 
                        fontWeight: 500, 
                        marginBottom: 'var(--spacing-xl)',
                        border: `1px solid ${getClassColor(getFlashcardListMedications[currentIndex].category)}30`
                      }}>
                        {getFlashcardListMedications[currentIndex].category}
                      </div>
                    )}
                    {showAnswer && (() => {
                      const med = getFlashcardListMedications[currentIndex];
                      const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                      const forms = med.pharmaceuticalForm ? med.pharmaceuticalForm.split(',').map(f => f.trim()) : [];
                      
                      return images.length > 0 ? (
                        <div style={{ 
                          display: 'flex', 
                          gap: 'var(--spacing-xl)', 
                          justifyContent: 'center', 
                          marginTop: 'var(--spacing-xl)', 
                          width: '100%',
                          flexWrap: 'wrap' 
                        }}>
                          {images.map((url, idx) => (
                            <div key={idx} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 'var(--spacing-sm)' }}>
                              <img 
                                src={url} 
                                alt={`${med.dci} ${idx + 1}`}
                                style={{ 
                                  maxWidth: images.length > 1 ? '180px' : '280px',
                                  maxHeight: images.length > 1 ? '180px' : '280px',
                                  borderRadius: '8px',
                                  cursor: 'pointer',
                                  transition: 'transform 0.2s',
                                  border: '1px solid var(--color-border)'
                                }}
                                onClick={(e) => { e.stopPropagation(); setImageModalUrl(url); }}
                                onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                                onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                              />
                              {forms[idx] && (
                                <div style={{ 
                                  fontSize: 'var(--font-small)', 
                                  color: 'var(--color-text-muted)', 
                                  fontWeight: 500 
                                }}>
                                  {forms[idx]}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      ) : null;
                    })()}

                    
                    {/* BOUTON NOTES/CONSEILS en haut √† droite - TOUJOURS VISIBLE */}
                    {(() => {
                      const med = getFlashcardListMedications[currentIndex];
                      const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                      const items = getConsolidatedNotesConseils(med.commercial[0] || med.dci, images);
                      
                      const notesCount = items.filter(it => it.type === 'note').length;
                      const conseilsCount = items.filter(it => it.type === 'conseil').length;
                      const totalCount = notesCount + conseilsCount;
                      
                      return (
                        <React.Fragment key={`notes-button-${refreshKey}-${currentIndex}`}>
                          {/* Zone hover pour les boutons en haut √† droite */}
                          <div
                            style={{
                              position: 'absolute',
                              top: '1rem',
                              right: '1rem',
                              display: 'flex',
                              gap: '0.5rem',
                              alignItems: 'center',
                              zIndex: 100
                            }}
                          >
                            {/* Bouton Modifier - Appara√Æt au hover */}
                            {hoveredCardIndex === currentIndex && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  // Trouver l'index r√©el dans medications, pas dans le tableau tri√©
                                  const currentMed = getFlashcardListMedications[currentIndex];
                                  const realIndex = medications.findIndex(m => 
                                    m.dci === currentMed.dci && 
                                    m.commercial[0] === currentMed.commercial[0]
                                  );
                                  startEditMedication(realIndex);
                                  setShowManagement(true);
                                }}
                                style={{
                                  padding: '0.4rem 0.6rem',
                                  background: 'var(--color-surface)',
                                  border: '1px solid var(--color-border)',
                                  borderRadius: '6px',
                                  cursor: 'pointer',
                                  color: 'var(--color-text-secondary)',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  transition: 'all 0.2s'
                                }}
                                onMouseEnter={(e) => {
                                  e.target.style.borderColor = 'var(--color-border-hover)';
                                  e.target.style.background = 'var(--color-bg)';
                                }}
                                onMouseLeave={(e) => {
                                  e.target.style.borderColor = 'var(--color-border)';
                                  e.target.style.background = 'var(--color-surface)';
                                }}
                              >
                                <Edit2 size={14} />
                              </button>
                            )}
                            
                            {/* Bouton Supprimer - Appara√Æt au hover */}
                            {hoveredCardIndex === currentIndex && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  const currentMed = getFlashcardListMedications[currentIndex];
                                  const realIndex = medications.findIndex(m => 
                                    m.dci === currentMed.dci && 
                                    m.commercial[0] === currentMed.commercial[0]
                                  );
                                  if (confirm(`Supprimer "${currentMed.commercial[0]}" ?`)) {
                                    const newMeds = medications.filter((_, idx) => idx !== realIndex);
                                    saveMedications(newMeds);
                                    // Ajuster l'index si n√©cessaire
                                    if (currentIndex >= newMeds.length) {
                                      setCurrentIndex(Math.max(0, newMeds.length - 1));
                                    }
                                  }
                                }}
                                style={{
                                  padding: '0.4rem 0.6rem',
                                  background: '#FEE2E2',
                                  border: '1px solid #FCA5A5',
                                  borderRadius: '6px',
                                  cursor: 'pointer',
                                  color: '#DC2626',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  transition: 'all 0.2s'
                                }}
                                onMouseEnter={(e) => {
                                  e.target.style.background = '#FEE2E2';
                                }}
                                onMouseLeave={(e) => {
                                  e.target.style.background = '#FEE2E2';
                                }}
                              >
                                <X size={14} />
                              </button>
                            )}

                            {/* Bouton Notes */}
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setModalMedication(getFlashcardListMedications[currentIndex]);
                                setShowNotesModal(true);
                              }}
                              style={{
                                padding: '0.4rem 0.75rem',
                                borderRadius: '6px',
                                background: totalCount > 0 ? 'var(--color-button-primary)' : 'var(--color-surface)',
                                border: `1px solid ${totalCount > 0 ? 'var(--color-button-primary)' : 'var(--color-border)'}`,
                                cursor: 'pointer',
                                color: totalCount > 0 ? 'white' : 'var(--color-text-muted)',
                                fontWeight: 600,
                                fontSize: 'var(--font-tiny)',
                                transition: 'all 0.2s',
                                minWidth: '32px',
                                textAlign: 'center'
                              }}
                              onMouseEnter={(e) => {
                                e.target.style.transform = 'translateY(-2px)';
                                e.target.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                              }}
                              onMouseLeave={(e) => {
                                e.target.style.transform = 'translateY(0)';
                                e.target.style.boxShadow = 'none';
                              }}
                            >
                              {totalCount > 0 ? totalCount : '‚Äî'}
                            </button>
                          </div>
                          
                          {/* MODAL NOTES/CONSEILS */}
                          {showNotesModal && (
                            <div
                              style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                background: 'rgba(0,0,0,0.5)',
                                backdropFilter: 'blur(4px)',
                                zIndex: 10000,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                padding: '1rem'
                              }}
                              onClick={(e) => {
                                e.stopPropagation();
                                console.log('üîí Fermeture modale - modalMedication:', modalMedication, 'pendingCacheUpdate:', pendingCacheUpdate);
                              setShowNotesModal(false);
                                setEditingItemId(null);
                              }}
                            >
                              <div
                                onClick={(e) => e.stopPropagation()}
                                style={{
                                  background: 'var(--color-surface)',
                                  borderRadius: '12px',
                                  padding: '2rem',
                                  maxWidth: '600px',
                                  width: '100%',
                                  maxHeight: '80vh',
                                  overflowY: 'auto',
                                  border: '1px solid var(--color-border)'
                                }}
                              >
                                <div style={{ 
                                  display: 'flex', 
                                  justifyContent: 'space-between', 
                                  alignItems: 'center', 
                                  marginBottom: 'var(--spacing-xl)',
                                  paddingBottom: 'var(--spacing-lg)',
                                  borderBottom: '1px solid var(--color-border)'
                                }}>
                                  <h3 style={{ 
                                    fontSize: '20px', 
                                    fontWeight: 600, 
                                    color: 'var(--color-text-primary)', 
                                    margin: 0 
                                  }}>
                                    Notes & Conseils
                                  </h3>
                                  <button
                                    onClick={() => {
                                      setShowNotesModal(false);
                                      setEditingItemId(null);
                                    }}
                                    style={{
                                      background: 'none',
                                      border: 'none',
                                      cursor: 'pointer',
                                      fontSize: '24px',
                                      color: 'var(--color-text-muted)',
                                      padding: 0,
                                      lineHeight: 1
                                    }}
                                  >
                                    √ó
                                  </button>
                                </div>
                                
                                <div key={refreshKey}>
                                  {(() => {
                                    const med = getFlashcardListMedications[currentIndex];
                                    const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                                    const items = getConsolidatedNotesConseils(med.commercial[0] || med.dci, images);
                                    return items.map((item) => (
                                    <div
                                      key={item.id}
                                      style={{
                                        marginBottom: 'var(--spacing-lg)',
                                        padding: 'var(--spacing-lg)',
                                        background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                                        borderRadius: '8px',
                                        borderLeft: `3px solid ${item.type === 'note' ? '#3B82F6' : '#0284C7'}`,
                                        border: '1px solid var(--color-border)',
                                        borderLeftWidth: '3px',
                                        borderLeftColor: item.type === 'note' ? '#3B82F6' : '#0284C7'
                                      }}
                                    >
                                      {editingItemId === item.id ? (
                                        <div>
                                          <textarea
                                            value={editingText}
                                            onChange={(e) => setEditingText(e.target.value)}
                                            style={{
                                              width: '100%',
                                              minHeight: '80px',
                                              padding: '0.75rem',
                                              background: 'var(--color-surface)',
                                              border: '1px solid var(--color-border)',
                                              borderRadius: '6px',
                                              fontSize: 'var(--font-body)',
                                              color: 'var(--color-text-primary)',
                                              resize: 'vertical',
                                              fontFamily: 'inherit'
                                            }}
                                            autoFocus
                                          />
                                          <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.75rem' }}>
                                            <button
                                              onClick={() => {
                                                const success = item.isStandalone 
                                                  ? updateStandaloneNoteConseil(item.id, editingText)
                                                  : updateNoteConseilInPlainte(item, editingText);
                                                if (success) {
                                                  setRefreshKey(prev => prev + 1);
                                                  setEditingItemId(null);
                                                }
                                              }}
                                              style={{
                                                flex: 1,
                                                padding: '0.75rem',
                                                background: 'var(--color-button-primary)',
                                                border: 'none',
                                                borderRadius: '6px',
                                                color: 'white',
                                                cursor: 'pointer',
                                                fontWeight: 500,
                                                fontSize: '14px',
                                                fontFamily: 'inherit'
                                              }}
                                            >
                                              Enregistrer
                                            </button>
                                            <button
                                              onClick={() => setEditingItemId(null)}
                                              style={{
                                                flex: 1,
                                                padding: '0.75rem',
                                                background: 'var(--color-surface)',
                                                border: '1px solid var(--color-border)',
                                                borderRadius: '6px',
                                                color: 'var(--color-text-secondary)',
                                                cursor: 'pointer',
                                                fontWeight: 500,
                                                fontSize: '14px',
                                                fontFamily: 'inherit'
                                              }}
                                            >
                                              Annuler
                                            </button>
                                          </div>
                                        </div>
                                      ) : (
                                        <div>
                                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                            <span style={{
                                              fontSize: 'var(--font-tiny)',
                                              fontWeight: 600,
                                              color: item.type === 'note' ? '#3B82F6' : '#0284C7',
                                              textTransform: 'uppercase',
                                              letterSpacing: '0.05em'
                                            }}>
                                              {item.type === 'note' ? 'Note' : 'Conseil'}
                                            </span>
                                            <div style={{ position: 'relative' }}>
                                              <button
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  setExpandedCard(expandedCard === item.id ? null : item.id);
                                                }}
                                                style={{
                                                  background: 'transparent',
                                                  border: 'none',
                                                  cursor: 'pointer',
                                                  fontSize: '1.2rem',
                                                  color: 'var(--color-text-muted)',
                                                  padding: '0.25rem 0.5rem'
                                                }}
                                              >
                                                ‚ãÆ
                                              </button>
                                              {expandedCard === item.id && (
                                                <div style={{
                                                  position: 'absolute',
                                                  top: '100%',
                                                  right: 0,
                                                  background: 'var(--color-surface)',
                                                  border: '1px solid var(--color-border)',
                                                  borderRadius: '6px',
                                                  boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                                                  minWidth: '120px',
                                                  zIndex: 1000,
                                                  overflow: 'hidden'
                                                }}>
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      setEditingItemId(item.id);
                                                      setEditingText(item.texte);
                                                      setExpandedCard(null);
                                                    }}
                                                    style={{
                                                      width: '100%',
                                                      padding: '0.75rem 1rem',
                                                      background: 'var(--color-surface)',
                                                      border: 'none',
                                                      borderBottom: '1px solid var(--color-border)',
                                                      cursor: 'pointer',
                                                      textAlign: 'left',
                                                      fontSize: '0.85rem',
                                                      color: 'var(--color-text-primary)'
                                                    }}
                                                    onMouseEnter={(e) => e.target.style.background = 'var(--color-bg)'}
                                                    onMouseLeave={(e) => e.target.style.background = 'var(--color-surface)'}
                                                  >
                                                    Modifier
                                                  </button>
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      if (confirm('Supprimer ' + (item.type === 'note' ? 'cette note' : 'ce conseil') + ' ?')) {
                                                        const success = item.isStandalone
                                                          ? deleteStandaloneNoteConseil(item.id)
                                                          : deleteNoteConseilInPlainte(item);
                                                        if (success) {
                                                          setRefreshKey(prev => prev + 1);
                                                        }
                                                      }
                                                      setExpandedCard(null);
                                                    }}
                                                    style={{
                                                      width: '100%',
                                                      padding: '0.75rem 1rem',
                                                      background: 'var(--color-surface)',
                                                      border: 'none',
                                                      cursor: 'pointer',
                                                      textAlign: 'left',
                                                      fontSize: '0.85rem',
                                                      color: '#ef4444'
                                                    }}
                                                    onMouseEnter={(e) => e.target.style.background = '#fef2f2'}
                                                    onMouseLeave={(e) => e.target.style.background = 'var(--color-surface)'}
                                                  >
                                                    Supprimer
                                                  </button>
                                                </div>
                                              )}
                                            </div>
                                          </div>
                                          <div style={{
                                            fontSize: '0.95rem',
                                            color: 'var(--color-text-primary)',
                                            lineHeight: 1.6,
                                            marginBottom: '0.5rem',
                                            whiteSpace: 'pre-wrap'
                                          }}>
                                            {item.texte}
                                          </div>
                                          <div style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'flex-end'
                                          }}>
                                            <div style={{
                                              fontSize: '0.75rem',
                                              color: 'var(--color-text-muted)',
                                              fontStyle: 'italic'
                                            }}>
                                              {item.isStandalone ? (
                                                <span>Note personnelle (non li√©e √† une fiche)</span>
                                              ) : (
                                                <span>Fiche: {item.plainteName}</span>
                                              )}
                                            </div>
                                            {!item.isStandalone && item.formes && item.formes.length > 0 && (
                                              <div style={{
                                                fontSize: '0.7rem',
                                                color: '#94a3b8',
                                                fontStyle: 'italic'
                                              }}>
                                                {[...new Set(item.formes)].join(', ')}
                                              </div>
                                            )}
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                  ));
                                  })()}
                                </div>
                                
                                {/* Boutons pour ajouter une note ou un conseil */}
                                {addingNoteType === null ? (
                                  <div style={{ marginTop: 'var(--spacing-xl)', display: 'flex', gap: 'var(--spacing-md)' }}>
                                    <button
                                      onClick={() => {
                                        setAddingNoteType('note');
                                        setNewNoteText('');
                                      }}
                                      style={{
                                        flex: 1,
                                        padding: '0.5rem 1rem',
                                        background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                                        border: '1px solid var(--color-border)',
                                        borderRadius: '4px',
                                        color: 'var(--color-text-secondary)',
                                        cursor: 'pointer',
                                        fontWeight: 500,
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        transition: 'all 0.2s'
                                      }}
                                      onMouseEnter={(e) => {
                                        e.currentTarget.style.background = '#EFF6FF';
                                        e.currentTarget.style.borderColor = '#3B82F6';
                                        e.currentTarget.style.color = '#D97706';
                                      }}
                                      onMouseLeave={(e) => {
                                        e.currentTarget.style.background = 'var(--color-bg)';
                                        e.currentTarget.style.borderColor = 'var(--color-border)';
                                        e.currentTarget.style.color = 'var(--color-text-secondary)';
                                      }}
                                    >
                                      + Ajouter une note
                                    </button>
                                    <button
                                      onClick={() => {
                                        setAddingNoteType('conseil');
                                        setNewNoteText('');
                                      }}
                                      style={{
                                        flex: 1,
                                        padding: '0.5rem 1rem',
                                        background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                                        border: '1px solid var(--color-border)',
                                        borderRadius: '4px',
                                        color: 'var(--color-text-secondary)',
                                        cursor: 'pointer',
                                        fontWeight: 500,
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        transition: 'all 0.2s'
                                      }}
                                      onMouseEnter={(e) => {
                                        e.currentTarget.style.background = '#DBEAFE';
                                        e.currentTarget.style.borderColor = '#0284C7';
                                        e.currentTarget.style.color = '#0369A1';
                                      }}
                                      onMouseLeave={(e) => {
                                        e.currentTarget.style.background = 'var(--color-bg)';
                                        e.currentTarget.style.borderColor = 'var(--color-border)';
                                        e.currentTarget.style.color = 'var(--color-text-secondary)';
                                      }}
                                    >
                                      + Ajouter un conseil
                                    </button>
                                  </div>
                                ) : (
                                  <div style={{ 
                                    marginTop: 'var(--spacing-xl)', 
                                    padding: 'var(--spacing-lg)', 
                                    background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)', 
                                    borderRadius: '8px', 
                                    border: `1px solid var(--color-border)`,
                                    borderLeftWidth: '3px',
                                    borderLeftColor: addingNoteType === 'note' ? '#3B82F6' : '#0284C7'
                                  }}>
                                    <div style={{ 
                                      fontSize: 'var(--font-small)', 
                                      fontWeight: 600, 
                                      color: addingNoteType === 'note' ? '#3B82F6' : '#0284C7', 
                                      marginBottom: 'var(--spacing-sm)',
                                      textTransform: 'uppercase',
                                      letterSpacing: '0.05em'
                                    }}>
                                      {addingNoteType === 'note' ? 'Nouvelle note' : 'Nouveau conseil'}
                                    </div>
                                    <textarea
                                      value={newNoteText}
                                      onChange={(e) => setNewNoteText(e.target.value)}
                                      placeholder="Tapez votre texte ici..."
                                      style={{
                                        width: '100%',
                                        minHeight: '80px',
                                        padding: '0.75rem',
                                        background: 'var(--color-surface)',
                                        border: '1px solid var(--color-border)',
                                        borderRadius: '6px',
                                        fontSize: 'var(--font-body)',
                                        color: 'var(--color-text-primary)',
                                        resize: 'vertical',
                                        fontFamily: 'inherit'
                                      }}
                                      autoFocus
                                    />
                                    <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.75rem' }}>
                                      <button
                                        onClick={() => {
                                          if (newNoteText.trim()) {
                                            const med = getFlashcardListMedications[currentIndex];
                                            const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                                            createStandaloneNoteConseil(med.commercial[0], med.dci, addingNoteType, newNoteText, images);
                                            setRefreshKey(prev => prev + 1);
                                            setAddingNoteType(null);
                                            setNewNoteText('');
                                          }
                                        }}
                                        style={{
                                          flex: 1,
                                          padding: '0.75rem',
                                          background: 'var(--color-button-primary)',
                                          border: 'none',
                                          borderRadius: '6px',
                                          color: 'white',
                                          cursor: 'pointer',
                                          fontWeight: 500,
                                          fontSize: '14px',
                                          fontFamily: 'inherit'
                                        }}
                                      >
                                        Enregistrer
                                      </button>
                                      <button
                                        onClick={() => {
                                          setAddingNoteType(null);
                                          setNewNoteText('');
                                        }}
                                        style={{
                                          flex: 1,
                                          padding: '0.75rem',
                                          background: 'var(--color-surface)',
                                          border: '1px solid var(--color-border)',
                                          borderRadius: '6px',
                                          color: 'var(--color-text-secondary)',
                                          cursor: 'pointer',
                                          fontWeight: 500,
                                          fontSize: '14px',
                                          fontFamily: 'inherit'
                                        }}
                                      >
                                        Annuler
                                      </button>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                        </React.Fragment>
                      );
                    })()}
                  </div>
                  ) : (
                  <div style={{
                    textAlign: 'center',
                    padding: '3rem',
                    color: 'var(--color-text-muted)',
                    background: 'var(--color-surface)',
                    border: '1px solid var(--color-border)',
                    borderRadius: '8px'
                  }}>
                    <div style={{ fontSize: '2rem', marginBottom: '1rem' }}>‚Äî</div>
                    <div style={{ fontSize: '16px', fontWeight: 600, marginBottom: '0.5rem', color: 'var(--color-text-primary)' }}>Aucun r√©sultat</div>
                    <div style={{ fontSize: '14px' }}>Essayez une autre recherche</div>
                  </div>
                  )}
                  
                  <div style={{ display: 'flex', gap: '1rem', marginTop: '2rem' }}>
                    <button onClick={() => currentIndex > 0 && (setCurrentIndex(currentIndex - 1), setShowAnswer(false))} disabled={currentIndex === 0} className="button-hover" style={{ flex: 1, padding: '1rem', background: currentIndex === 0 ? 'var(--color-bg)' : 'var(--color-surface)', border: '1px solid var(--color-border)', borderRadius: '12px', color: currentIndex === 0 ? 'var(--color-text-muted)' : 'var(--color-text-primary)', cursor: currentIndex === 0 ? 'not-allowed' : 'pointer', fontWeight: 600, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem' }}>
                      <ChevronLeft size={20} />
                      <span>Pr√©c√©dent</span>
                    </button>
                    <button 
                      onClick={() => getFlashcardListMedications.length > 1 && handleNext()} 
                      disabled={getFlashcardListMedications.length === 1}
                      className="button-hover" 
                      style={{ 
                        flex: 1, 
                        padding: '1rem', 
                        background: getFlashcardListMedications.length === 1 ? 'var(--color-bg)' : 'var(--color-button-primary)', 
                        border: 'none', 
                        borderRadius: '12px', 
                        color: getFlashcardListMedications.length === 1 ? 'var(--color-text-muted)' : 'white', 
                        cursor: getFlashcardListMedications.length === 1 ? 'not-allowed' : 'pointer', 
                        fontWeight: 600, 
                        display: 'flex', 
                        alignItems: 'center', 
                        justifyContent: 'center', 
                        gap: '0.5rem' 
                      }}
                    >
                      <span>Suivant</span>
                      <ChevronRight size={20} />
                    </button>
                  </div>
                </>
              ) : (
                <div>
                  {/* Barre recherche et tri mode liste */}
                  <div style={{ 
                    display: 'flex', 
                    gap: 'var(--spacing-md)', 
                    marginBottom: 'var(--spacing-xl)'
                  }}>
                    <input 
                      type="text" 
                      value={searchQuery} 
                      onChange={(e) => setSearchQuery(e.target.value)} 
                      placeholder="Rechercher par DCI, nom commercial..." 
                      style={{ 
                        flex: 1, 
                        padding: '0.75rem 1rem', 
                        border: '1px solid var(--color-border)', 
                        borderRadius: '6px', 
                        fontSize: 'var(--font-body)',
                        fontFamily: 'inherit',
                        background: 'var(--color-surface)',
                        transition: 'all 0.2s'
                      }} 
                      onFocus={(e) => {
                        e.target.style.borderColor = 'var(--color-border-hover)';
                      }}
                      onBlur={(e) => {
                        e.target.style.borderColor = 'var(--color-border)';
                      }}
                    />
                    <select 
                      value={flashcardListSort} 
                      onChange={(e) => setFlashcardListSort(e.target.value)} 
                      style={{ 
                        padding: '0.75rem 1rem', 
                        border: '1px solid var(--color-border)', 
                        borderRadius: '6px', 
                        fontSize: '14px', 
                        cursor: 'pointer', 
                        background: 'var(--color-surface)',
                        fontFamily: 'inherit',
                        color: 'var(--color-text-primary)'
                      }}
                    >
                      <option value="dci">DCI (A-Z)</option>
                      <option value="commercial">Commercial (A-Z)</option>
                      <option value="category">Par classe</option>
                      <option value="form">Par forme</option>
                      <option value="notes">Par notes/conseils</option>
                    </select>
                  </div>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--spacing-md)' }}>
                    {getFlashcardListMedications.length === 0 ? (
                      <div style={{ 
                        textAlign: 'center', 
                        padding: '3rem', 
                        color: 'var(--color-text-muted)',
                        background: 'var(--color-surface)',
                        border: '1px solid var(--color-border)',
                        borderRadius: '8px'
                      }}>
                        <div style={{ fontSize: '2rem', marginBottom: '1rem' }}>‚Äî</div>
                        <div style={{ fontSize: '16px', fontWeight: 600, marginBottom: '0.5rem', color: 'var(--color-text-primary)' }}>Aucun r√©sultat</div>
                        <div style={{ fontSize: '14px' }}>Essayez une autre recherche</div>
                      </div>
                    ) : (
                    getFlashcardListMedications.map((med, i) => {
                      // D√©finir les variables pour ce m√©dicament
                      const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                      const items = getConsolidatedNotesConseils(med.commercial[0] || med.dci, images);
                      const hasContent = items.length > 0;
                      const notesCount = items.filter(it => it.type === 'note').length;
                      const conseilsCount = items.filter(it => it.type === 'conseil').length;
                      const totalCount = notesCount + conseilsCount;
                      
                      return (
                        <div 
                          key={`${med.dci}-${listUpdateKey}-${i}`} 
                          style={{ 
                            position: 'relative', 
                            padding: 'var(--spacing-lg)', 
                            background: 'var(--color-surface)', 
                            border: '1px solid var(--color-border)', 
                            borderRadius: '8px', 
                            display: 'flex', 
                            gap: 'var(--spacing-lg)',
                            transition: 'all 0.2s'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.borderColor = 'var(--color-border-hover)';
                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.05)';
                            setHoveredCardIndex(i);
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.borderColor = 'var(--color-border)';
                            e.currentTarget.style.boxShadow = 'none';
                            setHoveredCardIndex(null);
                          }}
                        >
                          {/* Zone hover pour les boutons en haut √† droite */}
                          <div
                            style={{
                              position: 'absolute',
                              top: '0.5rem',
                              right: '0.5rem',
                              display: 'flex',
                              gap: '0.4rem',
                              alignItems: 'center',
                              zIndex: 10
                            }}
                          >
                            {/* Bouton Modifier - Appara√Æt au hover */}
                            {hoveredCardIndex === i && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  // Trouver l'index r√©el en utilisant l'ID unique (ou fallback sur comparaison compl√®te)
                                  const realIndex = medications.findIndex(m => {
                                    // Si les m√©dicaments ont un ID, utiliser l'ID
                                    if (med.id && m.id) {
                                      return m.id === med.id;
                                    }
                                    // Sinon, comparer toutes les propri√©t√©s
                                    return m.dci === med.dci && 
                                      JSON.stringify(m.commercial) === JSON.stringify(med.commercial) &&
                                      m.category === med.category &&
                                      m.pharmaceuticalForm === med.pharmaceuticalForm;
                                  });
                                  if (realIndex === -1) {
                                    console.error('‚ùå M√©dicament non trouv√©:', med);
                                    alert('Erreur: M√©dicament introuvable');
                                    return;
                                  }
                                  startEditMedication(realIndex);
                                  setShowManagement(true);
                                }}
                                style={{
                                  padding: '0.3rem 0.5rem',
                                  background: 'var(--color-surface)',
                                  border: '1px solid var(--color-border)',
                                  borderRadius: '4px',
                                  cursor: 'pointer',
                                  color: 'var(--color-text-secondary)',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  transition: 'all 0.2s'
                                }}
                                onMouseEnter={(e) => {
                                  e.target.style.borderColor = 'var(--color-border-hover)';
                                  e.target.style.background = 'var(--color-bg)';
                                }}
                                onMouseLeave={(e) => {
                                  e.target.style.borderColor = 'var(--color-border)';
                                  e.target.style.background = 'var(--color-surface)';
                                }}
                              >
                                <Edit2 size={12} color="var(--color-text-primary)" />
                              </button>
                            )}
                            
                            {/* Bouton Supprimer - Appara√Æt au hover */}
                            {hoveredCardIndex === i && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  const realIndex = medications.findIndex(m => m.dci === med.dci);
                                  if (confirm(`Supprimer "${med.commercial[0]}" ?`)) {
                                    const newMeds = medications.filter((_, idx) => idx !== realIndex);
                                    saveMedications(newMeds);
                                  }
                                }}
                                style={{
                                  padding: '0.3rem 0.5rem',
                                  background: '#FEE2E2',
                                  border: '1px solid #FCA5A5',
                                  borderRadius: '4px',
                                  cursor: 'pointer',
                                  color: '#DC2626',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  transition: 'all 0.2s'
                                }}
                                onMouseEnter={(e) => {
                                  e.target.style.background = '#FEE2E2';
                                }}
                                onMouseLeave={(e) => {
                                  e.target.style.background = '#FEE2E2';
                                }}
                              >
                                <X size={12} />
                              </button>
                            )}

                            {/* Badge notes */}
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setModalMedication(med);
                                console.log('üîì Modale ouverte pour:', med.dci, 'index:', i);
                                setShowNotesModal(true);
                              }}
                              style={{
                                padding: '0.3rem 0.6rem',
                                borderRadius: '4px',
                                background: totalCount > 0 ? 'var(--color-button-primary)' : 'var(--color-surface)',
                                border: `1px solid ${totalCount > 0 ? 'var(--color-button-primary)' : 'var(--color-border)'}`,
                                cursor: 'pointer',
                                color: totalCount > 0 ? 'white' : 'var(--color-text-muted)',
                                fontWeight: 600,
                                fontSize: '10px',
                                transition: 'all 0.2s',
                                minWidth: '28px',
                                textAlign: 'center'
                              }}
                              onMouseEnter={(e) => e.target.style.transform = 'translateY(-2px)'}
                              onMouseLeave={(e) => e.target.style.transform = 'translateY(0)'}
                            >
                              {totalCount > 0 ? totalCount : '‚Äî'}
                            </button>
                          </div>

                        {(() => {
                          const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                          return images.length > 0 ? (
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.25rem', width: '60px' }}>
                              {images.map((img, idx) => (
                                <img 
                                  key={idx}
                                  src={img} 
                                  alt={`${med.dci} ${idx+1}`} 
                                  style={{ 
                                    width: images.length === 1 ? '60px' : '28px', 
                                    height: images.length === 1 ? '60px' : '28px', 
                                    objectFit: 'contain', 
                                    borderRadius: '6px', 
                                    border: '1px solid var(--color-border)', 
                                    cursor: 'pointer',
                                    background: 'white'
                                  }} 
                                  onClick={() => setImageModalUrl(img)} 
                                />
                              ))}
                            </div>
                          ) : (
                            <div style={{ 
                              width: '60px', 
                              height: '60px', 
                              background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)', 
                              borderRadius: '6px', 
                              display: 'flex', 
                              alignItems: 'center', 
                              justifyContent: 'center', 
                              color: 'var(--color-text-muted)',
                              border: '1px solid var(--color-border)'
                            }}>
                              <ImagePlaceholder />
                            </div>
                          );
                        })()}
                        <div style={{ flex: 1 }}>
                          <div style={{ 
                            fontSize: '16px', 
                            fontWeight: 600, 
                            color: 'var(--color-text-primary)',
                            marginBottom: '0.25rem'
                          }}>
                            {med.commercial.join(' ‚Ä¢ ')}
                          </div>
                          <div style={{ 
                            fontSize: '14px', 
                            color: 'var(--color-text-secondary)',
                            marginBottom: 'var(--spacing-sm)'
                          }}>
                            {med.dci}
                          </div>
                          <div style={{ 
                            display: 'flex', 
                            gap: 'var(--spacing-sm)', 
                            alignItems: 'center', 
                            flexWrap: 'wrap' 
                          }}>
                            <div style={{ 
                              display: 'inline-block', 
                              padding: '0.25rem 0.75rem', 
                              background: `${getClassColor(med.category)}15`, 
                              borderRadius: '4px', 
                              color: getClassColor(med.category), 
                              fontSize: 'var(--font-small)', 
                              fontWeight: 500,
                              border: `1px solid ${getClassColor(med.category)}30`
                            }}>
                              {med.category}
                            </div>
                            {med.pharmaceuticalForm && (
                              <div style={{ 
                                fontSize: 'var(--font-small)', 
                                color: 'var(--color-text-muted)', 
                                display: 'flex', 
                                gap: '0.25rem', 
                                flexWrap: 'wrap' 
                              }}>
                                {[...new Set(med.pharmaceuticalForm.split(',').map(f => f.trim()))].map((form, i) => (
                                  <span 
                                    key={i} 
                                    style={{ 
                                      background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)', 
                                      padding: '0.25rem 0.6rem', 
                                      borderRadius: '12px',
                                      border: '1px solid var(--color-border)',
                                      fontSize: '11px'
                                    }}
                                  >
                                    {form}
                                  </span>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                    })
                    )}
                  </div>


                  {/* MODAL NOTES/CONSEILS - Accessible depuis tous les modes */}
                  {showNotesModal && modalMedication && (
                    <div
                      style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0,0,0,0.5)',
                        backdropFilter: 'blur(4px)',
                        zIndex: 10000,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '1rem'
                      }}
                      onClick={(e) => {
                        e.stopPropagation();
                        setShowNotesModal(false);
                        setModalMedication(null);
                        setEditingItemId(null);
                        setAddingNoteType(null);
                      }}
                    >
                      <div
                        onClick={(e) => e.stopPropagation()}
                        style={{
                          background: 'var(--color-surface)',
                          borderRadius: '12px',
                          padding: '2rem',
                          maxWidth: '600px',
                          width: '100%',
                          maxHeight: '80vh',
                          overflowY: 'auto',
                          border: '1px solid var(--color-border)'
                        }}
                      >
                        <div style={{ 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          alignItems: 'center', 
                          marginBottom: 'var(--spacing-xl)',
                          paddingBottom: 'var(--spacing-lg)',
                          borderBottom: '1px solid var(--color-border)'
                        }}>
                          <h3 style={{ 
                            fontSize: '20px', 
                            fontWeight: 600, 
                            color: 'var(--color-text-primary)', 
                            margin: 0 
                          }}>
                            Notes & Conseils
                          </h3>
                          <button
                            onClick={() => {
                              setShowNotesModal(false);
                              setModalMedication(null);
                              setEditingItemId(null);
                              setAddingNoteType(null);
                            }}
                            style={{
                              background: 'none',
                              border: 'none',
                              cursor: 'pointer',
                              fontSize: '24px',
                              color: 'var(--color-text-muted)',
                              padding: 0,
                              lineHeight: 1
                            }}
                          >
                            √ó
                          </button>
                        </div>
                        
                        {(() => {
                          const med = modalMedication;
                          const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                          const items = getConsolidatedNotesConseils(med.commercial[0] || med.dci, images);
                          
                          return (
                            <>
                              <div key={refreshKey}>
                                {items.map((item) => (
                                  <div
                                    key={item.id}
                                    style={{
                                      marginBottom: 'var(--spacing-lg)',
                                      padding: 'var(--spacing-lg)',
                                      background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                                      borderRadius: '8px',
                                      borderLeft: `3px solid ${item.type === 'note' ? '#3B82F6' : '#0284C7'}`,
                                      border: '1px solid var(--color-border)',
                                      borderLeftWidth: '3px',
                                      borderLeftColor: item.type === 'note' ? '#3B82F6' : '#0284C7'
                                    }}
                                  >
                                    {editingItemId === item.id ? (
                                      <div>
                                        <textarea
                                          value={editingText}
                                          onChange={(e) => setEditingText(e.target.value)}
                                          style={{
                                            width: '100%',
                                            minHeight: '80px',
                                            padding: '0.75rem',
                                            background: 'var(--color-surface)',
                                            border: '1px solid var(--color-border)',
                                            borderRadius: '6px',
                                            fontSize: 'var(--font-body)',
                                            color: 'var(--color-text-primary)',
                                            resize: 'vertical',
                                            fontFamily: 'inherit'
                                          }}
                                          autoFocus
                                        />
                                        <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.75rem' }}>
                                          <button
                                            onClick={() => {
                                              const success = item.isStandalone 
                                                ? updateStandaloneNoteConseil(item.id, editingText)
                                                : updateNoteConseilInPlainte(item, editingText);
                                              if (success) {
                                                setRefreshKey(prev => prev + 1);
                                                setEditingItemId(null);
                                              }
                                            }}
                                            style={{
                                              flex: 1,
                                              padding: '0.75rem',
                                              background: 'var(--color-button-primary)',
                                              border: 'none',
                                              borderRadius: '6px',
                                              color: 'white',
                                              cursor: 'pointer',
                                              fontWeight: 500,
                                              fontSize: '14px',
                                              fontFamily: 'inherit'
                                            }}
                                          >
                                            Enregistrer
                                          </button>
                                          <button
                                            onClick={() => setEditingItemId(null)}
                                            style={{
                                              flex: 1,
                                              padding: '0.75rem',
                                              background: 'var(--color-surface)',
                                              border: '1px solid var(--color-border)',
                                              borderRadius: '6px',
                                              color: 'var(--color-text-secondary)',
                                              cursor: 'pointer',
                                              fontWeight: 500,
                                              fontSize: '14px',
                                              fontFamily: 'inherit'
                                            }}
                                          >
                                            Annuler
                                          </button>
                                        </div>
                                      </div>
                                    ) : (
                                      <div>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                          <span style={{
                                            fontSize: 'var(--font-tiny)',
                                            fontWeight: 600,
                                            color: item.type === 'note' ? '#3B82F6' : '#0284C7',
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.05em'
                                          }}>
                                            {item.type === 'note' ? 'Note' : 'Conseil'}
                                          </span>
                                          <div style={{ position: 'relative' }}>
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                setExpandedCard(expandedCard === item.id ? null : item.id);
                                              }}
                                              style={{
                                                background: 'transparent',
                                                border: 'none',
                                                cursor: 'pointer',
                                                fontSize: '1.2rem',
                                                color: 'var(--color-text-muted)',
                                                padding: '0.25rem 0.5rem'
                                              }}
                                            >
                                              ‚ãÆ
                                            </button>
                                            {expandedCard === item.id && (
                                              <div style={{
                                                position: 'absolute',
                                                top: '100%',
                                                right: 0,
                                                background: 'var(--color-surface)',
                                                border: '1px solid var(--color-border)',
                                                borderRadius: '6px',
                                                boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                                                minWidth: '120px',
                                                zIndex: 1000,
                                                overflow: 'hidden'
                                              }}>
                                                <button
                                                  onClick={(e) => {
                                                    e.stopPropagation();
                                                    setEditingItemId(item.id);
                                                    setEditingText(item.texte);
                                                    setExpandedCard(null);
                                                  }}
                                                  style={{
                                                    width: '100%',
                                                    padding: '0.75rem 1rem',
                                                    background: 'var(--color-surface)',
                                                    border: 'none',
                                                    borderBottom: '1px solid var(--color-border)',
                                                    cursor: 'pointer',
                                                    textAlign: 'left',
                                                    fontSize: '0.85rem',
                                                    color: 'var(--color-text-primary)'
                                                  }}
                                                  onMouseEnter={(e) => e.target.style.background = 'var(--color-bg)'}
                                                  onMouseLeave={(e) => e.target.style.background = 'var(--color-surface)'}
                                                >
                                                  Modifier
                                                </button>
                                                <button
                                                  onClick={(e) => {
                                                    e.stopPropagation();
                                                    if (confirm('Supprimer ' + (item.type === 'note' ? 'cette note' : 'ce conseil') + ' ?')) {
                                                      const success = item.isStandalone
                                                        ? deleteStandaloneNoteConseil(item.id)
                                                        : deleteNoteConseilInPlainte(item);
                                                      if (success) {
                                                        setRefreshKey(prev => prev + 1);
                                                      }
                                                    }
                                                    setExpandedCard(null);
                                                  }}
                                                  style={{
                                                    width: '100%',
                                                    padding: '0.75rem 1rem',
                                                    background: 'var(--color-surface)',
                                                    border: 'none',
                                                    cursor: 'pointer',
                                                    textAlign: 'left',
                                                    fontSize: '0.85rem',
                                                    color: '#ef4444'
                                                  }}
                                                  onMouseEnter={(e) => e.target.style.background = '#fef2f2'}
                                                  onMouseLeave={(e) => e.target.style.background = 'var(--color-surface)'}
                                                >
                                                  Supprimer
                                                </button>
                                              </div>
                                            )}
                                          </div>
                                        </div>
                                        <div style={{
                                          fontSize: '0.95rem',
                                          color: 'var(--color-text-primary)',
                                          lineHeight: 1.6,
                                          marginBottom: '0.5rem',
                                          whiteSpace: 'pre-wrap'
                                        }}>
                                          {item.texte}
                                        </div>
                                        <div style={{
                                          display: 'flex',
                                          justifyContent: 'space-between',
                                          alignItems: 'flex-end'
                                        }}>
                                          <div style={{
                                            fontSize: '0.75rem',
                                            color: 'var(--color-text-muted)',
                                            fontStyle: 'italic'
                                          }}>
                                            {item.isStandalone ? (
                                              <span>Note personnelle (non li√©e √† une fiche)</span>
                                            ) : (
                                              <span>Fiche: {item.plainteName}</span>
                                            )}
                                          </div>
                                          {!item.isStandalone && item.formes && item.formes.length > 0 && (
                                            <div style={{
                                              fontSize: '0.7rem',
                                              color: '#94a3b8',
                                              fontStyle: 'italic'
                                            }}>
                                              {[...new Set(item.formes)].join(', ')}
                                            </div>
                                          )}
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                              
                              {/* Boutons ajout */}
                              {addingNoteType === null ? (
                                <div style={{ marginTop: 'var(--spacing-xl)', display: 'flex', gap: 'var(--spacing-md)' }}>
                                  <button
                                    onClick={() => {
                                      setAddingNoteType('note');
                                      setNewNoteText('');
                                    }}
                                    style={{
                                      flex: 1,
                                      padding: '0.5rem 1rem',
                                      background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                                      border: '1px solid var(--color-border)',
                                      borderRadius: '4px',
                                      color: 'var(--color-text-secondary)',
                                      cursor: 'pointer',
                                      fontWeight: 500,
                                      fontSize: '14px',
                                      fontFamily: 'inherit',
                                      transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                      e.currentTarget.style.background = '#EFF6FF';
                                      e.currentTarget.style.borderColor = '#3B82F6';
                                      e.currentTarget.style.color = '#D97706';
                                    }}
                                    onMouseLeave={(e) => {
                                      e.currentTarget.style.background = 'var(--color-bg)';
                                      e.currentTarget.style.borderColor = 'var(--color-border)';
                                      e.currentTarget.style.color = 'var(--color-text-secondary)';
                                    }}
                                  >
                                    + Ajouter une note
                                  </button>
                                  <button
                                    onClick={() => {
                                      setAddingNoteType('conseil');
                                      setNewNoteText('');
                                    }}
                                    style={{
                                      flex: 1,
                                      padding: '0.5rem 1rem',
                                      background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)',
                                      border: '1px solid var(--color-border)',
                                      borderRadius: '4px',
                                      color: 'var(--color-text-secondary)',
                                      cursor: 'pointer',
                                      fontWeight: 500,
                                      fontSize: '14px',
                                      fontFamily: 'inherit',
                                      transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                      e.currentTarget.style.background = '#DBEAFE';
                                      e.currentTarget.style.borderColor = '#0284C7';
                                      e.currentTarget.style.color = '#0369A1';
                                    }}
                                    onMouseLeave={(e) => {
                                      e.currentTarget.style.background = 'var(--color-bg)';
                                      e.currentTarget.style.borderColor = 'var(--color-border)';
                                      e.currentTarget.style.color = 'var(--color-text-secondary)';
                                    }}
                                  >
                                    + Ajouter un conseil
                                  </button>
                                </div>
                              ) : (
                                <div style={{ 
                                  marginTop: 'var(--spacing-xl)', 
                                  padding: 'var(--spacing-lg)', 
                                  background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)', 
                                  borderRadius: '8px', 
                                  border: `1px solid var(--color-border)`,
                                  borderLeftWidth: '3px',
                                  borderLeftColor: addingNoteType === 'note' ? '#3B82F6' : '#0284C7'
                                }}>
                                  <div style={{ 
                                    fontSize: 'var(--font-small)', 
                                    fontWeight: 600, 
                                    color: addingNoteType === 'note' ? '#3B82F6' : '#0284C7', 
                                    marginBottom: 'var(--spacing-sm)',
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.05em'
                                  }}>
                                    {addingNoteType === 'note' ? 'Nouvelle note' : 'Nouveau conseil'}
                                  </div>
                                  <textarea
                                    value={newNoteText}
                                    onChange={(e) => setNewNoteText(e.target.value)}
                                    placeholder="Tapez votre texte ici..."
                                    style={{
                                      width: '100%',
                                      minHeight: '80px',
                                      padding: '0.75rem',
                                      background: 'var(--color-surface)',
                                      border: '1px solid var(--color-border)',
                                      borderRadius: '6px',
                                      fontSize: 'var(--font-body)',
                                      color: 'var(--color-text-primary)',
                                      resize: 'vertical',
                                      fontFamily: 'inherit'
                                    }}
                                    autoFocus
                                  />
                                  <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.75rem' }}>
                                    <button
                                      onClick={() => {
                                        if (newNoteText.trim()) {
                                          createStandaloneNoteConseil(med.commercial[0], med.dci, addingNoteType, newNoteText, images);
                                          setRefreshKey(prev => prev + 1);
                                          setAddingNoteType(null);
                                          setNewNoteText('');
                                        }
                                      }}
                                      style={{
                                        flex: 1,
                                        padding: '0.75rem',
                                        background: 'var(--color-button-primary)',
                                        border: 'none',
                                        borderRadius: '6px',
                                        color: 'white',
                                        cursor: 'pointer',
                                        fontWeight: 500,
                                        fontSize: '14px',
                                        fontFamily: 'inherit'
                                      }}
                                    >
                                      Enregistrer
                                    </button>
                                    <button
                                      onClick={() => {
                                        setAddingNoteType(null);
                                        setNewNoteText('');
                                      }}
                                      style={{
                                        flex: 1,
                                        padding: '0.75rem',
                                        background: 'var(--color-surface)',
                                        border: '1px solid var(--color-border)',
                                        borderRadius: '6px',
                                        color: 'var(--color-text-secondary)',
                                        cursor: 'pointer',
                                        fontWeight: 500,
                                        fontSize: '14px',
                                        fontFamily: 'inherit'
                                      }}
                                    >
                                      Annuler
                                    </button>
                                  </div>
                                </div>
                              )}
                            </>
                          );
                        })()}
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          )}


          {/* MODAL IMAGE AGRANDIE */}
          {imageModalUrl && (
            <div 
              onClick={() => setImageModalUrl(null)} 
              style={{ 
                position: 'fixed', 
                top: 0, 
                left: 0, 
                right: 0, 
                bottom: 0, 
                background: 'rgba(0, 0, 0, 0.7)', 
                backdropFilter: 'blur(8px)',
                zIndex: 9999, 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center', 
                padding: '2rem',
                cursor: 'pointer'
              }}
            >
              <div 
                style={{ 
                  background: 'var(--color-surface)', 
                  borderRadius: '16px', 
                  padding: '1.5rem',
                  boxShadow: '0 25px 80px rgba(0, 0, 0, 0.3)',
                  maxWidth: '90%',
                  maxHeight: '90%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
                onClick={(e) => e.stopPropagation()}
              >
                <img 
                  src={imageModalUrl} 
                  alt="Image agrandie" 
                  style={{ 
                    maxWidth: '100%', 
                    maxHeight: '80vh', 
                    objectFit: 'contain', 
                    borderRadius: '8px'
                  }} 
                />


              </div>
            </div>
          )}

          {/* MODE QUIZ */}

          
          {/* MODAL GESTION DES DONN√âES */}
          {showDataManagement && (
            <div 
              style={{ 
                position: 'fixed', 
                top: 0, 
                left: 0, 
                right: 0, 
                bottom: 0, 
                background: 'rgba(0,0,0,0.5)', 
                backdropFilter: 'blur(4px)',
                zIndex: 2000, 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center', 
                padding: '1rem' 
              }} 
              onClick={() => setShowDataManagement(false)}
            >
              <div 
                onClick={(e) => e.stopPropagation()} 
                style={{ 
                  background: 'var(--color-surface)', 
                  borderRadius: '12px', 
                  padding: '2rem', 
                  maxWidth: '500px', 
                  width: '100%',
                  border: '1px solid var(--color-border)'
                }}
              >
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between', 
                  alignItems: 'center', 
                  marginBottom: 'var(--spacing-xl)',
                  paddingBottom: 'var(--spacing-lg)',
                  borderBottom: '1px solid var(--color-border)'
                }}>
                  <h2 style={{ 
                    fontSize: '20px', 
                    fontWeight: 600, 
                    color: 'var(--color-text-primary)',
                    margin: 0,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.75rem'
                  }}>
                    <Database size={24} color="var(--color-text-primary)" />
                    Gestion des donn√©es
                  </h2>
                  <button
                    onClick={() => setShowDataManagement(false)}
                    style={{
                      background: 'none',
                      border: 'none',
                      fontSize: '24px',
                      color: 'var(--color-text-muted)',
                      cursor: 'pointer',
                      padding: 0,
                      lineHeight: 1
                    }}
                  >
                    √ó
                  </button>
                </div>

                <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--spacing-md)', marginBottom: 'var(--spacing-xl)' }}>
                  {/* SECTION FIREBASE */}
                  <div style={{ 
                    padding: 'var(--spacing-lg)', 
                    background: isOnline ? '#ECFDF5' : '#FEF2F2',
                    borderRadius: '8px',
                    border: `1px solid ${isOnline ? '#059669' : '#DC2626'}`
                  }}>
                    <div style={{ 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '0.75rem',
                      marginBottom: 'var(--spacing-sm)'
                    }}>
                      <div style={{
                        width: '32px',
                        height: '32px',
                        borderRadius: '50%',
                        background: isOnline ? '#059669' : '#DC2626',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '16px'
                      }}>
                        {isOnline ? '‚úì' : '√ó'}
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontWeight: 600, fontSize: '16px', color: isOnline ? '#059669' : '#DC2626' }}>
                          {isOnline ? 'Connect√©' : 'D√©connect√©'}
                        </div>
                        <div style={{ fontSize: 'var(--font-small)', color: 'var(--color-text-muted)' }}>
                          Firebase Sync
                        </div>
                      </div>
                    </div>
                    
                    <div style={{ 
                      fontSize: 'var(--font-small)', 
                      color: 'var(--color-text-secondary)', 
                      lineHeight: '1.5' 
                    }}>
                      {!isOnline && (
                        'Mode lecture seule. Connexion Internet requise pour modifier les donn√©es.'
                      )}
                    </div>
                  </div>
                  
                  {/* EXPORT */}
                  <button 
                    onClick={() => { exportData(); setShowDataManagement(false); }} 
                    className="button-hover" 
                    style={{ 
                      padding: 'var(--spacing-lg)', 
                      background: 'var(--color-button-primary)', 
                      border: 'none', 
                      borderRadius: '6px', 
                      color: 'white', 
                      cursor: 'pointer', 
                      fontWeight: 500, 
                      fontSize: '14px', 
                      display: 'flex', 
                      alignItems: 'center', 
                      justifyContent: 'center', 
                      gap: '0.75rem',
                      fontFamily: 'inherit'
                    }}
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Exporter mes donn√©es
                  </button>
                  
                  {/* IMPORT */}
                  <label 
                    style={{ 
                      padding: 'var(--spacing-lg)', 
                      background: 'var(--color-surface)', 
                      border: '1px solid var(--color-border)', 
                      borderRadius: '6px', 
                      color: 'var(--color-text-secondary)', 
                      cursor: 'pointer', 
                      fontWeight: 500, 
                      fontSize: '14px', 
                      display: 'flex', 
                      alignItems: 'center', 
                      justifyContent: 'center', 
                      gap: '0.75rem',
                      fontFamily: 'inherit'
                    }} 
                    className="button-hover"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="17 8 12 3 7 8"/>
                      <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Importer des donn√©es
                    <input type="file" accept=".json" onChange={(e) => { 
                      if (confirm('‚ö†Ô∏è ATTENTION\n\nEn important ce fichier, vous allez :\n‚Ä¢ √âcraser TOUTES vos donn√©es actuelles\n‚Ä¢ Remplacer Firebase par ce fichier\n‚Ä¢ Synchroniser le changement sur tous vos appareils\n\nVoulez-vous vraiment continuer ?')) {
                        importData(e); 
                        setShowDataManagement(false);
                      } else {
                        e.target.value = '';
                      }
                    }} style={{ display: 'none' }} />
                  </label>
                  
                  {/* RESET */}
                  <button 
                    onClick={() => { 
                      const confirmation = prompt('üö® R√âINITIALISATION TOTALE\n\nVous √™tes sur le point de :\n‚Ä¢ Supprimer TOUS vos m√©dicaments\n‚Ä¢ Supprimer TOUTES vos plaintes conseils\n‚Ä¢ Revenir aux donn√©es par d√©faut\n‚Ä¢ Synchroniser sur tous vos appareils\n\nCette action est IRR√âVERSIBLE !\n\nTapez "SUPPRIMER" pour confirmer :');
                      if (confirmation === 'SUPPRIMER') {
                        resetToDefault(); 
                        setShowDataManagement(false);
                      }
                    }} 
                    className="button-hover" 
                    style={{ 
                      padding: 'var(--spacing-lg)', 
                      background: '#FEE2E2', 
                      border: '1px solid #DC2626', 
                      borderRadius: '6px', 
                      color: '#DC2626', 
                      cursor: 'pointer', 
                      fontWeight: 500, 
                      fontSize: '14px', 
                      display: 'flex', 
                      alignItems: 'center', 
                      justifyContent: 'center', 
                      gap: '0.75rem',
                      fontFamily: 'inherit'
                    }}
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <polyline points="1 4 1 10 7 10"/>
                      <polyline points="23 20 23 14 17 14"/>
                      <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                    R√©initialiser tout
                  </button>
                </div>

              </div>
            </div>
          )}

          {/* MODAL GUIDE IMGUR */}
          {showImgurGuide && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.7)', zIndex: 3000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '1rem' }} onClick={() => setShowImgurGuide(false)}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: 'var(--color-surface)', borderRadius: '20px', padding: '2rem', maxWidth: '600px', width: '100%', maxHeight: '90vh', overflowY: 'auto' }}>
                <h2 style={{ fontSize: '1.5rem', marginBottom: '1.5rem', color: 'var(--color-text-primary)', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3B82F6" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                  Comment obtenir une URL d'image ?
                </h2>
                
                <div style={{ marginBottom: '1.5rem' }}>
                  <h3 style={{ fontSize: '1.1rem', color: '#3B82F6', marginBottom: '0.75rem', fontWeight: 700 }}>
                    üåê M√©thode 1 : Imgur (Recommand√©)
                  </h3>
                  
                  <div style={{ background: 'var(--color-bg)', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                    <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: 'var(--color-text-primary)' }}>
                      <strong style={{ color: '#3B82F6' }}>√âtape 1 :</strong> Allez sur <a href="https://imgur.com/upload" target="_blank" style={{ color: '#3B82F6', fontWeight: 600 }}>imgur.com/upload</a>
                    </div>
                  </div>
                  
                  <div style={{ background: 'var(--color-bg)', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                    <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: 'var(--color-text-primary)' }}>
                      <strong style={{ color: '#3B82F6' }}>√âtape 2 :</strong> Cliquez sur "New post" ou glissez votre image
                    </div>
                  </div>
                  
                  <div style={{ background: 'var(--color-bg)', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                    <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: 'var(--color-text-primary)' }}>
                      <strong style={{ color: '#3B82F6' }}>√âtape 3 :</strong> Une fois upload√©e, faites <strong>clic droit</strong> sur l'image ‚Üí "Copier l'adresse de l'image"
                    </div>
                  </div>
                  
                  <div style={{ padding: '1rem', background: '#FEE', borderRadius: '10px', fontSize: '0.85rem', lineHeight: '1.5', marginBottom: '1rem', border: '2px solid #EF4444' }}>
                    <strong style={{ color: '#C00' }}>‚ö†Ô∏è IMPORTANT - Diff√©rence d'URL :</strong><br/><br/>
                    <div style={{ fontFamily: 'monospace', fontSize: '0.8rem' }}>
                      ‚ùå <span style={{ color: '#C00', fontWeight: 'bold' }}>MAUVAISE</span> (URL de la page) :<br/>
                      <code style={{ background: 'var(--color-surface)', padding: '0.2rem 0.4rem', borderRadius: '4px' }}>https://imgur.com/abc123</code><br/><br/>
                      
                      ‚úÖ <span style={{ color: '#10B981', fontWeight: 'bold' }}>BONNE</span> (URL directe) :<br/>
                      <code style={{ background: 'var(--color-surface)', padding: '0.2rem 0.4rem', borderRadius: '4px' }}>https://i.imgur.com/abc123.jpg</code>
                    </div>
                    <div style={{ marginTop: '0.75rem', fontSize: '0.85rem', color: '#92400E' }}>
                      üí° Notez le <strong>"i."</strong> au d√©but et <strong>".jpg"</strong> √† la fin !
                    </div>
                  </div>
                  
                  <div style={{ background: 'var(--color-bg)', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                    <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: 'var(--color-text-primary)' }}>
                      <strong style={{ color: '#3B82F6' }}>√âtape 4 :</strong> Collez l'URL dans PharmaSpace !
                    </div>
                  </div>
                  
                  <div style={{ padding: '0.75rem', background: 'var(--color-badge-bg)', borderRadius: '8px', fontSize: '0.85rem', color: 'var(--color-badge-text)', marginTop: '0.75rem' }}>
                    ‚úÖ L'URL ressemble √† : <code style={{ background: 'var(--color-surface)', padding: '0.2rem 0.4rem', borderRadius: '4px', fontFamily: 'monospace' }}>https://i.imgur.com/abc123.jpg</code>
                  </div>
                </div>
                
                <div style={{ marginBottom: '1.5rem' }}>
                  <h3 style={{ fontSize: '1.1rem', color: '#10B981', marginBottom: '0.75rem', fontWeight: 700 }}>
                    üñºÔ∏è M√©thode 2 : Autres services
                  </h3>
                  
                  <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: 'var(--color-text-muted)' }}>
                    ‚Ä¢ <strong>imgbb.com</strong> - Gratuit, sans compte<br/>
                    ‚Ä¢ <strong>Google Photos</strong> - Si vous avez un compte Google<br/>
                    ‚Ä¢ <strong>Cloudinary</strong> - Pour usage avanc√©<br/>
                  </div>
                </div>
                
                <div style={{ padding: '1rem', background: 'var(--color-bg)', borderRadius: '10px', fontSize: '0.85rem', color: 'var(--color-text-primary)', lineHeight: '1.5', marginBottom: '1.5rem', border: '2px solid var(--color-accent)' }}>
                  <strong>üí° Astuce :</strong> Avec des URLs, vous pouvez avoir <strong>272 images</strong> sans limite de stockage ! Une seule image est charg√©e √† la fois depuis internet.
                </div>
                
                <div style={{ padding: '1rem', background: 'var(--color-bg)', borderRadius: '10px', fontSize: '0.85rem', color: 'var(--color-text-primary)', lineHeight: '1.5', marginBottom: '1.5rem', border: '2px solid var(--color-warning)' }}>
                  <strong>‚ö†Ô∏è Important :</strong> Vous aurez besoin d'une connexion internet pour voir les images. Les images upload√©es via "üìÅ Fichier" fonctionnent hors ligne.
                </div>
                
                <button onClick={() => setShowImgurGuide(false)} className="button-hover" style={{ width: '100%', padding: '1rem', background: '#3B82F6', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '1rem' }}>
                  J'ai compris !
                </button>
              </div>
            </div>
          )}

          {/* MODAL SETTINGS */}
          {showSettings && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', zIndex: 1000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '1rem' }} onClick={() => { setShowSettings(false); setSelectionMode('all'); }}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: 'var(--color-surface)', borderRadius: '20px', padding: '2rem', maxWidth: '600px', width: '100%', maxHeight: '90vh', overflowY: 'auto' }}>
                <h2 style={{ fontSize: '1.5rem', marginBottom: '1.5rem', color: 'var(--color-text-primary)' }}>
                  S√©lection
                </h2>
                
                <div style={{ marginBottom: '1.5rem' }}>
                  
                  <div style={{ marginBottom: '1rem' }}>
                    <label style={{ display: 'flex', alignItems: 'center', padding: '1rem', background: selectionMode === 'all' ? '#EFF6FF' : 'white', border: `2px solid ${selectionMode === 'all' ? '#3B82F6' : '#e2e8f0'}`, borderRadius: '12px', cursor: 'pointer', marginBottom: '0.5rem' }}>
                      <input type="radio" name="mode" value="all" checked={selectionMode === 'all'} onChange={(e) => setSelectionMode(e.target.value)} style={{ marginRight: '0.75rem' }} />
                      <span style={{ fontWeight: 600, color: 'var(--color-text-primary)' }}>
                        Tous les m√©dicaments ({medications.length})
                      </span>
                    </label>
                    
                    <label style={{ display: 'flex', alignItems: 'center', padding: '1rem', background: selectionMode === 'class' ? '#EFF6FF' : 'white', border: `2px solid ${selectionMode === 'class' ? '#3B82F6' : '#e2e8f0'}`, borderRadius: '12px', cursor: 'pointer', marginBottom: '0.5rem' }}>
                      <input type="radio" name="mode" value="class" checked={selectionMode === 'class'} onChange={(e) => setSelectionMode(e.target.value)} style={{ marginRight: '0.75rem' }} />
                      <span style={{ fontWeight: 600, color: 'var(--color-text-primary)' }}>S√©lection par classe</span>
                    </label>
                    
                    <label style={{ display: 'flex', alignItems: 'center', padding: '1rem', background: selectionMode === 'custom' ? '#EFF6FF' : 'white', border: `2px solid ${selectionMode === 'custom' ? '#3B82F6' : '#e2e8f0'}`, borderRadius: '12px', cursor: 'pointer' }}>
                      <input type="radio" name="mode" value="custom" checked={selectionMode === 'custom'} onChange={(e) => setSelectionMode(e.target.value)} style={{ marginRight: '0.75rem' }} />
                      <span style={{ fontWeight: 600, color: 'var(--color-text-primary)' }}>S√©lection personnalis√©e</span>
                    </label>
                  </div>

                  {selectionMode === 'class' && (
                    <div style={{ padding: '1rem', background: 'var(--color-surface)', borderRadius: '12px', border: '2px solid var(--color-border)' }}>
                      <div style={{ fontSize: '0.85rem', color: 'var(--color-text-muted)', marginBottom: '0.75rem', fontWeight: 600 }}>Classes th√©rapeutiques :</div>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                        {getCategories().map(cat => {
                          const count = medications.filter(m => m.category === cat).length;
                          const isSelected = selectedClasses.includes(cat);
                          return (
                            <button 
                              key={cat}
                              onClick={() => setSelectedClasses(
                                isSelected 
                                  ? selectedClasses.filter(c => c !== cat) 
                                  : [...selectedClasses, cat]
                              )}
                              style={{ 
                                padding: '0.5rem 1rem', 
                                background: isSelected ? getClassColor(cat) : 'white', 
                                border: `2px solid ${getClassColor(cat)}`, 
                                borderRadius: '8px', 
                                color: isSelected ? 'white' : getClassColor(cat), 
                                cursor: 'pointer', 
                                fontWeight: 600, 
                                fontSize: '0.85rem',
                                transition: 'all 0.2s'
                              }}
                            >
                              {cat} ({count})
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  )}
                  
                  {selectionMode === 'custom' && mode === 'flashcard' && (
                    <div style={{ padding: '1rem', background: 'var(--color-surface)', borderRadius: '12px', border: '2px solid var(--color-border)', maxHeight: '300px', overflowY: 'auto' }}>
                      <div style={{ fontSize: '0.85rem', color: 'var(--color-text-muted)', marginBottom: '0.75rem', fontWeight: 600 }}>
                        S√©lectionnez les m√©dicaments ({selectedMeds.length} s√©lectionn√©{selectedMeds.length > 1 ? 's' : ''}) :
                      </div>
                      {medications.map((med, idx) => {
                        const isSelected = selectedMeds.includes(idx);
                        return (
                          <label 
                            key={idx} 
                            style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              padding: '0.75rem', 
                              background: isSelected ? `${getClassColor(med.category)}20` : 'white', 
                              border: `2px solid ${isSelected ? getClassColor(med.category) : '#e2e8f0'}`,
                              borderRadius: '8px', 
                              marginBottom: '0.5rem', 
                              cursor: 'pointer',
                              transition: 'all 0.2s'
                            }}
                          >
                            <input 
                              type="checkbox" 
                              checked={isSelected}
                              onChange={() => setSelectedMeds(
                                isSelected 
                                  ? selectedMeds.filter(i => i !== idx)
                                  : [...selectedMeds, idx]
                              )}
                              style={{ marginRight: '0.75rem', width: '18px', height: '18px', cursor: 'pointer' }}
                            />
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: 600, color: 'var(--color-text-primary)', fontSize: '0.9rem' }}>{med.commercial.join(' ‚Ä¢ ')}</div>
                              <div style={{ fontSize: '0.8rem', color: 'var(--color-text-muted)' }}>{med.dci}</div>
                            </div>
                            
                          </label>
                        );
                      })}
                    </div>
                  )}
                </div>

                <div style={{ display: 'flex', gap: '1rem' }}>
                  <button onClick={() => { setShowSettings(false); setSelectionMode('all'); }} className="button-hover" style={{ flex: 1, padding: '1rem', background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)', border: 'none', borderRadius: '12px', color: 'var(--color-text-primary)', cursor: 'pointer', fontWeight: 600 }}>
                    Annuler
                  </button>
                  <button onClick={applySelection} className="button-hover" style={{ flex: 1, padding: '1rem', background: '#334155', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600 }}>
                    'Appliquer'
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* MODAL GESTION */}
          {showManagement && (
            <div 
              style={{ 
                position: 'fixed', 
                top: 0, 
                left: 0, 
                right: 0, 
                bottom: 0, 
                background: 'rgba(0,0,0,0.5)', 
                backdropFilter: 'blur(4px)',
                zIndex: 1000, 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center', 
                padding: '1rem' 
              }} 
              onClick={() => { 
                setShowManagement(false); 
                cancelEdit(); 
                setErrorMessage(''); 
                setShowClassManager(false); 
                setEditingClass(null); 
              }}
            >
              <div 
                onClick={(e) => e.stopPropagation()} 
                style={{ 
                  background: 'var(--color-surface)', 
                  borderRadius: '12px', 
                  padding: '2rem', 
                  maxWidth: '700px', 
                  width: '100%', 
                  maxHeight: '90vh', 
                  overflowY: 'auto',
                  border: '1px solid var(--color-border)'
                }}
              >
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between', 
                  alignItems: 'center', 
                  marginBottom: '1.5rem',
                  paddingBottom: '1rem',
                  borderBottom: '1px solid var(--color-border)'
                }}>
                  <h2 style={{ 
                    fontSize: '20px', 
                    fontWeight: 600, 
                    color: 'var(--color-text-primary)',
                    margin: 0
                  }}>
                    {editingIndex !== null ? 'Modifier une sp√©cialit√©' : 'Ajouter une sp√©cialit√©'}
                  </h2>
                  <button
                    onClick={() => {
                      setShowManagement(false);
                      cancelEdit();
                      setErrorMessage('');
                      setShowClassManager(false);
                      setEditingClass(null);
                    }}
                    style={{
                      background: 'none',
                      border: 'none',
                      fontSize: '24px',
                      color: 'var(--color-text-muted)',
                      cursor: 'pointer',
                      padding: '0',
                      lineHeight: 1
                    }}
                  >
                    √ó
                  </button>
                </div>

                {errorMessage && (
                  <div style={{ 
                    padding: 'var(--spacing-md)', 
                    background: '#FEE2E2', 
                    border: '1px solid #DC2626', 
                    borderRadius: '6px', 
                    color: '#991B1B', 
                    marginBottom: 'var(--spacing-lg)', 
                    fontSize: 'var(--font-body)' 
                  }}>
                    {errorMessage}
                  </div>
                )}

                <div style={{ 
                  padding: 'var(--spacing-xl)', 
                  background: editingIndex !== null ? '#EFF6FF' : 'var(--color-bg)', 
                  borderRadius: '8px', 
                  marginBottom: 'var(--spacing-xl)', 
                  border: `1px solid ${editingIndex !== null ? '#3B82F6' : 'var(--color-border)'}`
                }}>
                  
                  <input 
                    type="text" 
                    placeholder="DCI *" 
                    value={customMed.dci} 
                    onChange={(e) => setCustomMed({...customMed, dci: e.target.value})} 
                    style={{ 
                      width: '100%', 
                      padding: '0.75rem', 
                      border: '1px solid var(--color-border)', 
                      borderRadius: '6px', 
                      marginBottom: '0.75rem', 
                      fontSize: 'var(--font-body)',
                      fontFamily: 'inherit',
                      background: 'var(--color-surface)',
                      color: 'var(--color-text-primary)'
                    }} 
                  />
                  
                  <input 
                    type="text" 
                    placeholder="Nom(s) commercial(aux) s√©par√©s par des virgules *" 
                    value={customMed.commercial} 
                    onChange={(e) => setCustomMed({...customMed, commercial: e.target.value})} 
                    style={{ 
                      width: '100%', 
                      padding: '0.75rem', 
                      border: '1px solid var(--color-border)', 
                      borderRadius: '6px', 
                      marginBottom: '0.75rem', 
                      fontSize: 'var(--font-body)',
                      fontFamily: 'inherit',
                      background: 'var(--color-surface)',
                      color: 'var(--color-text-primary)'
                    }} 
                  />
                  
                  <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                    <select 
                      value={customMed.category} 
                      onChange={(e) => setCustomMed({...customMed, category: e.target.value})} 
                      style={{ 
                        flex: 1, 
                        padding: '0.75rem', 
                        border: '1px solid var(--color-border)', 
                        borderRadius: '6px', 
                        fontSize: 'var(--font-body)', 
                        cursor: 'pointer',
                        fontFamily: 'inherit',
                        background: 'var(--color-surface)' 
                      }}
                    >
                      <option value="">-- S√©lectionner une classe --</option>
                      {getCategories().map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                      ))}
                    </select>
                    <button 
                      onClick={() => setShowClassManager(!showClassManager)} 
                      className="button-hover" 
                      style={{ 
                        padding: '0.75rem 1rem', 
                        background: showClassManager ? 'var(--color-button-primary)' : 'var(--color-surface)', 
                        border: `1px solid ${showClassManager ? 'var(--color-button-primary)' : 'var(--color-border)'}`, 
                        borderRadius: '6px', 
                        color: showClassManager ? 'white' : 'var(--color-text-secondary)', 
                        cursor: 'pointer', 
                        fontWeight: 500, 
                        fontSize: '14px',
                        fontFamily: 'inherit' 
                      }}
                    >
                      G√©rer
                    </button>
                  </div>
                  
                  {showClassManager && (
                    <div style={{ padding: '1rem', background: 'var(--color-surface)', borderRadius: '8px', marginBottom: '0.75rem', border: '2px solid #3B82F6' }}>
                      <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: 'var(--color-text-primary)' }}>Ajouter une nouvelle classe</div>
                      <input type="text" placeholder="Nom de la classe" value={newClassName} onChange={(e) => setNewClassName(e.target.value)} style={{ width: '100%', padding: '0.5rem', border: '2px solid var(--color-border)', borderRadius: '6px', marginBottom: '0.5rem', fontSize: '0.85rem', background: 'var(--color-surface)', color: 'var(--color-text-primary)' }} />
                      <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                        <input type="color" value={newClassColor} onChange={(e) => setNewClassColor(e.target.value)} style={{ width: '40px', height: '40px', border: 'none', borderRadius: '6px', cursor: 'pointer' }} />
                        <div style={{ flex: 1, padding: '0.5rem', background: newClassColor, borderRadius: '6px', color: 'white', textAlign: 'center', fontWeight: 600, fontSize: '0.85rem' }}>
                          Aper√ßu
                        </div>
                      </div>
                      <button onClick={addNewClass} className="button-hover" style={{ width: '100%', padding: '0.5rem', background: '#10B981', border: 'none', borderRadius: '6px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '0.85rem' }}>
                        Ajouter
                      </button>
                      
                      <div style={{ marginTop: '1rem', paddingTop: '1rem', borderTop: '1px solid var(--color-border)' }}>
                        <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: 'var(--color-text-primary)' }}>G√©rer les classes existantes</div>
                        {Object.entries(therapeuticClasses).map(([className, color]) => {
                          const isEditing = editingClass === className;
                          const medsInClass = medications.filter(m => m.category === className).length;
                          return (
                            <div key={className} style={{ padding: '0.5rem', background: isEditing ? '#EFF6FF' : 'var(--color-surface)', borderRadius: '6px', marginBottom: '0.5rem', border: isEditing ? '2px solid #3B82F6' : '1px solid var(--color-border)' }}>
                              {isEditing ? (
                                <div>
                                  <input type="text" defaultValue={className} id={`edit-${className}`} style={{ width: '100%', padding: '0.4rem', border: '1px solid var(--color-border)', borderRadius: '4px', marginBottom: '0.3rem', fontSize: '0.8rem', background: 'var(--color-surface)', color: 'var(--color-text-primary)' }} />
                                  <div style={{ display: 'flex', gap: '0.3rem', marginBottom: '0.3rem' }}>
                                    <input type="color" defaultValue={color} id={`color-${className}`} style={{ width: '30px', height: '30px', border: 'none', borderRadius: '4px' }} />
                                    <div style={{ flex: 1, padding: '0.3rem', background: color, borderRadius: '4px', color: 'white', textAlign: 'center', fontSize: '0.75rem', fontWeight: '600' }}>
                                      Aper√ßu
                                    </div>
                                  </div>
                                  <div style={{ display: 'flex', gap: '0.3rem' }}>
                                    <button onClick={() => { const newName = document.getElementById(`edit-${className}`).value; const newColor = document.getElementById(`color-${className}`).value; updateClass(className, newName, newColor); }} className="button-hover" style={{ flex: 1, padding: '0.4rem', background: '#10B981', border: 'none', borderRadius: '4px', color: 'white', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}>
                                      Valider
                                    </button>
                                    <button onClick={() => setEditingClass(null)} className="button-hover" style={{ flex: 1, padding: '0.4rem', background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)', border: 'none', borderRadius: '4px', color: 'var(--color-text-muted)', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}>
                                      Annuler
                                    </button>
                                  </div>
                                </div>
                              ) : (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                  <div style={{ width: '20px', height: '20px', background: color, borderRadius: '4px' }} />
                                  <span style={{ flex: 1, fontSize: '0.85rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>{className} ({medsInClass})</span>
                                  <button onClick={() => setEditingClass(className)} className="button-hover" style={{ padding: '0.3rem', background: 'var(--color-badge-bg)', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                                    <Edit size={12} color="#1E40AF" />
                                  </button>
                                  <button type="button" onClick={() => {
                                    console.log('className:', className);
                                    const medsCount = medications.filter(m => m.category === className).length;
                                    console.log('Nombre de m√©dicaments avec cette classe:', medsCount);
                                    if (medsCount > 0) {
                                      const updatedMeds = medications.map(med => 
                                        med.category === className ? {...med, category: 'Non attribu√©e'} : med
                                      );
                                      saveMedications(updatedMeds);
                                      if (!therapeuticClasses['Non attribu√©e']) {
                                        saveClasses({...therapeuticClasses, 'Non attribu√©e': '#9CA3AF'});
                                      }
                                    }
                                    console.log('Suppression directe');
                                    const updated = {...therapeuticClasses};
                                    delete updated[className];
                                    console.log('Nouveau dictionnaire de classes:', updated);
                                    saveClasses(updated);
                                    console.log('Suppression classe termin√©e');
                                  }} className="button-hover" style={{ padding: '0.3rem', background: '#FEE2E2', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                                    <Trash2 size={12} color="#DC2626" />
                                  </button>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                  
                  <div style={{ marginBottom: '1rem' }}>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.85rem', fontWeight: 600, color: 'var(--color-text-muted)' }}>
                      URLs des images (optionnel)
                    </label>
                    <textarea 
                      placeholder="Une URL par ligne&#10;https://example.com/image1.jpg&#10;https://example.com/image2.jpg"
                      value={customMed.imageUrls}
                      onChange={(e) => setCustomMed({...customMed, imageUrls: e.target.value})}
                      style={{ width: '100%', padding: '0.75rem', border: '2px solid var(--color-border)', borderRadius: '8px', fontSize: '0.9rem', minHeight: '80px', fontFamily: 'monospace', background: 'var(--color-surface)', color: 'var(--color-text-primary)' }}
                    />
                    {customMed.imageUrls && customMed.imageUrls.split('\n').filter(s => s.trim()).length > 0 && (
                      <div style={{ marginTop: '0.5rem', padding: '0.75rem', background: 'var(--color-bg)', borderRadius: '8px', border: '2px solid #3B82F6' }}>
                        <div style={{ fontSize: '0.75rem', color: 'var(--color-text-muted)', marginBottom: '0.5rem', fontWeight: 600 }}>
                          Aper√ßu ({customMed.imageUrls.split('\n').filter(s => s.trim()).length} image(s))
                        </div>
                        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                          {customMed.imageUrls.split('\n').filter(s => s.trim()).map((url, idx) => (
                            <img 
                              key={idx}
                              src={url.trim()} 
                              alt={`Aper√ßu ${idx+1}`}
                              style={{ maxWidth: '80px', maxHeight: '80px', objectFit: 'contain', borderRadius: '4px', background: 'var(--color-surface)', border: '1px solid var(--color-border)' }}
                              onError={(e) => { e.target.style.border = '2px solid #EF4444'; }}
                            />
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <div style={{ marginBottom: '1rem' }}>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.85rem', fontWeight: 600, color: 'var(--color-text-muted)' }}>
                      Forme(s) pharmaceutique(s) (optionnel)
                    </label>
                    
                    {/* FORMES S√âLECTIONN√âES DANS L'ORDRE */}
                    {customMed.pharmaceuticalForm && (
                      <div style={{ marginBottom: '0.75rem', padding: '0.75rem', background: 'var(--color-surface)', borderRadius: '8px', border: '2px solid #3B82F6' }}>
                        <div style={{ fontSize: '0.75rem', fontWeight: 600, color: 'var(--color-text-muted)', marginBottom: '0.5rem' }}>
                          Formes s√©lectionn√©es (ordre = ordre des images):
                        </div>
                        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap', alignItems: 'center' }}>
                          {customMed.pharmaceuticalForm.split(',').map((form, idx) => (
                            <div key={idx} style={{ display: 'flex', alignItems: 'center', gap: '0.25rem', padding: '0.5rem 0.75rem', background: '#3B82F6', color: 'white', borderRadius: '8px', fontSize: '0.85rem', fontWeight: 600 }}>
                              <span style={{ fontSize: '0.7rem', opacity: 0.8 }}>#{idx + 1}</span>
                              <span>{form.trim()}</span>
                              <button
                                type="button"
                                onClick={() => {
                                  const forms = customMed.pharmaceuticalForm.split(',').map(f => f.trim());
                                  forms.splice(idx, 1);
                                  setCustomMed({...customMed, pharmaceuticalForm: forms.join(', ')});
                                }}
                                style={{ marginLeft: '0.25rem', background: 'transparent', border: 'none', color: 'white', cursor: 'pointer', padding: '0.1rem', lineHeight: 1 }}
                              >
                                ‚úï
                              </button>
                            </div>
                          ))}
                          <button
                            type="button"
                            onClick={() => setCustomMed({...customMed, pharmaceuticalForm: ''})}
                            className="button-hover"
                            style={{ padding: '0.5rem 0.75rem', background: '#FEE2E2', border: 'none', borderRadius: '8px', color: '#DC2626', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}
                          >
                            Tout effacer
                          </button>
                        </div>
                      </div>
                    )}
                    
                    {/* DROPDOWN COMPACT POUR AJOUTER DES FORMES */}
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                      <select
                        value=""
                        onChange={(e) => {
                          if (e.target.value) {
                            const currentForms = customMed.pharmaceuticalForm ? customMed.pharmaceuticalForm.split(',').map(f => f.trim()) : [];
                            currentForms.push(e.target.value);
                            setCustomMed({...customMed, pharmaceuticalForm: currentForms.join(', ')});
                            e.target.value = ''; // Reset
                          }
                        }}
                        style={{ 
                          flex: 1, 
                          padding: '0.75rem', 
                          border: '2px solid var(--color-border)', 
                          borderRadius: '8px', 
                          fontSize: '0.9rem',
                          cursor: 'pointer',
                          background: 'var(--color-surface)'
                        }}
                      >
                        <option value="">‚ûï Ajouter une forme...</option>
                        {pharmaceuticalForms.sort().map(form => {
                          const isSelected = customMed.pharmaceuticalForm && customMed.pharmaceuticalForm.split(',').map(f => f.trim()).includes(form);
                          return (
                            <option key={form} value={form}>
                              {isSelected ? '‚úì ' : ''}{form}
                            </option>
                          );
                        })}
                      </select>
                      <button 
                        onClick={() => setShowFormManager(!showFormManager)} 
                        className="button-hover" 
                        style={{ 
                          padding: '0.75rem 1rem', 
                          background: showFormManager ? 'var(--color-button-primary)' : 'var(--color-surface)', 
                          border: `1px solid ${showFormManager ? 'var(--color-button-primary)' : 'var(--color-border)'}`, 
                          borderRadius: '6px', 
                          color: showFormManager ? 'white' : 'var(--color-text-secondary)', 
                          cursor: 'pointer', 
                          fontWeight: 500, 
                          fontSize: '14px',
                          fontFamily: 'inherit'
                        }}
                      >
                        G√©rer
                      </button>
                    </div>
                    <div style={{ fontSize: '0.75rem', color: 'var(--color-text-muted)', fontStyle: 'italic' }}>
                      S√©lectionnez les formes dans l'ordre de vos images. #1 = 1√®re image, #2 = 2√®me image, etc.
                    </div>
                    
                    {showFormManager && (
                      <div style={{ padding: '1rem', background: 'var(--color-surface)', borderRadius: '8px', marginTop: '0.75rem', border: '2px solid #3B82F6' }}>
                        <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: 'var(--color-text-primary)' }}>Ajouter une nouvelle forme</div>
                        <input 
                          type="text" 
                          placeholder="Nom de la forme" 
                          value={newFormName} 
                          onChange={(e) => setNewFormName(e.target.value)} 
                          style={{ width: '100%', padding: '0.5rem', border: '2px solid var(--color-border)', borderRadius: '6px', marginBottom: '0.5rem', fontSize: '0.85rem', background: 'var(--color-surface)', color: 'var(--color-text-primary)' }} 
                        />
                        <button 
                          onClick={() => {
                            if (!newFormName.trim()) {
                              alert('Le nom de la forme est obligatoire');
                              return;
                            }
                            if (pharmaceuticalForms.includes(newFormName.trim())) {
                              alert('Cette forme existe d√©j√†');
                              return;
                            }
                            saveForms([...pharmaceuticalForms, newFormName.trim()]);
                            setNewFormName('');
                          }} 
                          className="button-hover" 
                          style={{ width: '100%', padding: '0.5rem', background: '#10B981', border: 'none', borderRadius: '6px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '0.85rem' }}
                        >
                          Ajouter
                        </button>
                        
                        <div style={{ marginTop: '1rem', paddingTop: '1rem', borderTop: '1px solid var(--color-border)' }}>
                          <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: 'var(--color-text-primary)' }}>G√©rer les formes existantes</div>
                          <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                            {pharmaceuticalForms.sort().map((form) => {
                              const isEditing = editingForm === form;
                              const medsWithForm = medications.filter(m => m.pharmaceuticalForm && m.pharmaceuticalForm.includes(form)).length;
                              return (
                                <div key={form} style={{ padding: '0.5rem', background: isEditing ? '#EFF6FF' : 'var(--color-surface)', borderRadius: '6px', marginBottom: '0.5rem', border: isEditing ? '2px solid #3B82F6' : '1px solid var(--color-border)' }}>
                                  {isEditing ? (
                                    <div>
                                      <input 
                                        type="text" 
                                        defaultValue={form} 
                                        id={`edit-form-${form}`} 
                                        style={{ width: '100%', padding: '0.4rem', border: '1px solid var(--color-border)', borderRadius: '4px', marginBottom: '0.3rem', fontSize: '0.8rem', background: 'var(--color-surface)', color: 'var(--color-text-primary)' }} 
                                      />
                                      <div style={{ display: 'flex', gap: '0.3rem' }}>
                                        <button 
                                          onClick={() => {
                                            const newName = document.getElementById(`edit-form-${form}`).value.trim();
                                            if (!newName) {
                                              alert('Le nom ne peut pas √™tre vide');
                                              return;
                                            }
                                            if (newName !== form && pharmaceuticalForms.includes(newName)) {
                                              alert('Cette forme existe d√©j√†');
                                              return;
                                            }
                                            // Mettre √† jour la forme dans les m√©dicaments
                                            const updatedMeds = medications.map(med => {
                                              if (med.pharmaceuticalForm && med.pharmaceuticalForm.includes(form)) {
                                                const forms = med.pharmaceuticalForm.split(',').map(f => f.trim());
                                                const newForms = forms.map(f => f === form ? newName : f);
                                                return {...med, pharmaceuticalForm: newForms.join(', ')};
                                              }
                                              return med;
                                            });
                                            saveMedications(updatedMeds);
                                            // Mettre √† jour la liste des formes
                                            const updatedForms = pharmaceuticalForms.map(f => f === form ? newName : f);
                                            saveForms(updatedForms);
                                            setEditingForm(null);
                                          }} 
                                          className="button-hover" 
                                          style={{ flex: 1, padding: '0.4rem', background: '#10B981', border: 'none', borderRadius: '4px', color: 'white', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}
                                        >
                                          Valider
                                        </button>
                                        <button 
                                          onClick={() => setEditingForm(null)} 
                                          className="button-hover" 
                                          style={{ flex: 1, padding: '0.4rem', background: 'var(--color-bg)',
                      color: 'var(--color-text-primary)', border: 'none', borderRadius: '4px', color: 'var(--color-text-muted)', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}
                                        >
                                          Annuler
                                        </button>
                                      </div>
                                    </div>
                                  ) : (
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                      <span style={{ flex: 1, fontSize: '0.85rem', fontWeight: 600, color: 'var(--color-text-primary)' }}>{form} ({medsWithForm})</span>
                                      <button 
                                        onClick={() => setEditingForm(form)} 
                                        className="button-hover" 
                                        style={{ padding: '0.3rem', background: 'var(--color-badge-bg)', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                                      >
                                        <Edit size={12} color="#1E40AF" />
                                      </button>
                                      <button 
                                        type="button" 
                                        onClick={() => {
                                          if (medsWithForm > 0 && !confirm(`${medsWithForm} m√©dicament(s) utilisent cette forme. Voulez-vous vraiment la supprimer ?`)) {
                                            return;
                                          }
                                          // Supprimer la forme de tous les m√©dicaments
                                          const updatedMeds = medications.map(med => {
                                            if (med.pharmaceuticalForm && med.pharmaceuticalForm.includes(form)) {
                                              const forms = med.pharmaceuticalForm.split(',').map(f => f.trim()).filter(f => f !== form);
                                              return {...med, pharmaceuticalForm: forms.join(', ')};
                                            }
                                            return med;
                                          });
                                          saveMedications(updatedMeds);
                                          // Supprimer de la liste
                                          saveForms(pharmaceuticalForms.filter(f => f !== form));
                                        }} 
                                        className="button-hover" 
                                        style={{ padding: '0.3rem', background: '#FEE2E2', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                                      >
                                        <Trash2 size={12} color="#DC2626" />
                                      </button>
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <div style={{ display: 'flex', gap: '0.5rem', marginTop: 'var(--spacing-lg)' }}>
                    {editingIndex !== null && (
                      <button 
                        onClick={cancelEdit} 
                        className="button-hover" 
                        style={{ 
                          flex: 1, 
                          padding: '0.75rem', 
                          background: 'var(--color-surface)', 
                          border: '1px solid var(--color-border)', 
                          borderRadius: '6px', 
                          color: 'var(--color-text-secondary)', 
                          cursor: 'pointer', 
                          fontWeight: 500, 
                          fontSize: '14px',
                          fontFamily: 'inherit'
                        }}
                      >
                        Annuler
                      </button>
                    )}
                    <button  
                      onClick={saveMedication} 
                      className="button-hover" 
                      style={{ 
                        flex: 1, 
                        padding: '0.75rem', 
                        background: 'var(--color-button-primary)', 
                        border: 'none', 
                        borderRadius: '6px', 
                        color: 'white', 
                        cursor: 'pointer', 
                        fontWeight: 500, 
                        fontSize: '14px',
                        fontFamily: 'inherit'
                      }}
                    >
                      {editingIndex !== null ? 'Enregistrer' : 'Ajouter'}
                    </button>
                  </div>
                </div>

              </div>
            </div>
          )}
          
        </div>
        ) : (
          <ConseilsOfficine 
            onReturnToMenu={() => setMode('menu')} 
            medications={medications} 
            isOnline={isOnline}
            handleOfflineAction={handleOfflineAction}
            onOpenDataManagement={() => setShowDataManagement(true)}
            onResetView={(resetFn) => { resetConseilsViewRef.current = resetFn; }}
          />
        )}
      </div>
      
      {/* MODAL GESTION DES DONN√âES - Accessible depuis tous les modes */}
      {showDataManagement && (
        <div 
          style={{ 
            position: 'fixed', 
            top: 0, 
            left: 0, 
            right: 0, 
            bottom: 0, 
            background: 'rgba(0,0,0,0.5)', 
            backdropFilter: 'blur(4px)',
            zIndex: 2000, 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center', 
            padding: '1rem' 
          }} 
          onClick={() => setShowDataManagement(false)}
        >
          <div 
            onClick={(e) => e.stopPropagation()} 
            style={{ 
              background: 'var(--color-surface)', 
              borderRadius: '12px', 
              padding: '2rem', 
              maxWidth: '500px', 
              width: '100%',
              border: '1px solid var(--color-border)'
            }}
          >
            <div style={{ 
              display: 'flex', 
              justifyContent: 'space-between', 
              alignItems: 'center', 
              marginBottom: 'var(--spacing-xl)',
              paddingBottom: 'var(--spacing-lg)',
              borderBottom: '1px solid var(--color-border)'
            }}>
              <h2 style={{ 
                fontSize: '20px', 
                fontWeight: 600, 
                color: 'var(--color-text-primary)',
                margin: 0,
                display: 'flex',
                alignItems: 'center',
                gap: '0.75rem'
              }}>
                <Database size={24} color="var(--color-text-primary)" />
                Gestion des donn√©es
              </h2>
              <button
                onClick={() => setShowDataManagement(false)}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '24px',
                  color: 'var(--color-text-muted)',
                  cursor: 'pointer',
                  padding: 0,
                  lineHeight: 1
                }}
              >
                √ó
              </button>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--spacing-md)', marginBottom: 'var(--spacing-xl)' }}>
              {/* Statut de connexion */}
              <div style={{ 
                padding: 'var(--spacing-lg)', 
                background: isOnline ? '#ECFDF5' : '#FEF2F2',
                borderRadius: '6px',
                border: `1px solid ${isOnline ? '#059669' : '#DC2626'}`,
                display: 'flex',
                alignItems: 'center',
                gap: 'var(--spacing-md)'
              }}>
                <div style={{
                  width: '24px',
                  height: '24px',
                  borderRadius: '50%',
                  background: isOnline ? '#059669' : '#DC2626',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '14px',
                  color: 'white',
                  flexShrink: 0
                }}>
                  {isOnline ? '‚úì' : '√ó'}
                </div>
                <div style={{ flex: 1 }}>
                  <div style={{ 
                    fontSize: '14px', 
                    fontWeight: 500,
                    color: isOnline ? '#059669' : '#DC2626',
                    marginBottom: !isOnline ? '0.25rem' : 0
                  }}>
                    {isOnline ? 'Connect√©' : 'D√©connect√©'}
                  </div>
                  {!isOnline && (
                    <div style={{ 
                      fontSize: '12px', 
                      color: 'var(--color-text-secondary)'
                    }}>
                      Mode lecture seule
                    </div>
                  )}
                </div>
              </div>
              
              {/* Toggle mode sombre */}
              <div style={{ 
                padding: 'var(--spacing-lg)', 
                background: 'var(--color-bg)',
                borderRadius: '6px',
                border: '1px solid var(--color-border)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                gap: 'var(--spacing-md)'
              }}>
                <div>
                  <div style={{ 
                    fontSize: '14px', 
                    fontWeight: 500,
                    color: 'var(--color-text-primary)',
                    marginBottom: '0.25rem'
                  }}>
                    Mode sombre
                  </div>
                  <div style={{ 
                    fontSize: '12px', 
                    color: 'var(--color-text-secondary)'
                  }}>
                    Activer le th√®me sombre
                  </div>
                </div>
                <label style={{ 
                  position: 'relative', 
                  display: 'inline-block', 
                  width: '48px', 
                  height: '24px',
                  cursor: 'pointer'
                }}>
                  <input 
                    type="checkbox" 
                    checked={darkMode}
                    onChange={(e) => setDarkMode(e.target.checked)}
                    style={{ 
                      opacity: 0, 
                      width: 0, 
                      height: 0 
                    }}
                  />
                  <span style={{
                    position: 'absolute',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: darkMode ? 'var(--color-accent)' : 'var(--color-border)',
                    borderRadius: '24px',
                    transition: 'all 0.3s'
                  }}>
                    <span style={{
                      position: 'absolute',
                      content: '',
                      height: '18px',
                      width: '18px',
                      left: darkMode ? '27px' : '3px',
                      bottom: '3px',
                      background: 'white',
                      borderRadius: '50%',
                      transition: 'all 0.3s'
                    }}></span>
                  </span>
                </label>
              </div>
              
              <button 
                onClick={() => { exportData(); setShowDataManagement(false); }} 
                className="button-hover" 
                style={{ 
                  padding: 'var(--spacing-lg)', 
                  background: 'var(--color-button-primary)', 
                  border: 'none', 
                  borderRadius: '6px', 
                  color: 'white', 
                  cursor: 'pointer', 
                  fontWeight: 500, 
                  fontSize: '14px', 
                  display: 'flex', 
                  alignItems: 'center', 
                  justifyContent: 'center', 
                  gap: '0.75rem',
                  fontFamily: 'inherit'
                }}
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Exporter mes donn√©es
              </button>
              
              <label 
                style={{ 
                  padding: 'var(--spacing-lg)', 
                  background: 'var(--color-surface)', 
                  border: '1px solid var(--color-border)', 
                  borderRadius: '6px', 
                  color: 'var(--color-text-secondary)', 
                  cursor: 'pointer', 
                  fontWeight: 500, 
                  fontSize: '14px', 
                  display: 'flex', 
                  alignItems: 'center', 
                  justifyContent: 'center', 
                  gap: '0.75rem',
                  fontFamily: 'inherit'
                }} 
                className="button-hover"
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Importer des donn√©es
                <input type="file" accept=".json" onChange={(e) => { 
                  if (confirm('‚ö†Ô∏è ATTENTION\n\nEn important ce fichier, vous allez :\n‚Ä¢ √âcraser TOUTES vos donn√©es actuelles\n‚Ä¢ Remplacer Firebase par ce fichier\n‚Ä¢ Synchroniser le changement sur tous vos appareils\n\nVoulez-vous vraiment continuer ?')) {
                    importData(e); 
                    setShowDataManagement(false);
                  } else {
                    e.target.value = '';
                  }
                }} style={{ display: 'none' }} />
              </label>
              
              <button 
                onClick={() => { 
                  const confirmation = prompt('üö® R√âINITIALISATION TOTALE\n\nVous √™tes sur le point de :\n‚Ä¢ Supprimer TOUS vos m√©dicaments\n‚Ä¢ Supprimer TOUTES vos plaintes conseils\n‚Ä¢ Revenir aux donn√©es par d√©faut\n‚Ä¢ Synchroniser sur tous vos appareils\n\nCette action est IRR√âVERSIBLE !\n\nTapez "SUPPRIMER" pour confirmer :');
                  if (confirmation === 'SUPPRIMER') {
                    resetToDefault(); 
                    setShowDataManagement(false);
                  }
                }} 
                className="button-hover" 
                style={{ 
                  padding: 'var(--spacing-lg)', 
                  background: '#FEE2E2', 
                  border: '1px solid #DC2626', 
                  borderRadius: '6px', 
                  color: '#DC2626', 
                  cursor: 'pointer', 
                  fontWeight: 500, 
                  fontSize: '14px', 
                  display: 'flex', 
                  alignItems: 'center', 
                  justifyContent: 'center', 
                  gap: '0.75rem',
                  fontFamily: 'inherit'
                }}
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <polyline points="1 4 1 10 7 10"/>
                  <polyline points="23 20 23 14 17 14"/>
                  <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                </svg>
                R√©initialiser tout
              </button>
            </div>

          </div>
        </div>
      )}
      
    </div>
  );
}


    ReactDOM.createRoot(document.getElementById('root')).render(<PharmaSpace />);
  </script>
</body>
</html>